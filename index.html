<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DomainSafe — Status · Quick-Codes · Verify · Connect · Docs · Control SPF</title>

  <!-- tiny inline favicon -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><defs><linearGradient id="g" x1="0" x2="1" y1="0" y2="1"><stop stop-color="%239dc0ff"/><stop offset="1" stop-color="%237aa2ff"/></linearGradient></defs><rect width="64" height="64" rx="12" fill="%2310193a"/><path d="M16 33c8-14 24-14 32 0" stroke="url(%23g)" stroke-width="6" fill="none" stroke-linecap="round"/><circle cx="32" cy="36" r="6" fill="%236be28e"/></svg>'>

  <style>
    :root { --bg:#0f1221; --card:#151935; --text:#e8ebff; --muted:#b7c0ff; --accent:#7aa2ff; --ok:#6be28e; --warn:#ffd277; --err:#ff8b8b; --line:#2a3470; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(160deg,#0b0f26,#10163a);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    .wrap{min-height:100%;display:flex;align-items:flex-start;justify-content:center;padding:32px}
    .card{max-width:1100px;width:100%;background:linear-gradient(180deg,var(--card),#121735);border:1px solid #232a55;border-radius:16px;padding:28px 24px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
    h1{color:var(--text);margin:0 0 8px;font-weight:700;letter-spacing:.2px}
    p{color:var(--muted);margin:0 0 16px;line-height:1.6}
    h3,h4{color:var(--text);margin:12px 0 8px}
    label{color:var(--text);font-size:14px;display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--line);background:#0f1533;color:#dbe1ff;outline:none}
    input::placeholder,textarea::placeholder{color:#8ea0ff}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > div{flex:1;min-width:240px}
    .btn{display:inline-block;margin-top:8px;padding:12px 16px;color:#08122b;background:linear-gradient(180deg,#9dc0ff,#7aa2ff);border:none;border-radius:10px;text-decoration:none;font-weight:600;cursor:pointer}
    .btn.secondary{background:#0f1533;color:#cbd5ff;border:1px solid var(--line)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:16px 0 8px}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--line);color:#c6d0ff;background:#0f1533;font-size:13px}
    .log{margin-top:16px;padding:12px;border:1px dashed var(--line);border-radius:10px;background:#0f1533;color:#cbd5ff;font-family:ui-monospace,Consolas,Monaco,monospace;font-size:13px;white-space:pre-wrap}
    table{width:100%;margin-top:12px;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;color:#cbd5ff;font-size:14px;text-align:left;vertical-align:top}
    th{color:#e8ebff}
    .grid{display:grid;grid-template-columns:1fr;gap:18px}
    @media (min-width:980px){ .grid{grid-template-columns:1fr 1fr} }
    .full{grid-column:1 / -1}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);margin-left:6px}
    .mono{font-family:ui-monospace,Consolas,Monaco,monospace}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .mini{font-size:12px;color:#b7c0ff}
    .tips{font-size:13px;color:#b7c0ff}
    .pill{display:inline-block;padding:2px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;margin-left:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>DomainSafe is live ✅</h1>
      <p>Status, Quick-Codes, Verify, and one-click Protect across providers. The robot keeps watch daily.</p>

      <div class="chips">
        <div class="chip">Calm</div>
        <div class="chip">Minimal</div>
        <div class="chip">One-and-done</div>
      </div>

      <div class="grid">
        <!-- Status -->
        <div class="full">
          <h3>Domain Status (daily robot checks)</h3>
          <div class="row">
            <button class="btn" id="stRefresh">Refresh status</button>
            <button class="btn" id="stRun">Run now (dev)</button>
          </div>
          <div class="log" id="st-log">Shows the latest recorded check per domain. “Run now” triggers a one-time check.</div>
          <table id="st-table" style="margin-top:8px">
            <thead><tr>
              <th>Domain</th><th>Owner</th><th>SPF</th><th>DMARC</th><th>DKIM s1</th><th>DKIM s2</th><th>Checked at</th>
            </tr></thead>
            <tbody id="st-body"><tr><td colspan="7" class="warn">No rows yet</td></tr></tbody>
          </table>
        </div>

        <!-- Add Domain -->
        <div>
          <h3>Add Domain</h3>
          <div class="row">
            <div>
              <label for="email">Contact email</label>
              <input id="email" type="email" placeholder="you@example.com" />
            </div>
            <div>
              <label for="domain">Domain</label>
              <input id="domain" type="text" placeholder="example.com" />
            </div>
          </div>
          <button class="btn" id="addBtn">Add domain</button>
          <div class="log" id="log">Waiting…</div>

          <h4 style="color:#e8ebff;margin-top:18px">Recent domains</h4>
          <table id="table">
            <thead><tr><th>Domain</th><th>Status</th><th>Owner</th><th>Created</th></tr></thead>
            <tbody id="tbody"><tr><td colspan="4" class="warn">No rows yet</td></tr></tbody>
          </table>
        </div>

        <!-- Quick-Codes -->
        <div>
          <h3>Quick-Codes (one-time DNS)</h3>
          <p class="tips">Use this if you don’t want to connect a provider account. Paste these values at your DNS provider and you’re done.</p>
          <div class="row">
            <div>
              <label for="qc-domain">Domain to secure</label>
              <input id="qc-domain" type="text" placeholder="example.com" />
            </div>
          </div>
          <div class="row">
            <button class="btn" id="qcBtn">Generate Quick-Codes</button>
            <label style="display:flex;align-items:center;gap:8px">
              <input type="checkbox" id="qcShowExtras" />
              <span>Show optional extras (TLS-RPT reports)</span>
            </label>
            <button class="btn secondary" id="qcCopyAll" title="Copy all records">Copy all</button>
          </div>
          <div class="log" id="qc-log">Enter a domain and click “Generate Quick-Codes”.</div>

          <div id="qc-table-wrap" style="display:none">
            <h4>Required records</h4>
            <table id="qc-table">
              <thead><tr><th>Type</th><th>Name/Host</th><th>Value</th><th>TTL</th><th>Purpose</th><th></th></tr></thead>
              <tbody id="qc-body"></tbody>
            </table>
            <div id="qc-extras-wrap" style="display:none">
              <h4>Optional extras</h4>
              <table id="qc-extras">
                <thead><tr><th>Type</th><th>Name/Host</th><th>Value</th><th>TTL</th><th>Purpose</th><th></th></tr></thead>
                <tbody id="qc-body-extras"></tbody>
              </table>
              <p class="tips">Extras improve transport security and reporting. They are not required for sending/receiving, but recommended.</p>
            </div>
          </div>
        </div>

        <!-- Verify Records -->
        <div class="full">
          <h3>Verify Records</h3>
          <p class="tips">Checks the public DNS. Green means your domain is wired to the central controls so you don’t need to revisit DNS later.</p>
          <div class="row">
            <div>
              <label for="vr-domain">Domain to check</label>
              <input id="vr-domain" type="text" placeholder="example.com" />
            </div>
          </div>
          <button class="btn" id="vrBtn">Check</button>
          <div class="log" id="vr-log">Enter a domain and click “Check”.</div>

          <table id="vr-table" style="display:none;margin-top:12px">
            <thead><tr><th>Check</th><th>Status</th><th>Detail</th></tr></thead>
            <tbody id="vr-body"></tbody>
          </table>
        </div>

        <!-- ===== DMARC Insights (beta) ===== -->
        <div class="full" id="insights-section" style="margin-top:24px">
          <h3 style="color:#e8ebff;margin:0 0 6px">DMARC Insights (beta)</h3>
          <p class="tips" id="insHelp">The robot parses DMARC reports from your bucket each night. Use “Ingest latest” to run it now.</p>

          <div class="row">
            <div>
              <label for="insDomain">Domain</label>
              <input id="insDomain" type="text" placeholder="example.com" />
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <button class="btn" id="ingestBtn">Ingest latest 20</button>
            <button class="btn" id="load7">Load 7-day</button>
            <button class="btn" id="load30">Load 30-day</button>
          </div>

          <div class="log" id="insLog" style="margin-top:12px">Waiting…</div>

          <table id="insTable" style="margin-top:8px">
            <thead>
              <tr><th>Day</th><th>Total</th><th>DMARC Pass</th><th>SPF Pass</th><th>DKIM Pass</th></tr>
            </thead>
            <tbody id="insBody"><tr><td colspan="5" class="warn">No data yet</td></tr></tbody>
          </table>
        </div>

        <!-- Connect Cloudflare -->
        <div class="full">
          <h3>Connect Cloudflare (one-click Protect)</h3>
          <p class="mono" style="color:#cbd5ff">
            Paste a Cloudflare API Token (Permissions: <b>Zone:Read</b> and <b>DNS:Edit</b>, scoped to the zone you’ll test).<br/>
            Token is used only for this request and not stored.
            <span class="pill">Platform: Cloudflare Dashboard → <a href="https://dash.cloudflare.com/profile/api-tokens" target="_blank" style="color:#9dc0ff">API Tokens</a></span>
          </p>
          <div class="row">
            <div>
              <label for="cf-token">Cloudflare API Token</label>
              <input id="cf-token" type="password" placeholder="paste token here" />
            </div>
          </div>
          <div class="row">
            <button class="btn" id="cfListBtn">List zones</button>
            <div style="flex:1;min-width:240px">
              <label for="cf-zone">Zone</label>
              <select id="cf-zone"><option value="">— choose a zone —</option></select>
            </div>
            <button class="btn" id="cfProtectBtn">Protect</button>
          </div>
          <div class="log" id="cf-log">Paste token → List zones → choose zone → Protect.</div>
        </div>

        <!-- Connect Route 53 -->
        <div class="full">
          <h3>Connect AWS Route 53 (one-click Protect)</h3>
          <p class="mono" style="color:#cbd5ff">
            Paste an AWS Access Key ID + Secret (IAM user limited to Route 53). Keys are used only for this request.
            <span class="pill">Platform: AWS Console → <a href="https://console.aws.amazon.com/iam/home#/users" target="_blank" style="color:#9dc0ff">IAM Users</a></span>
            <span class="pill">Hosted zones: <a href="https://console.aws.amazon.com/route53/home#HostedZones" target="_blank" style="color:#9dc0ff">Route 53 Hosted Zones</a></span>
          </p>
          <div class="row">
            <div>
              <label for="r53-akid">AWS Access Key ID</label>
              <input id="r53-akid" type="text" placeholder="AKIA..." />
            </div>
            <div>
              <label for="r53-secret">AWS Secret Access Key</label>
              <input id="r53-secret" type="password" placeholder="********" />
            </div>
          </div>
          <div class="row">
            <button class="btn" id="r53ListBtn">List hosted zones</button>
            <div style="flex:1;min-width:240px">
              <label for="r53-zone">Hosted zone</label>
              <select id="r53-zone"><option value="">— choose a hosted zone —</option></select>
            </div>
            <button class="btn" id="r53ProtectBtn">Protect</button>
          </div>
          <div class="log" id="r53-log">Paste keys → List hosted zones → choose one → Protect.</div>
        </div>

        <!-- Control SPF -->
        <div class="full">
          <h3>Control SPF (central include for all protected domains)</h3>
          <p class="mono" style="color:#cbd5ff">
            Choose senders and update <b>_spf.control.domainsafepro.com</b> once. All protected domains inherit it.
            <span class="pill">Platform: Cloudflare Dashboard → <a href="https://dash.cloudflare.com/profile/api-tokens" target="_blank" style="color:#9dc0ff">API Tokens</a> (Zone:Read + DNS:Edit on domainsafepro.com)</span>
          </p>
          <div class="row" style="gap:16px">
            <div style="min-width:260px">
              <label><input type="checkbox" class="spf-v" value="google"> Google Workspace</label><br/>
              <label><input type="checkbox" class="spf-v" value="m365"> Microsoft 365</label><br/>
              <label><input type="checkbox" class="spf-v" value="sendgrid"> SendGrid</label><br/>
              <label><input type="checkbox" class="spf-v" value="ses"> Amazon SES</label><br/>
              <label><input type="checkbox" class="spf-v" value="mailgun"> Mailgun</label><br/>
              <label><input type="checkbox" class="spf-v" value="mailchimp"> Mailchimp</label><br/>
              <label><input type="checkbox" class="spf-v" value="postmark"> Postmark</label><br/>
              <label><input type="checkbox" class="spf-v" value="sparkpost"> SparkPost</label><br/>
              <label><input type="checkbox" class="spf-v" value="zoho"> Zoho</label><br/>
              <label><input type="checkbox" class="spf-v" value="zendesk"> Zendesk</label><br/>
              <label><input type="checkbox" class="spf-v" value="intercom"> Intercom</label>
            </div>
            <div style="flex:1;min-width:260px">
              <label for="spf-preview">Preview (TXT _spf.control.domainsafepro.com)</label>
              <textarea id="spf-preview" rows="4" readonly class="mono" placeholder="v=spf1 ~all"></textarea>
            </div>
          </div>
          <div class="row">
            <div>
              <label for="spf-token">Cloudflare API Token (Zone:Read + DNS:Edit on domainsafepro.com)</label>
              <input id="spf-token" type="password" placeholder="paste token here"/>
            </div>
          </div>
          <div class="row">
            <button class="btn" id="spfLoad">Load current</button>
            <button class="btn" id="spfUpdate">Update control SPF</button>
          </div>
          <div class="log" id="spf-log">Use “Load current” to see existing value, select senders, then “Update”.</div>
        </div>

        <!-- Docs -->
        <div class="full">
          <h3>Docs (short & practical)</h3>
          <h4>Option A — Quick-Codes (copy-paste at your DNS provider)</h4>
          <ol>
            <li>Enter your domain in <b>Quick-Codes</b> → <b>Generate</b>.</li>
            <li>Copy each required row (use <b>Copy</b> buttons) and paste at your DNS provider (TXT/CNAME records).</li>
            <li>(Optional) Tick “Show optional extras” and add those too.</li>
            <li>Go to <b>Verify Records</b> → <b>Check</b> → expect all green.</li>
          </ol>
          <p class="tips">
            Platform links:
            <a href="https://dash.cloudflare.com/" target="_blank" style="color:#9dc0ff">Cloudflare Dashboard</a> ·
            <a href="https://console.aws.amazon.com/route53/home#HostedZones" target="_blank" style="color:#9dc0ff">AWS Route 53</a>
          </p>

          <h4>Option B — Connect Cloudflare (one-click)</h4>
          <ol>
            <li>Cloudflare Dashboard → <a href="https://dash.cloudflare.com/profile/api-tokens" target="_blank" style="color:#9dc0ff">API Tokens</a> → Create Token (Zone:Read + DNS:Edit).</li>
            <li>Paste token here → <b>List zones</b> → choose zone → <b>Protect</b>.</li>
            <li>Use <b>Verify Records</b> to confirm.</li>
          </ol>

          <h4>Option C — Connect AWS Route 53 (one-click)</h4>
          <ol>
            <li>AWS Console → IAM Users → create user with <b>AmazonRoute53FullAccess</b> (for first test).</li>
            <li>Create access key (CLI) → paste here → <b>List hosted zones</b> → choose → <b>Protect</b>.</li>
            <li>Use <b>Verify Records</b> to confirm.</li>
          </ol>

          <h4>What the robot sets</h4>
          <ul>
            <li><b>SPF</b> TXT at apex: <span class="mono">v=spf1 include:_spf.control.domainsafepro.com ~all</span></li>
            <li><b>DKIM</b> CNAMEs: <span class="mono">s1._domainkey</span> and <span class="mono">s2._domainkey</span> → central keys</li>
            <li><b>DMARC</b> TXT at <span class="mono">_dmarc</span>: monitor mode (<span class="mono">p=none</span>) to start</li>
            <li><b>Extras</b> (optional): <span class="mono">_smtp._tls</span> TXT for TLS reporting</li>
          </ul>
          <p class="tips">You can tighten DMARC later without touching customer DNS because SPF/DKIM are centrally included.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===================== CONSTANTS ===================== */
    const API_BASE = "https://domainsafe-robot.pankajonlinerepository.workers.dev";
    const DMARC_API_BASE = ""https://api.domainsafepro.com";

    /* ===================== STATUS ===================== */
    const stBody = document.getElementById('st-body');
    const stLog  = document.getElementById('st-log');
    const stRefreshBtn = document.getElementById('stRefresh');
    const stRunBtn     = document.getElementById('stRun');

    function esc(s){ return (s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    const pill = (ok)=> `<span class="tag" style="border-color:${ok?'#2f7':'#d66'};color:${ok?'#6be28e':'#ff8b8b'}">${ok?'OK':'Needs fix'}</span>`;

    async function loadStatus(){
      stLog.textContent = 'Loading status…';
      try{
        const r = await fetch(API_BASE + "/api/status");
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Failed to load status');
        const rows = j.rows || [];
        stBody.innerHTML = '';
        if(rows.length === 0){
          stBody.innerHTML = '<tr><td colspan="7" class="warn">No rows yet</td></tr>';
          stLog.textContent = 'No recorded checks yet. Click “Run now (dev)” to seed status, or wait for cron.';
          return;
        }
        for(const r of rows){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${esc(r.domain_name||'')}</td>
            <td>${esc(r.email||'')}</td>
            <td>${pill(r.spf_ok===1)}</td>
            <td>${pill(r.dmarc_ok===1)}</td>
            <td>${pill(r.dkim_s1_ok===1)}</td>
            <td>${pill(r.dkim_s2_ok===1)}</td>
            <td class="mini">${esc(r.checked_at||'')}</td>
          `;
          stBody.appendChild(tr);
        }
        stLog.textContent = `Loaded ${rows.length} row(s).`;
      }catch(e){
        stLog.textContent = e.message;
      }
    }
    if (stRefreshBtn) stRefreshBtn.addEventListener('click', loadStatus);
    if (stRunBtn) stRunBtn.addEventListener('click', async ()=>{
      stRunBtn.disabled = true; stLog.textContent = 'Running checks…';
      try{
        const r = await fetch(API_BASE + "/api/monitor-run", { method:'POST' });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Run failed');
        stLog.textContent = `Ran ${j.count} domain(s). Reloading status…`;
        setTimeout(loadStatus, 800);
      }catch(e){ stLog.textContent = e.message; }
      finally{ stRunBtn.disabled = false; }
    });

    /* ===================== ADD DOMAIN ===================== */
    const logEl   = document.getElementById('log');
    const tbody   = document.getElementById('tbody');
    const emailEl = document.getElementById('email');
    const domainEl= document.getElementById('domain');
    const addBtn  = document.getElementById('addBtn');

    function log(msg){ logEl.textContent = typeof msg==='string' ? msg : JSON.stringify(msg,null,2); }

    async function listDomains(){
      try{
        const r = await fetch(API_BASE + "/api/domains");
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Failed to fetch');
        tbody.innerHTML = '';
        if(!j.domains || j.domains.length === 0){
          tbody.innerHTML = '<tr><td colspan="4" class="warn">No rows yet</td></tr>';
          return;
        }
        for(const d of j.domains){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${esc(d.domain_name || '')}</td>
            <td>${esc(d.status || '')}</td>
            <td>${esc(d.email  || '')}</td>
            <td>${esc(d.created_at || '')}</td>
          `;
          tbody.appendChild(tr);
        }
      }catch(e){ log({error:e.message}); }
    }
    if (addBtn) addBtn.addEventListener('click', async ()=>{
      const email = emailEl.value.trim();
      const dom   = domainEl.value.trim().toLowerCase();
      if(!email || !dom){ log('Please fill email and domain.'); return; }
      addBtn.disabled = true; log('Saving…');
      try{
        const r = await fetch(API_BASE + "/api/domains", {
          method:"POST",
          headers:{ "content-type":"application/json" },
          body: JSON.stringify({ email, domain: dom })
        });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Failed to save');
        log(j.created ? "Added ✔" : "Already exists ✓");
        domainEl.value = ""; await listDomains(); await loadStatus();
      }catch(e){ log({error:e.message}); }
      finally{ addBtn.disabled = false; }
    });

    /* ===================== QUICK-CODES ===================== */
    const qcBtn     = document.getElementById('qcBtn');
    const qcDomain  = document.getElementById('qc-domain');
    const qcLog     = document.getElementById('qc-log');
    const qcWrap    = document.getElementById('qc-table-wrap');
    const qcBody    = document.getElementById('qc-body');
    const qcBodyX   = document.getElementById('qc-body-extras');
    const qcXWrap   = document.getElementById('qc-extras-wrap');
    const qcShowX   = document.getElementById('qcShowExtras');
    const qcCopyAll = document.getElementById('qcCopyAll');

    function rowHTML(r){
      const value = esc(r.value);
      const host  = esc(r.name);
      const cmd   = `${r.type} ${host} ${r.value} TTL=${r.ttl||3600}`;
      return `<tr>
        <td>${esc(r.type)}</td>
        <td>${host}</td>
        <td style="max-width:520px;word-break:break-all" class="mono">${value}</td>
        <td>${esc(String(r.ttl || '3600'))}</td>
        <td>${esc(r.purpose || '')}</td>
        <td><button class="btn secondary" onclick="navigator.clipboard.writeText('${cmd.replace(/'/g,"\\'")}')">Copy</button></td>
      </tr>`;
    }

    if (qcBtn) qcBtn.addEventListener('click', async ()=>{
      const d = qcDomain.value.trim().toLowerCase();
      if(!d){ qcLog.textContent = 'Enter a domain first.'; return; }
      qcBtn.disabled = true; qcLog.textContent = 'Generating…';
      try{
        const res = await fetch(API_BASE + "/api/quick-codes?domain=" + encodeURIComponent(d));
        const j = await res.json();
        if(!j.ok) throw new Error(j.error || 'Failed');
        qcBody.innerHTML = ''; qcBodyX.innerHTML = '';
        (j.records || []).forEach(r => qcBody.insertAdjacentHTML('beforeend', rowHTML(r)));
        (j.extras  || []).forEach(r => qcBodyX.insertAdjacentHTML('beforeend', rowHTML(r)));
        qcWrap.style.display = 'block';
        qcXWrap.style.display = qcShowX.checked ? 'block' : 'none';
        qcLog.textContent = `TTL ${j.ttl}s • Control domain: ${j.control_domain}`;
      }catch(e){ qcLog.textContent = e.message; }
      finally{ qcBtn.disabled = false; }
    });
    if (qcShowX) qcShowX.addEventListener('change', ()=>{ qcXWrap.style.display = qcShowX.checked ? 'block' : 'none'; });

    if (qcCopyAll) qcCopyAll.addEventListener('click', ()=>{
      const rows = [...document.querySelectorAll('#qc-table tbody tr, #qc-extras tbody tr')];
      const lines = rows.map(tr=>{
        const t = tr.children[0]?.textContent?.trim();
        const n = tr.children[1]?.textContent?.trim();
        const v = tr.children[2]?.textContent?.trim();
        const ttl = tr.children[3]?.textContent?.trim();
        return `${t} ${n} ${v} TTL=${ttl}`;
      }).join('\n');
      navigator.clipboard.writeText(lines).catch(()=>{});
    });

    /* ===================== VERIFY ===================== */
    const vrBtn  = document.getElementById('vrBtn');
    const vrDom  = document.getElementById('vr-domain');
    const vrLog  = document.getElementById('vr-log');
    const vrTable= document.getElementById('vr-table');
    const vrBody = document.getElementById('vr-body');

    if (vrBtn) vrBtn.addEventListener('click', async ()=>{
      const d = vrDom.value.trim().toLowerCase();
      if(!d){ vrLog.textContent = 'Enter a domain first.'; return; }
      vrBtn.disabled = true; vrLog.textContent = 'Checking…';
      vrTable.style.display = 'none'; vrBody.innerHTML = '';
      try{
        const res = await fetch(API_BASE + "/api/check-quick-codes?domain=" + encodeURIComponent(d));
        const j = await res.json();
        if(!j.ok) throw new Error(j.error || 'Failed');
        const c = j.checks || {};
        const spfOk = !!(c.spf && c.spf.present && c.spf.includesControl);
        const dmarcOk = !!(c.dmarc && c.dmarc.present);
        const s1Ok = !!(c.dkim && c.dkim.s1 && c.dkim.s1.ok);
        const s2Ok = !!(c.dkim && c.dkim.s2 && c.dkim.s2.ok);

        const rows = [
          ['SPF include', spfOk, (c.spf?.record || '—')],
          ['DMARC TXT', dmarcOk, (c.dmarc?.record || '—')],
          ['DKIM s1 CNAME', s1Ok, (c.dkim?.s1?.target || '—')],
          ['DKIM s2 CNAME', s2Ok, (c.dkim?.s2?.target || '—')]
        ];
        rows.forEach(([label, ok, detail])=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${label}</td><td>${ok?'<span class="ok">OK</span>':'<span class="err">Needs fix</span>'}</td><td class="mono" style="max-width:620px;word-break:break-all">${esc(detail)}</td>`;
          vrBody.appendChild(tr);
        });

        vrTable.style.display = 'table';
        vrLog.textContent = spfOk && dmarcOk && s1Ok && s2Ok ? 'All good ✓' : 'Some items need attention';
      }catch(e){ vrLog.textContent = e.message; }
      finally{ vrBtn.disabled = false; }
    });

    /* ===================== CONNECT CLOUDFLARE ===================== */
    const cfToken   = document.getElementById('cf-token');
    const cfListBtn = document.getElementById('cfListBtn');
    const cfZoneSel = document.getElementById('cf-zone');
    const cfProtect = document.getElementById('cfProtectBtn');
    const cfLog     = document.getElementById('cf-log');

    if (cfListBtn) cfListBtn.addEventListener('click', async ()=>{
      const token = cfToken.value.trim();
      if(!token){ cfLog.textContent = 'Please paste your Cloudflare API token.'; return; }
      cfListBtn.disabled = true; cfLog.textContent = 'Listing zones…';
      try{
        const r = await fetch(API_BASE + '/api/cf/list-zones', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ token }) });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Failed to list zones');
        cfZoneSel.innerHTML = '<option value="">— choose a zone —</option>';
        (j.zones || []).forEach(z=>{
          const opt = document.createElement('option');
          opt.value = z.id; opt.textContent = `${z.name} (${z.status})`;
          cfZoneSel.appendChild(opt);
        });
        cfLog.textContent = (j.zones||[]).length ? `Found ${j.zones.length} zone(s). Choose one and click Protect.` : 'No zones returned. Check token scopes.';
      }catch(e){ cfLog.textContent = e.message; }
      finally{ cfListBtn.disabled = false; }
    });

    if (cfProtect) cfProtect.addEventListener('click', async ()=>{
      const token   = cfToken.value.trim();
      const zone_id = cfZoneSel.value;
      if(!token){ cfLog.textContent = 'Please paste your token.'; return; }
      if(!zone_id){ cfLog.textContent = 'Please choose a zone first.'; return; }
      cfProtect.disabled = true; cfLog.textContent = 'Protecting… (writing SPF, DKIM, DMARC)';
      try{
        const r = await fetch(API_BASE + '/api/cf/protect', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ token, zone_id }) });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Failed to protect');
        const lines = (j.results||[]).map(x => `${x.type} ${x.name} → ${x.action}`);
        cfLog.textContent = `Zone ${j.apex}: ${lines.join(' | ')}. Use Verify Records to confirm.`;
      }catch(e){ cfLog.textContent = e.message; }
      finally{ cfProtect.disabled = false; }
    });

    /* ===================== CONNECT ROUTE 53 ===================== */
    const r53Akid    = document.getElementById('r53-akid');
    const r53Secret  = document.getElementById('r53-secret');
    const r53ListBtn = document.getElementById('r53ListBtn');
    const r53ZoneSel = document.getElementById('r53-zone');
    const r53Protect = document.getElementById('r53ProtectBtn');
    const r53Log     = document.getElementById('r53-log');

    if (r53ListBtn) r53ListBtn.addEventListener('click', async ()=>{
      const access_key_id = r53Akid.value.trim();
      const secret_access_key = r53Secret.value.trim();
      if(!access_key_id || !secret_access_key){ r53Log.textContent = 'Paste AWS Access Key ID and Secret first.'; return; }
      r53ListBtn.disabled = true; r53Log.textContent = 'Listing hosted zones…';
      try{
        const r = await fetch(API_BASE + '/api/r53/list-zones', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ access_key_id, secret_access_key }) });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Failed to list hosted zones');
        r53ZoneSel.innerHTML = '<option value="">— choose a hosted zone —</option>';
        (j.zones || []).forEach(z=>{
          const opt = document.createElement('option');
          opt.value = z.id; opt.textContent = `${z.name} (${z.id})`;
          r53ZoneSel.appendChild(opt);
        });
        r53Log.textContent = (j.zones||[]).length ? `Found ${j.zones.length} hosted zone(s). Choose one and click Protect.` : 'No hosted zones found.';
      }catch(e){ r53Log.textContent = e.message; }
      finally{ r53ListBtn.disabled = false; }
    });

    if (r53Protect) r53Protect.addEventListener('click', async ()=>{
      const access_key_id = r53Akid.value.trim();
      const secret_access_key = r53Secret.value.trim();
      const hosted_zone_id = r53ZoneSel.value;
      if(!access_key_id || !secret_access_key){ r53Log.textContent = 'Paste AWS keys first.'; return; }
      if(!hosted_zone_id){ r53Log.textContent = 'Choose a hosted zone first.'; return; }
      r53Protect.disabled = true; r53Log.textContent = 'Protecting… (writing SPF, DKIM, DMARC)';
      try{
        const r = await fetch(API_BASE + '/api/r53/protect', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ access_key_id, secret_access_key, hosted_zone_id }) });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Failed to protect');
        const lines = (j.results||[]).map(x => `${x.type} ${x.name} → ${x.action}`);
        r53Log.textContent = `Zone ${j.apex}: ${lines.join(' | ')}. Use Verify Records to confirm.`;
      }catch(e){ r53Log.textContent = e.message; }
      finally{ r53Protect.disabled = false; }
    });

    /* ===================== CONTROL SPF ===================== */
    const spfToken = document.getElementById('spf-token');
    const spfLog   = document.getElementById('spf-log');
    const spfPrev  = document.getElementById('spf-preview');
    const spfLoad  = document.getElementById('spfLoad');
    const spfUpdate= document.getElementById('spfUpdate');
    const spfChecks= [...document.querySelectorAll('.spf-v')];

    function buildSpf(){
      const map = {
        google:   "include:_spf.google.com",
        m365:     "include:spf.protection.outlook.com",
        sendgrid: "include:sendgrid.net",
        ses:      "include:amazonses.com",
        mailgun:  "include:mailgun.org",
        mailchimp:"include:servers.mcsv.net",
        postmark: "include:spf.mtasv.net",
        sparkpost:"include:_spf.sparkpostmail.com",
        zoho:     "include:zoho.com",
        zendesk:  "include:mail.zendesk.com",
        intercom: "include:spf.intercom.io"
      };
      const sel = spfChecks.filter(x=>x.checked).map(x=>map[x.value]).filter(Boolean);
      spfPrev.value = ["v=spf1", ...sel, "~all"].join(" ");
    }
    spfChecks.forEach(cb=>cb.addEventListener('change', buildSpf));

    if (spfLoad) spfLoad.addEventListener('click', async ()=>{
      spfLog.textContent = 'Loading current control SPF…';
      try{
        const r = await fetch("https://dns.google/resolve?name=_spf.control.domainsafepro.com&type=TXT");
        const j = await r.json();
        const ans = (j.Answer||[]).map(a=>a.data.replace(/^"|"$/g,'')).join(' ');
        spfPrev.value = ans || 'v=spf1 ~all';
        spfLog.textContent = `Current: ${ans || 'v=spf1 ~all'}`;
      }catch(e){ spfLog.textContent = e.message; }
    });

    if (spfUpdate) spfUpdate.addEventListener('click', async ()=>{
      const token = spfToken.value.trim();
      if(!token){ spfLog.textContent = 'Paste Cloudflare API token (Zone:Read + DNS:Edit on domainsafepro.com).'; return; }
      buildSpf();
      const vendors = spfChecks.filter(x=>x.checked).map(x=>x.value);
      spfUpdate.disabled = true; spfLog.textContent = 'Updating _spf.control.domainsafepro.com…';
      try{
        const r = await fetch(API_BASE.replace('domainsafe-robot','dmarc-inbound').replace('workers','workers') // keep base same domain scheme
          .replace('dmarc-inbound','domainsafe-robot') // leave unchanged if not needed
          ); // no-op, just placeholder to ensure no accidental change
      }catch(e){/* noop */} // safeguard against accidental edit
      try{
        const r = await fetch("https://domainsafe-robot.pankajonlinerepository.workers.dev/api/control-spf/upsert", {
          method:'POST', headers:{'content-type':'application/json'},
          body: JSON.stringify({ token, vendors })
        });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Failed to update');
        spfPrev.value = j.spf || spfPrev.value;
        spfLog.textContent = `Updated ${j.name} → ${j.action}.`;
      }catch(e){ spfLog.textContent = e.message; }
      finally{ spfUpdate.disabled = false; }
    });

    /* ===================== DMARC INSIGHTS (new) ===================== */
    const insDomain = document.getElementById('insDomain');
    const insLog    = document.getElementById('insLog');
    const insBody   = document.getElementById('insBody');

    async function loadDmarcRange(days){
      const d = (insDomain.value||'').trim().toLowerCase();
      if(!d){ insLog.textContent = 'Enter a domain first.'; return; }
      insLog.textContent = 'Loading…';
      try{
        const r = await fetch(DMARC_API_BASE + '/api/dmarc/summary?domain=' + encodeURIComponent(d) + '&days=' + days);
        const j = await r.json();
        if(!j.ok){ insLog.textContent = j.error || 'Failed'; return; }
        insBody.innerHTML = '';
        const rows = j.series || [];
        if(!rows.length){
          insBody.innerHTML = '<tr><td colspan="5" class="warn">No data yet</td></tr>';
          insLog.textContent = 'OK (no data yet)';
          return;
        }
        for(const row of rows){
          const passPct = row.total ? Math.round(100 * row.aligned / row.total) + '%' : '-';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.day}</td>
            <td>${row.total}</td>
            <td>${row.aligned} (${passPct})</td>
            <td>${row.spf}</td>
            <td>${row.dkim}</td>`;
          insBody.appendChild(tr);
        }
        insLog.textContent = 'OK';
      }catch(e){
        insLog.textContent = 'Error: ' + e.message;
      }
    }
    async function ingestLatest(){
      insLog.textContent = 'Ingesting latest…';
      try{
        const r = await fetch(DMARC_API_BASE + '/api/dmarc/ingest-latest?limit=20', { method:'POST' });
        const j = await r.json();
        insLog.textContent = JSON.stringify(j, null, 2);
      }catch(e){
        insLog.textContent = 'Error: ' + e.message;
      }
    }
    const ingestBtn = document.getElementById('ingestBtn');
    const load7Btn  = document.getElementById('load7');
    const load30Btn = document.getElementById('load30');
    if (ingestBtn) ingestBtn.addEventListener('click', ingestLatest);
    if (load7Btn)  load7Btn.addEventListener('click', ()=> loadDmarcRange(7));
    if (load30Btn) load30Btn.addEventListener('click', ()=> loadDmarcRange(30));

    /* ===================== INIT LOADS ===================== */
    listDomains(); loadStatus();
  </script>
</body>
</html>
