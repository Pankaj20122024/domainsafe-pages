<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DomainSafePro - Setup Your Protection</title>
  <meta name="description" content="Set up email authentication for your domain. Get your DNS records and verify your protection status."/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vollkorn:wght@600&family=Exo+2:wght@600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://rsms.me/">
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">

  <style>
/* ========== TOKENS (matching landing page) ========== */
:root {
  --font-serif: 'Vollkorn', Georgia, serif;
  --font-sans: 'Inter', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  --font-brand: 'Exo 2', sans-serif;
  --font-mono: 'Roboto Mono', 'Fira Code', ui-monospace, monospace;
  --radius: 14px;
  --radius-sm: 8px;
  --maxw: 1100px;
  --fast-transition: 0.15s ease;
  --med-transition: 0.3s ease;
}

[data-theme="dark"] {
  --bg: #0c0c0e;
  --bg-card: #141417;
  --bg-alt: #1a1a1d;
  --bg-input: rgba(0,0,0,0.25);
  --fg: #ededf0;
  --fg-muted: #9496a3;
  --border: rgba(255,255,255,0.1);
  --border-glow: rgba(255,255,255,0.2);
  --brand: #5a81ff;
  --brand-accent: #8a7aff;
  --warn: #ffd36a;
  --ok: #67e8a3;
  --danger: #ff7a7a;
  --shadow-color: rgba(0,0,0,0.3);
  --glass-bg: rgba(20,20,23,0.55);
  --glass-border: rgba(255,255,255,0.12);
  --highlight-bg: rgba(90,129,255,0.08);
  --highlight-border: rgba(90,129,255,0.3);
}

[data-theme="light"] {
  --bg: #fafafa;
  --bg-card: #ffffff;
  --bg-alt: #f5f5f5;
  --bg-input: rgba(0,0,0,0.04);
  --fg: #111113;
  --fg-muted: #55555c;
  --border: rgba(0,0,0,0.1);
  --border-glow: rgba(0,0,0,0.2);
  --brand: #4a75ff;
  --brand-accent: #7a6aff;
  --warn: #f5a623;
  --ok: #28a745;
  --danger: #d9534f;
  --shadow-color: rgba(0,0,0,0.08);
  --glass-bg: rgba(255,255,255,0.6);
  --glass-border: rgba(0,0,0,0.08);
  --highlight-bg: rgba(74,117,255,0.06);
  --highlight-border: rgba(74,117,255,0.25);
}

/* ========== BASE ========== */
* { box-sizing: border-box; }
html { scroll-behavior: smooth; font-feature-settings: 'liga' 1, 'kern' 1; }
html, body { max-width: 100%; overflow-x: clip; }
body {
  margin: 0;
  min-height: 100vh;
  background: linear-gradient(135deg, var(--bg) 0%, var(--bg-alt) 50%, var(--bg) 100%);
  color: var(--fg);
  font-family: var(--font-sans);
  font-size: 17px;
  line-height: 1.7;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  transition: background-color var(--med-transition), color var(--med-transition);
}
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 1000px;
  height: 1000px;
  background: radial-gradient(circle, rgba(90,129,255,0.06) 0%, transparent 70%);
  pointer-events: none;
  z-index: 0;
}

h1, h2, h3, h4 {
  font-family: var(--font-serif);
  color: var(--fg);
  font-weight: 600;
  letter-spacing: -0.01em;
  line-height: 1.3;
  margin: 0;
}
p { color: var(--fg-muted); margin: 0; max-width: 65ch; }
a { text-decoration: none; color: var(--brand); }
code, .mono { font-family: var(--font-mono); font-size: 0.9em; }

/* ========== HEADER ========== */
header {
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  background: var(--glass-bg);
  border-bottom: 1px solid var(--glass-border);
  padding: 16px 20px;
}
.header-inner {
  max-width: var(--maxw);
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 12px;
}
.brand {
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 700;
  font-size: 1.4rem;
  color: var(--fg);
  text-decoration: none;
}
.brand:hover {
  opacity: 0.9;
}
.brand-text {
  font-family: var(--font-brand);
  background: linear-gradient(90deg, #5a81ff 0%, #21E6C1 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.header-tag {
  font-size: 13px;
  color: var(--fg-muted);
  display: none;
}
@media (min-width: 768px) {
  .header-tag { display: block; max-width: 400px; }
}

.auth-bar {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}
#auth-status-label {
  font-size: 13px;
  color: var(--fg-muted);
}

/* Theme toggle */
.theme-toggle {
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-card);
  border: 1px solid var(--border);
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  transition: all var(--fast-transition);
}
.theme-toggle:hover { border-color: var(--border-glow); }
.theme-toggle svg { width: 16px; height: 16px; color: var(--fg-muted); }
[data-theme="dark"] .theme-toggle .sun-icon { display: block; }
[data-theme="dark"] .theme-toggle .moon-icon { display: none; }
[data-theme="light"] .theme-toggle .sun-icon { display: none; }
[data-theme="light"] .theme-toggle .moon-icon { display: block; }

/* ========== BUTTONS ========== */
.btn {
  appearance: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 12px 22px;
  border-radius: 999px;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--fast-transition);
  font-size: 15px;
  font-family: var(--font-sans);
  border: 2px solid var(--brand);
  background: var(--brand);
  color: #fff;
  box-shadow: 0 4px 12px var(--shadow-color);
}
.btn:hover {
  filter: brightness(1.1);
  transform: translateY(-1px);
  box-shadow: 0 6px 18px var(--shadow-color);
}
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; filter: none; }

.btn.secondary, .btn-auth {
  background: var(--glass-bg);
  border: 2px solid var(--glass-border);
  color: var(--fg);
  backdrop-filter: blur(8px);
}
.btn.secondary:hover, .btn-auth:hover {
  background: var(--bg-alt);
  border-color: var(--border-glow);
}

.btn.ghost {
  background: transparent;
  border: 2px solid var(--border);
  color: var(--fg-muted);
}
.btn.ghost:hover {
  border-color: var(--border-glow);
  color: var(--fg);
}

.btn.warn {
  background: linear-gradient(135deg, #ffd36a 0%, #f5a623 100%);
  border-color: #f5a623;
  color: #1a1a1d;
}
.btn.warn:hover {
  filter: brightness(1.05);
}

.btn.large {
  padding: 16px 32px;
  font-size: 1rem;
}

.btn-sm {
  padding: 8px 16px;
  font-size: 13px;
}

/* ========== LOADING SECTION ========== */
#loading-section {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  min-height: 60vh;
}
.loading-card {
  width: 100%;
  max-width: 480px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: var(--radius);
  border: 1px solid var(--glass-border);
  padding: 48px 28px;
  box-shadow: 0 24px 60px var(--shadow-color);
  text-align: center;
  position: relative;
  z-index: 1;
}
.loading-spinner {
  width: 48px;
  height: 48px;
  border: 3px solid var(--border);
  border-top-color: var(--brand);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
.loading-card h2 {
  font-size: 1.5rem;
  margin-bottom: 8px;
}
.loading-card p {
  font-size: 15px;
  color: var(--fg-muted);
  max-width: 320px;
  margin: 0 auto;
}

/* ========== LOGIN SECTION ========== */
#login-section {
  display: none;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  min-height: 60vh;
}
.login-card {
  width: 100%;
  max-width: 480px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: var(--radius);
  border: 1px solid var(--glass-border);
  padding: 32px 28px;
  box-shadow: 0 24px 60px var(--shadow-color);
  text-align: center;
  position: relative;
  z-index: 1;
}
.login-card .eyebrow {
  font-size: 12px;
  color: var(--brand);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-bottom: 8px;
  font-weight: 600;
}
.login-card h2 {
  font-size: 1.75rem;
  margin-bottom: 12px;
}
.login-card p {
  font-size: 15px;
  color: var(--fg-muted);
  margin-bottom: 24px;
  max-width: 360px;
  margin-left: auto;
  margin-right: auto;
}
.login-card .btn { width: 100%; max-width: 280px; }
.login-card .tiny {
  margin-top: 16px;
  font-size: 12px;
  color: var(--fg-muted);
}

body.authed #loading-section { display: none; }
body.authed #login-section { display: none; }
body.authed #app-main { display: block; }
body.logged-out #loading-section { display: none; }
body.logged-out #login-section { display: flex; }
body.logged-out #app-main { display: none; }

/* ========== MAIN CONSOLE ========== */
main {
  max-width: var(--maxw);
  margin: 0 auto;
  padding: 24px 16px 80px;
  position: relative;
  z-index: 1;
}
#app-main { display: none; }

/* Welcome message */
.welcome-banner {
  text-align: center;
  padding: 32px 20px;
  margin-bottom: 24px;
}
.welcome-banner h1 {
  font-size: 1.8rem;
  margin-bottom: 8px;
}
.welcome-banner p {
  font-size: 1.05rem;
  max-width: 500px;
  margin: 0 auto;
}

/* Section titles */
.section-title {
  font-size: 1rem;
  color: var(--fg-muted);
  font-weight: 600;
  margin-bottom: 16px;
  margin-top: 32px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
  font-family: var(--font-sans);
  display: flex;
  align-items: center;
  gap: 10px;
}
.section-title:first-of-type { margin-top: 0; }
.section-title .icon {
  font-size: 1.2rem;
}

/* ========== GRID ========== */
.grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 20px;
  margin-bottom: 24px;
}
@media (min-width: 900px) {
  .grid { grid-template-columns: 1fr 1fr; }
}
.grid.full { grid-template-columns: 1fr; }
.grid.three {
  grid-template-columns: 1fr;
}
@media (min-width: 700px) {
  .grid.three { grid-template-columns: 1fr 1fr 1fr; }
}

/* ========== CARDS ========== */
.card {
  background: var(--glass-bg);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: 0 8px 32px var(--shadow-color);
  transition: border-color var(--fast-transition), box-shadow var(--fast-transition);
}
.card:hover {
  border-color: var(--border-glow);
}
.card h3 {
  font-size: 1.25rem;
  margin: 0 0 8px 0;
  display: flex;
  align-items: center;
  gap: 10px;
}
.card h3 .card-icon {
  font-size: 1.3rem;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
.card h3 .card-icon svg {
  width: 28px;
  height: 28px;
}
.card h3 .card-icon img {
  width: 28px;
  height: 28px;
  object-fit: contain;
}
.card .desc {
  color: var(--fg-muted);
  font-size: 15px;
  margin: 0 0 16px 0;
  line-height: 1.6;
}

/* HIGHLIGHTED CARD (for primary actions) */
.card.highlight {
  border: 2px solid var(--highlight-border);
  background: var(--highlight-bg);
  box-shadow: 0 8px 32px var(--shadow-color), 0 0 0 1px var(--highlight-border);
}
.card.highlight:hover {
  border-color: var(--brand);
}
.card.highlight h3 {
  color: var(--brand);
}

/* ========== ROUTE SELECTION CARDS ========== */
.route-card {
  background: var(--glass-bg);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border: 2px solid var(--glass-border);
  border-radius: var(--radius);
  padding: 24px;
  text-align: center;
  cursor: pointer;
  transition: all var(--fast-transition);
}
.route-card:hover {
  border-color: var(--border-glow);
  transform: translateY(-2px);
}
.route-card.selected {
  border-color: var(--brand);
  background: var(--highlight-bg);
}
.route-card .route-icon {
  width: 64px;
  height: 64px;
  margin: 0 auto 12px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.route-card .route-icon svg {
  width: 100%;
  height: 100%;
}
.route-card .route-icon img {
  width: 64px;
  height: 64px;
  object-fit: contain;
}
.route-card h4 {
  font-family: var(--font-sans);
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 8px;
}
.route-card p {
  font-size: 14px;
  margin: 0;
}
.route-card .route-tag {
  display: inline-block;
  margin-top: 12px;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
}
.route-card .route-tag.auto {
  background: rgba(103,232,163,0.15);
  color: var(--ok);
}
.route-card .route-tag.manual {
  background: rgba(90,129,255,0.15);
  color: var(--brand);
}

/* ========== FORM ELEMENTS ========== */
label {
  display: block;
  font-size: 13px;
  color: var(--fg-muted);
  margin-bottom: 6px;
  font-weight: 500;
}
input, select, textarea {
  width: 100%;
  padding: 12px 14px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--fg);
  border-radius: var(--radius-sm);
  font-size: 1rem;
  font-family: var(--font-sans);
  outline: none;
  transition: border-color var(--fast-transition), box-shadow var(--fast-transition);
}
input:focus, select:focus, textarea:focus {
  border-color: var(--brand);
  box-shadow: 0 0 0 3px rgba(90,129,255,0.15);
}
input.mono, textarea.mono, .mono {
  font-family: var(--font-mono);
  font-size: 14px;
}
textarea { min-height: 100px; resize: vertical; }
select {
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%239496a3' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 36px;
}

/* Checkbox row */
.checkbox-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 12px;
  font-size: 14px;
  color: var(--fg-muted);
}
.checkbox-row input[type="checkbox"] {
  width: auto;
  margin: 0;
}

/* SPF Builder checkboxes */
.spf-checkboxes {
  display: flex;
  flex-wrap: wrap;
  gap: 12px 18px;
  margin-bottom: 16px;
}
.spf-checkboxes label {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: var(--fg);
  cursor: pointer;
  margin-bottom: 0;
}
.spf-checkboxes input[type="checkbox"] {
  width: auto;
  margin: 0;
}

/* Row layouts */
.row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}
.row:last-child { margin-bottom: 0; }
.row > div { flex: 1 1 200px; }
.row > div.narrow { flex: 0 0 140px; }
.row > div.action { flex: 0 0 auto; align-self: flex-end; }

/* Notice banners */
.notice {
  margin-top: 8px;
  padding: 10px 14px;
  background: rgba(90,129,255,0.1);
  border: 1px solid rgba(90,129,255,0.2);
  border-radius: var(--radius-sm);
  color: var(--brand);
  font-size: 13px;
}

/* ========== LOG / OUTPUT AREAS ========== */
.log {
  white-space: pre-wrap;
  word-break: break-word;
  font-family: var(--font-mono);
  font-size: 13px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 14px;
  max-height: 300px;
  overflow-y: auto;
  color: var(--fg-muted);
}
.log:empty::before {
  content: 'Ready.';
  opacity: 0.5;
}

/* ========== VERIFICATION RESULTS (Human-readable) ========== */
.verify-results {
  margin-top: 16px;
}
.verify-item {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 14px 16px;
  background: var(--bg-input);
  border-radius: var(--radius-sm);
  margin-bottom: 10px;
  border: 1px solid var(--border);
}
.verify-item:last-child { margin-bottom: 0; }
.verify-icon {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  flex-shrink: 0;
}
.verify-icon.pass {
  background: rgba(103,232,163,0.15);
  color: var(--ok);
}
.verify-icon.fail {
  background: rgba(255,122,122,0.15);
  color: var(--danger);
}
.verify-icon.warn {
  background: rgba(255,211,106,0.12);
  color: var(--warn);
}
.verify-content {
  flex: 1;
}
.verify-label {
  font-weight: 600;
  color: var(--fg);
  margin-bottom: 2px;
}
.verify-status {
  font-size: 13px;
  color: var(--fg-muted);
}
.verify-status.pass { color: var(--ok); }
.verify-status.fail { color: var(--danger); }

/* Overall status banner */
.verify-summary {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px 20px;
  border-radius: var(--radius-sm);
  margin-bottom: 16px;
}
.verify-summary.all-pass {
  background: rgba(103,232,163,0.1);
  border: 1px solid rgba(103,232,163,0.3);
}
.verify-summary.has-issues {
  background: rgba(255,211,106,0.1);
  border: 1px solid rgba(255,211,106,0.3);
}
.verify-summary-icon {
  font-size: 28px;
}
.verify-summary-text h4 {
  font-family: var(--font-sans);
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 2px;
}
.verify-summary-text p {
  font-size: 14px;
  margin: 0;
}

/* ========== TABLES ========== */
.table-wrap {
  overflow-x: auto;
  margin-top: 16px;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}
th, td {
  padding: 10px 12px;
  text-align: left;
  border-bottom: 1px solid var(--border);
}
th {
  font-weight: 600;
  color: var(--fg-muted);
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
td {
  color: var(--fg);
}
.pill {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
}
.pill.ok {
  background: rgba(103,232,163,0.15);
  color: var(--ok);
}
.pill.bad {
  background: rgba(255,122,122,0.12);
  color: var(--danger);
}

/* Responsive tables */
@media (max-width: 768px) {
  table, thead, tbody, th, td, tr {
    display: block;
  }
  thead tr {
    position: absolute;
    top: -9999px;
    left: -9999px;
  }
  tr {
    margin-bottom: 16px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px;
    background: var(--bg-input);
  }
  td {
    border: none;
    position: relative;
    padding-left: 40%;
    padding-top: 6px;
    padding-bottom: 6px;
  }
  td::before {
    position: absolute;
    top: 6px;
    left: 12px;
    width: 35%;
    padding-right: 10px;
    white-space: nowrap;
    content: attr(data-label);
    font-weight: 600;
    color: var(--fg-muted);
    font-size: 12px;
  }
}

/* ========== DETAILS/SUMMARY ========== */
details {
  margin-top: 16px;
}
summary {
  cursor: pointer;
  font-size: 14px;
  color: var(--brand);
  font-weight: 500;
  padding: 8px 0;
}
summary:hover {
  text-decoration: underline;
}
details[open] summary {
  margin-bottom: 12px;
}

/* ========== QUICK CODES DISPLAY ========== */
.qc-cards {
  display: grid;
  gap: 16px;
  margin-top: 16px;
}
.qc-card {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 16px;
}
.qc-card-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 12px;
}
.qc-type {
  display: inline-block;
  padding: 4px 10px;
  border-radius: var(--radius-sm);
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.qc-type.txt {
  background: rgba(90,129,255,0.15);
  color: var(--brand);
}
.qc-type.cname {
  background: rgba(103,232,163,0.15);
  color: var(--ok);
}
.qc-purpose {
  font-size: 14px;
  color: var(--fg);
  font-weight: 600;
}
.qc-field {
  margin-bottom: 12px;
}
.qc-field:last-child { margin-bottom: 0; }
.qc-label {
  font-size: 11px;
  color: var(--fg-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 6px;
}
.qc-value {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 10px 12px;
}
.qc-value code {
  flex: 1;
  font-family: var(--font-mono);
  font-size: 13px;
  word-break: break-all;
  color: var(--fg);
}
.copy-btn {
  flex-shrink: 0;
  padding: 6px 12px;
  font-size: 12px;
  border-radius: var(--radius-sm);
  background: var(--brand);
  color: #fff;
  border: none;
  cursor: pointer;
  font-weight: 600;
  transition: all var(--fast-transition);
}
.copy-btn:hover { filter: brightness(1.1); }
.copy-btn.copied {
  background: var(--ok);
}

/* ========== SETUP FLOW SECTIONS ========== */
.setup-section {
  display: none;
}
.setup-section.active {
  display: block;
}

/* Simple back navigation */
.back-nav {
  margin-bottom: 16px;
}
.btn-back {
  background: none;
  border: none;
  color: var(--fg-muted);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  padding: 8px 0;
  font-family: var(--font-sans);
  transition: color var(--fast-transition);
}
.btn-back:hover {
  color: var(--fg);
}

/* ========== INSIGHTS SECTION ========== */
.insights-section {
  margin-top: 32px;
  padding-top: 24px;
  border-top: 1px solid var(--border);
}

/* Insights alignment bars */
.ins-bar {
  height: 10px;
  background: var(--border);
  border-radius: 6px;
  overflow: hidden;
  min-width: 100px;
}
.ins-bar > i {
  display: block;
  height: 100%;
  background: var(--ok);
  border-radius: 6px;
}
.ins-stats {
  font-size: 12px;
  color: var(--fg-muted);
  margin-top: 4px;
}
.ins-summary-stat {
  display: inline-block;
  padding: 4px 10px;
  background: var(--bg-input);
  border-radius: var(--radius-sm);
  margin-right: 8px;
  margin-bottom: 8px;
  font-size: 14px;
}
.ins-summary-stat strong {
  color: var(--ok);
}

/* ========== ADMIN SECTION ========== */
.admin-section {
  margin-top: 40px;
  padding-top: 24px;
  border-top: 2px solid var(--border);
}
.admin-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 12px;
}
.admin-header h2 {
  font-size: 1.3rem;
  display: flex;
  align-items: center;
  gap: 10px;
}
.admin-badge {
  font-size: 11px;
  padding: 4px 10px;
  background: rgba(255,211,106,0.15);
  color: var(--warn);
  border-radius: 999px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.admin-toggle {
  font-size: 13px;
  color: var(--fg-muted);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
}
.admin-toggle:hover { color: var(--fg); }
.admin-content {
  display: none;
}
.admin-content.visible {
  display: block;
}

/* ========== UTILITIES ========== */
.tiny { font-size: 12px; }
.muted { color: var(--fg-muted); }
.danger { color: var(--danger); }
.text-center { text-align: center; }
.mt-sm { margin-top: 8px; }
.mt-md { margin-top: 16px; }
.mb-sm { margin-bottom: 8px; }
.mb-md { margin-bottom: 16px; }
.hidden { display: none !important; }

/* Gap between button rows */
.btn-row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 16px;
}

/* ========== DOCS SECTION ========== */
.docs-content {
  font-size: 15px;
  line-height: 1.7;
}
.docs-content strong {
  color: var(--fg);
  display: block;
  margin-top: 16px;
  margin-bottom: 6px;
}
.docs-content strong:first-child { margin-top: 0; }
.docs-content p {
  margin-bottom: 12px;
}
.docs-content .mono {
  background: var(--bg-input);
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 13px;
}

/* ========== MOBILE OPTIMIZATIONS ========== */
@media (max-width: 640px) {
  header { padding: 12px 16px; }
  .header-inner { gap: 8px; }
  .brand { font-size: 1.2rem; gap: 8px; }
  main { padding: 16px 12px 60px; }
  .card { padding: 18px 16px; }
  .card h3 { font-size: 1.1rem; }
  .btn { padding: 10px 18px; font-size: 14px; }
  .btn.large { padding: 14px 24px; font-size: 15px; }
  .row > div { flex: 1 1 100%; }
  .row > div.narrow { flex: 1 1 100%; }
  .row > div.action { width: 100%; }
  .btn-row { flex-direction: column; }
  .btn-row .btn { width: 100%; }
  .login-card { padding: 24px 20px; }
  .login-card h2 { font-size: 1.5rem; }
  .welcome-banner h1 { font-size: 1.5rem; }
  .route-card { padding: 18px 16px; }
  .route-card .route-icon { width: 56px; height: 56px; }
}

/* Touch-friendly tap targets */
@media (max-width: 768px) {
  input, select, textarea {
    font-size: 16px;
    min-height: 48px;
  }
  .btn { min-height: 48px; }
}

/* ========== ANIMATIONS ========== */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.card {
  animation: fadeIn 0.4s ease;
}
@keyframes pulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(90,129,255,0.4); }
  50% { box-shadow: 0 0 0 8px rgba(90,129,255,0); }
}
.card.highlight {
  animation: fadeIn 0.4s ease, pulse 2s ease-in-out 3;
}

/* ========== FOOTER ========== */
/* Plan gate card */
#plan-gate {
  margin-bottom: 18px;
}
#plan-gate .desc {
  max-width: 540px;
}

.console-footer {
  text-align: center;
  padding: 24px;
  font-size: 13px;
  color: var(--fg-muted);
  border-top: 1px solid var(--border);
  margin-top: 40px;
}
.console-footer a {
  color: var(--brand);
}
  </style>
</head>
<body>

<header>
  <div class="header-inner">
    <a href="https://www.domainsafepro.com" class="brand">
      <span class="brand-text">DomainSafePro</span>
      <span class="header-tag">Setup and manage your email protection</span>
    </a>
    <div class="auth-bar" id="auth-bar">
      <span id="auth-status-label">Not signed in</span>
      <span id="auth-plan-label" class="tiny muted"></span>
      <button class="btn secondary btn-sm btn-auth" id="auth-login-btn" type="button">Sign in with Google</button>
      <button class="theme-toggle" type="button" onclick="toggleTheme()" aria-label="Toggle theme">
        <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
      </button>
    </div>
  </div>
</header>

<!-- Loading state (shown initially while checking auth) -->
<section id="loading-section">
  <div class="loading-card">
    <div class="loading-spinner"></div>
    <h2>Loading...</h2>
    <p>Checking your authentication status</p>
  </div>
</section>

<!-- Login hero (shown when not signed in) -->
<section id="login-section">
  <div class="login-card">
    <div class="eyebrow">DomainSafePro</div>
    <h2>Welcome Back</h2>
    <p>Sign in with your Google account to set up protection for your domain and manage your email security.</p>
    <button class="btn" type="button" id="login-hero-btn">Sign in with Google</button>
    <div class="tiny">You will be redirected back here after signing in.</div>
  </div>
</section>

<!-- Main app (hidden until authed) -->
<main id="app-main">

  <div id="plan-gate" class="card highlight hidden">
    <h3><span class="card-icon">üîí</span> Activate Your DomainSafePro Plan</h3>
    <p class="desc">You are signed in as <span id="plan-gate-email" class="mono"></span>, but do not yet have an active DomainSafePro subscription connected to this account.</p>
    <p class="tiny muted mt-sm">Choose a plan to unlock automatic setup (Cloudflare, Route 53) and domain monitoring. Once your purchase is complete, return here with the same Google account to connect your domain.</p>
    <div class="row mt-sm">
      <div class="action">
        <a class="btn" href="https://www.domainsafepro.com/#pricing">View plans on main site</a>
      </div>
    </div>
  </div>


  <!-- Welcome banner -->
  <div class="welcome-banner">
    <h1>Where Is Your DNS Hosted?</h1>
    <p>Your domain's DNS is managed by one provider. Select yours below to get started.</p>
  </div>

  <!-- ROUTE SELECTION -->
  <section class="grid three" id="route-selection">
    <div class="route-card" data-route="cloudflare" onclick="selectRoute('cloudflare')">
      <div class="route-icon">
        <img src="https://res.cloudinary.com/dxwuwbmjd/image/upload/v1764174230/cloudflare_transparent_cci2hq.png" alt=""/>
      </div>
      <h4>Cloudflare</h4>
      <p>I manage my DNS through Cloudflare.</p>
      <span class="route-tag auto">Automatic Setup</span>
    </div>
    <div class="route-card" data-route="route53" onclick="selectRoute('route53')">
      <div class="route-icon">
        <img src="https://res.cloudinary.com/dxwuwbmjd/image/upload/v1764174236/ChatGPT_Image_Nov_26_2025_09_03_47_PM_yjbzqf.png" alt=""/>
      </div>
      <h4>AWS Route 53</h4>
      <p>I manage my DNS through AWS.</p>
      <span class="route-tag auto">Automatic Setup</span>
    </div>
    <div class="route-card" data-route="manual" onclick="selectRoute('manual')">
      <div class="route-icon">
        <img src="https://res.cloudinary.com/dxwuwbmjd/image/upload/v1764176078/ChatGPT_Image_Nov_26_2025_10_24_10_PM_xcgbrm.png" alt=""/>
      </div>
      <h4>Other Provider</h4>
      <p>GoDaddy, Namecheap, Google Domains, or another registrar.</p>
      <span class="route-tag manual">Copy-Paste Setup</span>
    </div>
  </section>

  <!-- ========== CLOUDFLARE SETUP FLOW ========== -->
  <div id="setup-cloudflare" class="setup-section">
    <div class="back-nav">
      <button class="btn-back" onclick="selectRoute(null)">‚Üê Back</button>
    </div>

    <section class="grid full">
      <div class="card highlight">
        <h3>
          <span class="card-icon">
            <img src="https://res.cloudinary.com/dxwuwbmjd/image/upload/v1764174230/cloudflare_transparent_cci2hq.png" alt="" style="width:28px;height:28px;object-fit:contain;"/>
          </span>
          Connect Your Cloudflare Account
        </h3>
        <p class="desc">Paste your Cloudflare API token below and we will automatically configure all your email security records. You need a token with "Zone Read" and "DNS Edit" permissions.</p>
        
        <div class="row">
          <div>
            <label for="cf-token">Cloudflare API Token</label>
            <input id="cf-token" class="mono" type="password" placeholder="Paste your API token here" autocomplete="off"/>
          </div>
          <div class="action">
            <button class="btn secondary" id="btnCfList">Load My Domains</button>
          </div>
        </div>
        
        <div class="row">
          <div>
            <label for="cf-zones">Select your domain</label>
            <select id="cf-zones"><option value="">First, load your domains above</option></select>
          </div>
          <div class="action">
            <button class="btn large" id="btnCfProtect">Protect This Domain</button>
          </div>
        </div>
        
        <pre class="log mt-md" id="cf-log">Paste your API token and click "Load My Domains" to get started.</pre>

        <details class="mt-md">
          <summary>How do I get a Cloudflare API token?</summary>
          <div class="docs-content">
            <p>1. Log in to your Cloudflare dashboard</p>
            <p>2. Go to "My Profile" (top right) then "API Tokens"</p>
            <p>3. Click "Create Token"</p>
            <p>4. Use the "Edit zone DNS" template</p>
            <p>5. Under "Zone Resources", select the zones you want to protect</p>
            <p>6. Click "Continue to summary" then "Create Token"</p>
            <p>7. Copy the token and paste it above</p>
          </div>
        </details>
      </div>
    </section>
  </div>

  <!-- ========== ROUTE 53 SETUP FLOW ========== -->
  <div id="setup-route53" class="setup-section">
    <div class="back-nav">
      <button class="btn-back" onclick="selectRoute(null)">‚Üê Back</button>
    </div>

    <section class="grid full">
      <div class="card highlight">
        <h3>
          <span class="card-icon">
            <img src="https://res.cloudinary.com/dxwuwbmjd/image/upload/v1764174236/ChatGPT_Image_Nov_26_2025_09_03_47_PM_yjbzqf.png" alt="" style="width:28px;height:28px;object-fit:contain;"/>
          </span>
          Connect Your AWS Account
        </h3>
        <p class="desc">Enter your AWS IAM credentials below and we will automatically configure all your email security records. You need an IAM user with Route 53 access.</p>
        
        <div class="row">
          <div>
            <label for="r53-ak">Access Key ID</label>
            <input id="r53-ak" class="mono" placeholder="AKIA..." autocomplete="off"/>
          </div>
          <div>
            <label for="r53-sk">Secret Access Key</label>
            <input id="r53-sk" class="mono" type="password" placeholder="Your secret key" autocomplete="off"/>
          </div>
        </div>
        
        <div class="row">
          <div>
            <label for="r53-zones">Select your hosted zone</label>
            <select id="r53-zones"><option value="">Enter credentials to load zones</option></select>
          </div>
          <div class="action">
            <button class="btn large" id="btnR53Protect">Protect This Domain</button>
          </div>
        </div>
        
        <pre class="log mt-md" id="r53-log">Enter your AWS credentials. Zones will load automatically.</pre>

        <details class="mt-md">
          <summary>How do I get AWS IAM credentials?</summary>
          <div class="docs-content">
            <p>1. Log in to your AWS Console</p>
            <p>2. Go to IAM (Identity and Access Management)</p>
            <p>3. Create a new user or use an existing one</p>
            <p>4. Attach the "AmazonRoute53FullAccess" policy</p>
            <p>5. Go to "Security credentials" and create an access key</p>
            <p>6. Copy both the Access Key ID and Secret Access Key</p>
          </div>
        </details>
      </div>
    </section>
  </div>

  <!-- ========== MANUAL DNS SETUP FLOW ========== -->
  <div id="setup-manual" class="setup-section">
    <div class="back-nav">
      <button class="btn-back" onclick="selectRoute(null)">‚Üê Back</button>
    </div>

    <!-- STEP 1: GET YOUR CODES -->
    <section class="grid full">
      <div class="card highlight">
        <h3><span class="card-icon">üìã</span> Step 1: Get Your DNS Records</h3>
        <p class="desc">Enter your domain below and we will generate the DNS records you need. Then copy each record and add it at your domain registrar.</p>
        
        <div class="row">
          <div>
            <label for="qc-domain">Your domain name</label>
            <input id="qc-domain" class="mono" placeholder="yourdomain.com" autocapitalize="off" autocorrect="off" spellcheck="false"/>
            <div class="notice hidden" id="qc-notice"></div>
          </div>
          <div class="action">
            <button class="btn large" id="btnQCodes">Generate My Records</button>
          </div>
        </div>
        
        <div class="checkbox-row">
          <input type="checkbox" id="qc-extras"/>
          <label for="qc-extras" style="margin:0">Include advanced security records (MTA-STS and TLS reporting)</label>
        </div>

        <div id="qc-results" class="hidden"></div>
        
        <div id="qc-actions" class="btn-row hidden">
          <button class="btn secondary btn-sm" id="btnCopyAll">Copy All as Text</button>
        </div>
      </div>
    </section>

    <!-- STEP 2: Instructions -->
    <section class="grid full">
      <div class="card">
        <h3><span class="card-icon">üìù</span> Step 2: Add Records to Your DNS</h3>
        <p class="desc">Log in to your domain registrar and add each record from Step 1. Here is what to look for:</p>
        
        <div class="docs-content">
          <strong>Where to add these records</strong>
          <p>Go to your domain registrar (the company where you bought your domain) and find the DNS settings. Common places include: "DNS Management", "DNS Records", or "Zone Editor".</p>
          
          <strong>Adding TXT records</strong>
          <p>For TXT records, create a new record with the "Host" (or "Name") and "Value" exactly as shown. The Host field is usually just the prefix like <code>_dmarc</code>, not the full domain.</p>
          
          <strong>Adding CNAME records</strong>
          <p>For CNAME records, the "Points to" or "Value" field should be the target address we provide. Some registrars add your domain automatically, so just enter the prefix.</p>
          
          <strong>When will it work?</strong>
          <p>DNS changes can take a few minutes to a few hours to spread across the internet. If verification fails at first, wait 15 minutes and try again.</p>
        </div>
      </div>
    </section>
  </div>

  <!-- ========== VERIFY SETUP (Always visible after route selected) ========== -->
  <div id="verify-section" class="setup-section">
    <section class="grid full">
      <div class="card highlight">
        <h3><span class="card-icon">‚úÖ</span> Verify Your Setup</h3>
        <p class="desc">Check if your domain's email protection is configured correctly. We will test each record and tell you if anything needs attention.</p>
        
        <div class="row">
          <div>
            <label for="verify-domain">Domain to verify</label>
            <input id="verify-domain" class="mono" placeholder="yourdomain.com" autocapitalize="off" autocorrect="off" spellcheck="false"/>
            <div class="notice hidden" id="verify-notice"></div>
          </div>
          <div class="action">
            <button class="btn large" id="btnVerify">Verify My Setup</button>
          </div>
        </div>
        
        <div id="verify-results" class="verify-results hidden"></div>
        
        <details class="hidden" id="verify-details">
          <summary>View technical details</summary>
          <div>
            <pre id="verify-log" class="log tiny">Waiting for verification...</pre>
          </div>
        </details>
      </div>
    </section>
  </div>

  <!-- HELP SECTION (Always visible) -->
  <section class="grid full" id="help-section">
    <div class="card">
      <h3><span class="card-icon">üí°</span> Need Help?</h3>
      <div class="docs-content">
        <strong>Not sure which DNS provider you use?</strong>
        <p>Your DNS is typically managed by whoever you registered your domain with (like GoDaddy, Namecheap), or by a service you pointed your nameservers to (like Cloudflare or AWS). Check your domain registrar's settings if unsure.</p>
        
        <strong>Already protected but showing errors?</strong>
        <p>If you set up protection through Cloudflare or Route 53 but verification shows issues, wait a few minutes for DNS to propagate and try again.</p>
      </div>
    </div>
  </section>

  <!-- ========== DMARC INSIGHTS (User-visible for active plans) ========== -->
  <div class="insights-section" id="insights-section">
    <section class="grid full">
      <div class="card">
        <h3><span class="card-icon">üìä</span> DMARC Insights</h3>
        <p class="desc">See who is sending email as your domain and whether they are passing authentication. This data comes from DMARC aggregate reports.</p>
        
        <div class="row">
          <div>
            <label for="ins-domain">Domain to analyze</label>
            <input id="ins-domain" class="mono" placeholder="yourdomain.com" autocapitalize="off"/>
          </div>
          <div class="action">
            <button class="btn secondary btn-sm" id="btnLoad7">Last 7 Days</button>
          </div>
          <div class="action">
            <button class="btn secondary btn-sm" id="btnLoad30">Last 30 Days</button>
          </div>
        </div>
        
        <div id="ins-summary" class="mt-md tiny muted">Enter a domain and select a time range to view insights.</div>
        
        <div class="table-wrap">
          <table id="ins-table" style="display:none">
            <thead>
              <tr>
                <th>Date</th>
                <th>Total Emails</th>
                <th>Aligned</th>
                <th>Aligned %</th>
                <th style="min-width:140px">Trend</th>
              </tr>
            </thead>
            <tbody id="ins-rows"></tbody>
          </table>
        </div>
        
        <details class="mt-md">
          <summary>View raw data</summary>
          <div>
            <pre id="ins-wrap" class="log tiny">‚Äî</pre>
          </div>
        </details>
      </div>
    </section>
  </div>

  <!-- ============================================================ -->
  <!-- ADMIN / OWNER SECTION (Collapsible) -->
  <!-- ============================================================ -->
  <div class="admin-section" id="admin-section">
    <div class="admin-header">
      <h2><span>üîß</span> Admin Tools</h2>
      <div class="admin-toggle" id="admin-toggle" onclick="toggleAdmin()">
        <span id="admin-toggle-text">Show admin tools</span>
        <span id="admin-toggle-icon">‚ñº</span>
      </div>
    </div>

    <div class="admin-content" id="admin-content">

      <!-- DOMAIN STATUS -->
      <div class="section-title"><span class="icon">üìä</span> Connected Domains</div>
      <section class="grid full">
        <div class="card">
          <h3>Domain Health Dashboard</h3>
          <p class="desc">All domains under your account with their current protection status. The robot checks these automatically every day.</p>
          <div class="btn-row">
            <button class="btn btn-sm" id="btnStatus">Refresh Status</button>
            <button class="btn btn-sm secondary" id="btnMonitor">Run Check Now</button>
          </div>
          <div class="mt-md table-wrap">
            <table id="statusTable">
              <thead>
                <tr>
                  <th>Domain</th>
                  <th>Owner</th>
                  <th>SPF</th>
                  <th>DMARC</th>
                  <th>DKIM s1</th>
                  <th>DKIM s2</th>
                  <th>Checked</th>
                </tr>
              </thead>
              <tbody id="statusRows">
                <tr><td colspan="7" class="muted">Loading domain status...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ADD DOMAIN -->
      <div class="section-title"><span class="icon">‚ûï</span> Register Domain</div>
      <section class="grid full">
        <div class="card">
          <h3>Add Domain to Monitoring</h3>
          <p class="desc">Register a new domain with the robot. We will start tracking its email security status automatically.</p>
          <div class="row">
            <div>
              <label for="add-email">Contact email for this domain</label>
              <input id="add-email" class="mono" placeholder="owner@example.com" type="email"/>
            </div>
            <div>
              <label for="add-domain">Domain name</label>
              <input id="add-domain" class="mono" placeholder="example.com" autocapitalize="off"/>
              <div class="notice hidden" id="add-notice"></div>
            </div>
          </div>
          <div class="btn-row">
            <button class="btn" id="btnAdd">Add Domain</button>
          </div>
          <pre class="log mt-md" id="add-log">Enter domain details above.</pre>

          <details class="mt-md">
            <summary>View registered domains</summary>
            <div id="recentWrap" class="tiny muted">Loading...</div>
          </details>
        </div>
      </section>

      <!-- DMARC POLICY STEP-UP -->
      <div class="section-title"><span class="icon">üìà</span> DMARC Policy Step-Up</div>
      <section class="grid full">
        <div class="card">
          <h3>Adjust DMARC Policy</h3>
          <p class="desc">Progress from monitoring (<code>p=none</code>) to quarantine to full rejection. Start safe, then tighten as alignment improves.</p>
          
          <div class="row">
            <div>
              <label for="pol-domain">Domain</label>
              <input id="pol-domain" class="mono" placeholder="example.com"/>
            </div>
            <div class="narrow">
              <label for="pol-policy">Policy</label>
              <select id="pol-policy">
                <option value="none">none (monitor)</option>
                <option value="quarantine">quarantine</option>
                <option value="reject">reject</option>
              </select>
            </div>
            <div class="narrow">
              <label for="pol-pct">Percentage</label>
              <input id="pol-pct" type="number" min="1" max="100" value="100"/>
            </div>
          </div>
          
          <div class="row">
            <div class="narrow">
              <label for="pol-adkim">DKIM Alignment</label>
              <select id="pol-adkim">
                <option value="r">relaxed (r)</option>
                <option value="s">strict (s)</option>
              </select>
            </div>
            <div class="narrow">
              <label for="pol-aspf">SPF Alignment</label>
              <select id="pol-aspf">
                <option value="r">relaxed (r)</option>
                <option value="s">strict (s)</option>
              </select>
            </div>
            <div>
              <label for="pol-rua">Report URI (rua)</label>
              <input id="pol-rua" class="mono" value="mailto:dmarc@domainsafepro.com"/>
            </div>
          </div>
          
          <div class="row">
            <div class="narrow">
              <label for="pol-fo">Failure Options (fo)</label>
              <input id="pol-fo" value="1"/>
            </div>
            <div>
              <label for="pol-sp">Subdomain Policy (sp, optional)</label>
              <input id="pol-sp" placeholder="leave blank to inherit"/>
            </div>
          </div>
          
          <div class="btn-row">
            <button class="btn secondary btn-sm" id="btnPolPreview">Preview Policy</button>
            <button class="btn btn-sm" id="btnApplyCf">Apply via Cloudflare</button>
            <button class="btn btn-sm" id="btnApplyR53">Apply via Route 53</button>
            <button class="btn secondary btn-sm" id="btnEvaluateNow">Evaluate Engine</button>
          </div>
          
          <pre class="log mt-md" id="pol-out">Use Preview to see the generated DMARC record, then Apply via your DNS provider.</pre>
        </div>
      </section>

      <!-- CONTROL SPF BUILDER -->
      <div class="section-title"><span class="icon">üõ†Ô∏è</span> Control SPF (Central Include)</div>
      <section class="grid full">
        <div class="card">
          <h3>SPF Sender Builder</h3>
          <p class="desc">Select authorized email senders and update <code>_spf.control.domainsafepro.com</code>. All protected domains inherit this central include automatically.</p>
          
          <div class="spf-checkboxes">
            <label><input type="checkbox" class="spf-sel" value="google"/> Google Workspace</label>
            <label><input type="checkbox" class="spf-sel" value="m365"/> Microsoft 365</label>
            <label><input type="checkbox" class="spf-sel" value="sendgrid"/> SendGrid</label>
            <label><input type="checkbox" class="spf-sel" value="ses"/> Amazon SES</label>
            <label><input type="checkbox" class="spf-sel" value="mailgun"/> Mailgun</label>
            <label><input type="checkbox" class="spf-sel" value="mailchimp"/> Mailchimp</label>
            <label><input type="checkbox" class="spf-sel" value="postmark"/> Postmark</label>
            <label><input type="checkbox" class="spf-sel" value="sparkpost"/> SparkPost</label>
            <label><input type="checkbox" class="spf-sel" value="zoho"/> Zoho</label>
            <label><input type="checkbox" class="spf-sel" value="zendesk"/> Zendesk</label>
            <label><input type="checkbox" class="spf-sel" value="intercom"/> Intercom</label>
          </div>
          
          <div class="row">
            <div>
              <label for="spf-preview">Generated SPF Record</label>
              <input id="spf-preview" class="mono" value="v=spf1 ~all" readonly/>
            </div>
          </div>
          
          <div class="row">
            <div>
              <label for="spf-token">Cloudflare API Token (for domainsafepro.com zone)</label>
              <input id="spf-token" class="mono" type="password" placeholder="Paste token here"/>
            </div>
          </div>
          
          <div class="btn-row">
            <button class="btn secondary btn-sm" id="btnSpfLoad2">Load Current</button>
            <button class="btn btn-sm" id="btnSpfUpdate2">Update Control SPF</button>
          </div>
          
          <pre class="log mt-md" id="spf-log2">Select senders above, then click "Update Control SPF" to apply.</pre>
        </div>
      </section>

      <!-- INGEST REPORTS -->
      <div class="section-title"><span class="icon">üì•</span> Report Ingestion</div>
      <section class="grid full">
        <div class="card">
          <h3>DMARC Report Pipeline</h3>
          <p class="desc">DMARC aggregate reports are processed automatically. The Robot's <code>/ingest/daily</code> endpoint receives parsed data from the ingestion pipeline.</p>
          
          <div class="docs-content">
            <strong>How it works</strong>
            <p>Email providers (Google, Microsoft, etc.) send DMARC aggregate reports to the <code>rua</code> address. A background job parses these XMLs and pushes daily summaries to the Robot, which stores them in the <code>dmarc_daily</code> table.</p>
            
            <strong>Manual ingestion</strong>
            <p>To manually push data, send a POST to <code>/ingest/daily</code> with the <code>x-ingest-key</code> header:</p>
          </div>
          
          <pre class="log mt-md" id="ingest-log">{
  "domain": "example.com",
  "date": "2025-01-15",
  "total": 1234,
  "aligned": 1200,
  "spf_aligned": 1180,
  "dkim_aligned": 1195
}</pre>
          
          <div class="btn-row">
            <button class="btn btn-sm secondary" id="btnIngestTest">Test /ingest/daily Endpoint</button>
          </div>
        </div>
      </section>

      <!-- ALERTS -->
      <div class="section-title"><span class="icon">üîî</span> Alerts</div>
      <section class="grid full">
        <div class="card">
          <h3>Slack Notifications</h3>
          <p class="desc">Test the alert system and flush any queued notifications.</p>
          
          <div class="btn-row">
            <button class="btn btn-sm" id="btnAlertTest">Send Test Alert</button>
            <button class="btn secondary btn-sm" id="btnAlertFlush">Flush Alert Queue</button>
          </div>
          
          <pre class="log mt-md" id="alerts-out">‚Äî</pre>
        </div>
      </section>

      <!-- API DEBUG -->
      <div class="section-title"><span class="icon">üîç</span> API Diagnostics</div>
      <section class="grid full">
        <div class="card">
          <h3>Test API Endpoints</h3>
          <p class="desc">Check which endpoints are reachable. This helps diagnose "Failed to fetch" errors.</p>
          
          <div class="btn-row">
            <button class="btn btn-sm secondary" id="btnTestAll">Test All Endpoints</button>
          </div>
          
          <pre class="log mt-md" id="debug-log">Click "Test All Endpoints" to check API connectivity.</pre>
        </div>
      </section>

    </div><!-- /admin-content -->
  </div><!-- /admin-section -->

  <footer class="console-footer">
    <a href="https://domainsafepro.com" target="_blank">DomainSafePro</a> | Email Authentication on Autopilot
  </footer>

</main>

<script>
/* ====== Theme Toggle ====== */
function toggleTheme() {
  var html = document.documentElement;
  var current = html.getAttribute('data-theme');
  var next = current === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  try { localStorage.setItem('dsp-theme', next); } catch(e){}
}
(function(){
  try {
    var saved = localStorage.getItem('dsp-theme');
    if (saved) document.documentElement.setAttribute('data-theme', saved);
  } catch(e){}
})();

/* ====== Admin Toggle ====== */
function toggleAdmin() {
  var content = document.getElementById('admin-content');
  var text = document.getElementById('admin-toggle-text');
  var icon = document.getElementById('admin-toggle-icon');
  if (content.classList.contains('visible')) {
    content.classList.remove('visible');
    text.textContent = 'Show admin tools';
    icon.textContent = '‚ñº';
  } else {
    content.classList.add('visible');
    text.textContent = 'Hide admin tools';
    icon.textContent = '‚ñ≤';
  }
}

/* ====== Route Selection ====== */
var currentRoute = null;

function selectRoute(route) {
  currentRoute = route;
  
  // Update card selection states
  var cards = document.querySelectorAll('.route-card');
  cards.forEach(function(card) {
    if (card.getAttribute('data-route') === route) {
      card.classList.add('selected');
    } else {
      card.classList.remove('selected');
    }
  });
  
  // Show/hide appropriate sections
  var cfSection = document.getElementById('setup-cloudflare');
  var r53Section = document.getElementById('setup-route53');
  var manualSection = document.getElementById('setup-manual');
  var verifySection = document.getElementById('verify-section');
  var routeSelection = document.getElementById('route-selection');
  var helpSection = document.getElementById('help-section');
  
  // Reset all
  cfSection.classList.remove('active');
  r53Section.classList.remove('active');
  manualSection.classList.remove('active');
  verifySection.classList.remove('active');
  
  if (route === null) {
    // Show route selection, hide everything else
    routeSelection.style.display = '';
    helpSection.style.display = '';
    return;
  }
  
  // Hide route selection once a route is chosen
  routeSelection.style.display = 'none';
  
  if (route === 'cloudflare') {
    cfSection.classList.add('active');
    verifySection.classList.add('active');
  } else if (route === 'route53') {
    r53Section.classList.add('active');
    verifySection.classList.add('active');
  } else if (route === 'manual') {
    manualSection.classList.add('active');
    verifySection.classList.add('active');
  }
}

/* ====== Real endpoints ====== */
var ROBOT_API = "https://domainsafe-robot.pankajonlinerepository.workers.dev";
var DMARC_API = "https://api.domainsafepro.com";
var AUTH_API  = "https://domainsafe-robot.pankajonlinerepository.workers.dev";

/* ====== Tiny helpers ====== */
var $ = function(sel) { return document.querySelector(sel); };
var $$ = function(sel) { return document.querySelectorAll(sel); };
var logEl = function(sel, v) { 
  var el = $(sel); 
  if (!el) return; 
  el.textContent = (typeof v === "string") ? v : JSON.stringify(v, null, 2); 
};
var copy = function(txt) { 
  if (navigator.clipboard) return navigator.clipboard.writeText(txt).catch(function(){}); 
  return Promise.resolve();
};
var show = function(el) { if (el) el.classList.remove('hidden'); };
var hide = function(el) { if (el) el.classList.add('hidden'); };

function sanitizeDomain(raw){
  return (raw||"").trim().toLowerCase()
    .replace(/^https?:\/\//,"")
    .replace(/^mailto:/,"")
    .replace(/\/.*$/,"")
    .replace(/\.$/,"");
}
function isValidHostname(raw){
  var s = sanitizeDomain(raw);
  if (!/^[a-z0-9.-]+\.[a-z]{2,}$/i.test(s)) return false;
  var labels = s.split(".");
  return labels.every(function(lbl) { return lbl.length>0 && lbl.length<=63 && /^[a-z0-9-]+$/i.test(lbl); });
}
function isDomain(s){ return /^[a-z0-9.-]+\.[a-z]{2,}$/i.test(s||""); }
function apexify(raw){
  var s = sanitizeDomain(raw);
  if (!isDomain(s)) return s;
  var parts = s.split(".").filter(Boolean);
  if (parts.length <= 2) return s;
  var cc2 = ["co.uk","com.au","co.in","co.jp","com.br","com.mx","com.sg","com.hk"];
  var tail2 = parts.slice(-2).join(".");
  var tail3 = parts.slice(-3).join(".");
  return cc2.indexOf(tail2) >= 0 ? tail3 : tail2;
}
function normalizeForUI(raw, noticeEl, errorEl, opts){
  var options = opts || {};
  var typed = sanitizeDomain(raw);
  if (!isValidHostname(typed)){
    if (errorEl){
      errorEl.textContent = "Please enter a valid domain name (like yourdomain.com)";
      show(errorEl);
    }
    if (noticeEl) hide(noticeEl);
    return { ok:false, value:typed, apex:"", changed:false };
  }
  if (errorEl) hide(errorEl);
  var apex = apexify(typed);
  var value = apex, changed = false;
  if (options.allowExact){
    value = typed;
  } else if (typed !== apex){
    changed = true;
  }
  if (noticeEl){
    if (changed){
      noticeEl.innerHTML = 'We will protect the root domain <span class="mono">'+apex+'</span> to cover all subdomains.';
      show(noticeEl);
    } else {
      hide(noticeEl);
    }
  }
  return { ok:true, value:value, apex:apex, changed:changed, typed:typed };
}

/* ====== HTTP helpers ====== */
async function get(url){
  var r = await fetch(url, {
    method:"GET",
    credentials:"include",
    headers:{ "accept":"application/json" }
  });
  var t = await r.text();
  var j = null;
  try{ j = t ? JSON.parse(t) : null; }catch(e){}
  if (!r.ok){
    var msg = (j && j.error) ? j.error : t || ("HTTP "+r.status);
    throw new Error(msg);
  }
  return j;
}
async function post(url, body){
  var r = await fetch(url, {
    method:"POST",
    credentials:"include",
    headers:{ "content-type":"application/json", "accept":"application/json" },
    body: JSON.stringify(body || {})
  });
  var t = await r.text();
  var j = null;
  try{ j = t ? JSON.parse(t) : null; }catch(e){}
  if (!r.ok){
    var msg = (j && j.error) ? j.error : t || ("HTTP "+r.status);
    throw new Error(msg);
  }
  return j;
}

/* ====== AUTH (Google sign-in) ====== */
async function fetchCurrentUser(){
  try{
    var r = await fetch(AUTH_API + "/api/me", {
      method:"GET",
      credentials:"include",
      headers:{ "accept":"application/json" }
    });
    var t = await r.text();
    var j = null;
    try{ j = t ? JSON.parse(t) : null; }catch(e){ return null; }
    if (!r.ok || !j || j.ok === false || !j.user || !j.user.email) return null;
    return j.user;
  }catch(e){
    return null;
  }
}

function startGoogleLogin(){
  window.location.href = AUTH_API + "/auth/google/start";
}

function applyPlanGate(user){
  var gate = $("#plan-gate");
  var gateEmail = $("#plan-gate-email");
  var welcomeBanner = $(".welcome-banner");
  var routeSelection = $("#route-selection");
  var cfSetup = $("#setup-cloudflare");
  var r53Setup = $("#setup-route53");
  var manualSetup = $("#setup-manual");
  var helpSection = $("#help-section");
  var insightsSection = $("#insights-section");
  var adminSection = document.getElementById("admin-section");

  var email = user && user.email ? String(user.email) : "";
  var plan = user && user.plan ? user.plan : null;
  var lower = email.toLowerCase();
  var isAdminFront = (lower === "pankajonlinerepository@gmail.com" || lower === "ops@domainsafepro.com");
  var hasActivePlan = !!(plan && plan.status === "active");

  if (gateEmail && email){
    gateEmail.textContent = email;
  }

  // Sections visible to users with active plans (or admins)
  var userSections = [welcomeBanner, routeSelection, cfSetup, r53Setup, manualSetup, helpSection, insightsSection];

  if (hasActivePlan || isAdminFront) {
    if (gate) gate.classList.add("hidden");
    userSections.forEach(function(el){ if (el) el.classList.remove("hidden"); });
  } else {
    if (gate) gate.classList.remove("hidden");
    userSections.forEach(function(el){ if (el) el.classList.add("hidden"); });
  }

  // Admin section only visible for admin users
  if (isAdminFront && adminSection) {
    adminSection.classList.remove("hidden");
  } else if (adminSection) {
    adminSection.classList.add("hidden");
  }
}

function showAuthedUI(user){
  document.body.classList.remove("logged-out");
  document.body.classList.add("authed");
  var label = $("#auth-status-label");
  var planLabel = $("#auth-plan-label");
  var loginBtn = $("#auth-login-btn");
  if (label && user && user.email){
    label.textContent = user.email;
  }
  if (planLabel){
    if (user && user.plan && user.plan.code){
      var plan = user.plan;
      var parts = [];
      parts.push("Plan: " + String(plan.code));
      if (typeof plan.domains_used === "number" && (plan.max_domains === null || typeof plan.max_domains === "number")){
        var used = plan.domains_used;
        var max = plan.max_domains;
        if (max === null){
          parts.push("Domains: " + used + "+");
        } else {
          parts.push("Domains: " + used + "/" + max);
        }
      }
      if (plan.valid_until){
        parts.push("Until: " + String(plan.valid_until).slice(0,10));
      }
      planLabel.textContent = parts.join(" ¬∑ ");
      planLabel.classList.remove("hidden");
    } else {
      planLabel.textContent = "";
      planLabel.classList.add("hidden");
    }
  }
  if (loginBtn) {
    loginBtn.textContent = "Sign out";
    loginBtn.onclick = function() {
      // Redirect to Robot's logout endpoint which clears the session cookie and redirects to landing page
      window.location.href = "https://domainsafe-robot.pankajonlinerepository.workers.dev/auth/logout";
    };
  }
  applyPlanGate(user);
  var statusRows = $("#statusRows");
  if (statusRows){
    statusRows.innerHTML = '<tr><td colspan="7" class="muted">Loading...</td></tr>';
  }
  var addEmail = $("#add-email");
  if (addEmail && user && user.email){
    addEmail.value = user.email;
  }
  loadStatus();
  refreshRecent();
}

function showLoggedOutUI(){
  document.body.classList.remove("authed");
  document.body.classList.add("logged-out");
  var label = $("#auth-status-label");
  var planLabel = $("#auth-plan-label");
  var loginBtn = $("#auth-login-btn");
  if (label) label.textContent = "Not signed in";
  if (planLabel){
    planLabel.textContent = "";
    planLabel.classList.add("hidden");
  }
  if (loginBtn) {
    loginBtn.textContent = "Sign in with Google";
    loginBtn.onclick = startGoogleLogin;
  }
  var statusRows = $("#statusRows");
  if (statusRows){
    statusRows.innerHTML = '<tr><td colspan="7" class="muted">Sign in to see your connected domains.</td></tr>';
  }
  var recent = $("#recentWrap");
  if (recent) recent.textContent = "Sign in to see your domains.";
  var addEmail = $("#add-email");
  if (addEmail) addEmail.value = "";
  var addLog = $("#add-log");
  if (addLog) addLog.textContent = "Enter domain details above.";
}

async function initAuth(){
  var btnHeader = $("#auth-login-btn");
  var btnHero   = $("#login-hero-btn");
  if (btnHeader) btnHeader.addEventListener("click", startGoogleLogin);
  if (btnHero)   btnHero.addEventListener("click", startGoogleLogin);

  // Show loading state initially (already shown by default)
  // Now fetch user
  var user = await fetchCurrentUser();
  
  // Hide loading and show appropriate UI
  if (user) {
    showAuthedUI(user);
  } else {
    showLoggedOutUI();
  }
}

/* ====== STATUS & MONITOR ====== */
function pill(ok){
  return ok
    ? '<span class="pill ok">OK</span>'
    : '<span class="pill bad">Needs setup</span>';
}

async function loadStatus(){
  var tb = $("#statusRows");
  if (!tb) return;
  tb.innerHTML = '<tr><td colspan="7" class="muted">Loading...</td></tr>';
  try{
    var j = await get(ROBOT_API + "/api/status");
    var rows = (j && j.rows) ? j.rows : [];
    if (!rows.length){
      tb.innerHTML = '<tr><td colspan="7" class="muted">No domains registered yet. Add your first domain above.</td></tr>';
      return;
    }
    tb.innerHTML = rows.map(function(r) {
      return '<tr>' +
        '<td data-label="Domain" class="mono">'+(r.domain_name||"")+'</td>' +
        '<td data-label="Owner" class="mono tiny">'+(r.email||"")+'</td>' +
        '<td data-label="SPF">'+pill(r.spf_ok)+'</td>' +
        '<td data-label="DMARC">'+pill(r.dmarc_ok)+'</td>' +
        '<td data-label="DKIM s1">'+pill(r.dkim_s1_ok)+'</td>' +
        '<td data-label="DKIM s2">'+pill(r.dkim_s2_ok)+'</td>' +
        '<td data-label="Checked" class="tiny muted">'+(r.checked_at||"")+'</td>' +
      '</tr>';
    }).join("");
  }catch(e){
    tb.innerHTML = '<tr><td colspan="7" class="tiny danger">Could not load status. Please try again.</td></tr>';
  }
}
$("#btnStatus").addEventListener("click", loadStatus);
$("#btnMonitor").addEventListener("click", async function(){
  try{ await post(ROBOT_API + "/api/monitor-run", {}); }catch(e){}
  loadStatus();
});

/* ====== QUICK-CODES (Customer-facing) ====== */
function renderQuickCodes(records, extras) {
  var container = $("#qc-results");
  if (!records || records.length === 0) {
    container.innerHTML = '<p class="muted">No records to display.</p>';
    show(container);
    return;
  }

  function getPurpose(name) {
    if (name.indexOf('_domainkey') >= 0) {
      return name.indexOf('s1') === 0 ? 'Email Signature Key 1 (DKIM)' : 'Email Signature Key 2 (DKIM)';
    }
    if (name === '_dmarc' || name.indexOf('_dmarc.') === 0) return 'Email Policy (DMARC)';
    if (name === '@' || name === '') return 'Email Sender Authorization (SPF)';
    if (name === '_smtp._tls') return 'Transport Security Reporting';
    if (name === 'mta-sts') return 'Mail Transfer Security';
    return 'DNS Record';
  }

  function escapeHtml(str) {
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function createCard(r) {
    var typeClass = r.type.toLowerCase() === 'txt' ? 'txt' : 'cname';
    var purpose = getPurpose(r.name);
    var displayName = r.name === '@' ? '@ (root domain)' : escapeHtml(r.name);
    var escapedName = escapeHtml(r.name);
    var escapedValue = escapeHtml(r.value);
    
    return '<div class="qc-card">' +
      '<div class="qc-card-header">' +
        '<span class="qc-type ' + typeClass + '">' + escapeHtml(r.type) + '</span>' +
        '<span class="qc-purpose">' + purpose + '</span>' +
      '</div>' +
      '<div class="qc-field">' +
        '<div class="qc-label">Host / Name</div>' +
        '<div class="qc-value">' +
          '<code>' + displayName + '</code>' +
          '<button class="copy-btn" data-copy="' + escapedName + '">Copy</button>' +
        '</div>' +
      '</div>' +
      '<div class="qc-field">' +
        '<div class="qc-label">Value / Points To</div>' +
        '<div class="qc-value">' +
          '<code>' + escapedValue + '</code>' +
          '<button class="copy-btn" data-copy="' + escapedValue + '">Copy</button>' +
        '</div>' +
      '</div>' +
    '</div>';
  }

  var html = '<div class="qc-cards">';
  records.forEach(function(r) { html += createCard(r); });
  if (extras && extras.length > 0) {
    html += '<div class="mt-md mb-sm"><strong class="tiny muted">ADVANCED SECURITY (OPTIONAL)</strong></div>';
    extras.forEach(function(r) { html += createCard(r); });
  }
  html += '</div>';

  container.innerHTML = html;
  show(container);
  show($("#qc-actions"));
  
  // Add click handlers for copy buttons
  container.querySelectorAll('.copy-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var text = this.getAttribute('data-copy');
      var button = this;
      copy(text).then(function() {
        button.textContent = 'Copied!';
        button.classList.add('copied');
        setTimeout(function() {
          button.textContent = 'Copy';
          button.classList.remove('copied');
        }, 2000);
      });
    });
  });
}

$("#btnQCodes").addEventListener("click", async function(){
  var norm = normalizeForUI($("#qc-domain").value, $("#qc-notice"), null);
  if (!norm.ok){
    hide($("#qc-results"));
    hide($("#qc-actions"));
    return;
  }
  try{
    var extras = ($("#qc-extras").checked ? "&extras=1" : "");
    var j = await get(ROBOT_API + "/api/quick-codes?domain=" + encodeURIComponent(norm.apex || norm.value) + extras);
    renderQuickCodes(j.records || [], j.extras || []);
    
    $("#verify-domain").value = norm.apex || norm.value;
  }catch(e){
    $("#qc-results").innerHTML = '<p class="danger">Could not generate records: ' + String(e).slice(0,100) + '</p>';
    show($("#qc-results"));
  }
});

$("#btnCopyAll").addEventListener("click", function(){
  var cards = $$("#qc-results .qc-card");
  if (!cards.length) return;
  
  var text = "";
  cards.forEach(function(card) {
    var typeEl = card.querySelector('.qc-type');
    var codeEls = card.querySelectorAll('.qc-value code');
    var type = typeEl ? typeEl.textContent : '';
    var name = codeEls[0] ? codeEls[0].textContent : '';
    var value = codeEls[1] ? codeEls[1].textContent : '';
    text += type + "\t" + name + "\t" + value + "\n";
  });
  
  copy(text).then(function() {
    var btn = $("#btnCopyAll");
    var oldText = btn.textContent;
    btn.textContent = "Copied to clipboard!";
    setTimeout(function() { btn.textContent = oldText; }, 2000);
  });
});

/* ====== VERIFY (Human-readable output) - FIXED to match API response ====== */
function renderVerifyResults(data) {
  var container = $("#verify-results");
  var detailsEl = $("#verify-details");
  
  var checks = data.checks || {};
  var items = [];
  
  // SPF check - API returns "includesControl" (camelCase), not "includes_control"
  var spfPresent = checks.spf && checks.spf.present;
  var spfIncludesControl = checks.spf && (checks.spf.includesControl || checks.spf.includes_control);
  var spfOk = spfPresent && spfIncludesControl;
  
  items.push({
    label: 'SPF (Sender Authorization)',
    pass: spfOk,
    status: spfOk 
      ? 'Your SPF record is configured correctly and includes our central control.'
      : spfPresent
        ? 'SPF record found, but it does not include our central control yet.'
        : 'No SPF record found. Add the TXT record from Step 1.'
  });
  
  // DKIM check - API returns "s1.ok" and "s2.ok", not "s1.present" and "s1.points_to_control"
  var dkimS1Ok = checks.dkim && checks.dkim.s1 && checks.dkim.s1.ok;
  var dkimS2Ok = checks.dkim && checks.dkim.s2 && checks.dkim.s2.ok;
  var dkimOk = dkimS1Ok || dkimS2Ok;
  var dkimBothOk = dkimS1Ok && dkimS2Ok;
  
  items.push({
    label: 'DKIM (Email Signatures)',
    pass: dkimOk,
    status: dkimBothOk
      ? 'Both DKIM keys (s1 and s2) are configured correctly.'
      : dkimOk
        ? 'One DKIM key is configured. Consider adding both s1 and s2 for redundancy.'
        : 'No DKIM records found. Add the CNAME records from Step 1.'
  });
  
  // DMARC check - This one was correct
  var dmarcOk = checks.dmarc && checks.dmarc.present;
  items.push({
    label: 'DMARC (Email Policy)',
    pass: dmarcOk,
    status: dmarcOk
      ? 'Your DMARC policy is active. Policy: ' + (checks.dmarc.policy || 'none')
      : 'No DMARC record found. Add the TXT record from Step 1.'
  });
  
  var allPass = items.every(function(i) { return i.pass; });
  var passCount = items.filter(function(i) { return i.pass; }).length;
  
  var summaryHtml = '';
  if (allPass) {
    summaryHtml = '<div class="verify-summary all-pass">' +
      '<span class="verify-summary-icon">üéâ</span>' +
      '<div class="verify-summary-text">' +
        '<h4>Your domain is protected!</h4>' +
        '<p>All email authentication records are configured correctly.</p>' +
      '</div>' +
    '</div>';
  } else {
    summaryHtml = '<div class="verify-summary has-issues">' +
      '<span class="verify-summary-icon">‚ö†Ô∏è</span>' +
      '<div class="verify-summary-text">' +
        '<h4>' + passCount + ' of ' + items.length + ' checks passed</h4>' +
        '<p>Some records still need to be added. See details below.</p>' +
      '</div>' +
    '</div>';
  }
  
  var itemsHtml = items.map(function(item) {
    return '<div class="verify-item">' +
      '<div class="verify-icon ' + (item.pass ? 'pass' : 'fail') + '">' + (item.pass ? '‚úì' : '‚úó') + '</div>' +
      '<div class="verify-content">' +
        '<div class="verify-label">' + item.label + '</div>' +
        '<div class="verify-status ' + (item.pass ? 'pass' : 'fail') + '">' + item.status + '</div>' +
      '</div>' +
    '</div>';
  }).join('');
  
  container.innerHTML = summaryHtml + itemsHtml;
  show(container);
  
  logEl("#verify-log", data);
  show(detailsEl);
}

$("#btnVerify").addEventListener("click", async function(){
  var norm = normalizeForUI($("#verify-domain").value, $("#verify-notice"), null);
  if (!norm.ok){
    hide($("#verify-results"));
    hide($("#verify-details"));
    return;
  }
  
  $("#verify-results").innerHTML = '<div class="verify-summary has-issues"><span class="verify-summary-icon">‚è≥</span><div class="verify-summary-text"><h4>Checking your domain...</h4><p>This may take a few seconds while we query DNS servers.</p></div></div>';
  show($("#verify-results"));
  
  try{
    var j = await get(ROBOT_API + "/api/check-quick-codes?domain=" + encodeURIComponent(norm.apex || norm.value));
    renderVerifyResults(j);
  }catch(e){
    $("#verify-results").innerHTML = '<div class="verify-summary has-issues"><span class="verify-summary-icon">‚ùå</span><div class="verify-summary-text"><h4>Could not verify domain</h4><p>' + String(e).slice(0,150) + '</p></div></div>';
    show($("#verify-results"));
  }
});

/* ====== ADD DOMAIN + RECENT ====== */
async function refreshRecent(){
  var wrap = $("#recentWrap");
  if (!wrap) return;
  try{
    var j = await get(ROBOT_API + "/api/domains");
    var rows = (j && (j.domains || j.rows)) ? (j.domains || j.rows) : [];
    if (!rows.length){
      wrap.textContent = "No domains registered yet.";
      return;
    }
    wrap.innerHTML = rows.slice(0,10).map(function(r) {
      return '<div class="mono" style="margin-bottom:6px">'+(r.domain_name || "")+' <span class="muted">| '+(r.status || "")+(r.created_at ? " | "+r.created_at : "")+'</span></div>';
    }).join("");
  }catch(e){
    wrap.textContent = "Could not load domains.";
  }
}

$("#btnAdd").addEventListener("click", async function(){
  var noticeEl = $("#add-notice");
  var norm = normalizeForUI($("#add-domain").value, noticeEl, null);
  var email = ($("#add-email").value || "").trim();
  if (!email || !norm.ok){
    $("#add-log").textContent = "Please enter a valid email and domain name.";
    return;
  }
  try{
    if (noticeEl) hide(noticeEl);
    var j = await post(ROBOT_API + "/api/domains", {
      email: email,
      domain: norm.apex || norm.value
    });
    logEl("#add-log", j);
    refreshRecent();
  }catch(e){
    var msg = String(e);
    logEl("#add-log", "Error: " + msg);
    if (noticeEl){
      noticeEl.textContent = msg;
      show(noticeEl);
    }
  }
});

/* ====== CLOUDFLARE ====== */
$("#btnCfList").addEventListener("click", async function(){
  var token = ($("#cf-token").value || "").trim();
  if (!token){
    logEl("#cf-log","Please paste your Cloudflare API token first.");
    return;
  }
  try{
    var j = await post(ROBOT_API + "/api/cf/list-zones", { token: token });
    var sel = $("#cf-zones");
    sel.innerHTML = '<option value="">Select your domain</option>';
    (j.zones || []).forEach(function(z) {
      var o = document.createElement("option");
      o.value = z.id;
      o.textContent = z.name + " (" + (z.status || "") + ")";
      sel.appendChild(o);
    });
    logEl("#cf-log","Loaded " + (j.zones || []).length + " zones. Select your domain above.");
  }catch(e){
    logEl("#cf-log", String(e));
  }
});

$("#btnCfProtect").addEventListener("click", async function(){
  var token = ($("#cf-token").value || "").trim();
  var zone_id = $("#cf-zones").value;
  if (!token || !zone_id){
    logEl("#cf-log","Please load zones and select a domain first.");
    return;
  }
  try{
    var j = await post(ROBOT_API + "/api/cf/protect", { token: token, zone_id: zone_id });
    logEl("#cf-log", j);
    if (j.apex) {
      $("#verify-domain").value = j.apex;
      $("#pol-domain").value = j.apex;
      $("#ins-domain").value = j.apex;
    }
  }catch(e){
    logEl("#cf-log", String(e));
  }
});

/* ====== ROUTE 53 ====== */
async function r53ListZonesIfReady(){
  var access_key_id = ($("#r53-ak").value || "").trim();
  var secret_access_key = ($("#r53-sk").value || "").trim();
  if (!access_key_id || !secret_access_key) return;
  try{
    var j = await post(ROBOT_API + "/api/r53/list-zones", { access_key_id: access_key_id, secret_access_key: secret_access_key });
    var sel = $("#r53-zones");
    sel.innerHTML = '<option value="">Select your hosted zone</option>';
    (j.zones || []).forEach(function(z) {
      var o = document.createElement("option");
      o.value = z.id;
      o.textContent = z.name + " (" + z.id + ")";
      sel.appendChild(o);
    });
    logEl("#r53-log","Loaded " + (j.zones || []).length + " hosted zones.");
  }catch(e){
    logEl("#r53-log", String(e));
  }
}
$("#r53-ak").addEventListener("change", r53ListZonesIfReady);
$("#r53-sk").addEventListener("change", r53ListZonesIfReady);

$("#btnR53Protect").addEventListener("click", async function(){
  var access_key_id = ($("#r53-ak").value || "").trim();
  var secret_access_key = ($("#r53-sk").value || "").trim();
  var hosted_zone_id = $("#r53-zones").value;
  if (!access_key_id || !secret_access_key || !hosted_zone_id){
    logEl("#r53-log","Please enter credentials and select a hosted zone.");
    return;
  }
  try{
    var j = await post(ROBOT_API + "/api/r53/protect", { access_key_id: access_key_id, secret_access_key: secret_access_key, hosted_zone_id: hosted_zone_id });
    logEl("#r53-log", j);
    if (j.apex) {
      $("#verify-domain").value = j.apex;
      $("#pol-domain").value = j.apex;
      $("#ins-domain").value = j.apex;
    }
  }catch(e){
    logEl("#r53-log", String(e));
  }
});

/* ====== DMARC INSIGHTS (Rollup) ====== */
function fmt(n){ return (n||0).toLocaleString(); }
function pct(a,b){ var r = (b>0) ? (a/b) : 0; return Math.round(r*1000)/10; }
function asArray(series){ 
  if (Array.isArray(series)) return series; 
  if (series && typeof series==='object'){ 
    return Object.keys(series).sort().map(function(d) { 
      return Object.assign({date:d}, series[d]); 
    }); 
  } 
  return []; 
}

function renderRollup(j){
  var rows = asArray(j.series);
  var table = $('#ins-table'); 
  var body = $('#ins-rows'); 
  var summary = $('#ins-summary');
  
  if (!rows.length){ 
    table.style.display='none'; 
    summary.textContent='No data yet for this domain and time range. DMARC reports may take 24-48 hours to arrive.'; 
    return; 
  }
  
  var T = rows.reduce(function(acc,r){ 
    acc.total += r.total||0; 
    acc.aligned += r.aligned||0; 
    return acc; 
  }, {total:0,aligned:0});
  
  var rate = pct(T.aligned, T.total);
  summary.innerHTML = '<div class="ins-summary-stat"><strong>' + j.domain + '</strong></div>' +
    '<div class="ins-summary-stat">' + j.days + '-day totals</div>' +
    '<div class="ins-summary-stat"><strong>' + fmt(T.total) + '</strong> emails</div>' +
    '<div class="ins-summary-stat"><strong>' + fmt(T.aligned) + '</strong> aligned (' + rate + '%)</div>';
  
  body.innerHTML = '';
  rows.forEach(function(r){
    var p = pct(r.aligned||0, r.total||0);
    var tr = document.createElement('tr');
    tr.innerHTML = 
      '<td data-label="Date" class="mono">' + r.date + '</td>' +
      '<td data-label="Total">' + fmt(r.total||0) + '</td>' +
      '<td data-label="Aligned">' + fmt(r.aligned||0) + '</td>' +
      '<td data-label="Aligned %">' + p + '%</td>' +
      '<td data-label="Trend">' +
        '<div class="ins-bar"><i style="width:' + Math.min(100,p) + '%"></i></div>' +
        (r.spf_aligned!=null && r.dkim_aligned!=null ? '<div class="ins-stats">SPF ' + fmt(r.spf_aligned) + ' ¬∑ DKIM ' + fmt(r.dkim_aligned) + '</div>' : '') +
      '</td>';
    body.appendChild(tr);
  });
  table.style.display = '';
}

async function loadRoll(days){
  var norm = normalizeForUI($('#ins-domain').value, null, null);
  if(!norm.ok){ 
    $('#ins-summary').textContent = 'Please enter a valid domain name first.'; 
    return; 
  }
  $('#ins-summary').textContent = 'Loading ' + days + '-day insights...';
  $('#ins-table').style.display = 'none';
  try{
    var url = ROBOT_API + '/api/rollup?domain=' + encodeURIComponent(norm.apex || norm.value) + '&days=' + days;
    var j = await get(url);
    $('#ins-wrap').textContent = JSON.stringify(j, null, 2);
    
    // Check if we got data
    var series = asArray(j.series);
    if (series.length === 0) {
      var msg = 'No DMARC data found for ' + (norm.apex || norm.value) + ' in the last ' + days + ' days.\n\n';
      msg += 'Possible reasons:\n';
      msg += '‚Ä¢ DMARC reports may take 24-48 hours to arrive after setup\n';
      msg += '‚Ä¢ No emails were sent from this domain in this period\n';
      msg += '‚Ä¢ Reports haven\'t been ingested yet (Admin: try "Ingest Latest 25 Reports")\n';
      if (days === 7) {
        msg += '‚Ä¢ Try "Last 30 Days" - you may have older data available';
      }
      $('#ins-summary').innerHTML = '<span style="white-space:pre-wrap">' + msg + '</span>';
      return;
    }
    
    renderRollup({domain: j.domain || (norm.apex || norm.value), days: days, series: j.series || []});
  }catch(e){ 
    var errMsg = String(e);
    if (errMsg.indexOf('Failed to fetch') >= 0) {
      errMsg = 'Network error: Could not reach the API. Check console for details.';
    }
    $('#ins-summary').textContent = 'Error loading ' + days + '-day data: ' + errMsg;
    $('#ins-wrap').textContent = String(e); 
  }
}

$('#btnLoad7').addEventListener('click', function(){ loadRoll(7); });
$('#btnLoad30').addEventListener('click', function(){ loadRoll(30); });

/* ====== DMARC POLICY STEP-UP ====== */
$('#btnPolPreview').addEventListener('click', async function(){
  var d = ($('#pol-domain').value || '').trim();
  if(!d){ logEl('#pol-out','Enter a domain first.'); return; }
  try{
    var j = await get(ROBOT_API + '/policy/preview?domain=' + encodeURIComponent(d));
    logEl('#pol-out', j);
  }catch(e){ logEl('#pol-out', String(e)); }
});

$('#btnApplyCf').addEventListener('click', async function(){
  var body = {
    domain: ($('#pol-domain').value || '').trim(),
    policy: $('#pol-policy').value,
    pct: Number($('#pol-pct').value||100),
    adkim: $('#pol-adkim').value,
    aspf:  $('#pol-aspf').value,
    rua:   ($('#pol-rua').value || '').trim(),
    fo:    ($('#pol-fo').value || '').trim(),
    sp:    ($('#pol-sp').value || '').trim() || null
  };
  if(!body.domain){ logEl('#pol-out','Enter a domain first.'); return; }
  try{ 
    var j = await post(ROBOT_API + '/api/policy/dmarc/cf', body); 
    logEl('#pol-out', j); 
  }catch(e){ logEl('#pol-out', String(e)); }
});

$('#btnApplyR53').addEventListener('click', async function(){
  var body = {
    domain: ($('#pol-domain').value || '').trim(),
    policy: $('#pol-policy').value,
    pct: Number($('#pol-pct').value||100),
    adkim: $('#pol-adkim').value,
    aspf:  $('#pol-aspf').value,
    rua:   ($('#pol-rua').value || '').trim(),
    fo:    ($('#pol-fo').value || '').trim(),
    sp:    ($('#pol-sp').value || '').trim() || null,
    hosted_zone_id: ($('#r53-zones').value || '').trim()
  };
  if(!body.domain){ logEl('#pol-out','Enter a domain first.'); return; }
  if(!body.hosted_zone_id){ logEl('#pol-out','Pick a Route 53 hosted zone first (in the setup section above).'); return; }
  try{ 
    var j = await post(ROBOT_API + '/api/policy/dmarc/r53', body); 
    logEl('#pol-out', j); 
  }catch(e){ logEl('#pol-out', String(e)); }
});

$('#btnEvaluateNow').addEventListener('click', async function(){
  try{ 
    var j = await get(ROBOT_API + '/policy/evaluate-now'); 
    logEl('#pol-out', j); 
  }catch(e){ logEl('#pol-out', String(e)); }
});

/* ====== CONTROL SPF BUILDER ====== */
var SPF_MAP = {
  google:'include:_spf.google.com', 
  m365:'include:spf.protection.outlook.com', 
  sendgrid:'include:sendgrid.net',
  ses:'include:amazonses.com', 
  mailgun:'include:mailgun.org', 
  mailchimp:'include:servers.mcsv.net',
  postmark:'include:spf.mtasv.net', 
  sparkpost:'include:_spf.sparkpostmail.com', 
  zoho:'include:zoho.com',
  zendesk:'include:mail.zendesk.com', 
  intercom:'include:_spf.intercom.io'
};

function updateSpfPreview(){
  var sels = [];
  document.querySelectorAll('.spf-sel:checked').forEach(function(x) {
    if (SPF_MAP[x.value]) sels.push(SPF_MAP[x.value]);
  });
  var txt = ['v=spf1'].concat(sels).concat(['~all']).join(' ');
  $('#spf-preview').value = txt;
}

document.querySelectorAll('.spf-sel').forEach(function(cb) { 
  cb.addEventListener('change', updateSpfPreview); 
});
updateSpfPreview();

$('#btnSpfLoad2').addEventListener('click', async function(){
  var tok = ($('#spf-token').value || '').trim();
  if(!tok){ logEl('#spf-log2','Paste a Cloudflare API token first.'); return; }
  try{ 
    var j = await get(ROBOT_API + '/api/cf/control-spf?token=' + encodeURIComponent(tok)); 
    if (j.value) $('#spf-preview').value = j.value; 
    logEl('#spf-log2', j); 
  }catch(e){ logEl('#spf-log2', String(e)); }
});

$('#btnSpfUpdate2').addEventListener('click', async function(){
  var tok = ($('#spf-token').value || '').trim();
  var val = ($('#spf-preview').value || '').trim();
  if(!tok){ logEl('#spf-log2','Paste a Cloudflare API token first.'); return; }
  try{ 
    var j = await post(ROBOT_API + '/api/cf/control-spf', { token: tok, value: val }); 
    logEl('#spf-log2', j); 
  }catch(e){ logEl('#spf-log2', String(e)); }
});

/* ====== INGEST REPORTS ====== */
$('#btnIngestTest').addEventListener('click', async function(){
  logEl('#ingest-log', 'Testing /ingest/daily endpoint (auth required)...');
  try{
    // This will return 401 without the key, but proves the endpoint exists
    var r = await fetch(ROBOT_API + '/ingest/daily', {
      method: 'POST',
      credentials: 'include',
      headers: { 'content-type': 'application/json', 'accept': 'application/json' },
      body: JSON.stringify({ domain: 'test.com', date: '2025-01-01', total: 0, aligned: 0 })
    });
    var t = await r.text();
    var j = null;
    try { j = JSON.parse(t); } catch(e) {}
    
    if (r.status === 401) {
      logEl('#ingest-log', '‚úÖ Endpoint exists and is protected (401 Unauthorized - correct behavior without x-ingest-key)\n\nTo use this endpoint, send POST with:\n- Header: x-ingest-key: <your-key>\n- Body: { domain, date, total, aligned, spf_aligned, dkim_aligned }');
    } else if (r.ok) {
      logEl('#ingest-log', '‚úÖ Endpoint working:\n' + JSON.stringify(j, null, 2));
    } else {
      logEl('#ingest-log', '‚ö†Ô∏è Endpoint returned ' + r.status + ':\n' + (j ? JSON.stringify(j, null, 2) : t));
    }
  } catch(e) {
    logEl('#ingest-log', '‚ùå Failed to reach endpoint: ' + String(e) + '\n\nThis may be a CORS or network issue.');
  }
});

/* ====== ALERTS ====== */
$('#btnAlertTest').addEventListener('click', async function(){
  try{
    var j = await post(ROBOT_API + '/alerts/test', {domain:'domainsafepro.com', title:'Test alert', message:'This is a test from DomainSafePro Console.'});
    logEl('#alerts-out', j);
  }catch(e){ logEl('#alerts-out', String(e)); }
});

$('#btnAlertFlush').addEventListener('click', async function(){
  try{
    var j = await post(ROBOT_API + '/alerts/flush', {});
    logEl('#alerts-out', j);
  }catch(e){ logEl('#alerts-out', String(e)); }
});

/* ====== API DIAGNOSTICS ====== */
$('#btnTestAll').addEventListener('click', async function(){
  var log = $('#debug-log');
  var results = [];
  
  results.push('=== API Endpoint Diagnostics ===');
  results.push('ROBOT_API: ' + ROBOT_API);
  results.push('DMARC_API: ' + DMARC_API);
  results.push('');
  
  async function testEndpoint(name, url, method){
    var start = Date.now();
    try{
      var opts = { method: method || 'GET', credentials: 'include', headers: { 'accept': 'application/json' } };
      if (method === 'POST') {
        opts.headers['content-type'] = 'application/json';
        opts.body = '{}';
      }
      var r = await fetch(url, opts);
      var elapsed = Date.now() - start;
      var status = r.status + ' ' + r.statusText;
      if (r.ok) {
        return '‚úÖ ' + name + ': ' + status + ' (' + elapsed + 'ms)';
      } else {
        var body = '';
        try { body = await r.text(); body = body.slice(0,100); } catch(e){}
        return '‚ö†Ô∏è ' + name + ': ' + status + ' (' + elapsed + 'ms) - ' + body;
      }
    } catch(e) {
      return '‚ùå ' + name + ': ' + String(e).slice(0,80);
    }
  }
  
  log.textContent = 'Testing endpoints...\n';
  
  // Test core ROBOT_API endpoints
  results.push(await testEndpoint('/api/me', ROBOT_API + '/api/me', 'GET'));
  results.push(await testEndpoint('/api/status', ROBOT_API + '/api/status', 'GET'));
  results.push(await testEndpoint('/api/domains', ROBOT_API + '/api/domains', 'GET'));
  results.push(await testEndpoint('/api/rollup (7d)', ROBOT_API + '/api/rollup?domain=domainsafepro.com&days=7', 'GET'));
  results.push(await testEndpoint('/api/rollup (30d)', ROBOT_API + '/api/rollup?domain=domainsafepro.com&days=30', 'GET'));
  results.push(await testEndpoint('/policy/preview', ROBOT_API + '/policy/preview?domain=domainsafepro.com', 'GET'));
  results.push(await testEndpoint('/policy/evaluate-now', ROBOT_API + '/policy/evaluate-now', 'GET'));
  results.push(await testEndpoint('/alerts/test', ROBOT_API + '/alerts/test', 'POST'));
  
  results.push('');
  results.push('--- Ingest Endpoint ---');
  results.push(await testEndpoint('/ingest/daily (auth required)', ROBOT_API + '/ingest/daily', 'POST'));
  
  results.push('');
  results.push('=== Done ===');
  results.push('');
  results.push('Legend:');
  results.push('‚úÖ = Working');
  results.push('‚ö†Ô∏è = Reachable but returned error (401 = auth required, which is correct)');
  results.push('‚ùå = Failed to fetch (CORS/network/not deployed)');
  results.push('');
  results.push('Note: DMARC_API (api.domainsafepro.com) is reserved for future use.');
  
  log.textContent = results.join('\n');
});

/* ====== Bootstrap ====== */
initAuth();
</script>
</body>
</html>
