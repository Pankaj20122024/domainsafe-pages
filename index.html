<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DomainSafe — Status • Quick‑Codes • Step‑Up</title>
  <style>
    :root{
      --bg:#0f1221; --fg:#e8ebff; --muted:#a7b1e6; --card:#14183a; --line:#2a3470;
      --ok:#3ddc97; --warn:#ffcc66; --bad:#ff6b6b; --btn:#3142d0; --btn2:#1f2a7a;
      --mono:#0f1533;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
      background:var(--bg); color:var(--fg); line-height:1.45;
    }
    header{padding:28px 20px 8px; border-bottom:1px solid var(--line)}
    header h1{margin:0 0 6px 0; font-size:22px}
    header .tag{color:var(--muted); font-size:13px}
    main{max-width:1100px; margin:0 auto; padding:24px 16px 48px}
    .grid{display:grid; grid-template-columns:1fr; gap:16px}
    @media(min-width:980px){ .grid{grid-template-columns:1fr 1fr} }
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:12px; padding:16px;
    }
    .card h3{margin:0 0 8px 0; font-size:18px}
    .desc{color:var(--muted); font-size:13px; margin:0 0 10px 0}
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    input,select,textarea{
      width:100%; padding:10px 12px; background:#0f1533; border:1px solid var(--line); color:var(--fg);
      border-radius:8px; outline:none;
    }
    textarea{min-height:100px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > div{flex:1 1 200px}
    .btn{
      appearance:none; border:1px solid var(--btn); background:var(--btn);
      color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600;
    }
    .btn.secondary{background:var(--btn2); border-color:var(--btn2)}
    .btn.ghost{background:transparent; color:var(--fg); border-color:var(--line)}
    .btn:disabled{opacity:0.6; cursor:not-allowed}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .log{white-space:pre-wrap; font-family:ui-monospace, Menlo, Monaco, Consolas, monospace;
         background:var(--mono); border:1px solid var(--line); border-radius:8px; padding:10px; font-size:13px}
    table{width:100%; border-collapse:collapse; font-size:14px}
    th,td{border-bottom:1px solid var(--line); padding:8px 6px; text-align:left}
    th{color:var(--muted); font-weight:600}
    .pill{display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px}
    .ok{background:rgba(61,220,151,.15); color:var(--ok); border:1px solid rgba(61,220,151,.4)}
    .bad{background:rgba(255,107,107,.15); color:var(--bad); border:1px solid rgba(255,107,107,.35)}
    .warn{background:rgba(255,204,102,.12); color:var(--warn); border:1px solid rgba(255,204,102,.35)}
    .hint{font-size:12px; color:var(--muted)}
    .flex{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .spacer{height:6px}
    .danger{color:#ff9f9f}
    .success{color:#8be8bd}
    .muted{color:var(--muted)}
    .copybtn{margin-left:8px}
    .section-title{margin:24px 0 6px 0; font-size:16px; color:#cbd3ff}
    .tiny{font-size:12px}
  </style>
</head>
<body>
<header>
  <h1>DomainSafe is live ✅ <span class="muted">StepUp‑UI 2025‑10‑30</span></h1>
  <div class="tag">Status, Quick‑Codes, Verify, one‑click Connect, DMARC Policy Step‑Up, Control SPF, Insights. The robot keeps watch daily.</div>
</header>

<main>
  <!-- STATUS & QUICK CHECK -->
  <section class="grid">
    <div class="card">
      <h3>Domain Status (daily robot checks)</h3>
      <p class="desc">The robot monitors connected domains and records SPF / DMARC / DKIM health snapshots.</p>
      <div class="row">
        <button class="btn" id="btnRunMonitor">Refresh status</button>
        <button class="btn secondary" id="btnRunMonitorDev">Run now (dev)</button>
      </div>
      <div class="spacer"></div>
      <div id="statusTableWrap">
        <table id="statusTable">
          <thead>
            <tr><th>Domain</th><th>Owner</th><th>SPF</th><th>DMARC</th><th>DKIM s1</th><th>DKIM s2</th><th>Checked at</th></tr>
          </thead>
          <tbody id="statusRows"><tr><td colspan="7" class="muted">Loading…</td></tr></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3>“Check my domain” (instant protection check)</h3>
      <p class="desc">Quick, safe checker — no tokens. We only read public DNS and your robot’s status.</p>
      <div class="row">
        <div><label>Domain</label><input id="chk-domain" class="mono" placeholder="example.com"/></div>
        <div style="flex:0 0 180px; align-self:flex-end"><button class="btn" id="btnCheck">Check now</button></div>
      </div>
      <div class="spacer"></div>
      <pre class="log" id="chk-log">Enter a domain → Check now.</pre>
      <p class="hint tiny">We consult: Robot <code>/api/status</code>, Robot <code>/api/check-quick-codes</code>, and DoH TXT for <code>_dmarc</code>, <code>_smtp._tls</code>, and <code>mta-sts</code>.</p>
    </div>
  </section>

  <!-- ONBOARD / ADD DOMAIN -->
  <section class="grid">
    <div class="card">
      <h3>Add Domain</h3>
      <p class="desc">Register a domain with the robot (owner email only; no tokens here).</p>
      <div class="row">
        <div><label>Contact email</label><input id="add-email" class="mono" placeholder="you@example.com" value="pankajonlinerepository@gmail.com"/></div>
        <div><label>Domain</label><input id="add-domain" class="mono" placeholder="example.com"/></div>
      </div>
      <div class="spacer"></div>
      <button class="btn" id="btnAddDomain">Add domain</button>
      <div class="spacer"></div>
      <pre class="log" id="add-log">Waiting…</pre>

      <h4 class="section-title">Recent domains</h4>
      <div id="recentWrap" class="tiny muted">—</div>
    </div>

    <div class="card">
      <h3>Verify Records</h3>
      <p class="desc">Checks public DNS. Green means your domain is wired to central controls.</p>
      <div class="row">
        <div><label>Domain to check</label><input id="verify-domain" class="mono" placeholder="example.com"/></div>
        <div style="flex:0 0 160px; align-self:flex-end"><button class="btn" id="btnVerify">Check</button></div>
      </div>
      <div class="spacer"></div>
      <pre class="log" id="verify-log">Enter a domain → Check.</pre>
    </div>
  </section>

  <!-- QUICK CODES -->
  <section class="grid">
    <div class="card">
      <h3>Quick‑Codes (one‑time DNS)</h3>
      <p class="desc">Use if you don’t want to connect a provider account. Paste these at your DNS provider and you’re done.</p>
      <div class="row">
        <div><label>Domain to secure</label><input id="qc-domain" class="mono" placeholder="example.com"/></div>
        <div style="flex:0 0 160px; align-self:flex-end"><button class="btn" id="btnQCodes">Generate Quick‑Codes</button></div>
      </div>
      <div style="margin:8px 0">
        <label class="flex"><input type="checkbox" id="qc-extras"/> <span>Show optional extras (MTA‑STS &amp; TLS‑RPT)</span></label>
      </div>
      <div class="spacer"></div>
      <div id="qc-results" class="tiny muted">Enter a domain → Generate.</div>
      <div class="spacer"></div>
      <button class="btn ghost" id="btnCopyAll">Copy all</button>
    </div>

    <div class="card">
      <h3>Connect Cloudflare (one‑click Protect)</h3>
      <p class="desc">Paste a Cloudflare API Token (Zone:Read + DNS:Edit). Token is used only for this request.</p>
      <div class="row">
        <div><label>Cloudflare API Token</label><input id="cf-token" class="mono" type="password" placeholder="paste token here"/></div>
        <div style="flex:0 0 160px; align-self:flex-end"><button class="btn" id="btnCfList">List zones</button></div>
      </div>
      <div class="row">
        <div><label>Zone</label><select id="cf-zones"><option value="">— choose a zone —</option></select></div>
        <div style="flex:0 0 160px; align-self:flex-end"><button class="btn" id="btnCfProtect">Protect</button></div>
      </div>
      <div class="spacer"></div>
      <pre class="log tiny" id="cf-log">Paste token → List zones → choose zone → Protect.</pre>
      <p class="hint">Safety: “Protect” is for first‑time onboarding; it starts DMARC at <code>p=none</code>. Policy changes later should use **Step‑Up** below (or automation).</p>
    </div>
  </section>

  <!-- ROUTE 53 -->
  <section class="grid">
    <div class="card">
      <h3>Connect AWS Route 53 (one‑click Protect)</h3>
      <p class="desc">Paste an AWS Access Key ID + Secret (IAM user limited to Route 53). Keys are used only for this request.</p>
      <div class="row">
        <div><label>AWS Access Key ID</label><input id="r53-key" class="mono" placeholder="AKIA..."/></div>
        <div><label>AWS Secret Access Key</label><input id="r53-secret" class="mono" type="password" placeholder="********"/></div>
      </div>
      <div class="row">
        <div><label>Hosted zone</label><select id="r53-zones"><option value="">— choose a hosted zone —</option></select></div>
        <div style="flex:0 0 160px; align-self:flex-end"><button class="btn" id="btnR53Protect">Protect</button></div>
      </div>
      <div class="spacer"></div>
      <pre class="log tiny" id="r53-log">Paste keys → List hosted zones → choose one → Protect.</pre>
    </div>

    <div class="card">
      <h3>DMARC Policy Step‑Up (None → Quarantine → Reject)</h3>
      <p class="desc">Start safe in monitor (<code>p=none</code>), then raise to <code>quarantine</code> (percentage of mail), finally <code>reject</code>. We write TXT at <code>_dmarc.&lt;domain&gt;</code>.</p>
      <div class="row">
        <div style="flex:0 0 160px">
          <label>Mode</label>
          <select id="ps-policy">
            <option value="none">None (monitor)</option>
            <option value="quarantine">Quarantine</option>
            <option value="reject">Reject</option>
          </select>
        </div>
        <div style="flex:0 0 160px">
          <label>Aggregate reports (RUA)</label>
          <input id="ps-rua" class="mono" value="mailto:dmarc@domainsafepro.com"/>
          <div class="hint tiny">DMARC aggregate XMLs will be sent here (captured via Email Routing).</div>
        </div>
      </div>

      <div class="row" style="align-items:center">
        <div style="flex:0 0 140px">
          <label>Preview TXT (_dmarc)</label>
          <input id="ps-preview" class="mono" value="v=DMARC1; p=none; adkim=s; aspf=s; rua=mailto:dmarc@domainsafepro.com; pct=100" readonly/>
        </div>
        <div style="flex:1">
          <label>Target domain (apex)</label>
          <input id="ps-domain" class="mono" placeholder="example.com"/>
          <div class="hint tiny">Populated automatically from your selected Cloudflare / Route 53 zone.</div>
        </div>
      </div>

      <div class="row">
        <button class="btn" id="btnPsPreview">Preview</button>
        <button class="btn" id="btnPsApplyCf">Apply via Cloudflare (uses selected zone)</button>
        <button class="btn" id="btnPsApplyR53">Apply via Route 53 (uses selected hosted zone)</button>
      </div>
      <div class="spacer"></div>
      <pre class="log tiny" id="ps-log">Use Preview, then Apply via CF or R53. For “other DNS”, copy the TXT from Preview.</pre>
    </div>
  </section>

  <!-- CONTROL SPF -->
  <section class="grid">
    <div class="card">
      <h3>Control SPF (central include for all protected domains)</h3>
      <p class="desc">Choose senders and update <code>_spf.control.domainsafepro.com</code> once. All protected domains inherit it.</p>

      <div class="row">
        <div style="flex:1">
          <div class="flex">
            <label><input type="checkbox" class="spf-sel" value="google"/> Google Workspace</label>
            <label><input type="checkbox" class="spf-sel" value="m365"/> Microsoft 365</label>
            <label><input type="checkbox" class="spf-sel" value="sendgrid"/> SendGrid</label>
            <label><input type="checkbox" class="spf-sel" value="ses"/> Amazon SES</label>
            <label><input type="checkbox" class="spf-sel" value="mailgun"/> Mailgun</label>
            <label><input type="checkbox" class="spf-sel" value="mailchimp"/> Mailchimp</label>
            <label><input type="checkbox" class="spf-sel" value="postmark"/> Postmark</label>
            <label><input type="checkbox" class="spf-sel" value="sparkpost"/> SparkPost</label>
            <label><input type="checkbox" class="spf-sel" value="zoho"/> Zoho</label>
            <label><input type="checkbox" class="spf-sel" value="zendesk"/> Zendesk</label>
            <label><input type="checkbox" class="spf-sel" value="intercom"/> Intercom</label>
          </div>
        </div>
      </div>

      <div class="row">
        <div><label>Preview (TXT <span class="mono">_spf.control.domainsafepro.com</span>)</label>
          <input id="spf-preview" class="mono" value="v=spf1 ~all" readonly/>
        </div>
      </div>

      <div class="row">
        <div><label>Cloudflare API Token (Zone:Read + DNS:Edit on <span class="mono">domainsafepro.com</span>)</label>
          <input id="spf-token" class="mono" type="password" placeholder="paste token here"/>
        </div>
      </div>

      <div class="row">
        <button class="btn" id="btnSpfLoad">Load current</button>
        <button class="btn" id="btnSpfUpdate">Update control SPF</button>
      </div>

      <div class="spacer"></div>
      <pre class="log tiny" id="spf-log">Use “Load current” to see existing value, select senders, then “Update”.</pre>
    </div>

    <div class="card">
      <h3>DMARC Insights (beta)</h3>
      <p class="desc">Pull fresh aggregate XMLs and show daily alignment summaries (7/30 days).</p>
      <div class="row">
        <div style="flex:0 0 200px"><button class="btn" id="btnIngest">Ingest latest 20</button></div>
        <div style="flex:1">
          <label>Domain</label>
          <input id="ins-domain" class="mono" value="domainsafepro.com"/>
        </div>
        <div style="flex:0 0 140px; align-self:flex-end">
          <button class="btn secondary" id="btnLoad7">Load 7‑day</button>
        </div>
        <div style="flex:0 0 140px; align-self:flex-end">
          <button class="btn secondary" id="btnLoad30">Load 30‑day</button>
        </div>
      </div>
      <div class="spacer"></div>
      <div id="ins-wrap" class="tiny muted">—</div>
    </div>
  </section>

  <!-- DOCS -->
  <section class="card">
    <h3>Docs (short &amp; practical)</h3>
    <p class="desc">
      <strong>Option A — Quick‑Codes (copy‑paste at your DNS provider)</strong><br/>
      Enter your domain in Quick‑Codes → Generate. Copy each required row and paste at your DNS provider (TXT/CNAME records).  
      (Optional) tick “Show optional extras” and add those too. Go to Verify → Check → expect all green.
    </p>
    <p class="desc">
      <strong>Option B — Connect Cloudflare (one‑click)</strong><br/>
      Cloudflare → API Tokens → Create Token (Zone:Read + DNS:Edit). Paste token here → List zones → choose zone → Protect. Use Verify to confirm.
    </p>
    <p class="desc">
      <strong>Option C — Connect AWS Route 53 (one‑click)</strong><br/>
      AWS IAM → create user with Route 53 (first test). Create access key → paste here → List hosted zones → choose → Protect. Use Verify to confirm.
    </p>
    <p class="desc">
      <strong>What the robot sets</strong><br/>
      SPF TXT at apex: <span class="mono">v=spf1 include:_spf.control.domainsafepro.com ~all</span><br/>
      DKIM CNAMEs: <span class="mono">s1._domainkey</span> and <span class="mono">s2._domainkey</span> → central keys<br/>
      DMARC TXT at <span class="mono">_dmarc</span>: start in monitor mode (<span class="mono">p=none</span>)<br/>
      Extras (optional): <span class="mono">mta-sts</span> CNAME and <span class="mono">_smtp._tls</span> TXT for TLS reporting
    </p>
  </section>
</main>

<script>
(() => {
  // ---- Configuration (no placeholder; your robot base is fixed) ----
  const API_BASE = 'https://domainsafe-robot.pankajonlinerepository.workers.dev';

  // ---- Helpers ----
  const $ = sel => document.querySelector(sel);
  const log = (sel, v) => { $(sel).textContent = (typeof v === 'string') ? v : JSON.stringify(v, null, 2); };
  const copy = (txt) => navigator.clipboard.writeText(txt).catch(()=>{});
  const qs = (obj) => new URLSearchParams(obj).toString();
  const isDomain = (s) => /^[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?)+$/i.test(String(s||"").trim());

  async function getJSON(url){ const r = await fetch(url); if(!r.ok) throw new Error(await r.text()); return r.json(); }
  async function postJSON(url, body){
    const r = await fetch(url,{method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify(body)});
    if(!r.ok) throw new Error(await r.text()); return r.json();
  }

  // ---- Status table ----
  async function refreshStatus(){
    try{
      const s = await getJSON(`${API_BASE}/api/status`);
      const rows = s.rows || s.results || [];
      const tbody = $('#statusRows');
      tbody.innerHTML = '';
      if (!rows.length) { tbody.innerHTML = `<tr><td colspan="7" class="muted">No rows yet.</td></tr>`; return; }
      for (const r of rows){
        const ok = (x)=> x ? `<span class="pill ok">OK</span>` : `<span class="pill bad">Needs fix</span>`;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${r.domain || r.domain_name}</td>
          <td class="mono">${r.email || r.owner || ''}</td>
          <td>${ok(r.spf_ok)}</td>
          <td>${ok(r.dmarc_ok)}</td>
          <td>${ok(r.dkim_s1_ok)}</td>
          <td>${ok(r.dkim_s2_ok)}</td>
          <td class="mono">${r.checked_at || ''}</td>
        `;
        tbody.appendChild(tr);
      }
    }catch(e){ $('#statusRows').innerHTML = `<tr><td colspan="7" class="danger tiny">${e}</td></tr>`; }
  }
  $('#btnRunMonitor').addEventListener('click', async ()=>{
    try{ await postJSON(`${API_BASE}/api/monitor-run`,{}); await refreshStatus(); }catch(e){ alert(e); }
  });
  $('#btnRunMonitorDev').addEventListener('click', async ()=>{
    try{ await postJSON(`${API_BASE}/api/monitor-run`,{dev:true}); await refreshStatus(); }catch(e){ alert(e); }
  });
  refreshStatus();

  // ---- Add domain ----
  async function refreshRecent(){
    try{
      const s = await getJSON(`${API_BASE}/api/domains`);
      const rows = s.rows || s.domains || [];
      const html = rows.slice(0,10).map(r =>
        `<div class="mono">${r.domain_name} <span class="muted">— ${r.status} — ${r.created_at||''}</span></div>`
      ).join('');
      $('#recentWrap').innerHTML = html || '—';
    }catch{ /* ignore */ }
  }
  $('#btnAddDomain').addEventListener('click', async ()=>{
    const email = $('#add-email').value.trim();
    const domain = $('#add-domain').value.trim().toLowerCase();
    if(!email || !domain){ return log('#add-log','Please enter email and domain.'); }
    if(!isDomain(domain)) return log('#add-log','Please enter a valid domain (e.g., example.com).');
    try{
      const j = await postJSON(`${API_BASE}/api/domains`, {email, domain});
      log('#add-log', j);
      await refreshRecent();
    }catch(e){ log('#add-log', String(e)); }
  });
  refreshRecent();

  // ---- Verify records ----
  $('#btnVerify').addEventListener('click', async ()=>{
    const domain = $('#verify-domain').value.trim().toLowerCase();
    if(!domain) return log('#verify-log','Enter a domain.');
    if(!isDomain(domain)) return log('#verify-log','Enter a valid domain (e.g., example.com).');
    try{
      const j = await getJSON(`${API_BASE}/api/check-quick-codes?domain=${encodeURIComponent(domain)}`);
      log('#verify-log', j);
    }catch(e){ log('#verify-log', String(e)); }
  });

  // ---- Quick‑Codes ----
  $('#btnQCodes').addEventListener('click', async ()=>{
    const domain = $('#qc-domain').value.trim().toLowerCase();
    if(!domain) return $('#qc-results').textContent = 'Enter a domain.';
    if(!isDomain(domain)) return $('#qc-results').textContent = 'Enter a valid domain (e.g., example.com).';
    try{
      const j = await getJSON(`${API_BASE}/api/quick-codes?domain=${encodeURIComponent(domain)}${$('#qc-extras').checked?'&extras=1':''}`);
      const lines = [];
      (j.records||[]).forEach(r => lines.push(`${r.type}\t${r.name}\t${r.value}`));
      if ($('#qc-extras').checked) (j.extras||[]).forEach(r => lines.push(`${r.type}\t${r.name}\t${r.value}`));
      $('#qc-results').innerHTML = `<pre class="log">${lines.join('\n')||'—'}</pre>`;
    }catch(e){ $('#qc-results').textContent = String(e); }
  });
  $('#btnCopyAll').addEventListener('click', ()=>{
    const pre = $('#qc-results').querySelector('pre');
    if (pre) copy(pre.textContent);
  });

  // ---- Cloudflare connect ----
  async function cfListZones(){
    const token = $('#cf-token').value.trim();
    if(!token) return log('#cf-log','Paste your Cloudflare API token first.');
    try{
      const j = await postJSON(`${API_BASE}/api/cf/list-zones`, {token});
      const z = j.zones || [];
      const sel = $('#cf-zones'); sel.innerHTML = '<option value="">— choose a zone —</option>';
      z.forEach(r => {
        const o = document.createElement('option');
        o.value = r.id; o.textContent = `${r.name} (${r.status})`; sel.appendChild(o);
      });
      log('#cf-log', {ok:true, zones:z.map(v=>({id:v.id,name:v.name,status:v.status}))});
    }catch(e){ log('#cf-log', String(e)); }
  }
  $('#btnCfList').addEventListener('click', cfListZones);

  $('#btnCfProtect').addEventListener('click', async ()=>{
    const token = $('#cf-token').value.trim();
    const zone = $('#cf-zones').value;
    if(!token || !zone) return log('#cf-log','Paste token and choose a zone.');
    try{
      const j = await postJSON(`${API_BASE}/api/cf/protect`, {token, zone_id: zone});
      log('#cf-log', j);
      const txt = j.apex || (j.results && j.results[0] && j.results[0].name) || '';
      if (txt) $('#ps-domain').value = txt;
    }catch(e){ log('#cf-log', String(e)); }
  });

  // ---- Route 53 connect ----
  async function r53ListZones(){
    const key = $('#r53-key').value.trim();
    const secret = $('#r53-secret').value.trim();
    if(!key || !secret) return log('#r53-log','Paste AWS key + secret.');
    try{
      const j = await postJSON(`${API_BASE}/api/r53/list-zones`, {
        access_key_id: key,
        secret_access_key: secret
      });
      const z = j.zones || [];
      const sel = $('#r53-zones'); sel.innerHTML = '<option value="">— choose a hosted zone —</option>';
      z.forEach(r => {
        const o = document.createElement('option');
        o.value = r.id; o.textContent = `${r.name} (${r.id})`; sel.appendChild(o);
      });
      log('#r53-log', {ok:true, zones:z});
    }catch(e){ log('#r53-log', String(e)); }
  }
  $('#r53-key').addEventListener('change', r53ListZones);
  $('#r53-secret').addEventListener('change', r53ListZones);

  $('#btnR53Protect').addEventListener('click', async ()=>{
    const key = $('#r53-key').value.trim();
    const secret = $('#r53-secret').value.trim();
    const zone = $('#r53-zones').value;
    if(!key || !secret || !zone) return log('#r53-log','Paste keys and choose a hosted zone.');
    try{
      const j = await postJSON(`${API_BASE}/api/r53/protect`, {
        access_key_id: key,
        secret_access_key: secret,
        hosted_zone_id: zone
      });
      log('#r53-log', j);
      const txt = j.apex || (j.results && j.results[0] && j.results[0].name) || '';
      if (txt) $('#ps-domain').value = txt;
    }catch(e){ log('#r53-log', String(e)); }
  });

  // ---- DMARC Step‑Up UI ----
  function computeDmarcPreview(){
    const p = $('#ps-policy').value;
    const rua = $('#ps-rua').value.trim() || 'mailto:dmarc@domainsafepro.com';
    const base = ['v=DMARC1', `p=${p}`, 'adkim=s', 'aspf=s', `rua=${rua}`];
    const pct = (p === 'none') ? 100 : 25;
    if (pct !== 100) base.push(`pct=${pct}`);
    $('#ps-preview').value = base.join('; ');
  }
  computeDmarcPreview();
  $('#ps-policy').addEventListener('change', computeDmarcPreview);
  $('#ps-rua').addEventListener('input', computeDmarcPreview);
  $('#btnPsPreview').addEventListener('click', computeDmarcPreview);

  $('#btnPsApplyCf').addEventListener('click', async ()=>{
    const domain = $('#ps-domain').value.trim().toLowerCase();
    const policy = $('#ps-policy').value;
    const rua = $('#ps-rua').value.trim() || 'mailto:dmarc@domainsafepro.com';
    const pct = (policy === 'none') ? 100 : 25;
    if(!domain) return log('#ps-log','Pick a zone (above) or enter a domain first.');
    if(!isDomain(domain)) return log('#ps-log','Enter a valid domain (e.g., example.com).');
    try{
      const body = {domain, policy, pct, adkim:'s', aspf:'s', rua};
      const j = await postJSON(`${API_BASE}/api/policy/dmarc/cf`, body);
      log('#ps-log', j);
    }catch(e){ log('#ps-log', String(e)); }
  });

  $('#btnPsApplyR53').addEventListener('click', async ()=>{
    const domain = $('#ps-domain').value.trim().toLowerCase();
    const policy = $('#ps-policy').value;
    const rua = $('#ps-rua').value.trim() || 'mailto:dmarc@domainsafepro.com';
    const pct = (policy === 'none') ? 100 : 25;
    if(!domain) return log('#ps-log','Enter a domain first.');
    if(!isDomain(domain)) return log('#ps-log','Enter a valid domain (e.g., example.com).');
    try{
      const body = {domain, policy, pct, adkim:'s', aspf:'s', rua};
      const j = await postJSON(`${API_BASE}/api/policy/dmarc/r53`, body);
      log('#ps-log', j);
    }catch(e){ log('#ps-log', String(e)); }
  });

  // ---- Control SPF (central) ----
  const SPF_MAP = {
    google: 'include:_spf.google.com',
    m365: 'include:spf.protection.outlook.com',
    sendgrid: 'include:sendgrid.net',
    ses: 'include:amazonses.com',
    mailgun: 'include:mailgun.org',
    mailchimp: 'include:servers.mcsv.net',
    postmark: 'include:spf.mtasv.net',
    sparkpost: 'include:_spf.sparkpostmail.com',
    zoho: 'include:zoho.com',
    zendesk: 'include:mail.zendesk.com',
    intercom: 'include:_spf.intercom.io'
  };
  function updateSpfPreview(){
    const sels = [...document.querySelectorAll('.spf-sel:checked')].map(x => SPF_MAP[x.value]).filter(Boolean);
    const txt = ['v=spf1', ...sels, '~all'].join(' ');
    $('#spf-preview').value = txt;
  }
  document.querySelectorAll('.spf-sel').forEach(cb => cb.addEventListener('change', updateSpfPreview));
  updateSpfPreview();

  $('#btnSpfLoad').addEventListener('click', async ()=>{
    const token = $('#spf-token').value.trim();
    if(!token) return log('#spf-log','Paste a Cloudflare API token first.');
    try{
      const j = await getJSON(`${API_BASE}/api/cf/control-spf?token=${encodeURIComponent(token)}`);
      if (j && j.value) $('#spf-preview').value = j.value;
      log('#spf-log', j);
    }catch(e){ log('#spf-log', String(e)); }
  });

  $('#btnSpfUpdate').addEventListener('click', async ()=>{
    const token = $('#spf-token').value.trim();
    if(!token) return log('#spf-log','Paste a Cloudflare API token first.');
    const value = $('#spf-preview').value.trim();
    try{
      const j = await postJSON(`${API_BASE}/api/cf/control-spf`, {token, value});
      log('#spf-log', j);
    }catch(e){ log('#spf-log', String(e)); }
  });

  // ---- Insights (beta) ----
  $('#btnIngest').addEventListener('click', async ()=>{
    try{
      const j = await postJSON(`https://api.domainsafepro.com/api/dmarc/ingest-latest`, {limit:25});
      $('#ins-wrap').textContent = JSON.stringify(j, null, 2);
    }catch(e){ $('#ins-wrap').textContent = String(e); }
  });
  async function loadRollup(days){
    const dom = $('#ins-domain').value.trim().toLowerCase();
    if(!dom) return $('#ins-wrap').textContent = 'Enter a domain first.';
    if(!isDomain(dom)) return $('#ins-wrap').textContent = 'Enter a valid domain (e.g., example.com).';
    try{
      const j = await getJSON(`https://api.domainsafepro.com/api/dmarc/summary?domain=${encodeURIComponent(dom)}&days=${days}`);
      $('#ins-wrap').textContent = JSON.stringify(j, null, 2);
    }catch(e){ $('#ins-wrap').textContent = String(e); }
  }
  $('#btnLoad7').addEventListener('click', ()=>loadRollup(7));
  $('#btnLoad30').addEventListener('click', ()=>loadRollup(30));

  // ---- “Check my domain” logic ----
  $('#btnCheck').addEventListener('click', async ()=>{
    const dom = $('#chk-domain').value.trim().toLowerCase();
    if(!dom) return log('#chk-log','Enter a domain first.');
    if(!isDomain(dom)) return log('#chk-log','Enter a valid domain (e.g., example.com).');
    try{
      const status = await getJSON(`${API_BASE}/api/status?domain=${encodeURIComponent(dom)}`);
      const quick  = await getJSON(`${API_BASE}/api/check-quick-codes?domain=${encodeURIComponent(dom)}`);
      const dohDMARC = await fetch(`https://cloudflare-dns.com/dns-query?name=${encodeURIComponent('_dmarc.'+dom)}&type=TXT`, {headers:{Accept:'application/dns-json'}}).then(r=>r.json()).catch(()=>null);
      const dohTLS   = await fetch(`https://cloudflare-dns.com/dns-query?name=${encodeURIComponent('_smtp._tls.'+dom)}&type=TXT`, {headers:{Accept:'application/dns-json'}}).then(r=>r.json()).catch(()=>null);
      const dohSTS   = await fetch(`https://cloudflare-dns.com/dns-query?name=${encodeURIComponent('mta-sts.'+dom)}&type=CNAME`, {headers:{Accept:'application/dns-json'}}).then(r=>r.json()).catch(()=>null);

      const ansTxt = (ans) => (ans && ans.Answer) ? ans.Answer.map(a=>a.data.replace(/^"|"$/g,'')).join('\n') : '—';
      const spf = quick?.checks?.spf || {};
      const dmarc = quick?.checks?.dmarc || {};
      const dkim = quick?.checks?.dkim || {};
      const robot = status?.status || status;

      // Score heuristic
      const score = (dmarc.policy==='reject'?40:(dmarc.policy==='quarantine'?25:10))
        + (spf.present && spf.includesControl?25:0)
        + ((dkim.s1?.ok && dkim.s2?.ok)?20:0)
        + ((dohTLS?.Answer?10:0) + (dohSTS?.Answer?5:0));

      const out = {
        domain: dom,
        score: `${Math.min(100, score)}/100`,
        robot_snapshot: robot,
        quick_checks: quick?.checks,
        doh: {
          _dmarc: ansTxt(dohDMARC),
          _smtp__tls: ansTxt(dohTLS),
          mta_sts: ansTxt(dohSTS)
        },
        tips: [
          !dohTLS?.Answer ? 'Add TLS-RPT TXT at _smtp._tls (Quick-Codes → extras).' : null,
          !dohSTS?.Answer ? 'Add MTA-STS CNAME mta-sts → mta-sts.control.domainsafepro.com (Quick-Codes → extras).' : null,
          (dmarc.policy!=='reject') ? 'Raise DMARC policy via Step‑Up once alignment stabilizes.' : null
        ].filter(Boolean)
      };
      log('#chk-log', out);
    }catch(e){ log('#chk-log', String(e)); }
  });

})();
</script>
</body>
</html>
