<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DomainSafePro - Setup Your Protection</title>
  <meta name="description" content="Set up email authentication for your domain. Get your DNS records and verify your protection status."/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vollkorn:wght@600&family=Exo+2:wght@600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://rsms.me/">
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">

  <style>
/* ========== TOKENS (matching landing page) ========== */
:root {
  --font-serif: 'Vollkorn', Georgia, serif;
  --font-sans: 'Inter', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  --font-brand: 'Exo 2', sans-serif;
  --font-mono: 'Roboto Mono', 'Fira Code', ui-monospace, monospace;
  --radius: 14px;
  --radius-sm: 8px;
  --maxw: 1100px;
  --fast-transition: 0.15s ease;
  --med-transition: 0.3s ease;
}

[data-theme="dark"] {
  --bg: #0c0c0e;
  --bg-card: #141417;
  --bg-alt: #1a1a1d;
  --bg-input: rgba(0,0,0,0.25);
  --fg: #ededf0;
  --fg-muted: #9496a3;
  --border: rgba(255,255,255,0.1);
  --border-glow: rgba(255,255,255,0.2);
  --brand: #5a81ff;
  --brand-accent: #8a7aff;
  --warn: #ffd36a;
  --ok: #67e8a3;
  --danger: #ff7a7a;
  --shadow-color: rgba(0,0,0,0.3);
  --glass-bg: rgba(20,20,23,0.55);
  --glass-border: rgba(255,255,255,0.12);
  --highlight-bg: rgba(90,129,255,0.08);
  --highlight-border: rgba(90,129,255,0.3);
}

[data-theme="light"] {
  --bg: #fafafa;
  --bg-card: #ffffff;
  --bg-alt: #f5f5f5;
  --bg-input: rgba(0,0,0,0.04);
  --fg: #111113;
  --fg-muted: #55555c;
  --border: rgba(0,0,0,0.1);
  --border-glow: rgba(0,0,0,0.2);
  --brand: #4a75ff;
  --brand-accent: #7a6aff;
  --warn: #f5a623;
  --ok: #28a745;
  --danger: #d9534f;
  --shadow-color: rgba(0,0,0,0.08);
  --glass-bg: rgba(255,255,255,0.6);
  --glass-border: rgba(0,0,0,0.08);
  --highlight-bg: rgba(74,117,255,0.06);
  --highlight-border: rgba(74,117,255,0.25);
}

/* ========== BASE ========== */
* { box-sizing: border-box; }
html { scroll-behavior: smooth; }
html, body { max-width: 100%; overflow-x: clip; }
body {
  margin: 0;
  min-height: 100vh;
  background: linear-gradient(135deg, var(--bg) 0%, var(--bg-alt) 50%, var(--bg) 100%);
  color: var(--fg);
  font-family: var(--font-sans);
  font-size: 16px;
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
}
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 1000px;
  height: 1000px;
  background: radial-gradient(circle, rgba(90,129,255,0.06) 0%, transparent 70%);
  pointer-events: none;
  z-index: 0;
}

h1, h2, h3, h4 {
  font-family: var(--font-serif);
  color: var(--fg);
  font-weight: 600;
  letter-spacing: -0.01em;
  line-height: 1.3;
  margin: 0;
}
p { color: var(--fg-muted); margin: 0; }
a { text-decoration: none; color: var(--brand); }
code, .mono { font-family: var(--font-mono); font-size: 0.9em; }

/* ========== HEADER ========== */
header {
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  background: var(--glass-bg);
  border-bottom: 1px solid var(--glass-border);
  padding: 16px 20px;
}
.header-inner {
  max-width: var(--maxw);
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 12px;
}
.brand {
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 700;
  font-size: 1.4rem;
  color: var(--fg);
}
.brand-text {
  font-family: var(--font-brand);
  background: linear-gradient(90deg, #5a81ff 0%, #21E6C1 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.header-tag {
  font-size: 13px;
  color: var(--fg-muted);
  display: none;
}
@media (min-width: 768px) {
  .header-tag { display: block; max-width: 400px; }
}

.auth-bar {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}
#auth-status-label {
  font-size: 13px;
  color: var(--fg-muted);
}

/* Theme toggle */
.theme-toggle {
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-card);
  border: 1px solid var(--border);
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  transition: all var(--fast-transition);
}
.theme-toggle:hover { border-color: var(--border-glow); }
.theme-toggle svg { width: 16px; height: 16px; color: var(--fg-muted); }
[data-theme="dark"] .theme-toggle .sun-icon { display: block; }
[data-theme="dark"] .theme-toggle .moon-icon { display: none; }
[data-theme="light"] .theme-toggle .sun-icon { display: none; }
[data-theme="light"] .theme-toggle .moon-icon { display: block; }

/* ========== BUTTONS ========== */
.btn {
  appearance: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 12px 22px;
  border-radius: 999px;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--fast-transition);
  font-size: 14px;
  font-family: var(--font-sans);
  border: 2px solid var(--brand);
  background: var(--brand);
  color: #fff;
  box-shadow: 0 4px 12px var(--shadow-color);
}
.btn:hover {
  filter: brightness(1.1);
  transform: translateY(-1px);
  box-shadow: 0 6px 18px var(--shadow-color);
}
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; filter: none; }

.btn.secondary, .btn-auth {
  background: var(--glass-bg);
  border: 2px solid var(--glass-border);
  color: var(--fg);
  backdrop-filter: blur(8px);
}
.btn.secondary:hover, .btn-auth:hover {
  background: var(--bg-alt);
  border-color: var(--border-glow);
}

.btn.ghost {
  background: transparent;
  border: 2px solid var(--border);
  color: var(--fg-muted);
}
.btn.ghost:hover {
  border-color: var(--border-glow);
  color: var(--fg);
}

.btn.warn {
  background: linear-gradient(135deg, #ffd36a 0%, #f5a623 100%);
  border-color: #f5a623;
  color: #1a1a1d;
}
.btn.warn:hover {
  filter: brightness(1.05);
}

.btn.large {
  padding: 16px 32px;
  font-size: 16px;
}

.btn-sm {
  padding: 8px 16px;
  font-size: 13px;
}

/* ========== LOGIN SECTION ========== */
#login-section {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  min-height: 60vh;
}
.login-card {
  width: 100%;
  max-width: 480px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: var(--radius);
  border: 1px solid var(--glass-border);
  padding: 32px 28px;
  box-shadow: 0 24px 60px var(--shadow-color);
  text-align: center;
  position: relative;
  z-index: 1;
}
.login-card .eyebrow {
  font-size: 12px;
  color: var(--brand);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-bottom: 8px;
  font-weight: 600;
}
.login-card h2 {
  font-size: 1.75rem;
  margin-bottom: 12px;
}
.login-card p {
  font-size: 15px;
  color: var(--fg-muted);
  margin-bottom: 24px;
  max-width: 360px;
  margin-left: auto;
  margin-right: auto;
}
.login-card .btn { width: 100%; max-width: 280px; }
.login-card .tiny {
  margin-top: 16px;
  font-size: 12px;
  color: var(--fg-muted);
}

body.authed #login-section { display: none; }
body.authed #app-main { display: block; }

/* ========== MAIN CONSOLE ========== */
main {
  max-width: var(--maxw);
  margin: 0 auto;
  padding: 24px 16px 80px;
  position: relative;
  z-index: 1;
}
#app-main { display: none; }

/* Welcome message */
.welcome-banner {
  text-align: center;
  padding: 32px 20px;
  margin-bottom: 24px;
}
.welcome-banner h1 {
  font-size: 1.8rem;
  margin-bottom: 8px;
}
.welcome-banner p {
  font-size: 16px;
  max-width: 500px;
  margin: 0 auto;
}

/* Section titles */
.section-title {
  font-size: 1rem;
  color: var(--fg-muted);
  font-weight: 600;
  margin-bottom: 16px;
  margin-top: 32px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
  font-family: var(--font-sans);
  display: flex;
  align-items: center;
  gap: 10px;
}
.section-title:first-of-type { margin-top: 0; }
.section-title .icon {
  font-size: 1.2rem;
}

/* ========== GRID ========== */
.grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 20px;
  margin-bottom: 24px;
}
@media (min-width: 900px) {
  .grid { grid-template-columns: 1fr 1fr; }
}
.grid.full { grid-template-columns: 1fr; }

/* ========== CARDS ========== */
.card {
  background: var(--glass-bg);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: 0 8px 32px var(--shadow-color);
  transition: border-color var(--fast-transition), box-shadow var(--fast-transition);
}
.card:hover {
  border-color: var(--border-glow);
}
.card h3 {
  font-size: 1.25rem;
  margin: 0 0 8px 0;
  display: flex;
  align-items: center;
  gap: 10px;
}
.card h3 .card-icon {
  font-size: 1.3rem;
}
.card .desc {
  color: var(--fg-muted);
  font-size: 14px;
  margin: 0 0 16px 0;
  line-height: 1.6;
}

/* HIGHLIGHTED CARD (for primary actions) */
.card.highlight {
  border: 2px solid var(--highlight-border);
  background: var(--highlight-bg);
  box-shadow: 0 8px 32px var(--shadow-color), 0 0 0 1px var(--highlight-border);
}
.card.highlight:hover {
  border-color: var(--brand);
}
.card.highlight h3 {
  color: var(--brand);
}

/* ========== FORM ELEMENTS ========== */
label {
  display: block;
  font-size: 13px;
  color: var(--fg-muted);
  margin-bottom: 6px;
  font-weight: 500;
}
input, select, textarea {
  width: 100%;
  padding: 12px 14px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--fg);
  border-radius: var(--radius-sm);
  font-size: 15px;
  font-family: var(--font-sans);
  outline: none;
  transition: border-color var(--fast-transition), box-shadow var(--fast-transition);
}
input:focus, select:focus, textarea:focus {
  border-color: var(--brand);
  box-shadow: 0 0 0 3px rgba(90,129,255,0.15);
}
input.mono, textarea.mono, .mono {
  font-family: var(--font-mono);
  font-size: 14px;
}
textarea { min-height: 100px; resize: vertical; }
select {
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%239496a3' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 36px;
}

/* Row layouts */
.row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}
.row:last-child { margin-bottom: 0; }
.row > div { flex: 1 1 200px; }
.row > div.narrow { flex: 0 0 140px; }
.row > div.action { flex: 0 0 auto; align-self: flex-end; }

/* ========== LOG / OUTPUT AREAS ========== */
.log {
  white-space: pre-wrap;
  word-break: break-word;
  font-family: var(--font-mono);
  font-size: 13px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 14px;
  max-height: 300px;
  overflow-y: auto;
  color: var(--fg-muted);
}
.log:empty::before {
  content: 'Ready.';
  opacity: 0.5;
}

/* ========== VERIFICATION RESULTS (Human-readable) ========== */
.verify-results {
  margin-top: 16px;
}
.verify-item {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 14px 16px;
  background: var(--bg-input);
  border-radius: var(--radius-sm);
  margin-bottom: 10px;
  border: 1px solid var(--border);
}
.verify-item:last-child { margin-bottom: 0; }
.verify-icon {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  flex-shrink: 0;
}
.verify-icon.pass {
  background: rgba(103,232,163,0.15);
  color: var(--ok);
}
.verify-icon.fail {
  background: rgba(255,122,122,0.15);
  color: var(--danger);
}
.verify-icon.warn {
  background: rgba(255,211,106,0.12);
  color: var(--warn);
}
.verify-content {
  flex: 1;
}
.verify-label {
  font-weight: 600;
  color: var(--fg);
  margin-bottom: 2px;
}
.verify-status {
  font-size: 13px;
  color: var(--fg-muted);
}
.verify-status.pass { color: var(--ok); }
.verify-status.fail { color: var(--danger); }

/* Overall status banner */
.verify-summary {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px 20px;
  border-radius: var(--radius-sm);
  margin-bottom: 16px;
}
.verify-summary.all-pass {
  background: rgba(103,232,163,0.1);
  border: 1px solid rgba(103,232,163,0.3);
}
.verify-summary.has-issues {
  background: rgba(255,211,106,0.1);
  border: 1px solid rgba(255,211,106,0.3);
}
.verify-summary-icon {
  font-size: 28px;
}
.verify-summary-text h4 {
  font-family: var(--font-sans);
  font-size: 15px;
  margin: 0 0 2px 0;
}
.verify-summary-text p {
  font-size: 13px;
  margin: 0;
}

/* ========== TABLES ========== */
.table-wrap {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  margin: 0 -4px;
  padding: 0 4px;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
  min-width: 600px;
}
th, td {
  padding: 12px 10px;
  text-align: left;
  border-bottom: 1px solid var(--border);
}
th {
  color: var(--fg);
  font-weight: 600;
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 0.03em;
}
td { color: var(--fg-muted); }

/* Mobile table to card stack */
@media (max-width: 700px) {
  .table-wrap { margin: 0; padding: 0; }
  table, thead, tbody, th, td, tr { display: block; }
  thead { display: none; }
  table { min-width: 0; }
  tr {
    background: var(--bg-input);
    border-radius: var(--radius-sm);
    padding: 14px;
    margin-bottom: 12px;
    border: 1px solid var(--border);
  }
  td {
    padding: 6px 0;
    border: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  td::before {
    content: attr(data-label);
    font-weight: 600;
    color: var(--fg);
    font-size: 12px;
    text-transform: uppercase;
    margin-right: 12px;
  }
}

/* ========== PILLS / BADGES ========== */
.pill {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;
}
.pill.ok {
  background: rgba(103,232,163,0.15);
  color: var(--ok);
  border: 1px solid rgba(103,232,163,0.3);
}
.pill.bad {
  background: rgba(255,122,122,0.15);
  color: var(--danger);
  border: 1px solid rgba(255,122,122,0.3);
}
.pill.warn {
  background: rgba(255,211,106,0.12);
  color: var(--warn);
  border: 1px solid rgba(255,211,106,0.3);
}

/* Badges row */
.badges {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 8px;
}
.badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: var(--bg-input);
  font-weight: 600;
  font-size: 13px;
}
.badge.ok { border-color: rgba(103,232,163,0.4); color: var(--ok); }
.badge.warn { border-color: rgba(255,211,106,0.4); color: var(--warn); }
.badge.bad { border-color: rgba(255,122,122,0.4); color: var(--danger); }

/* ========== SCORE METER ========== */
.meter {
  height: 14px;
  border-radius: 999px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  overflow: hidden;
  max-width: 320px;
}
.meter > i {
  display: block;
  height: 100%;
  background: linear-gradient(90deg, var(--danger), var(--warn), var(--ok));
  width: 0%;
  transition: width 0.5s ease;
  border-radius: 999px;
}

/* Mini bar chart */
.bar {
  height: 10px;
  background: var(--border);
  border-radius: 6px;
  overflow: hidden;
}
.bar > i {
  display: block;
  height: 100%;
  background: var(--ok);
  border-radius: 6px;
}

/* ========== KVS (Key-Value pairs) ========== */
.kvs {
  display: grid;
  grid-template-columns: 140px 1fr;
  gap: 10px 16px;
  font-size: 14px;
}
.kvs > div:nth-child(odd) {
  color: var(--fg-muted);
  font-weight: 500;
}
@media (max-width: 500px) {
  .kvs {
    grid-template-columns: 1fr;
    gap: 4px;
  }
  .kvs > div:nth-child(odd) {
    margin-top: 12px;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }
  .kvs > div:nth-child(odd):first-child { margin-top: 0; }
}

/* ========== NOTICES ========== */
.notice {
  margin-top: 8px;
  background: rgba(255,211,106,0.1);
  border: 1px dashed var(--warn);
  color: var(--warn);
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  font-size: 13px;
}
.notice.info {
  background: rgba(90,129,255,0.1);
  border-color: var(--brand);
  color: var(--brand);
}
.notice.success {
  background: rgba(103,232,163,0.1);
  border-color: var(--ok);
  color: var(--ok);
}

/* ========== CHECKBOXES ========== */
.checkbox-row {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: var(--fg-muted);
  margin: 8px 0;
}
.checkbox-row input[type="checkbox"] {
  width: 16px;
  height: 16px;
  flex-shrink: 0;
  accent-color: var(--brand);
}

/* SPF checkboxes grid */
.spf-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 8px;
  margin-bottom: 16px;
}
.spf-grid label {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: var(--bg-input);
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  cursor: pointer;
  font-size: 13px;
  transition: all var(--fast-transition);
}
.spf-grid label:hover {
  border-color: var(--border-glow);
}
.spf-grid input[type="checkbox"] {
  width: 16px;
  height: 16px;
  accent-color: var(--brand);
}

/* ========== COLLAPSIBLE SECTIONS ========== */
details {
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  margin-top: 16px;
}
summary {
  padding: 12px 16px;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  color: var(--fg);
  background: var(--bg-input);
  border-radius: var(--radius-sm);
  list-style: none;
  display: flex;
  align-items: center;
  gap: 8px;
}
summary::-webkit-details-marker { display: none; }
summary::before {
  content: '‚ñ∏';
  font-size: 12px;
  transition: transform var(--fast-transition);
}
details[open] summary::before {
  transform: rotate(90deg);
}
details > div {
  padding: 16px;
}

/* ========== QUICK-CODES RESULT CARDS ========== */
.qc-cards {
  display: grid;
  gap: 12px;
  margin-top: 16px;
}
.qc-card {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 16px;
}
.qc-card-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 12px;
}
.qc-type {
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.qc-type.txt { background: rgba(138,122,255,0.2); color: var(--brand-accent); }
.qc-type.cname { background: rgba(90,129,255,0.2); color: var(--brand); }
.qc-purpose {
  font-size: 14px;
  color: var(--fg);
  font-weight: 600;
}
.qc-field {
  margin-bottom: 12px;
}
.qc-field:last-child { margin-bottom: 0; }
.qc-label {
  font-size: 11px;
  color: var(--fg-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 6px;
}
.qc-value {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 10px 12px;
}
.qc-value code {
  flex: 1;
  font-family: var(--font-mono);
  font-size: 13px;
  word-break: break-all;
  color: var(--fg);
}
.copy-btn {
  flex-shrink: 0;
  padding: 6px 12px;
  font-size: 12px;
  border-radius: var(--radius-sm);
  background: var(--brand);
  color: #fff;
  border: none;
  cursor: pointer;
  font-weight: 600;
  transition: all var(--fast-transition);
}
.copy-btn:hover { filter: brightness(1.1); }
.copy-btn.copied {
  background: var(--ok);
}

/* ========== ADMIN SECTION ========== */
.admin-section {
  margin-top: 40px;
  padding-top: 24px;
  border-top: 2px solid var(--border);
}
.admin-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 12px;
}
.admin-header h2 {
  font-size: 1.3rem;
  display: flex;
  align-items: center;
  gap: 10px;
}
.admin-badge {
  font-size: 11px;
  padding: 4px 10px;
  background: rgba(255,211,106,0.15);
  color: var(--warn);
  border-radius: 999px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.admin-toggle {
  font-size: 13px;
  color: var(--fg-muted);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
}
.admin-toggle:hover { color: var(--fg); }
.admin-content {
  display: none;
}
.admin-content.visible {
  display: block;
}

/* ========== UTILITIES ========== */
.tiny { font-size: 12px; }
.muted { color: var(--fg-muted); }
.danger { color: var(--danger); }
.text-center { text-align: center; }
.mt-sm { margin-top: 8px; }
.mt-md { margin-top: 16px; }
.mb-sm { margin-bottom: 8px; }
.mb-md { margin-bottom: 16px; }
.hidden { display: none !important; }

/* Gap between button rows */
.btn-row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 16px;
}

/* ========== DOCS SECTION ========== */
.docs-content {
  font-size: 14px;
  line-height: 1.7;
}
.docs-content strong {
  color: var(--fg);
  display: block;
  margin-top: 16px;
  margin-bottom: 6px;
}
.docs-content strong:first-child { margin-top: 0; }
.docs-content p {
  margin-bottom: 12px;
}
.docs-content .mono {
  background: var(--bg-input);
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 13px;
}

/* ========== STEP INDICATORS ========== */
.steps {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}
.step {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 14px;
  background: var(--bg-input);
  border-radius: 999px;
  font-size: 13px;
  font-weight: 600;
}
.step-number {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: var(--brand);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
}
.step.completed .step-number {
  background: var(--ok);
}
.step-arrow {
  color: var(--fg-muted);
  font-size: 18px;
}

/* ========== MOBILE OPTIMIZATIONS ========== */
@media (max-width: 640px) {
  header { padding: 12px 16px; }
  .header-inner { gap: 8px; }
  .brand { font-size: 1.2rem; gap: 8px; }
  main { padding: 16px 12px 60px; }
  .card { padding: 18px 16px; }
  .card h3 { font-size: 1.1rem; }
  .btn { padding: 10px 18px; font-size: 13px; }
  .btn.large { padding: 14px 24px; font-size: 15px; }
  .row > div { flex: 1 1 100%; }
  .row > div.narrow { flex: 1 1 100%; }
  .row > div.action { width: 100%; }
  .btn-row { flex-direction: column; }
  .btn-row .btn { width: 100%; }
  .login-card { padding: 24px 20px; }
  .login-card h2 { font-size: 1.5rem; }
  .welcome-banner h1 { font-size: 1.5rem; }
  .steps { gap: 6px; }
  .step { padding: 6px 10px; font-size: 12px; }
}

/* Touch-friendly tap targets */
@media (max-width: 768px) {
  input, select, textarea {
    font-size: 16px;
    min-height: 48px;
  }
  .btn { min-height: 48px; }
}

/* ========== ANIMATIONS ========== */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.card {
  animation: fadeIn 0.4s ease;
}
@keyframes pulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(90,129,255,0.4); }
  50% { box-shadow: 0 0 0 8px rgba(90,129,255,0); }
}
.card.highlight {
  animation: fadeIn 0.4s ease, pulse 2s ease-in-out 3;
}

/* ========== FOOTER ========== */
.console-footer {
  text-align: center;
  padding: 24px;
  font-size: 13px;
  color: var(--fg-muted);
  border-top: 1px solid var(--border);
  margin-top: 40px;
}
.console-footer a {
  color: var(--brand);
}
  </style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="brand">
      <span class="brand-text">DomainSafePro</span>
      <span class="header-tag">Setup and manage your email protection</span>
    </div>
    <div class="auth-bar" id="auth-bar">
      <span id="auth-status-label">Not signed in</span>
      <button class="btn secondary btn-sm btn-auth" id="auth-login-btn" type="button">Sign in with Google</button>
      <button class="theme-toggle" type="button" onclick="toggleTheme()" aria-label="Toggle theme">
        <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
      </button>
    </div>
  </div>
</header>

<!-- Login hero (shown when not signed in) -->
<section id="login-section">
  <div class="login-card">
    <div class="eyebrow">DomainSafePro</div>
    <h2>Welcome Back</h2>
    <p>Sign in with your Google account to set up protection for your domain and manage your email security.</p>
    <button class="btn" type="button" id="login-hero-btn">Sign in with Google</button>
    <div class="tiny">You will be redirected back here after signing in.</div>
  </div>
</section>

<!-- Main app (hidden until authed) -->
<main id="app-main">

  <!-- Welcome banner -->
  <div class="welcome-banner">
    <h1>Set Up Your Domain Protection</h1>
    <p>Follow the steps below to secure your email. Most customers complete setup in under 5 minutes.</p>
  </div>

  <!-- Step indicator -->
  <div class="steps">
    <div class="step" id="step1-indicator">
      <span class="step-number">1</span>
      <span>Get Your Codes</span>
    </div>
    <span class="step-arrow">‚Üí</span>
    <div class="step" id="step2-indicator">
      <span class="step-number">2</span>
      <span>Add to DNS</span>
    </div>
    <span class="step-arrow">‚Üí</span>
    <div class="step" id="step3-indicator">
      <span class="step-number">3</span>
      <span>Verify Setup</span>
    </div>
  </div>

  <!-- STEP 1: GET YOUR CODES (Primary action, highlighted) -->
  <section class="grid full">
    <div class="card highlight">
      <h3><span class="card-icon">üìã</span> Step 1: Get Your DNS Records</h3>
      <p class="desc">Enter your domain below and we will generate the DNS records you need. Then copy each record and add it at your domain registrar (like GoDaddy, Namecheap, or Cloudflare).</p>
      
      <div class="row">
        <div>
          <label for="qc-domain">Your domain name</label>
          <input id="qc-domain" class="mono" placeholder="yourdomain.com" autocapitalize="off" autocorrect="off" spellcheck="false"/>
          <div class="notice hidden" id="qc-notice"></div>
        </div>
        <div class="action">
          <button class="btn large" id="btnQCodes">Generate My Records</button>
        </div>
      </div>
      
      <div class="checkbox-row">
        <input type="checkbox" id="qc-extras"/>
        <label for="qc-extras" style="margin:0">Include advanced security records (MTA-STS and TLS reporting)</label>
      </div>

      <div id="qc-results" class="hidden"></div>
      
      <div id="qc-actions" class="btn-row hidden">
        <button class="btn secondary btn-sm" id="btnCopyAll">Copy All as Text</button>
      </div>
    </div>
  </section>

  <!-- STEP 2: Instructions -->
  <section class="grid full">
    <div class="card">
      <h3><span class="card-icon">üìù</span> Step 2: Add Records to Your DNS</h3>
      <p class="desc">Log in to your domain registrar and add each record from Step 1. Here is what to look for:</p>
      
      <div class="docs-content">
        <strong>Where to add these records</strong>
        <p>Go to your domain registrar (the company where you bought your domain) and find the DNS settings. Common places include: "DNS Management", "DNS Records", or "Zone Editor".</p>
        
        <strong>Adding TXT records</strong>
        <p>For TXT records, create a new record with the "Host" (or "Name") and "Value" exactly as shown. The Host field is usually just the prefix like <code>_dmarc</code>, not the full domain.</p>
        
        <strong>Adding CNAME records</strong>
        <p>For CNAME records, the "Points to" or "Value" field should be the target address we provide. Some registrars add your domain automatically, so just enter the prefix.</p>
        
        <strong>When will it work?</strong>
        <p>DNS changes can take a few minutes to a few hours to spread across the internet. If verification fails at first, wait 15 minutes and try again.</p>
      </div>
    </div>
  </section>

  <!-- STEP 3: VERIFY SETUP (Highlighted) -->
  <section class="grid full">
    <div class="card highlight">
      <h3><span class="card-icon">‚úÖ</span> Step 3: Verify Your Setup</h3>
      <p class="desc">After adding your DNS records, enter your domain below to confirm everything is working. We will check each record and tell you if anything needs attention.</p>
      
      <div class="row">
        <div>
          <label for="verify-domain">Domain to verify</label>
          <input id="verify-domain" class="mono" placeholder="yourdomain.com" autocapitalize="off" autocorrect="off" spellcheck="false"/>
          <div class="notice hidden" id="verify-notice"></div>
        </div>
        <div class="action">
          <button class="btn large" id="btnVerify">Verify My Setup</button>
        </div>
      </div>
      
      <div id="verify-results" class="verify-results hidden"></div>
      
      <details class="hidden" id="verify-details">
        <summary>View technical details</summary>
        <div>
          <pre id="verify-log" class="log tiny">Waiting for verification...</pre>
        </div>
      </details>
    </div>
  </section>

  <!-- HELP SECTION -->
  <section class="grid full">
    <div class="card">
      <h3><span class="card-icon">üí°</span> Need Help?</h3>
      <div class="docs-content">
        <strong>Not sure which DNS provider you use?</strong>
        <p>Check the confirmation email from when you bought your domain, or look at your domain's WHOIS record. Common providers include GoDaddy, Namecheap, Google Domains, and Cloudflare.</p>
        
        <strong>Verification keeps failing?</strong>
        <p>DNS changes can take up to 48 hours to fully propagate, though most complete within an hour. Make sure you copied the records exactly as shown, including any underscores or periods.</p>
        
        <strong>Want automatic setup instead?</strong>
        <p>If your domain is managed by Cloudflare or AWS Route 53, we can configure everything automatically. See the "Automatic Setup" section in Admin Tools below.</p>
      </div>
    </div>
  </section>

  <!-- ============================================================ -->
  <!-- ADMIN / OWNER SECTION (Collapsible) -->
  <!-- ============================================================ -->
  <div class="admin-section">
    <div class="admin-header">
      <h2><span>üîß</span> Admin Tools <span class="admin-badge">Owner Only</span></h2>
      <div class="admin-toggle" id="admin-toggle" onclick="toggleAdmin()">
        <span id="admin-toggle-text">Show admin tools</span>
        <span id="admin-toggle-icon">‚ñº</span>
      </div>
    </div>

    <div class="admin-content" id="admin-content">

      <!-- DOMAIN STATUS -->
      <div class="section-title"><span class="icon">üìä</span> Connected Domains</div>
      <section class="grid full">
        <div class="card">
          <h3>Domain Health Dashboard</h3>
          <p class="desc">All domains under your account with their current protection status. The robot checks these automatically every day.</p>
          <div class="btn-row">
            <button class="btn btn-sm" id="btnStatus">Refresh Status</button>
            <button class="btn btn-sm secondary" id="btnMonitor">Run Check Now</button>
          </div>
          <div class="mt-md table-wrap">
            <table id="statusTable">
              <thead>
                <tr>
                  <th>Domain</th>
                  <th>Owner</th>
                  <th>SPF</th>
                  <th>DMARC</th>
                  <th>DKIM s1</th>
                  <th>DKIM s2</th>
                  <th>Checked</th>
                </tr>
              </thead>
              <tbody id="statusRows">
                <tr><td colspan="7" class="muted">Loading domain status...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ADD DOMAIN -->
      <div class="section-title"><span class="icon">‚ûï</span> Register Domain</div>
      <section class="grid full">
        <div class="card">
          <h3>Add Domain to Monitoring</h3>
          <p class="desc">Register a new domain with the robot. We will start tracking its email security status automatically.</p>
          <div class="row">
            <div>
              <label for="add-email">Contact email for this domain</label>
              <input id="add-email" class="mono" placeholder="owner@example.com" type="email"/>
            </div>
            <div>
              <label for="add-domain">Domain name</label>
              <input id="add-domain" class="mono" placeholder="example.com" autocapitalize="off"/>
              <div class="notice hidden" id="add-notice"></div>
            </div>
          </div>
          <div class="btn-row">
            <button class="btn" id="btnAdd">Add Domain</button>
          </div>
          <pre class="log mt-md" id="add-log">Enter domain details above.</pre>

          <details class="mt-md">
            <summary>View registered domains</summary>
            <div id="recentWrap" class="tiny muted">Loading...</div>
          </details>
        </div>
      </section>

      <!-- AUTOMATIC SETUP -->
      <div class="section-title"><span class="icon">‚ö°</span> Automatic Setup</div>
      <section class="grid">
        <div class="card">
          <h3>Cloudflare Integration</h3>
          <p class="desc">If your DNS is managed by Cloudflare, we can configure all records automatically. You will need an API token with Zone Read and DNS Edit permissions.</p>
          <div class="row">
            <div>
              <label for="cf-token">Cloudflare API Token</label>
              <input id="cf-token" class="mono" type="password" placeholder="Paste your API token"/>
            </div>
            <div class="action">
              <button class="btn secondary btn-sm" id="btnCfList">Load Zones</button>
            </div>
          </div>
          <div class="row">
            <div>
              <label for="cf-zones">Select your domain</label>
              <select id="cf-zones"><option value="">Select a zone after loading</option></select>
            </div>
            <div class="action">
              <button class="btn warn btn-sm" id="btnCfProtect">Protect Domain</button>
            </div>
          </div>
          <pre class="log mt-md tiny" id="cf-log">Paste token, then click Load Zones.</pre>

          <details class="mt-md">
            <summary>Manage Control SPF</summary>
            <div>
              <div class="row">
                <button class="btn secondary btn-sm" id="btnSpfLoad">Load Current Value</button>
                <button class="btn secondary btn-sm" id="btnSpfUpdate">Update Value</button>
              </div>
              <div class="row mt-sm">
                <div>
                  <label for="spf-value">SPF Record Value</label>
                  <textarea id="spf-value" class="mono" spellcheck="false" rows="3"></textarea>
                </div>
              </div>
            </div>
          </details>
        </div>

        <div class="card">
          <h3>AWS Route 53 Integration</h3>
          <p class="desc">If your DNS is managed by AWS Route 53, we can configure all records automatically. You will need IAM credentials with Route 53 access.</p>
          <div class="row">
            <div>
              <label for="r53-ak">Access Key ID</label>
              <input id="r53-ak" class="mono" placeholder="AKIA..."/>
            </div>
            <div>
              <label for="r53-sk">Secret Access Key</label>
              <input id="r53-sk" class="mono" type="password" placeholder="Your secret key"/>
            </div>
          </div>
          <div class="row">
            <div>
              <label for="r53-zones">Hosted Zone</label>
              <select id="r53-zones"><option value="">Enter credentials to load zones</option></select>
            </div>
            <div class="action">
              <button class="btn warn btn-sm" id="btnR53Protect">Protect Domain</button>
            </div>
          </div>
          <pre class="log mt-md tiny" id="r53-log">Enter credentials to load zones automatically.</pre>
        </div>
      </section>

      <!-- POLICY MANAGEMENT -->
      <div class="section-title"><span class="icon">üõ°Ô∏è</span> DMARC Policy Management</div>
      <section class="grid full">
        <div class="card">
          <h3>Policy Step-Up</h3>
          <p class="desc">Gradually strengthen your DMARC policy. Start with "none" to monitor, move to "quarantine" to test, then "reject" for full protection.</p>
          <div class="row">
            <div>
              <label for="pol-domain">Domain</label>
              <input id="pol-domain" class="mono" placeholder="example.com"/>
            </div>
            <div class="narrow">
              <label for="pol-policy">Policy</label>
              <select id="pol-policy">
                <option value="none">none (monitor)</option>
                <option value="quarantine">quarantine (spam)</option>
                <option value="reject">reject (block)</option>
              </select>
            </div>
            <div class="narrow">
              <label for="pol-pct">Percentage</label>
              <input id="pol-pct" type="number" min="1" max="100" value="100"/>
            </div>
          </div>
          <div class="row">
            <div class="narrow">
              <label for="pol-adkim">DKIM Alignment</label>
              <select id="pol-adkim"><option value="s">strict</option><option value="r">relaxed</option></select>
            </div>
            <div class="narrow">
              <label for="pol-aspf">SPF Alignment</label>
              <select id="pol-aspf"><option value="s">strict</option><option value="r">relaxed</option></select>
            </div>
            <div>
              <label for="pol-rua">Report Address</label>
              <input id="pol-rua" value="mailto:dmarc@domainsafepro.com"/>
            </div>
          </div>
          <div class="row">
            <div class="narrow">
              <label for="pol-fo">Failure Options</label>
              <input id="pol-fo" value="1"/>
            </div>
            <div>
              <label for="pol-sp">Subdomain Policy (optional)</label>
              <input id="pol-sp" placeholder="Leave blank to inherit"/>
            </div>
          </div>
          <div class="btn-row">
            <button class="btn secondary btn-sm" id="btnPolPreview">Preview Record</button>
            <button class="btn btn-sm" id="btnApplyCf">Apply via Cloudflare</button>
            <button class="btn btn-sm" id="btnApplyR53">Apply via Route 53</button>
            <button class="btn ghost btn-sm" id="btnEvaluateNow">Run Policy Engine</button>
          </div>
          <pre id="pol-out" class="log mt-md tiny">Preview your policy record before applying.</pre>
        </div>
      </section>

      <!-- CENTRAL SPF -->
      <div class="section-title"><span class="icon">üìß</span> Central SPF Management</div>
      <section class="grid full">
        <div class="card">
          <h3>Authorized Senders</h3>
          <p class="desc">Select which email services are authorized to send on behalf of protected domains. Changes apply to all domains using central control.</p>

          <div class="spf-grid">
            <label><input type="checkbox" class="spf-sel" value="google"/> Google Workspace</label>
            <label><input type="checkbox" class="spf-sel" value="m365"/> Microsoft 365</label>
            <label><input type="checkbox" class="spf-sel" value="sendgrid"/> SendGrid</label>
            <label><input type="checkbox" class="spf-sel" value="ses"/> Amazon SES</label>
            <label><input type="checkbox" class="spf-sel" value="mailgun"/> Mailgun</label>
            <label><input type="checkbox" class="spf-sel" value="mailchimp"/> Mailchimp</label>
            <label><input type="checkbox" class="spf-sel" value="postmark"/> Postmark</label>
            <label><input type="checkbox" class="spf-sel" value="sparkpost"/> SparkPost</label>
            <label><input type="checkbox" class="spf-sel" value="zoho"/> Zoho</label>
            <label><input type="checkbox" class="spf-sel" value="zendesk"/> Zendesk</label>
            <label><input type="checkbox" class="spf-sel" value="intercom"/> Intercom</label>
          </div>

          <div class="row">
            <div>
              <label for="spf-preview">Generated SPF Record</label>
              <input id="spf-preview" class="mono" value="v=spf1 ~all" readonly/>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="spf-token">Cloudflare API Token (for domainsafepro.com zone)</label>
              <input id="spf-token" class="mono" type="password" placeholder="Token with DNS edit access"/>
            </div>
          </div>

          <div class="btn-row">
            <button class="btn secondary btn-sm" id="btnSpfLoad2">Load Current</button>
            <button class="btn btn-sm" id="btnSpfUpdate2">Update Central SPF</button>
          </div>
          <pre class="log mt-md tiny" id="spf-log2">Select authorized senders, then update.</pre>
        </div>
      </section>

      <!-- INSIGHTS -->
      <div class="section-title"><span class="icon">üìà</span> DMARC Reports</div>
      <section class="grid full">
        <div class="card">
          <h3>Alignment Insights</h3>
          <p class="desc">View aggregate report data showing how many emails passed authentication checks over the past 7 or 30 days.</p>
          <div class="row">
            <div class="narrow">
              <button class="btn secondary btn-sm" id="btnIngest">Ingest Reports</button>
            </div>
            <div>
              <label for="ins-domain">Domain</label>
              <input id="ins-domain" class="mono" value="domainsafepro.com"/>
            </div>
            <div class="action">
              <button class="btn secondary btn-sm" id="btnLoad7">7 Days</button>
            </div>
            <div class="action">
              <button class="btn secondary btn-sm" id="btnLoad30">30 Days</button>
            </div>
          </div>
          <div id="ins-summary" class="mt-md tiny muted">Select a time range to view data.</div>
          <div class="mt-md table-wrap">
            <table id="ins-table" class="hidden">
              <thead>
                <tr><th>Date</th><th>Total</th><th>Aligned</th><th>Rate</th><th>Trend</th></tr>
              </thead>
              <tbody id="ins-rows"></tbody>
            </table>
          </div>
          <details class="mt-md">
            <summary>View raw data</summary>
            <div><pre id="ins-wrap" class="log tiny">No data loaded.</pre></div>
          </details>
        </div>
      </section>

      <!-- ALERTS -->
      <div class="section-title"><span class="icon">üîî</span> Notifications</div>
      <section class="grid full">
        <div class="card">
          <h3>Alert Management</h3>
          <p class="desc">Test your Slack integration and manage queued notifications.</p>
          <div class="btn-row">
            <button class="btn btn-sm" id="btnAlertTest">Send Test Alert</button>
            <button class="btn secondary btn-sm" id="btnAlertFlush">Flush Queue</button>
          </div>
          <pre class="log mt-md tiny" id="alerts-out">Ready to send alerts.</pre>
        </div>
      </section>

    </div><!-- /admin-content -->
  </div><!-- /admin-section -->

  <footer class="console-footer">
    <a href="https://domainsafepro.com" target="_blank">DomainSafePro</a> | Email Authentication on Autopilot
  </footer>

</main>

<script>
/* ====== Theme Toggle ====== */
function toggleTheme() {
  const html = document.documentElement;
  const current = html.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  try { localStorage.setItem('dsp-theme', next); } catch(e){}
}
(function(){
  try {
    const saved = localStorage.getItem('dsp-theme');
    if (saved) document.documentElement.setAttribute('data-theme', saved);
  } catch(e){}
})();

/* ====== Admin Toggle ====== */
function toggleAdmin() {
  const content = document.getElementById('admin-content');
  const text = document.getElementById('admin-toggle-text');
  const icon = document.getElementById('admin-toggle-icon');
  if (content.classList.contains('visible')) {
    content.classList.remove('visible');
    text.textContent = 'Show admin tools';
    icon.textContent = '‚ñº';
  } else {
    content.classList.add('visible');
    text.textContent = 'Hide admin tools';
    icon.textContent = '‚ñ≤';
  }
}

/* ====== Real endpoints ====== */
const ROBOT_API = "https://domainsafe-robot.pankajonlinerepository.workers.dev";
const DMARC_API = "https://api.domainsafepro.com";
const AUTH_API  = "https://domainsafe-robot.pankajonlinerepository.workers.dev";

/* ====== Tiny helpers ====== */
const $ = function(sel) { return document.querySelector(sel); };
const $$ = function(sel) { return document.querySelectorAll(sel); };
const logEl = function(sel, v) { 
  const el = $(sel); 
  if (!el) return; 
  el.textContent = (typeof v === "string") ? v : JSON.stringify(v, null, 2); 
};
const copy = function(txt) { 
  if (navigator.clipboard) return navigator.clipboard.writeText(txt).catch(function(){}); 
  return Promise.resolve();
};
const show = function(el) { if (el) el.classList.remove('hidden'); };
const hide = function(el) { if (el) el.classList.add('hidden'); };

function sanitizeDomain(raw){
  return (raw||"").trim().toLowerCase()
    .replace(/^https?:\/\//,"")
    .replace(/^mailto:/,"")
    .replace(/\/.*$/,"")
    .replace(/\.$/,"");
}
function isValidHostname(raw){
  const s = sanitizeDomain(raw);
  if (!/^[a-z0-9.-]+\.[a-z]{2,}$/i.test(s)) return false;
  const labels = s.split(".");
  return labels.every(function(lbl) { return lbl.length>0 && lbl.length<=63 && /^[a-z0-9-]+$/i.test(lbl); });
}
function isDomain(s){ return /^[a-z0-9.-]+\.[a-z]{2,}$/i.test(s||""); }
function apexify(raw){
  const s = sanitizeDomain(raw);
  if (!isDomain(s)) return s;
  const parts = s.split(".").filter(Boolean);
  if (parts.length <= 2) return s;
  const cc2 = new Set(["co.uk","com.au","co.in","co.jp","com.br","com.mx","com.sg","com.hk"]);
  const tail2 = parts.slice(-2).join(".");
  const tail3 = parts.slice(-3).join(".");
  return cc2.has(tail2) ? tail3 : tail2;
}
function normalizeForUI(raw, noticeEl, errorEl, opts){
  const options = opts || {};
  const typed = sanitizeDomain(raw);
  if (!isValidHostname(typed)){
    if (errorEl){
      errorEl.textContent = "Please enter a valid domain name (like yourdomain.com)";
      show(errorEl);
    }
    if (noticeEl) hide(noticeEl);
    return { ok:false, value:typed, apex:"", changed:false };
  }
  if (errorEl) hide(errorEl);
  const apex = apexify(typed);
  var value = apex, changed = false;
  if (options.allowExact){
    value = typed;
  } else if (typed !== apex){
    changed = true;
  }
  if (noticeEl){
    if (changed){
      noticeEl.innerHTML = 'We will protect the root domain <span class="mono">'+apex+'</span> to cover all subdomains.';
      show(noticeEl);
    } else {
      hide(noticeEl);
    }
  }
  return { ok:true, value:value, apex:apex, changed:changed, typed:typed };
}

/* ====== HTTP helpers ====== */
async function get(url){
  const r = await fetch(url, {
    method:"GET",
    credentials:"include",
    headers:{ "accept":"application/json" }
  });
  const t = await r.text();
  var j = null;
  try{ j = t ? JSON.parse(t) : null; }catch(e){}
  if (!r.ok){
    const msg = (j && j.error) ? j.error : t || ("HTTP "+r.status);
    throw new Error(msg);
  }
  return j;
}
async function post(url, body){
  const r = await fetch(url, {
    method:"POST",
    credentials:"include",
    headers:{ "content-type":"application/json", "accept":"application/json" },
    body: JSON.stringify(body || {})
  });
  const t = await r.text();
  var j = null;
  try{ j = t ? JSON.parse(t) : null; }catch(e){}
  if (!r.ok){
    const msg = (j && j.error) ? j.error : t || ("HTTP "+r.status);
    throw new Error(msg);
  }
  return j;
}

/* ====== AUTH (Google sign-in) ====== */
async function fetchCurrentUser(){
  try{
    const r = await fetch(AUTH_API + "/api/me", {
      method:"GET",
      credentials:"include",
      headers:{ "accept":"application/json" }
    });
    const t = await r.text();
    var j = null;
    try{ j = t ? JSON.parse(t) : null; }catch(e){ return null; }
    if (!r.ok || !j || j.ok === false || !j.user || !j.user.email) return null;
    return j.user;
  }catch(e){
    return null;
  }
}

function startGoogleLogin(){
  window.location.href = AUTH_API + "/auth/google/start";
}

function showAuthedUI(user){
  document.body.classList.add("authed");
  const label = $("#auth-status-label");
  const loginBtn = $("#auth-login-btn");
  if (label && user && user.email){
    label.textContent = user.email;
  }
  if (loginBtn) {
    loginBtn.textContent = "Sign out";
    loginBtn.onclick = function() {
      document.body.classList.remove("authed");
      showLoggedOutUI();
    };
  }
  const statusRows = $("#statusRows");
  if (statusRows){
    statusRows.innerHTML = '<tr><td colspan="7" class="muted">Loading...</td></tr>';
  }
  loadStatus();
  refreshRecent();
}

function showLoggedOutUI(){
  document.body.classList.remove("authed");
  const label = $("#auth-status-label");
  const loginBtn = $("#auth-login-btn");
  if (label) label.textContent = "Not signed in";
  if (loginBtn) {
    loginBtn.textContent = "Sign in with Google";
    loginBtn.onclick = startGoogleLogin;
  }
  const statusRows = $("#statusRows");
  if (statusRows){
    statusRows.innerHTML = '<tr><td colspan="7" class="muted">Sign in to see your connected domains.</td></tr>';
  }
  const recent = $("#recentWrap");
  if (recent) recent.textContent = "Sign in to see your domains.";
  const addLog = $("#add-log");
  if (addLog) addLog.textContent = "Enter domain details above.";
}

async function initAuth(){
  const btnHeader = $("#auth-login-btn");
  const btnHero   = $("#login-hero-btn");
  if (btnHeader) btnHeader.addEventListener("click", startGoogleLogin);
  if (btnHero)   btnHero.addEventListener("click", startGoogleLogin);

  const user = await fetchCurrentUser();
  if (user) showAuthedUI(user);
  else showLoggedOutUI();
}

/* ====== STATUS & MONITOR ====== */
function pill(ok){
  return ok
    ? '<span class="pill ok">OK</span>'
    : '<span class="pill bad">Needs setup</span>';
}

async function loadStatus(){
  const tb = $("#statusRows");
  if (!tb) return;
  tb.innerHTML = '<tr><td colspan="7" class="muted">Loading...</td></tr>';
  try{
    const j = await get(ROBOT_API + "/api/status");
    const rows = (j && j.rows) ? j.rows : [];
    if (!rows.length){
      tb.innerHTML = '<tr><td colspan="7" class="muted">No domains registered yet. Add your first domain above.</td></tr>';
      return;
    }
    tb.innerHTML = rows.map(function(r) {
      return '<tr>' +
        '<td data-label="Domain" class="mono">'+(r.domain_name||"")+'</td>' +
        '<td data-label="Owner" class="mono tiny">'+(r.email||"")+'</td>' +
        '<td data-label="SPF">'+pill(r.spf_ok)+'</td>' +
        '<td data-label="DMARC">'+pill(r.dmarc_ok)+'</td>' +
        '<td data-label="DKIM s1">'+pill(r.dkim_s1_ok)+'</td>' +
        '<td data-label="DKIM s2">'+pill(r.dkim_s2_ok)+'</td>' +
        '<td data-label="Checked" class="tiny muted">'+(r.checked_at||"")+'</td>' +
      '</tr>';
    }).join("");
  }catch(e){
    tb.innerHTML = '<tr><td colspan="7" class="tiny danger">Could not load status. Please try again.</td></tr>';
  }
}
$("#btnStatus").addEventListener("click", loadStatus);
$("#btnMonitor").addEventListener("click", async function(){
  try{ await post(ROBOT_API + "/api/monitor-run", {}); }catch(e){}
  loadStatus();
});

/* ====== QUICK-CODES (Customer-facing) ====== */
function renderQuickCodes(records, extras) {
  const container = $("#qc-results");
  if (!records || records.length === 0) {
    container.innerHTML = '<p class="muted">No records to display.</p>';
    show(container);
    return;
  }

  function getPurpose(name) {
    if (name.includes('_domainkey')) {
      return name.startsWith('s1') ? 'Email Signature Key 1 (DKIM)' : 'Email Signature Key 2 (DKIM)';
    }
    if (name === '_dmarc' || name.startsWith('_dmarc.')) return 'Email Policy (DMARC)';
    if (name === '@' || name === '') return 'Email Sender Authorization (SPF)';
    if (name === '_smtp._tls') return 'Transport Security Reporting';
    if (name === 'mta-sts') return 'Mail Transfer Security';
    return 'DNS Record';
  }

  function escapeHtml(str) {
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function createCard(r) {
    const typeClass = r.type.toLowerCase() === 'txt' ? 'txt' : 'cname';
    const purpose = getPurpose(r.name);
    const displayName = r.name === '@' ? '@ (root domain)' : escapeHtml(r.name);
    const escapedName = escapeHtml(r.name);
    const escapedValue = escapeHtml(r.value);
    
    return '<div class="qc-card">' +
      '<div class="qc-card-header">' +
        '<span class="qc-type ' + typeClass + '">' + escapeHtml(r.type) + '</span>' +
        '<span class="qc-purpose">' + purpose + '</span>' +
      '</div>' +
      '<div class="qc-field">' +
        '<div class="qc-label">Host / Name</div>' +
        '<div class="qc-value">' +
          '<code>' + displayName + '</code>' +
          '<button class="copy-btn" data-copy="' + escapedName + '">Copy</button>' +
        '</div>' +
      '</div>' +
      '<div class="qc-field">' +
        '<div class="qc-label">Value / Points To</div>' +
        '<div class="qc-value">' +
          '<code>' + escapedValue + '</code>' +
          '<button class="copy-btn" data-copy="' + escapedValue + '">Copy</button>' +
        '</div>' +
      '</div>' +
    '</div>';
  }

  var html = '<div class="qc-cards">';
  records.forEach(function(r) { html += createCard(r); });
  if (extras && extras.length > 0) {
    html += '<div class="mt-md mb-sm"><strong class="tiny muted">ADVANCED SECURITY (OPTIONAL)</strong></div>';
    extras.forEach(function(r) { html += createCard(r); });
  }
  html += '</div>';

  container.innerHTML = html;
  show(container);
  show($("#qc-actions"));
  
  // Add click handlers for copy buttons
  container.querySelectorAll('.copy-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const text = this.getAttribute('data-copy');
      const button = this;
      copy(text).then(function() {
        button.textContent = 'Copied!';
        button.classList.add('copied');
        setTimeout(function() {
          button.textContent = 'Copy';
          button.classList.remove('copied');
        }, 2000);
      });
    });
  });
  
  $("#step1-indicator").classList.add("completed");
}

$("#btnQCodes").addEventListener("click", async function(){
  const norm = normalizeForUI($("#qc-domain").value, $("#qc-notice"), null);
  if (!norm.ok){
    hide($("#qc-results"));
    hide($("#qc-actions"));
    return;
  }
  try{
    const extras = ($("#qc-extras").checked ? "&extras=1" : "");
    const j = await get(ROBOT_API + "/api/quick-codes?domain=" + encodeURIComponent(norm.apex || norm.value) + extras);
    renderQuickCodes(j.records || [], j.extras || []);
    
    $("#verify-domain").value = norm.apex || norm.value;
  }catch(e){
    $("#qc-results").innerHTML = '<p class="danger">Could not generate records: ' + String(e).slice(0,100) + '</p>';
    show($("#qc-results"));
  }
});

$("#btnCopyAll").addEventListener("click", function(){
  const cards = $$("#qc-results .qc-card");
  if (!cards.length) return;
  
  var text = "";
  cards.forEach(function(card) {
    const typeEl = card.querySelector('.qc-type');
    const codeEls = card.querySelectorAll('.qc-value code');
    const type = typeEl ? typeEl.textContent : '';
    const name = codeEls[0] ? codeEls[0].textContent : '';
    const value = codeEls[1] ? codeEls[1].textContent : '';
    text += type + "\t" + name + "\t" + value + "\n";
  });
  
  copy(text).then(function() {
    const btn = $("#btnCopyAll");
    const oldText = btn.textContent;
    btn.textContent = "Copied to clipboard!";
    setTimeout(function() { btn.textContent = oldText; }, 2000);
  });
});

/* ====== VERIFY (Human-readable output) ====== */
function renderVerifyResults(data) {
  const container = $("#verify-results");
  const detailsEl = $("#verify-details");
  
  const checks = data.checks || {};
  const items = [];
  
  const spfOk = checks.spf && checks.spf.present && checks.spf.includes_control;
  items.push({
    label: 'SPF (Sender Authorization)',
    pass: spfOk,
    status: spfOk 
      ? 'Your SPF record is configured correctly and includes our central control.'
      : checks.spf && checks.spf.present 
        ? 'SPF record found, but it does not include our central control yet.'
        : 'No SPF record found. Add the TXT record from Step 1.'
  });
  
  const dkimOk = checks.dkim && checks.dkim.s1 && checks.dkim.s1.present && checks.dkim.s1.points_to_control;
  items.push({
    label: 'DKIM (Email Signatures)',
    pass: dkimOk,
    status: dkimOk
      ? 'Your DKIM records are configured correctly and point to our signing keys.'
      : checks.dkim && checks.dkim.s1 && checks.dkim.s1.present
        ? 'DKIM record found, but it does not point to our control keys yet.'
        : 'No DKIM records found. Add the CNAME records from Step 1.'
  });
  
  const dmarcOk = checks.dmarc && checks.dmarc.present;
  items.push({
    label: 'DMARC (Email Policy)',
    pass: dmarcOk,
    status: dmarcOk
      ? 'Your DMARC policy is active. Policy: ' + (checks.dmarc.policy || 'none')
      : 'No DMARC record found. Add the TXT record from Step 1.'
  });
  
  const allPass = items.every(function(i) { return i.pass; });
  const passCount = items.filter(function(i) { return i.pass; }).length;
  
  var summaryHtml = '';
  if (allPass) {
    summaryHtml = '<div class="verify-summary all-pass">' +
      '<span class="verify-summary-icon">üéâ</span>' +
      '<div class="verify-summary-text">' +
        '<h4>Your domain is protected!</h4>' +
        '<p>All email authentication records are configured correctly.</p>' +
      '</div>' +
    '</div>';
    $("#step3-indicator").classList.add("completed");
  } else {
    summaryHtml = '<div class="verify-summary has-issues">' +
      '<span class="verify-summary-icon">‚ö†Ô∏è</span>' +
      '<div class="verify-summary-text">' +
        '<h4>' + passCount + ' of ' + items.length + ' checks passed</h4>' +
        '<p>Some records still need to be added. See details below.</p>' +
      '</div>' +
    '</div>';
  }
  
  var itemsHtml = items.map(function(item) {
    return '<div class="verify-item">' +
      '<div class="verify-icon ' + (item.pass ? 'pass' : 'fail') + '">' + (item.pass ? '‚úì' : '‚úó') + '</div>' +
      '<div class="verify-content">' +
        '<div class="verify-label">' + item.label + '</div>' +
        '<div class="verify-status ' + (item.pass ? 'pass' : 'fail') + '">' + item.status + '</div>' +
      '</div>' +
    '</div>';
  }).join('');
  
  container.innerHTML = summaryHtml + itemsHtml;
  show(container);
  
  logEl("#verify-log", data);
  show(detailsEl);
}

$("#btnVerify").addEventListener("click", async function(){
  const norm = normalizeForUI($("#verify-domain").value, $("#verify-notice"), null);
  if (!norm.ok){
    hide($("#verify-results"));
    hide($("#verify-details"));
    return;
  }
  
  $("#verify-results").innerHTML = '<div class="verify-summary has-issues"><span class="verify-summary-icon">‚è≥</span><div class="verify-summary-text"><h4>Checking your domain...</h4><p>This may take a few seconds while we query DNS servers.</p></div></div>';
  show($("#verify-results"));
  
  try{
    const j = await get(ROBOT_API + "/api/check-quick-codes?domain=" + encodeURIComponent(norm.apex || norm.value));
    renderVerifyResults(j);
  }catch(e){
    $("#verify-results").innerHTML = '<div class="verify-summary has-issues"><span class="verify-summary-icon">‚ùå</span><div class="verify-summary-text"><h4>Could not verify domain</h4><p>' + String(e).slice(0,150) + '</p></div></div>';
    show($("#verify-results"));
  }
});

/* ====== ADD DOMAIN + RECENT ====== */
async function refreshRecent(){
  const wrap = $("#recentWrap");
  if (!wrap) return;
  try{
    const j = await get(ROBOT_API + "/api/domains");
    const rows = (j && (j.domains || j.rows)) ? (j.domains || j.rows) : [];
    if (!rows.length){
      wrap.textContent = "No domains registered yet.";
      return;
    }
    wrap.innerHTML = rows.slice(0,10).map(function(r) {
      return '<div class="mono" style="margin-bottom:6px">'+(r.domain_name || "")+' <span class="muted">| '+(r.status || "")+(r.created_at ? " | "+r.created_at : "")+'</span></div>';
    }).join("");
  }catch(e){
    wrap.textContent = "Could not load domains.";
  }
}

$("#btnAdd").addEventListener("click", async function(){
  const norm = normalizeForUI($("#add-domain").value, $("#add-notice"), null);
  const email = ($("#add-email").value || "").trim();
  if (!email || !norm.ok){
    $("#add-log").textContent = "Please enter a valid email and domain name.";
    return;
  }
  try{
    const j = await post(ROBOT_API + "/api/domains", {
      email: email,
      domain: norm.apex || norm.value
    });
    logEl("#add-log", j);
    refreshRecent();
  }catch(e){
    logEl("#add-log", String(e));
  }
});

/* ====== CLOUDFLARE ====== */
$("#btnCfList").addEventListener("click", async function(){
  const token = ($("#cf-token").value || "").trim();
  if (!token){
    logEl("#cf-log","Please paste your Cloudflare API token first.");
    return;
  }
  try{
    const j = await post(ROBOT_API + "/api/cf/list-zones", { token: token });
    const sel = $("#cf-zones");
    sel.innerHTML = '<option value="">Select your domain</option>';
    (j.zones || []).forEach(function(z) {
      const o = document.createElement("option");
      o.value = z.id;
      o.textContent = z.name + " (" + (z.status || "") + ")";
      sel.appendChild(o);
    });
    logEl("#cf-log","Loaded " + (j.zones || []).length + " zones. Select your domain above.");
  }catch(e){
    logEl("#cf-log", String(e));
  }
});

$("#btnCfProtect").addEventListener("click", async function(){
  const token = ($("#cf-token").value || "").trim();
  const zone_id = $("#cf-zones").value;
  if (!token || !zone_id){
    logEl("#cf-log","Please load zones and select a domain first.");
    return;
  }
  try{
    const j = await post(ROBOT_API + "/api/cf/protect", { token: token, zone_id: zone_id });
    logEl("#cf-log", j);
    if (j.apex) {
      $("#pol-domain").value = j.apex;
      $("#qc-domain").value = j.apex;
      $("#verify-domain").value = j.apex;
    }
  }catch(e){
    logEl("#cf-log", String(e));
  }
});

$("#btnSpfLoad").addEventListener("click", async function(){
  const token = ($("#cf-token").value || "").trim();
  if (!token){
    logEl("#cf-log","Please paste your Cloudflare API token first.");
    return;
  }
  try{
    const j = await get(ROBOT_API + "/api/cf/control-spf?token=" + encodeURIComponent(token));
    $("#spf-value").value = j.value || "";
    logEl("#cf-log", j);
  }catch(e){
    logEl("#cf-log", String(e));
  }
});

$("#btnSpfUpdate").addEventListener("click", async function(){
  const token = ($("#cf-token").value || "").trim();
  const value = ($("#spf-value").value || "").trim();
  if (!token){
    logEl("#cf-log","Please paste your Cloudflare API token first.");
    return;
  }
  try{
    const j = await post(ROBOT_API + "/api/cf/control-spf", { token: token, value: value });
    logEl("#cf-log", j);
  }catch(e){
    logEl("#cf-log", String(e));
  }
});

/* ====== ROUTE 53 ====== */
async function r53ListZonesIfReady(){
  const access_key_id = ($("#r53-ak").value || "").trim();
  const secret_access_key = ($("#r53-sk").value || "").trim();
  if (!access_key_id || !secret_access_key) return;
  try{
    const j = await post(ROBOT_API + "/api/r53/list-zones", { access_key_id: access_key_id, secret_access_key: secret_access_key });
    const sel = $("#r53-zones");
    sel.innerHTML = '<option value="">Select your hosted zone</option>';
    (j.zones || []).forEach(function(z) {
      const o = document.createElement("option");
      o.value = z.id;
      o.textContent = z.name + " (" + z.id + ")";
      sel.appendChild(o);
    });
    logEl("#r53-log","Loaded " + (j.zones || []).length + " hosted zones.");
  }catch(e){
    logEl("#r53-log", String(e));
  }
}
$("#r53-ak").addEventListener("change", r53ListZonesIfReady);
$("#r53-sk").addEventListener("change", r53ListZonesIfReady);

$("#btnR53Protect").addEventListener("click", async function(){
  const access_key_id = ($("#r53-ak").value || "").trim();
  const secret_access_key = ($("#r53-sk").value || "").trim();
  const hosted_zone_id = $("#r53-zones").value;
  if (!access_key_id || !secret_access_key || !hosted_zone_id){
    logEl("#r53-log","Please enter credentials and select a hosted zone.");
    return;
  }
  try{
    const j = await post(ROBOT_API + "/api/r53/protect", { access_key_id: access_key_id, secret_access_key: secret_access_key, hosted_zone_id: hosted_zone_id });
    logEl("#r53-log", j);
    if (j.apex) {
      $("#pol-domain").value = j.apex;
      $("#qc-domain").value = j.apex;
      $("#verify-domain").value = j.apex;
    }
  }catch(e){
    logEl("#r53-log", String(e));
  }
});

/* ====== POLICY STEP-UP ====== */
$("#btnPolPreview").addEventListener("click", async function(){
  const d = ($("#pol-domain").value || "").trim();
  if (!d){
    logEl("#pol-out","Please enter a domain first.");
    return;
  }
  try{
    const j = await get(ROBOT_API + "/policy/preview?domain=" + encodeURIComponent(d));
    logEl("#pol-out", j);
  }catch(e){
    logEl("#pol-out", String(e));
  }
});

$("#btnApplyCf").addEventListener("click", async function(){
  const body = {
    domain: ($("#pol-domain").value || "").trim(),
    policy: $("#pol-policy").value,
    pct: Number($("#pol-pct").value || 100),
    adkim: $("#pol-adkim").value,
    aspf:  $("#pol-aspf").value,
    rua:   ($("#pol-rua").value || "").trim(),
    fo:    ($("#pol-fo").value || "").trim(),
    sp:    (($("#pol-sp").value || "").trim() || null)
  };
  if (!body.domain){
    logEl("#pol-out","Please enter a domain first.");
    return;
  }
  try{
    const j = await post(ROBOT_API + "/api/policy/dmarc/cf", body);
    logEl("#pol-out", j);
  }catch(e){
    logEl("#pol-out", String(e));
  }
});

$("#btnApplyR53").addEventListener("click", async function(){
  const body = {
    domain: ($("#pol-domain").value || "").trim(),
    policy: $("#pol-policy").value,
    pct: Number($("#pol-pct").value || 100),
    adkim: $("#pol-adkim").value,
    aspf:  $("#pol-aspf").value,
    rua:   ($("#pol-rua").value || "").trim(),
    fo:    ($("#pol-fo").value || "").trim(),
    sp:    (($("#pol-sp").value || "").trim() || null),
    hosted_zone_id: ($("#r53-zones").value || "").trim()
  };
  if (!body.domain){
    logEl("#pol-out","Please enter a domain first.");
    return;
  }
  if (!body.hosted_zone_id){
    logEl("#pol-out","Please select a Route 53 hosted zone first.");
    return;
  }
  try{
    const j = await post(ROBOT_API + "/api/policy/dmarc/r53", body);
    logEl("#pol-out", j);
  }catch(e){
    logEl("#pol-out", String(e));
  }
});

$("#btnEvaluateNow").addEventListener("click", async function(){
  try{
    const j = await get(ROBOT_API + "/policy/evaluate-now");
    logEl("#pol-out", j);
  }catch(e){
    logEl("#pol-out", String(e));
  }
});

/* ====== CONTROL SPF BUILDER ====== */
var SPF_MAP = {
  google:"include:_spf.google.com",
  m365:"include:spf.protection.outlook.com",
  sendgrid:"include:sendgrid.net",
  ses:"include:amazonses.com",
  mailgun:"include:mailgun.org",
  mailchimp:"include:servers.mcsv.net",
  postmark:"include:spf.mtasv.net",
  sparkpost:"include:_spf.sparkpostmail.com",
  zoho:"include:zoho.com",
  zendesk:"include:mail.zendesk.com",
  intercom:"include:_spf.intercom.io"
};

function updateSpfPreview(){
  var sels = [];
  document.querySelectorAll(".spf-sel:checked").forEach(function(cb) {
    if (SPF_MAP[cb.value]) sels.push(SPF_MAP[cb.value]);
  });
  var parts = ["v=spf1"];
  parts = parts.concat(sels);
  parts.push("~all");
  var txt = parts.join(" ");
  var out = $("#spf-preview");
  if (out) out.value = txt;
}
document.querySelectorAll(".spf-sel").forEach(function(cb) { 
  cb.addEventListener("change", updateSpfPreview); 
});

$("#btnSpfLoad2").addEventListener("click", async function(){
  const tok = ($("#spf-token").value || "").trim();
  if (!tok){
    logEl("#spf-log2","Please paste your Cloudflare API token first.");
    return;
  }
  try{
    const j = await get(ROBOT_API + "/api/cf/control-spf?token=" + encodeURIComponent(tok));
    if (j.value) $("#spf-preview").value = j.value;
    logEl("#spf-log2", j);
  }catch(e){
    logEl("#spf-log2", String(e));
  }
});

$("#btnSpfUpdate2").addEventListener("click", async function(){
  const tok = ($("#spf-token").value || "").trim();
  const val = ($("#spf-preview").value || "").trim();
  if (!tok){
    logEl("#spf-log2","Please paste your Cloudflare API token first.");
    return;
  }
  try{
    const j = await post(ROBOT_API + "/api/cf/control-spf", { token: tok, value: val });
    logEl("#spf-log2", j);
  }catch(e){
    logEl("#spf-log2", String(e));
  }
});

/* ====== INSIGHTS ====== */
function fmt(n){ return (n || 0).toLocaleString(); }
function pct(a,b){ var r = (b>0) ? (a/b) : 0; return Math.round(r*1000)/10; }
function asArray(series){
  if (Array.isArray(series)) return series;
  if (series && typeof series === "object"){
    return Object.keys(series).sort().map(function(d) { 
      var obj = {date:d}; 
      for(var k in series[d]) obj[k] = series[d][k];
      return obj;
    });
  }
  return [];
}
function renderRollup(j){
  var rows = asArray(j.series);
  var table = $("#ins-table");
  var body  = $("#ins-rows");
  var summary = $("#ins-summary");
  if (!rows.length){
    hide(table);
    summary.textContent = "No data available for this time range.";
    return;
  }
  var totals = rows.reduce(function(acc,r){
    acc.total += r.total || 0;
    acc.aligned += r.aligned || 0;
    return acc;
  }, {total:0,aligned:0});
  var rate = pct(totals.aligned, totals.total);
  summary.innerHTML = "<strong>"+j.domain+"</strong> over "+j.days+" days: <strong>"+fmt(totals.total)+"</strong> emails, <strong style=\"color:var(--ok)\">"+fmt(totals.aligned)+"</strong> passed authentication (<strong style=\"color:var(--ok)\">"+rate+"%</strong>)";
  body.innerHTML = "";
  rows.forEach(function(r){
    var p = pct(r.aligned || 0, r.total || 0);
    var tr = document.createElement("tr");
    tr.innerHTML =
      '<td data-label="Date" class="mono">'+r.date+'</td>'+
      '<td data-label="Total">'+fmt(r.total || 0)+'</td>'+
      '<td data-label="Aligned">'+fmt(r.aligned || 0)+'</td>'+
      '<td data-label="Rate">'+p+'%</td>'+
      '<td data-label="Trend"><div class="bar"><i style="width:'+Math.min(100,p)+'%"></i></div><div class="tiny muted" style="margin-top:4px">'+
      (r.spf_aligned!=null && r.dkim_aligned!=null ? ("SPF "+fmt(r.spf_aligned)+" / DKIM "+fmt(r.dkim_aligned)) : "")+
      '</div></td>';
    body.appendChild(tr);
  });
  show(table);
}

async function loadRoll(days){
  var norm = normalizeForUI($("#ins-domain").value, null, null);
  if (!norm.ok){
    $("#ins-wrap").textContent = "Please enter a valid domain.";
    return;
  }
  try{
    var j = await get(ROBOT_API + "/api/rollup?domain=" + encodeURIComponent(norm.apex || norm.value) + "&days=" + days);
    $("#ins-wrap").textContent = JSON.stringify(j, null, 2);
    renderRollup({domain: j.domain || (norm.apex || norm.value), days: days, series: j.series || []});
  }catch(e){
    $("#ins-wrap").textContent = String(e);
  }
}

$("#btnLoad7").addEventListener("click", function(){ loadRoll(7); });
$("#btnLoad30").addEventListener("click", function(){ loadRoll(30); });

$("#btnIngest").addEventListener("click", async function(){
  try{
    var j = await post(DMARC_API + "/api/dmarc/ingest-latest", {limit:25});
    $("#ins-wrap").textContent = JSON.stringify(j, null, 2);
  }catch(e){
    $("#ins-wrap").textContent = String(e);
  }
});

/* ====== ALERTS ====== */
$("#btnAlertTest").addEventListener("click", async function(){
  try{
    var j = await post(ROBOT_API + "/alerts/test", {
      domain:"slawitness.com",
      title:"Test alert",
      message:"This is a test from DomainSafe UI."
    });
    logEl("#alerts-out", j);
  }catch(e){
    logEl("#alerts-out", String(e));
  }
});

$("#btnAlertFlush").addEventListener("click", async function(){
  try{
    var j = await post(ROBOT_API + "/alerts/flush", {});
    logEl("#alerts-out", j);
  }catch(e){
    logEl("#alerts-out", String(e));
  }
});

/* ====== Bootstrap ====== */
updateSpfPreview();
initAuth();
</script>
</body>
</html>
