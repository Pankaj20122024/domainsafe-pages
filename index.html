<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DomainSafePro - Setup Your Protection</title>
  <meta name="description" content="Set up email authentication for your domain. Get your DNS records and verify your protection status."/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vollkorn:wght@600&family=Exo+2:wght@600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://rsms.me/">
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">

  <style>
/* ========== TOKENS (matching landing page) ========== */
:root {
  --font-serif: 'Vollkorn', Georgia, serif;
  --font-sans: 'Inter', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  --font-brand: 'Exo 2', sans-serif;
  --font-mono: 'Roboto Mono', 'Fira Code', ui-monospace, monospace;
  --radius: 14px;
  --radius-sm: 8px;
  --maxw: 1100px;
  --fast-transition: 0.15s ease;
  --med-transition: 0.3s ease;
}

[data-theme="dark"] {
  --bg: #0c0c0e;
  --bg-card: #141417;
  --bg-alt: #1a1a1d;
  --bg-input: rgba(0,0,0,0.25);
  --fg: #ededf0;
  --fg-muted: #9496a3;
  --border: rgba(255,255,255,0.1);
  --border-glow: rgba(255,255,255,0.2);
  --brand: #5a81ff;
  --brand-accent: #8a7aff;
  --warn: #ffd36a;
  --ok: #67e8a3;
  --danger: #ff7a7a;
  --shadow-color: rgba(0,0,0,0.3);
  --glass-bg: rgba(20,20,23,0.55);
  --glass-border: rgba(255,255,255,0.12);
  --highlight-bg: rgba(90,129,255,0.08);
  --highlight-border: rgba(90,129,255,0.3);
}

[data-theme="light"] {
  --bg: #fafafa;
  --bg-card: #ffffff;
  --bg-alt: #f5f5f5;
  --bg-input: rgba(0,0,0,0.04);
  --fg: #111113;
  --fg-muted: #55555c;
  --border: rgba(0,0,0,0.1);
  --border-glow: rgba(0,0,0,0.2);
  --brand: #4a75ff;
  --brand-accent: #7a6aff;
  --warn: #f5a623;
  --ok: #28a745;
  --danger: #d9534f;
  --shadow-color: rgba(0,0,0,0.08);
  --glass-bg: rgba(255,255,255,0.6);
  --glass-border: rgba(0,0,0,0.08);
  --highlight-bg: rgba(74,117,255,0.06);
  --highlight-border: rgba(74,117,255,0.25);
}

/* ========== BASE ========== */
* { box-sizing: border-box; }
html { scroll-behavior: smooth; font-feature-settings: 'liga' 1, 'kern' 1; }
html, body { max-width: 100%; overflow-x: clip; }
body {
  margin: 0;
  min-height: 100vh;
  background: linear-gradient(135deg, var(--bg) 0%, var(--bg-alt) 50%, var(--bg) 100%);
  color: var(--fg);
  font-family: var(--font-sans);
  font-size: 17px;
  line-height: 1.7;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  transition: background-color var(--med-transition), color var(--med-transition);
}
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 1000px;
  height: 1000px;
  background: radial-gradient(circle, rgba(90,129,255,0.06) 0%, transparent 70%);
  pointer-events: none;
  z-index: 0;
}

h1, h2, h3, h4 {
  font-family: var(--font-serif);
  color: var(--fg);
  font-weight: 600;
  letter-spacing: -0.01em;
  line-height: 1.3;
  margin: 0;
}
p { color: var(--fg-muted); margin: 0; max-width: 65ch; }
a { text-decoration: none; color: var(--brand); }
code, .mono { font-family: var(--font-mono); font-size: 0.9em; }

/* ========== HEADER ========== */
header {
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  background: var(--glass-bg);
  border-bottom: 1px solid var(--glass-border);
  padding: 16px 20px;
}
.header-inner {
  max-width: var(--maxw);
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 12px;
}
.brand {
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 700;
  font-size: 1.4rem;
  color: var(--fg);
  text-decoration: none;
}
.brand:hover {
  opacity: 0.9;
}
.brand-text {
  font-family: var(--font-brand);
  background: linear-gradient(90deg, #5a81ff 0%, #21E6C1 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.header-tag {
  font-size: 13px;
  color: var(--fg-muted);
  display: none;
}
@media (min-width: 768px) {
  .header-tag { display: block; max-width: 400px; }
}

.auth-bar {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}
#auth-status-label {
  font-size: 13px;
  color: var(--fg-muted);
}

/* Theme toggle */
.theme-toggle {
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-card);
  border: 1px solid var(--border);
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  transition: all var(--fast-transition);
}
.theme-toggle:hover { border-color: var(--border-glow); }
.theme-toggle svg { width: 16px; height: 16px; color: var(--fg-muted); }
[data-theme="dark"] .theme-toggle .sun-icon { display: block; }
[data-theme="dark"] .theme-toggle .moon-icon { display: none; }
[data-theme="light"] .theme-toggle .sun-icon { display: none; }
[data-theme="light"] .theme-toggle .moon-icon { display: block; }

/* ========== BUTTONS ========== */
.btn {
  appearance: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 12px 22px;
  border-radius: 999px;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--fast-transition);
  font-size: 15px;
  font-family: var(--font-sans);
  border: 2px solid var(--brand);
  background: var(--brand);
  color: #fff;
  box-shadow: 0 4px 12px var(--shadow-color);
}
.btn:hover {
  filter: brightness(1.1);
  transform: translateY(-1px);
  box-shadow: 0 6px 18px var(--shadow-color);
}
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; filter: none; }

.btn.secondary, .btn-auth {
  background: var(--glass-bg);
  border: 2px solid var(--glass-border);
  color: var(--fg);
  backdrop-filter: blur(8px);
}
.btn.secondary:hover, .btn-auth:hover {
  background: var(--bg-alt);
  border-color: var(--border-glow);
}

.btn.ghost {
  background: transparent;
  border: 2px solid var(--border);
  color: var(--fg-muted);
}
.btn.ghost:hover {
  border-color: var(--border-glow);
  color: var(--fg);
}

.btn.warn {
  background: linear-gradient(135deg, #ffd36a 0%, #f5a623 100%);
  border-color: #f5a623;
  color: #1a1a1d;
}
.btn.warn:hover {
  filter: brightness(1.05);
}

.btn.large {
  padding: 16px 32px;
  font-size: 1rem;
}

.btn-sm {
  padding: 8px 16px;
  font-size: 13px;
}

/* ========== LOADING SECTION ========== */
#loading-section {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  min-height: 60vh;
}
.loading-card {
  width: 100%;
  max-width: 480px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: var(--radius);
  border: 1px solid var(--glass-border);
  padding: 48px 28px;
  box-shadow: 0 24px 60px var(--shadow-color);
  text-align: center;
  position: relative;
  z-index: 1;
}
.loading-spinner {
  width: 48px;
  height: 48px;
  border: 3px solid var(--border);
  border-top-color: var(--brand);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
.loading-card h2 {
  font-size: 1.5rem;
  margin-bottom: 8px;
}
.loading-card p {
  font-size: 15px;
  color: var(--fg-muted);
  max-width: 320px;
  margin: 0 auto;
}

/* ========== LOGIN SECTION ========== */
#login-section {
  display: none;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  min-height: 60vh;
}
.login-card {
  width: 100%;
  max-width: 480px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: var(--radius);
  border: 1px solid var(--glass-border);
  padding: 32px 28px;
  box-shadow: 0 24px 60px var(--shadow-color);
  text-align: center;
  position: relative;
  z-index: 1;
}
.login-card .eyebrow {
  font-size: 12px;
  color: var(--brand);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-bottom: 8px;
  font-weight: 600;
}
.login-card h2 {
  font-size: 1.75rem;
  margin-bottom: 12px;
}
.login-card p {
  font-size: 15px;
  color: var(--fg-muted);
  margin-bottom: 24px;
  max-width: 360px;
  margin-left: auto;
  margin-right: auto;
}
.login-card .btn { width: 100%; max-width: 280px; }
.login-card .tiny {
  margin-top: 16px;
  font-size: 12px;
  color: var(--fg-muted);
}

/* Checkout success variations */
.login-card .checkout-success-icon {
  font-size: 3rem;
  margin-bottom: 12px;
}
.login-card.checkout-success h2 {
  color: var(--ok);
}
.login-card .checkout-success-msg {
  display: none;
}
.login-card.checkout-success .checkout-success-msg {
  display: block;
}
.login-card.checkout-success .normal-msg {
  display: none;
}

/* Claim subscription form in plan-gate */
.claim-subscription-form {
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid var(--border);
}
.claim-subscription-form h4 {
  font-size: 1rem;
  margin-bottom: 12px;
  color: var(--fg);
}
.claim-subscription-form p {
  font-size: 14px;
  color: var(--fg-muted);
  margin-bottom: 16px;
}
.claim-subscription-form .input-row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}
.claim-subscription-form input[type="email"] {
  flex: 1;
  min-width: 200px;
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: var(--bg-input);
  color: var(--fg);
  font-size: 15px;
}
.claim-subscription-form input[type="email"]:focus {
  outline: none;
  border-color: var(--brand);
}
.claim-subscription-form .btn-claim {
  padding: 10px 20px;
  white-space: nowrap;
}
.claim-subscription-form .claim-status {
  margin-top: 12px;
  font-size: 14px;
  min-height: 20px;
}
.claim-subscription-form .claim-status.error {
  color: var(--danger);
}
.claim-subscription-form .claim-status.success {
  color: var(--ok);
}

body.authed #loading-section { display: none; }
body.authed #login-section { display: none; }
body.authed #app-main { display: block; }
body.logged-out #loading-section { display: none; }
body.logged-out #login-section { display: flex; }
body.logged-out #app-main { display: none; }

/* ========== MAIN CONSOLE ========== */
main {
  max-width: var(--maxw);
  margin: 0 auto;
  padding: 24px 16px 80px;
  position: relative;
  z-index: 1;
}
#app-main { display: none; }

/* Welcome message */
.welcome-banner {
  text-align: center;
  padding: 32px 20px;
  margin-bottom: 24px;
}
.welcome-banner h1 {
  font-size: 1.8rem;
  margin-bottom: 8px;
}
.welcome-banner p {
  font-size: 1.05rem;
  max-width: 500px;
  margin: 0 auto;
}

/* Section titles */
.section-title {
  font-size: 1rem;
  color: var(--fg-muted);
  font-weight: 600;
  margin-bottom: 16px;
  margin-top: 32px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
  font-family: var(--font-sans);
  display: flex;
  align-items: center;
  gap: 10px;
}
.section-title:first-of-type { margin-top: 0; }
.section-title .icon {
  font-size: 1.2rem;
}

/* ========== GRID ========== */
.grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 20px;
  margin-bottom: 24px;
}
@media (min-width: 900px) {
  .grid { grid-template-columns: 1fr 1fr; }
}
.grid.full { grid-template-columns: 1fr; }
.grid.three {
  grid-template-columns: 1fr;
}
@media (min-width: 700px) {
  .grid.three { grid-template-columns: 1fr 1fr 1fr; }
}

/* ========== CARDS ========== */
.card {
  background: var(--glass-bg);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: 0 8px 32px var(--shadow-color);
  transition: border-color var(--fast-transition), box-shadow var(--fast-transition);
}
.card:hover {
  border-color: var(--border-glow);
}
.card h3 {
  font-size: 1.25rem;
  margin: 0 0 8px 0;
  display: flex;
  align-items: center;
  gap: 10px;
}
.card h3 .card-icon {
  font-size: 1.3rem;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
.card h3 .card-icon svg {
  width: 28px;
  height: 28px;
}
.card h3 .card-icon img {
  width: 28px;
  height: 28px;
  object-fit: contain;
}
.card .desc {
  color: var(--fg-muted);
  font-size: 15px;
  margin: 0 0 16px 0;
  line-height: 1.6;
}

/* HIGHLIGHTED CARD (for primary actions) */
.card.highlight {
  border: 2px solid var(--highlight-border);
  background: var(--highlight-bg);
  box-shadow: 0 8px 32px var(--shadow-color), 0 0 0 1px var(--highlight-border);
}
.card.highlight:hover {
  border-color: var(--brand);
}
.card.highlight h3 {
  color: var(--brand);
}

/* ========== ROUTE SELECTION CARDS ========== */
.route-card {
  background: var(--glass-bg);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border: 2px solid var(--glass-border);
  border-radius: var(--radius);
  padding: 24px;
  text-align: center;
  cursor: pointer;
  transition: all var(--fast-transition);
}
.route-card:hover {
  border-color: var(--border-glow);
  transform: translateY(-2px);
}
.route-card.selected {
  border-color: var(--brand);
  background: var(--highlight-bg);
}
.route-card .route-icon {
  width: 64px;
  height: 64px;
  margin: 0 auto 12px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.route-card .route-icon svg {
  width: 100%;
  height: 100%;
}
.route-card .route-icon img {
  width: 64px;
  height: 64px;
  object-fit: contain;
}
.route-card h4 {
  font-family: var(--font-sans);
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 8px;
}
.route-card p {
  font-size: 14px;
  margin: 0;
}
.route-card .route-tag {
  display: inline-block;
  margin-top: 12px;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
}
.route-card .route-tag.auto {
  background: rgba(103,232,163,0.15);
  color: var(--ok);
}
.route-card .route-tag.manual {
  background: rgba(90,129,255,0.15);
  color: var(--brand);
}

/* ========== FORM ELEMENTS ========== */
label {
  display: block;
  font-size: 13px;
  color: var(--fg-muted);
  margin-bottom: 6px;
  font-weight: 500;
}
input, select, textarea {
  width: 100%;
  padding: 12px 14px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--fg);
  border-radius: var(--radius-sm);
  font-size: 1rem;
  font-family: var(--font-sans);
  outline: none;
  transition: border-color var(--fast-transition), box-shadow var(--fast-transition);
}
input:focus, select:focus, textarea:focus {
  border-color: var(--brand);
  box-shadow: 0 0 0 3px rgba(90,129,255,0.15);
}
input.mono, textarea.mono, .mono {
  font-family: var(--font-mono);
  font-size: 14px;
}
textarea { min-height: 100px; resize: vertical; }
select {
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%239496a3' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 36px;
}

/* Checkbox row */
.checkbox-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 12px;
  font-size: 14px;
  color: var(--fg-muted);
}
.checkbox-row input[type="checkbox"] {
  width: auto;
  margin: 0;
}

/* SPF Builder checkboxes */
.spf-checkboxes {
  display: flex;
  flex-wrap: wrap;
  gap: 12px 18px;
  margin-bottom: 16px;
}
.spf-checkboxes label {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: var(--fg);
  cursor: pointer;
  margin-bottom: 0;
}
.spf-checkboxes input[type="checkbox"] {
  width: auto;
  margin: 0;
}

/* Row layouts */
.row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}
.row:last-child { margin-bottom: 0; }
.row > div { flex: 1 1 200px; }
.row > div.narrow { flex: 0 0 140px; }
.row > div.action { flex: 0 0 auto; align-self: flex-end; }

/* Notice banners */
.notice {
  margin-top: 8px;
  padding: 10px 14px;
  background: rgba(90,129,255,0.1);
  border: 1px solid rgba(90,129,255,0.2);
  border-radius: var(--radius-sm);
  color: var(--brand);
  font-size: 13px;
}

/* ========== LOG / OUTPUT AREAS ========== */
.log {
  white-space: pre-wrap;
  word-break: break-word;
  font-family: var(--font-mono);
  font-size: 13px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 14px;
  max-height: 300px;
  overflow-y: auto;
  color: var(--fg-muted);
}
.log:empty::before {
  content: 'Ready.';
  opacity: 0.5;
}

/* ========== VERIFICATION RESULTS (Human-readable) ========== */
.verify-results {
  margin-top: 16px;
}
.verify-item {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 14px 16px;
  background: var(--bg-input);
  border-radius: var(--radius-sm);
  margin-bottom: 10px;
  border: 1px solid var(--border);
}
.verify-item:last-child { margin-bottom: 0; }
.verify-icon {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  flex-shrink: 0;
}
.verify-icon.pass {
  background: rgba(103,232,163,0.15);
  color: var(--ok);
}
.verify-icon.fail {
  background: rgba(255,122,122,0.15);
  color: var(--danger);
}
.verify-icon.warn {
  background: rgba(255,211,106,0.12);
  color: var(--warn);
}
.verify-content {
  flex: 1;
}
.verify-label {
  font-weight: 600;
  color: var(--fg);
  margin-bottom: 2px;
}
.verify-status {
  font-size: 13px;
  color: var(--fg-muted);
}
.verify-status.pass { color: var(--ok); }
.verify-status.fail { color: var(--danger); }

/* Overall status banner */
.verify-summary {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px 20px;
  border-radius: var(--radius-sm);
  margin-bottom: 16px;
}
.verify-summary.all-pass {
  background: rgba(103,232,163,0.1);
  border: 1px solid rgba(103,232,163,0.3);
}
.verify-summary.has-issues {
  background: rgba(255,211,106,0.1);
  border: 1px solid rgba(255,211,106,0.3);
}
.verify-summary-icon {
  font-size: 28px;
}
.verify-summary-text h4 {
  font-family: var(--font-sans);
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 2px;
}
.verify-summary-text p {
  font-size: 14px;
  margin: 0;
}

/* ========== TABLES ========== */
.table-wrap {
  overflow-x: auto;
  margin-top: 16px;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}
th, td {
  padding: 10px 12px;
  text-align: left;
  border-bottom: 1px solid var(--border);
}
th {
  font-weight: 600;
  color: var(--fg-muted);
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
td {
  color: var(--fg);
}
.pill {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
}
.pill.ok {
  background: rgba(103,232,163,0.15);
  color: var(--ok);
}
.pill.warn {
  background: rgba(255,211,106,0.15);
  color: var(--warn);
}
.pill.bad, .pill.danger {
  background: rgba(255,122,122,0.12);
  color: var(--danger);
}

/* Responsive tables */
@media (max-width: 768px) {
  table, thead, tbody, th, td, tr {
    display: block;
  }
  thead tr {
    position: absolute;
    top: -9999px;
    left: -9999px;
  }
  tr {
    margin-bottom: 16px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px;
    background: var(--bg-input);
  }
  td {
    border: none;
    position: relative;
    padding-left: 40%;
    padding-top: 6px;
    padding-bottom: 6px;
  }
  td::before {
    position: absolute;
    top: 6px;
    left: 12px;
    width: 35%;
    padding-right: 10px;
    white-space: nowrap;
    content: attr(data-label);
    font-weight: 600;
    color: var(--fg-muted);
    font-size: 12px;
  }
}

/* ========== DETAILS/SUMMARY ========== */
details {
  margin-top: 16px;
}
summary {
  cursor: pointer;
  font-size: 14px;
  color: var(--brand);
  font-weight: 500;
  padding: 8px 0;
}
summary:hover {
  text-decoration: underline;
}
details[open] summary {
  margin-bottom: 12px;
}

/* ========== QUICK CODES DISPLAY ========== */
.qc-cards {
  display: grid;
  gap: 16px;
  margin-top: 16px;
}
.qc-card {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 16px;
}
.qc-card-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 12px;
}
.qc-type {
  display: inline-block;
  padding: 4px 10px;
  border-radius: var(--radius-sm);
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.qc-type.txt {
  background: rgba(90,129,255,0.15);
  color: var(--brand);
}
.qc-type.cname {
  background: rgba(103,232,163,0.15);
  color: var(--ok);
}
.qc-purpose {
  font-size: 14px;
  color: var(--fg);
  font-weight: 600;
}
.qc-field {
  margin-bottom: 12px;
}
.qc-field:last-child { margin-bottom: 0; }
.qc-label {
  font-size: 11px;
  color: var(--fg-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 6px;
}
.qc-value {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 10px 12px;
}
.qc-value code {
  flex: 1;
  font-family: var(--font-mono);
  font-size: 13px;
  word-break: break-all;
  color: var(--fg);
}
.copy-btn {
  flex-shrink: 0;
  padding: 6px 12px;
  font-size: 12px;
  border-radius: var(--radius-sm);
  background: var(--brand);
  color: #fff;
  border: none;
  cursor: pointer;
  font-weight: 600;
  transition: all var(--fast-transition);
}
.copy-btn:hover { filter: brightness(1.1); }
.copy-btn.copied {
  background: var(--ok);
}

/* ========== SETUP FLOW SECTIONS ========== */
.setup-section {
  display: none;
}
.setup-section.active {
  display: block;
}

/* Simple back navigation */
.back-nav {
  margin-bottom: 16px;
}
.btn-back {
  background: none;
  border: none;
  color: var(--fg-muted);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  padding: 8px 0;
  font-family: var(--font-sans);
  transition: color var(--fast-transition);
}
.btn-back:hover {
  color: var(--fg);
}

/* ========== INSIGHTS SECTION ========== */
.insights-section {
  margin-top: 32px;
  padding-top: 24px;
  border-top: 1px solid var(--border);
}

/* Insights alignment bars */
.ins-bar {
  height: 10px;
  background: var(--border);
  border-radius: 6px;
  overflow: hidden;
  min-width: 100px;
}
.ins-bar > i {
  display: block;
  height: 100%;
  background: var(--ok);
  border-radius: 6px;
}
.ins-stats {
  font-size: 12px;
  color: var(--fg-muted);
  margin-top: 4px;
}
.ins-summary-stat {
  display: inline-block;
  padding: 4px 10px;
  background: var(--bg-input);
  border-radius: var(--radius-sm);
  margin-right: 8px;
  margin-bottom: 8px;
  font-size: 14px;
}
.ins-summary-stat strong {
  color: var(--ok);
}

/* ========== ADMIN SECTION ========== */
.admin-section {
  margin-top: 40px;
  padding-top: 24px;
  border-top: 2px solid var(--border);
}
.admin-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 12px;
}
.admin-header h2 {
  font-size: 1.3rem;
  display: flex;
  align-items: center;
  gap: 10px;
}
.admin-badge {
  font-size: 11px;
  padding: 4px 10px;
  background: rgba(255,211,106,0.15);
  color: var(--warn);
  border-radius: 999px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.admin-toggle {
  font-size: 13px;
  color: var(--fg-muted);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
}
.admin-toggle:hover { color: var(--fg); }
.admin-content {
  display: none;
}
.admin-content.visible {
  display: block;
}

/* ========== UTILITIES ========== */
.tiny { font-size: 12px; }
.muted { color: var(--fg-muted); }
.danger { color: var(--danger); }
.text-center { text-align: center; }
.mt-sm { margin-top: 8px; }
.mt-md { margin-top: 16px; }
.mb-sm { margin-bottom: 8px; }
.mb-md { margin-bottom: 16px; }
.hidden { display: none !important; }

/* Gap between button rows */
.btn-row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 16px;
}

/* ========== DOCS SECTION ========== */
.docs-content {
  font-size: 15px;
  line-height: 1.7;
}
.docs-content strong {
  color: var(--fg);
  display: block;
  margin-top: 16px;
  margin-bottom: 6px;
}
.docs-content strong:first-child { margin-top: 0; }
.docs-content p {
  margin-bottom: 12px;
}
.docs-content .mono {
  background: var(--bg-input);
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 13px;
}

/* ========== MOBILE OPTIMIZATIONS ========== */
@media (max-width: 640px) {
  header { padding: 12px 16px; }
  .header-inner { gap: 8px; }
  .brand { font-size: 1.2rem; gap: 8px; }
  main { padding: 16px 12px 60px; }
  .card { padding: 18px 16px; }
  .card h3 { font-size: 1.1rem; }
  .btn { padding: 10px 18px; font-size: 14px; }
  .btn.large { padding: 14px 24px; font-size: 15px; }
  .row > div { flex: 1 1 100%; }
  .row > div.narrow { flex: 1 1 100%; }
  .row > div.action { width: 100%; }
  .btn-row { flex-direction: column; }
  .btn-row .btn { width: 100%; }
  .login-card { padding: 24px 20px; }
  .login-card h2 { font-size: 1.5rem; }
  .welcome-banner h1 { font-size: 1.5rem; }
  .route-card { padding: 18px 16px; }
  .route-card .route-icon { width: 56px; height: 56px; }
}

/* Touch-friendly tap targets */
@media (max-width: 768px) {
  input, select, textarea {
    font-size: 16px;
    min-height: 48px;
  }
  .btn { min-height: 48px; }
}

/* ========== ANIMATIONS ========== */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.card {
  animation: fadeIn 0.4s ease;
}
@keyframes pulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(90,129,255,0.4); }
  50% { box-shadow: 0 0 0 8px rgba(90,129,255,0); }
}
.card.highlight {
  animation: fadeIn 0.4s ease, pulse 2s ease-in-out 3;
}

/* ========== PROTECTION SUCCESS ANIMATION ========== */
.protection-success-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  animation: fadeInOverlay 0.3s ease forwards;
}
@keyframes fadeInOverlay {
  to { opacity: 1; }
}
.protection-success-card {
  background: var(--bg-card);
  border: 2px solid var(--ok);
  border-radius: var(--radius);
  padding: 48px 56px;
  text-align: center;
  max-width: 480px;
  box-shadow: 0 0 60px rgba(103,232,163,0.3), 0 24px 48px rgba(0,0,0,0.4);
  animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
  transform: scale(0.8);
}
@keyframes popIn {
  to { transform: scale(1); }
}
.protection-shield {
  width: 120px;
  height: 120px;
  margin: 0 auto 24px;
  position: relative;
}
.protection-shield svg {
  width: 100%;
  height: 100%;
  filter: drop-shadow(0 0 20px rgba(103,232,163,0.5));
}
.protection-shield .shield-fill {
  fill: var(--ok);
  opacity: 0;
  animation: shieldFill 0.6s ease 0.3s forwards;
}
.protection-shield .shield-stroke {
  stroke: var(--ok);
  stroke-width: 2;
  fill: none;
  stroke-dasharray: 200;
  stroke-dashoffset: 200;
  animation: shieldDraw 0.6s ease forwards;
}
.protection-shield .checkmark {
  stroke: #fff;
  stroke-width: 3;
  fill: none;
  stroke-linecap: round;
  stroke-linejoin: round;
  stroke-dasharray: 50;
  stroke-dashoffset: 50;
  animation: checkDraw 0.4s ease 0.7s forwards;
}
@keyframes shieldDraw {
  to { stroke-dashoffset: 0; }
}
@keyframes shieldFill {
  to { opacity: 1; }
}
@keyframes checkDraw {
  to { stroke-dashoffset: 0; }
}
.protection-success-card h2 {
  color: var(--ok);
  font-size: 1.75rem;
  margin-bottom: 8px;
  opacity: 0;
  animation: fadeUp 0.4s ease 0.5s forwards;
}
.protection-success-card .protected-domain {
  font-family: var(--font-mono);
  font-size: 1.25rem;
  color: var(--fg);
  background: var(--bg-input);
  padding: 12px 20px;
  border-radius: var(--radius-sm);
  margin: 16px 0;
  opacity: 0;
  animation: fadeUp 0.4s ease 0.6s forwards;
}
.protection-success-card p {
  color: var(--fg-muted);
  font-size: 15px;
  opacity: 0;
  animation: fadeUp 0.4s ease 0.7s forwards;
  max-width: none;
}
.protection-success-card .btn {
  margin-top: 24px;
  opacity: 0;
  animation: fadeUp 0.4s ease 0.8s forwards;
}
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
/* Confetti particles */
.confetti-container {
  position: absolute;
  top: 0;
  left: 50%;
  width: 300px;
  height: 300px;
  margin-left: -150px;
  pointer-events: none;
  overflow: visible;
}
.confetti {
  position: absolute;
  width: 10px;
  height: 10px;
  opacity: 0;
}
.confetti:nth-child(odd) { border-radius: 50%; }
.confetti:nth-child(even) { border-radius: 2px; }

/* ========== PROTECTED DOMAINS LIST ========== */
.protected-domains-section {
  margin-bottom: 24px;
}
.protected-domains-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}
.protected-domains-header h3 {
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  gap: 10px;
}
.protected-domains-count {
  font-size: 14px;
  color: var(--fg-muted);
  background: var(--bg-input);
  padding: 4px 12px;
  border-radius: 999px;
}
.protected-domain-item {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px 20px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  margin-bottom: 10px;
  transition: all var(--fast-transition);
}
.protected-domain-item:hover {
  border-color: var(--border-glow);
}
.protected-domain-item.new-item {
  animation: slideInRight 0.4s ease;
  border-color: var(--ok);
  box-shadow: 0 0 0 1px var(--ok);
}
@keyframes slideInRight {
  from { opacity: 0; transform: translateX(-20px); }
  to { opacity: 1; transform: translateX(0); }
}
.protected-domain-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: rgba(103,232,163,0.15);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--ok);
  font-size: 18px;
  flex-shrink: 0;
}
.protected-domain-info {
  flex: 1;
  min-width: 0;
}
.protected-domain-name {
  font-family: var(--font-mono);
  font-size: 1rem;
  color: var(--fg);
  font-weight: 600;
}
.protected-domain-meta {
  font-size: 12px;
  color: var(--fg-muted);
  margin-top: 2px;
}
.protected-domain-status {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
.protected-domain-badge {
  font-size: 11px;
  padding: 4px 10px;
  border-radius: 999px;
  font-weight: 600;
  text-transform: uppercase;
}
.protected-domain-badge.ok {
  background: rgba(103,232,163,0.15);
  color: var(--ok);
}
.protected-domain-badge.pending {
  background: rgba(255,211,106,0.15);
  color: var(--warn);
}
.protected-domains-empty {
  text-align: center;
  padding: 32px 20px;
  color: var(--fg-muted);
  font-size: 14px;
  background: var(--bg-input);
  border: 1px dashed var(--border);
  border-radius: var(--radius-sm);
}

/* ========== FOOTER ========== */
/* Plan gate card */
#plan-gate {
  margin-bottom: 18px;
}
#plan-gate .desc {
  max-width: 540px;
}

.console-footer {
  text-align: center;
  padding: 24px;
  font-size: 13px;
  color: var(--fg-muted);
  border-top: 1px solid var(--border);
  margin-top: 40px;
}
.console-footer a {
  color: var(--brand);
}
/* ========== SOURCE ANALYSIS SECTION ========== */
.sources-section {
  margin-top: 32px;
  border-top: 1px solid var(--border);
  padding-top: 32px;
}
.sources-section h4 {
  font-size: 1rem;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.sources-summary {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  margin-bottom: 20px;
}
.sources-stat {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 12px 18px;
  min-width: 140px;
}
.sources-stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--fg);
  line-height: 1.2;
}
.sources-stat-label {
  font-size: 12px;
  color: var(--fg-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.source-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 16px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  margin-bottom: 10px;
  transition: border-color var(--fast-transition);
}
.source-row:hover {
  border-color: var(--border-glow);
}
.source-row:last-child {
  margin-bottom: 0;
}
.source-identity {
  flex: 1;
  min-width: 0;
}
.source-identity-name {
  font-weight: 600;
  color: var(--fg);
  margin-bottom: 2px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.source-identity-ip {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--fg-muted);
}
.source-identity-org {
  font-size: 12px;
  color: var(--fg-muted);
}
.source-stats {
  display: flex;
  gap: 24px;
  align-items: center;
  flex-wrap: wrap;
}
.source-stat-item {
  text-align: center;
  min-width: 60px;
}
.source-stat-num {
  font-weight: 600;
  font-size: 1.1rem;
  color: var(--fg);
}
.source-stat-lbl {
  font-size: 11px;
  color: var(--fg-muted);
  text-transform: uppercase;
}
.source-status {
  min-width: 100px;
  text-align: right;
}
.pill.authorized {
  background: rgba(103,232,163,0.15);
  color: var(--ok);
}
.pill.partial {
  background: rgba(255,211,106,0.15);
  color: var(--warn);
}
.pill.misconfigured {
  background: rgba(255,211,106,0.2);
  color: var(--warn);
}
.pill.suspicious {
  background: rgba(255,122,122,0.15);
  color: var(--danger);
}
.source-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--bg-alt);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
}
.source-icon.authorized {
  background: rgba(103,232,163,0.15);
}
.source-icon.suspicious {
  background: rgba(255,122,122,0.15);
}
.source-icon.partial,
.source-icon.misconfigured {
  background: rgba(255,211,106,0.15);
}
.sources-empty {
  padding: 32px;
  text-align: center;
  color: var(--fg-muted);
  background: var(--bg-input);
  border: 1px dashed var(--border);
  border-radius: var(--radius-sm);
}
.sources-loading {
  padding: 24px;
  text-align: center;
  color: var(--fg-muted);
}
@media (max-width: 600px) {
  .source-row {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  .source-stats {
    width: 100%;
    justify-content: space-between;
  }
  .source-status {
    width: 100%;
    text-align: left;
  }
}
/* ========== ENHANCED INSIGHTS STYLES ========== */

/* Hero Metric - The Big Number */
.hero-metric {
  text-align: center;
  padding: 32px 24px;
  background: linear-gradient(135deg, var(--bg-alt) 0%, var(--bg-card) 100%);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  margin-bottom: 24px;
  position: relative;
  overflow: hidden;
}
.hero-metric::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: radial-gradient(circle at 30% 20%, rgba(103,232,163,0.08) 0%, transparent 50%);
  pointer-events: none;
}
.hero-metric-value {
  font-size: 4rem;
  font-weight: 700;
  font-family: var(--font-mono);
  line-height: 1;
  margin-bottom: 8px;
  position: relative;
}
.hero-metric-value.excellent { color: var(--ok); }
.hero-metric-value.good { color: var(--ok); }
.hero-metric-value.fair { color: var(--warn); }
.hero-metric-value.poor { color: var(--danger); }
.hero-metric-label {
  font-size: 14px;
  color: var(--fg-muted);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-bottom: 16px;
}
.hero-metric-domain {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--fg);
  margin-bottom: 4px;
}
.hero-metric-period {
  font-size: 13px;
  color: var(--fg-muted);
}

/* NLG Summary - Natural Language Insight */
.nlg-summary {
  background: var(--highlight-bg);
  border: 1px solid var(--highlight-border);
  border-radius: var(--radius-sm);
  padding: 16px 20px;
  margin-bottom: 20px;
  font-size: 15px;
  line-height: 1.6;
}
.nlg-summary-icon {
  font-size: 20px;
  margin-right: 10px;
  vertical-align: middle;
}
.nlg-summary strong {
  color: var(--fg);
}
.nlg-summary.excellent {
  background: rgba(103,232,163,0.08);
  border-color: rgba(103,232,163,0.25);
}
.nlg-summary.good {
  background: rgba(103,232,163,0.06);
  border-color: rgba(103,232,163,0.2);
}
.nlg-summary.fair {
  background: rgba(255,211,106,0.08);
  border-color: rgba(255,211,106,0.25);
}
.nlg-summary.poor {
  background: rgba(255,122,122,0.08);
  border-color: rgba(255,122,122,0.25);
}

/* History Strip - 30-day visual bar */
.history-strip {
  margin-bottom: 20px;
}
.history-strip-label {
  font-size: 12px;
  color: var(--fg-muted);
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
}
.history-strip-bars {
  display: flex;
  gap: 3px;
  height: 32px;
  align-items: flex-end;
}
.history-bar {
  flex: 1;
  min-width: 6px;
  border-radius: 3px 3px 0 0;
  transition: transform 0.15s ease, opacity 0.15s ease;
  cursor: pointer;
  position: relative;
}
.history-bar:hover {
  transform: scaleY(1.15);
  opacity: 0.85;
}
.history-bar.excellent { background: var(--ok); }
.history-bar.good { background: rgba(103,232,163,0.7); }
.history-bar.fair { background: var(--warn); }
.history-bar.poor { background: var(--danger); }
.history-bar.empty { background: var(--border); height: 4px !important; }
.history-bar-tooltip {
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 6px 10px;
  font-size: 11px;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.15s ease;
  z-index: 10;
  box-shadow: 0 4px 12px var(--shadow-color);
}
.history-bar:hover .history-bar-tooltip {
  opacity: 1;
}

/* Skeleton Loading Screens */
.skeleton {
  background: linear-gradient(90deg, var(--bg-input) 25%, var(--bg-alt) 50%, var(--bg-input) 75%);
  background-size: 200% 100%;
  animation: skeleton-shimmer 1.5s infinite;
  border-radius: var(--radius-sm);
}
@keyframes skeleton-shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
.skeleton-hero {
  height: 180px;
  margin-bottom: 24px;
}
.skeleton-nlg {
  height: 60px;
  margin-bottom: 20px;
}
.skeleton-strip {
  height: 50px;
  margin-bottom: 20px;
}
.skeleton-table {
  height: 200px;
}
.skeleton-row {
  display: flex;
  gap: 12px;
  margin-bottom: 12px;
}
.skeleton-row > div {
  height: 20px;
  background: linear-gradient(90deg, var(--bg-input) 25%, var(--bg-alt) 50%, var(--bg-input) 75%);
  background-size: 200% 100%;
  animation: skeleton-shimmer 1.5s infinite;
  border-radius: 4px;
}
.skeleton-row > div:nth-child(1) { flex: 2; }
.skeleton-row > div:nth-child(2) { flex: 1; }
.skeleton-row > div:nth-child(3) { flex: 1; }

/* Improved Empty States */
.empty-state {
  padding: 48px 32px;
  text-align: center;
  background: var(--bg-input);
  border: 1px dashed var(--border);
  border-radius: var(--radius);
}
.empty-state-icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.7;
}
.empty-state-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--fg);
  margin-bottom: 8px;
}
.empty-state-desc {
  font-size: 14px;
  color: var(--fg-muted);
  max-width: 400px;
  margin: 0 auto 20px;
  line-height: 1.6;
}
.empty-state-hint {
  font-size: 13px;
  color: var(--fg-muted);
  opacity: 0.8;
}
.empty-state-hint strong {
  color: var(--brand);
}

/* Stats Row - for quick metrics */
.stats-row {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  margin-bottom: 20px;
}
.stat-card {
  flex: 1;
  min-width: 120px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 16px;
  text-align: center;
}
.stat-card-value {
  font-size: 1.75rem;
  font-weight: 700;
  font-family: var(--font-mono);
  line-height: 1.2;
  margin-bottom: 4px;
}
.stat-card-label {
  font-size: 11px;
  color: var(--fg-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

/* Responsive adjustments for new components */
@media (max-width: 600px) {
  .hero-metric {
    padding: 24px 16px;
  }
  .hero-metric-value {
    font-size: 3rem;
  }
  .history-strip-bars {
    height: 24px;
    gap: 2px;
  }
  .history-bar {
    min-width: 4px;
  }
  .stats-row {
    gap: 10px;
  }
  .stat-card {
    min-width: 100px;
    padding: 12px;
  }
  .stat-card-value {
    font-size: 1.4rem;
  }
}


  </style>
</head>
<body>

<header>
  <div class="header-inner">
    <a href="https://www.domainsafepro.com" class="brand">
      <span class="brand-text">DomainSafePro</span>
      <span class="header-tag">Setup and manage your email protection</span>
    </a>
    <div class="auth-bar" id="auth-bar">
      <span id="auth-status-label">Not signed in</span>
      <span id="auth-plan-label" class="tiny muted"></span>
      <button class="btn secondary btn-sm btn-auth" id="auth-login-btn" type="button">Sign in with Google</button>
      <button class="theme-toggle" type="button" onclick="toggleTheme()" aria-label="Toggle theme">
        <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
      </button>
    </div>
  </div>
</header>

<!-- Loading state (shown initially while checking auth) -->
<section id="loading-section">
  <div class="loading-card">
    <div class="loading-spinner"></div>
    <h2>Loading...</h2>
    <p>Checking your authentication status</p>
  </div>
</section>

<!-- Login hero (shown when not signed in) -->
<section id="login-section">
  <div class="login-card" id="login-card">
    <div class="eyebrow">DomainSafePro</div>
    <div class="checkout-success-msg">
      <div class="checkout-success-icon">üéâ</div>
      <h2>Payment Successful!</h2>
      <p>Log in with Google to activate your subscription and protect your first domain.</p>
    </div>
    <div class="normal-msg">
      <h2>Welcome Back</h2>
      <p>Sign in with your Google account to set up protection for your domain and manage your email security.</p>
    </div>
    <button class="btn" type="button" id="login-hero-btn">Continue with Google</button>
    <div class="tiny">You will be redirected back here after signing in.</div>
  </div>
</section>

<!-- Main app (hidden until authed) -->
<main id="app-main">

  <div id="plan-gate" class="card highlight hidden">
    <h3><span class="card-icon">üîí</span> Activate Your DomainSafePro Plan</h3>
    <p class="desc">You are signed in as <span id="plan-gate-email" class="mono"></span>, but do not yet have an active DomainSafePro subscription connected to this account.</p>
    <p class="tiny muted mt-sm">Choose a plan to unlock automatic setup (Cloudflare, Route 53) and domain monitoring. Once your purchase is complete, return here with the same Google account to connect your domain.</p>
    <div class="row mt-sm">
      <div class="action">
        <a class="btn" href="https://www.domainsafepro.com/#pricing">View plans on main site</a>
      </div>
    </div>
    <div class="claim-subscription-form" id="claim-subscription-form">
      <h4>Already purchased? Link your subscription</h4>
      <p>If you used a different email at checkout, enter it below to link your subscription to this Google account.</p>
      <div class="input-row">
        <input type="email" id="claim-email" placeholder="Email used at checkout" autocomplete="email" />
        <button class="btn secondary btn-claim" id="btn-claim-subscription" type="button">Link Subscription</button>
      </div>
      <div class="claim-status" id="claim-status"></div>
    </div>
  </div>

  <!-- Protected Domains List -->
  <div id="protected-domains-section" class="protected-domains-section hidden">
    <div class="protected-domains-header">
      <h3>üõ°Ô∏è Protected Domains</h3>
      <span class="protected-domains-count" id="protected-count">0 domains</span>
    </div>
    <div id="protected-domains-list">
      <div class="protected-domains-empty">
        No domains protected yet. Choose your DNS provider below to get started.
      </div>
    </div>
  </div>

  <!-- Protection Success Overlay (hidden by default) -->
  <div id="protection-success-overlay" class="protection-success-overlay" style="display:none;">
    <div class="protection-success-card">
      <div class="confetti-container" id="confetti-container"></div>
      <div class="protection-shield">
        <svg viewBox="0 0 64 64">
          <path class="shield-stroke" d="M32 4 L56 14 L56 30 C56 46 32 60 32 60 C32 60 8 46 8 30 L8 14 L32 4 Z"/>
          <path class="shield-fill" d="M32 4 L56 14 L56 30 C56 46 32 60 32 60 C32 60 8 46 8 30 L8 14 L32 4 Z"/>
          <polyline class="checkmark" points="20,32 28,40 44,24"/>
        </svg>
      </div>
      <h2>Domain Protected!</h2>
      <div class="protected-domain" id="success-domain-name">yourdomain.com</div>
      <p>Your email authentication records have been configured. Your domain is now protected against spoofing and impersonation.</p>
      <button class="btn" onclick="closeProtectionSuccess()">Continue Setup</button>
    </div>
  </div>


  <!-- Welcome banner -->
  <div class="welcome-banner">
    <h1>Where Is Your DNS Hosted?</h1>
    <p>Your domain's DNS is managed by one provider. Select yours below to get started.</p>
  </div>

  <!-- ROUTE SELECTION -->
  <section class="grid three" id="route-selection">
    <div class="route-card" data-route="cloudflare" onclick="selectRoute('cloudflare')">
      <div class="route-icon">
        <img src="https://res.cloudinary.com/dxwuwbmjd/image/upload/v1764174230/cloudflare_transparent_cci2hq.png" alt=""/>
      </div>
      <h4>Cloudflare</h4>
      <p>I manage my DNS through Cloudflare.</p>
      <span class="route-tag auto">Automatic Setup</span>
    </div>
    <div class="route-card" data-route="route53" onclick="selectRoute('route53')">
      <div class="route-icon">
        <img src="https://res.cloudinary.com/dxwuwbmjd/image/upload/v1764174236/ChatGPT_Image_Nov_26_2025_09_03_47_PM_yjbzqf.png" alt=""/>
      </div>
      <h4>AWS Route 53</h4>
      <p>I manage my DNS through AWS.</p>
      <span class="route-tag auto">Automatic Setup</span>
    </div>
    <div class="route-card" data-route="manual" onclick="selectRoute('manual')">
      <div class="route-icon">
        <img src="https://res.cloudinary.com/dxwuwbmjd/image/upload/v1764176078/ChatGPT_Image_Nov_26_2025_10_24_10_PM_xcgbrm.png" alt=""/>
      </div>
      <h4>Other Provider</h4>
      <p>GoDaddy, Namecheap, Google Domains, or another registrar.</p>
      <span class="route-tag manual">Copy-Paste Setup</span>
    </div>
  </section>

  <!-- ========== CLOUDFLARE SETUP FLOW ========== -->
  <div id="setup-cloudflare" class="setup-section">
    <div class="back-nav">
      <button class="btn-back" onclick="selectRoute(null)">‚Üê Back</button>
    </div>

    <section class="grid full">
      <div class="card highlight">
        <h3>
          <span class="card-icon">
            <img src="https://res.cloudinary.com/dxwuwbmjd/image/upload/v1764174230/cloudflare_transparent_cci2hq.png" alt="" style="width:28px;height:28px;object-fit:contain;"/>
          </span>
          Connect Your Cloudflare Account
        </h3>
        <p class="desc">Paste your Cloudflare API token below and we will automatically configure all your email security records. You need a token with "Zone Read" and "DNS Edit" permissions.</p>
        
        <div class="row">
          <div>
            <label for="cf-token">Cloudflare API Token</label>
            <input id="cf-token" class="mono" type="password" placeholder="Paste your API token here" autocomplete="off"/>
          </div>
          <div class="action">
            <button class="btn secondary" id="btnCfList">Load My Domains</button>
          </div>
        </div>
        
        <div class="row">
          <div>
            <label for="cf-zones">Select your domain</label>
            <select id="cf-zones"><option value="">First, load your domains above</option></select>
          </div>
          <div class="action">
            <button class="btn large" id="btnCfProtect">Protect This Domain</button>
          </div>
        </div>
        
        <pre class="log mt-md" id="cf-log">Paste your API token and click "Load My Domains" to get started.</pre>

        <details class="mt-md">
          <summary>How do I get a Cloudflare API token?</summary>
          <div class="docs-content">
            <p>1. Log in to your Cloudflare dashboard</p>
            <p>2. Go to "My Profile" (top right) then "API Tokens"</p>
            <p>3. Click "Create Token"</p>
            <p>4. Use the "Edit zone DNS" template</p>
            <p>5. Under "Zone Resources", select the zones you want to protect</p>
            <p>6. Click "Continue to summary" then "Create Token"</p>
            <p>7. Copy the token and paste it above</p>
          </div>
        </details>
      </div>
    </section>
  </div>

  <!-- ========== ROUTE 53 SETUP FLOW ========== -->
  <div id="setup-route53" class="setup-section">
    <div class="back-nav">
      <button class="btn-back" onclick="selectRoute(null)">‚Üê Back</button>
    </div>

    <section class="grid full">
      <div class="card highlight">
        <h3>
          <span class="card-icon">
            <img src="https://res.cloudinary.com/dxwuwbmjd/image/upload/v1764174236/ChatGPT_Image_Nov_26_2025_09_03_47_PM_yjbzqf.png" alt="" style="width:28px;height:28px;object-fit:contain;"/>
          </span>
          Connect Your AWS Account
        </h3>
        <p class="desc">Enter your AWS IAM credentials below and we will automatically configure all your email security records. You need an IAM user with Route 53 access.</p>
        
        <div class="row">
          <div>
            <label for="r53-ak">Access Key ID</label>
            <input id="r53-ak" class="mono" placeholder="AKIA..." autocomplete="off"/>
          </div>
          <div>
            <label for="r53-sk">Secret Access Key</label>
            <input id="r53-sk" class="mono" type="password" placeholder="Your secret key" autocomplete="off"/>
          </div>
        </div>
        
        <div class="row">
          <div>
            <label for="r53-zones">Select your hosted zone</label>
            <select id="r53-zones"><option value="">Enter credentials to load zones</option></select>
          </div>
          <div class="action">
            <button class="btn large" id="btnR53Protect">Protect This Domain</button>
          </div>
        </div>
        
        <pre class="log mt-md" id="r53-log">Enter your AWS credentials. Zones will load automatically.</pre>

        <details class="mt-md">
          <summary>How do I get AWS IAM credentials?</summary>
          <div class="docs-content">
            <p>1. Log in to your AWS Console</p>
            <p>2. Go to IAM (Identity and Access Management)</p>
            <p>3. Create a new user or use an existing one</p>
            <p>4. Attach the "AmazonRoute53FullAccess" policy</p>
            <p>5. Go to "Security credentials" and create an access key</p>
            <p>6. Copy both the Access Key ID and Secret Access Key</p>
          </div>
        </details>
      </div>
    </section>
  </div>

  <!-- ========== MANUAL DNS SETUP FLOW ========== -->
  <div id="setup-manual" class="setup-section">
    <div class="back-nav">
      <button class="btn-back" onclick="selectRoute(null)">‚Üê Back</button>
    </div>

    <!-- STEP 1: GET YOUR CODES -->
    <section class="grid full">
      <div class="card highlight">
        <h3><span class="card-icon">üìã</span> Step 1: Get Your DNS Records</h3>
        <p class="desc">Enter your domain below and we will generate the DNS records you need. Then copy each record and add it at your domain registrar.</p>
        
        <div class="row">
          <div>
            <label for="qc-domain">Your domain name</label>
            <input id="qc-domain" class="mono" placeholder="yourdomain.com" autocapitalize="off" autocorrect="off" spellcheck="false"/>
            <div class="notice hidden" id="qc-notice"></div>
          </div>
          <div class="action">
            <button class="btn large" id="btnQCodes">Generate My Records</button>
          </div>
        </div>
        
        <div class="checkbox-row">
          <input type="checkbox" id="qc-extras"/>
          <label for="qc-extras" style="margin:0">Include advanced security records (MTA-STS and TLS reporting)</label>
        </div>

        <div id="qc-results" class="hidden"></div>
        
        <div id="qc-actions" class="btn-row hidden">
          <button class="btn secondary btn-sm" id="btnCopyAll">Copy All as Text</button>
        </div>
      </div>
    </section>

    <!-- STEP 2: Instructions -->
    <section class="grid full">
      <div class="card">
        <h3><span class="card-icon">üìù</span> Step 2: Add Records to Your DNS</h3>
        <p class="desc">Log in to your domain registrar and add each record from Step 1. Here is what to look for:</p>
        
        <div class="docs-content">
          <strong>Where to add these records</strong>
          <p>Go to your domain registrar (the company where you bought your domain) and find the DNS settings. Common places include: "DNS Management", "DNS Records", or "Zone Editor".</p>
          
          <strong>Adding TXT records</strong>
          <p>For TXT records, create a new record with the "Host" (or "Name") and "Value" exactly as shown. The Host field is usually just the prefix like <code>_dmarc</code>, not the full domain.</p>
          
          <strong>Adding CNAME records</strong>
          <p>For CNAME records, the "Points to" or "Value" field should be the target address we provide. Some registrars add your domain automatically, so just enter the prefix.</p>
          
          <strong style="color:var(--warn)">‚ö†Ô∏è Important: Check for existing records first!</strong>
          <p>Before adding new records, check if your domain already has SPF or DMARC records. Having duplicate records causes problems:</p>
          <p style="margin-left:16px">‚Ä¢ If you see an existing <code>TXT</code> record at <code>@</code> starting with <code>v=spf1</code>, <strong>delete it first</strong> or edit it to match our new value.</p>
          <p style="margin-left:16px">‚Ä¢ If you see an existing <code>TXT</code> record at <code>_dmarc</code> starting with <code>v=DMARC1</code>, <strong>delete it first</strong>. You can only have one DMARC record.</p>
          <p style="margin-left:16px">‚Ä¢ GoDaddy, Namecheap, and other registrars sometimes add default records ‚Äî remove those before adding ours.</p>
          
          <strong>When will it work?</strong>
          <p>DNS changes can take 15-60 minutes to spread across the internet. If verification fails at first, wait and try again.</p>
        </div>
      </div>
    </section>

    <!-- STEP 3: Mark as Protected -->
    <section class="grid full" id="manual-step3-section" style="display:none;">
      <div class="card highlight">
        <h3><span class="card-icon">‚úÖ</span> Step 3: Confirm Your Protection</h3>
        <p class="desc">Once you have added all the DNS records from Step 1, click the button below to register your domain and verify the setup.</p>
        
        <div class="verify-summary has-issues" style="background:rgba(90,129,255,0.1);border-color:rgba(90,129,255,0.3);margin-bottom:16px;">
          <span class="verify-summary-icon">‚è±Ô∏è</span>
          <div class="verify-summary-text">
            <h4 style="font-family:var(--font-sans);">Wait 15-30 minutes after adding records</h4>
            <p>DNS changes take time to propagate across the internet. If verification fails, wait a bit and try again.</p>
          </div>
        </div>
        
        <div id="manual-protected-domain" class="mono" style="font-size:1.1rem;color:var(--fg);margin-bottom:16px;"></div>
        
        <button class="btn large" id="btnManualProtect">üõ°Ô∏è I've Added My Records ‚Äî Protect My Domain</button>
        
        <div id="manual-protect-status" class="mt-md hidden"></div>
      </div>
    </section>
  </div>

  <!-- ========== VERIFY SETUP (Always visible after route selected) ========== -->
  <div id="verify-section" class="setup-section">
    <section class="grid full">
      <div class="card highlight">
        <h3><span class="card-icon"><img src="https://res.cloudinary.com/dxwuwbmjd/image/upload/v1764246818/ChatGPT_Image_Nov_27_2025_06_03_10_PM_bny5wa.png" alt="Verify" style="width:28px;height:28px;object-fit:contain;vertical-align:middle;"/></span> Verify Your Setup</h3>
        <p class="desc">Check if your domain's email protection is configured correctly. We will test each record and tell you if anything needs attention.</p>
        
        <div class="row">
          <div>
            <label for="verify-domain">Domain to verify</label>
            <input id="verify-domain" class="mono" placeholder="yourdomain.com" autocapitalize="off" autocorrect="off" spellcheck="false"/>
            <div class="notice hidden" id="verify-notice"></div>
          </div>
          <div class="action">
            <button class="btn large" id="btnVerify">Verify My Setup</button>
          </div>
        </div>
        
        <div id="verify-results" class="verify-results hidden"></div>
        
        <details class="hidden" id="verify-details">
          <summary>View technical details</summary>
          <div>
            <pre id="verify-log" class="log tiny">Waiting for verification...</pre>
          </div>
        </details>
      </div>
    </section>
  </div>

  <!-- HELP SECTION (Always visible) -->
  <section class="grid full" id="help-section">
    <div class="card">
      <h3><span class="card-icon"><img src="https://res.cloudinary.com/dxwuwbmjd/image/upload/v1764246383/ChatGPT_Image_Nov_27_2025_05_55_21_PM_pypkve.png" alt="Help" style="width:28px;height:28px;object-fit:contain;vertical-align:middle;"/></span> Need Help?</h3>
      <div class="docs-content">
        <strong>Not sure which DNS provider you use?</strong>
        <p>Your DNS is typically managed by whoever you registered your domain with (like GoDaddy, Namecheap), or by a service you pointed your nameservers to (like Cloudflare or AWS). Check your domain registrar's settings if unsure.</p>
        
        <strong>Already protected but showing errors?</strong>
        <p>If you set up protection through Cloudflare or Route 53 but verification shows issues, wait a few minutes for DNS to propagate and try again.</p>
      </div>
    </div>
  </section>

    <!-- ========== DMARC INSIGHTS (User-visible for active plans) ========== -->
  <div class="insights-section" id="insights-section">
    <section class="grid full">
      <div class="card">
        <h3><span class="card-icon"><img src="https://res.cloudinary.com/dxwuwbmjd/image/upload/v1764245049/ChatGPT_Image_Nov_27_2025_03_14_25_PM_dk1wwb.png" alt="Insights" style="width:28px;height:28px;object-fit:contain;vertical-align:middle;"/></span> Email Authentication Insights</h3>
        <p class="desc">See how well your outgoing emails are authenticating. Higher alignment means better protection against impersonation.</p>
        
        <div class="row">
          <div>
            <label for="ins-domain">Your domain</label>
            <input id="ins-domain" class="mono" placeholder="yourdomain.com" autocapitalize="off"/>
          </div>
          <div class="action">
            <button class="btn secondary btn-sm" id="btnLoad7">Last 7 Days</button>
          </div>
          <div class="action">
            <button class="btn secondary btn-sm" id="btnLoad30">Last 30 Days</button>
          </div>
        </div>
        
        <!-- Skeleton loading state (hidden by default) -->
        <div id="ins-skeleton" class="mt-md hidden">
          <div class="skeleton skeleton-hero"></div>
          <div class="skeleton skeleton-nlg"></div>
          <div class="skeleton skeleton-strip"></div>
          <div class="skeleton-row"><div></div><div></div><div></div></div>
          <div class="skeleton-row"><div></div><div></div><div></div></div>
          <div class="skeleton-row"><div></div><div></div><div></div></div>
        </div>
        
        <!-- Initial empty state -->
        <div id="ins-empty" class="mt-md">
          <div class="empty-state">
            <div class="empty-state-icon"><img src="https://res.cloudinary.com/dxwuwbmjd/image/upload/v1764246399/ChatGPT_Image_Nov_27_2025_02_56_26_PM_d3n4dr.png" alt="Analyze" style="width:48px;height:48px;object-fit:contain;"/></div>
            <div class="empty-state-title">Ready to analyze your domain</div>
            <div class="empty-state-desc">
              Enter your domain name above and select a time range to see how well your emails are authenticating.
            </div>
            <div class="empty-state-hint">
              <strong>Tip:</strong> Start with "Last 30 Days" for a comprehensive view
            </div>
          </div>
        </div>
        
        <!-- Results container (hidden until data loads) -->
        <div id="ins-results" class="mt-md hidden">
          <!-- Hero metric - The big percentage -->
          <div id="ins-hero" class="hero-metric">
            <div class="hero-metric-domain" id="ins-hero-domain">‚Äî</div>
            <div class="hero-metric-value" id="ins-hero-value">‚Äî</div>
            <div class="hero-metric-label">Authentication Rate</div>
            <div class="hero-metric-period" id="ins-hero-period">‚Äî</div>
          </div>
          
          <!-- NLG Summary - Natural language interpretation -->
          <div id="ins-nlg" class="nlg-summary">
            <span class="nlg-summary-icon">üí°</span>
            <span id="ins-nlg-text">Loading insights...</span>
          </div>
          
          <!-- History strip - 30 colored bars -->
          <div id="ins-history" class="history-strip">
            <div class="history-strip-label">
              <span>Daily Authentication History</span>
              <span id="ins-history-range">‚Äî</span>
            </div>
            <div class="history-strip-bars" id="ins-history-bars"></div>
          </div>
          
          <!-- Quick stats row -->
          <div class="stats-row" id="ins-stats-row">
            <div class="stat-card">
              <div class="stat-card-value" id="ins-stat-total">‚Äî</div>
              <div class="stat-card-label">Total Emails</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-value" style="color:var(--ok)" id="ins-stat-auth">‚Äî</div>
              <div class="stat-card-label">Authenticated</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-value" style="color:var(--danger)" id="ins-stat-fail">‚Äî</div>
              <div class="stat-card-label">Failed</div>
            </div>
          </div>
        </div>
        
        <!-- Traditional table (still available) -->
        <div class="table-wrap">
          <table id="ins-table" style="display:none">
            <thead>
              <tr>
                <th>Date</th>
                <th>Emails Sent</th>
                <th>Authenticated</th>
                <th>Protection</th>
                <th style="min-width:140px">Status</th>
              </tr>
            </thead>
            <tbody id="ins-rows"></tbody>
          </table>
        </div>
        
        <div id="ins-explainer" class="docs-content mt-md hidden">
          <strong>What does this mean?</strong>
          <p><b>Authenticated emails</b> passed both SPF and DKIM checks, proving they really came from your authorized servers. Unauthenticated emails may be legitimate services you haven't added yet, or could be someone impersonating your domain.</p>
          <p><b>97%+ alignment</b> is excellent. Below 90% suggests you may have services sending email that aren't properly configured, or potential spoofing attempts.</p>
        </div>
        
        <details class="mt-md">
          <summary>View raw API response</summary>
          <div>
            <pre id="ins-wrap" class="log tiny">‚Äî</pre>
          </div>
        </details>

        <!-- ========== WHO'S SENDING AS YOUR DOMAIN (Source Analysis) ========== -->
        <div class="sources-section" id="sources-section">
          <h4><span><img src="https://res.cloudinary.com/dxwuwbmjd/image/upload/v1764246390/ChatGPT_Image_Nov_27_2025_03_01_18_PM_q6r0lx.png" alt="" style="width:24px;height:24px;object-fit:contain;vertical-align:middle;margin-right:6px;"/></span> Who's Sending As Your Domain</h4>
          <p class="desc" style="margin-bottom:16px">See every server that has sent email claiming to be from your domain. Identify legitimate senders vs potential impersonators.</p>
          
          <div class="btn-row" style="margin-bottom:16px">
            <button class="btn secondary btn-sm" id="btnSources7">Load Sources (7 Days)</button>
            <button class="btn secondary btn-sm" id="btnSources30">Load Sources (30 Days)</button>
          </div>
          
          <div id="sources-summary" class="sources-summary hidden"></div>
          
          <div id="sources-list">
            <div class="empty-state">
              <div class="empty-state-icon"><img src="https://res.cloudinary.com/dxwuwbmjd/image/upload/v1764246390/ChatGPT_Image_Nov_27_2025_03_01_18_PM_q6r0lx.png" alt="Source" style="width:48px;height:48px;object-fit:contain;"/></div>
              <div class="empty-state-title">Source analysis ready</div>
              <div class="empty-state-desc">
                Click a button above to see which servers have been sending email as your domain.
              </div>
              <div class="empty-state-hint">
                We'll show you authorized senders, partial matches, and any suspicious activity.
              </div>
            </div>
          </div>
          
          <div id="sources-explainer" class="docs-content mt-md hidden">
            <strong>Understanding the status badges</strong>
            <p><b>Authorized</b> (green) ‚Äî This sender passed both SPF and DKIM checks. They are properly configured and trusted.</p>
            <p><b>Partial</b> (yellow) ‚Äî This sender passed some checks but not all. They may need configuration fixes.</p>
            <p><b>Misconfigured</b> (orange) ‚Äî This sender failed most checks. Usually a legitimate service that needs proper setup.</p>
            <p><b>Suspicious</b> (red) ‚Äî This sender failed all authentication. Could be a spoofing attempt or severely misconfigured service. Investigate immediately.</p>
          </div>
          
          <details class="mt-md">
            <summary>View raw sources API response</summary>
            <div>
              <pre id="sources-wrap" class="log tiny">‚Äî</pre>
            </div>
          </details>
        </div>

      </div>
    </section>
  </div>


  <!-- ============================================================ -->
  <!-- ADMIN / OWNER SECTION (Collapsible) -->
  <!-- ============================================================ -->
  <div class="admin-section" id="admin-section">
    <div class="admin-header">
      <h2><span>üîß</span> Admin Tools</h2>
      <div class="admin-toggle" id="admin-toggle" onclick="toggleAdmin()">
        <span id="admin-toggle-text">Show admin tools</span>
        <span id="admin-toggle-icon">‚ñº</span>
      </div>
    </div>

    <div class="admin-content" id="admin-content">

      <!-- DOMAIN STATUS -->
      <div class="section-title"><span class="icon">üìä</span> Connected Domains</div>
      <section class="grid full">
        <div class="card">
          <h3>Domain Health Dashboard</h3>
          <p class="desc">All domains under your account with their current protection status. The robot checks these automatically every day.</p>
          <div class="btn-row">
            <button class="btn btn-sm" id="btnStatus">Refresh Status</button>
            <button class="btn btn-sm secondary" id="btnMonitor">Run Check Now</button>
          </div>
          <div class="mt-md table-wrap">
            <table id="statusTable">
              <thead>
                <tr>
                  <th>Domain</th>
                  <th>Owner</th>
                  <th>SPF</th>
                  <th>DMARC</th>
                  <th>DKIM s1</th>
                  <th>DKIM s2</th>
                  <th>Checked</th>
                </tr>
              </thead>
              <tbody id="statusRows">
                <tr><td colspan="7" class="muted">Loading domain status...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ADD DOMAIN -->
      <div class="section-title"><span class="icon">‚ûï</span> Register Domain</div>
      <section class="grid full">
        <div class="card">
          <h3>Add Domain to Monitoring</h3>
          <p class="desc">Register a new domain with the robot. We will start tracking its email security status automatically.</p>
          <div class="row">
            <div>
              <label for="add-email">Contact email for this domain</label>
              <input id="add-email" class="mono" placeholder="owner@example.com" type="email"/>
            </div>
            <div>
              <label for="add-domain">Domain name</label>
              <input id="add-domain" class="mono" placeholder="example.com" autocapitalize="off"/>
              <div class="notice hidden" id="add-notice"></div>
            </div>
          </div>
          <div class="btn-row">
            <button class="btn" id="btnAdd">Add Domain</button>
          </div>
          <pre class="log mt-md" id="add-log">Enter domain details above.</pre>

          <details class="mt-md">
            <summary>View registered domains</summary>
            <div id="recentWrap" class="tiny muted">Loading...</div>
          </details>
        </div>
      </section>

      <!-- DMARC POLICY STEP-UP -->
      <div class="section-title"><span class="icon">üìà</span> DMARC Policy Step-Up</div>
      <section class="grid full">
        <div class="card">
          <h3>Adjust DMARC Policy</h3>
          <p class="desc">Progress from monitoring (<code>p=none</code>) to quarantine to full rejection. Start safe, then tighten as alignment improves.</p>
          
          <div class="row">
            <div>
              <label for="pol-domain">Domain</label>
              <input id="pol-domain" class="mono" placeholder="example.com"/>
            </div>
            <div class="narrow">
              <label for="pol-policy">Policy</label>
              <select id="pol-policy">
                <option value="none">none (monitor)</option>
                <option value="quarantine">quarantine</option>
                <option value="reject">reject</option>
              </select>
            </div>
            <div class="narrow">
              <label for="pol-pct">Percentage</label>
              <input id="pol-pct" type="number" min="1" max="100" value="100"/>
            </div>
          </div>
          
          <div class="row">
            <div class="narrow">
              <label for="pol-adkim">DKIM Alignment</label>
              <select id="pol-adkim">
                <option value="r">relaxed (r)</option>
                <option value="s">strict (s)</option>
              </select>
            </div>
            <div class="narrow">
              <label for="pol-aspf">SPF Alignment</label>
              <select id="pol-aspf">
                <option value="r">relaxed (r)</option>
                <option value="s">strict (s)</option>
              </select>
            </div>
            <div>
              <label for="pol-rua">Report URI (rua)</label>
              <input id="pol-rua" class="mono" value="mailto:dmarc@domainsafepro.com"/>
            </div>
          </div>
          
          <div class="row">
            <div class="narrow">
              <label for="pol-fo">Failure Options (fo)</label>
              <input id="pol-fo" value="1"/>
            </div>
            <div>
              <label for="pol-sp">Subdomain Policy (sp, optional)</label>
              <input id="pol-sp" placeholder="leave blank to inherit"/>
            </div>
          </div>
          
          <div class="btn-row">
            <button class="btn secondary btn-sm" id="btnPolPreview">Preview Policy</button>
            <button class="btn btn-sm" id="btnApplyCf">Apply via Cloudflare</button>
            <button class="btn btn-sm" id="btnApplyR53">Apply via Route 53</button>
            <button class="btn secondary btn-sm" id="btnEvaluateNow">Evaluate Engine</button>
          </div>
          
          <pre class="log mt-md" id="pol-out">Use Preview to see the generated DMARC record, then Apply via your DNS provider.</pre>
        </div>
      </section>

      <!-- CONTROL SPF BUILDER -->
      <div class="section-title"><span class="icon">üõ†Ô∏è</span> Control SPF (Central Include)</div>
      <section class="grid full">
        <div class="card">
          <h3>SPF Sender Builder</h3>
          <p class="desc">Select authorized email senders and update <code>_spf.control.domainsafepro.com</code>. All protected domains inherit this central include automatically.</p>
          
          <div class="spf-checkboxes">
            <label><input type="checkbox" class="spf-sel" value="google"/> Google Workspace</label>
            <label><input type="checkbox" class="spf-sel" value="m365"/> Microsoft 365</label>
            <label><input type="checkbox" class="spf-sel" value="sendgrid"/> SendGrid</label>
            <label><input type="checkbox" class="spf-sel" value="ses"/> Amazon SES</label>
            <label><input type="checkbox" class="spf-sel" value="mailgun"/> Mailgun</label>
            <label><input type="checkbox" class="spf-sel" value="mailchimp"/> Mailchimp</label>
            <label><input type="checkbox" class="spf-sel" value="postmark"/> Postmark</label>
            <label><input type="checkbox" class="spf-sel" value="sparkpost"/> SparkPost</label>
            <label><input type="checkbox" class="spf-sel" value="zoho"/> Zoho</label>
            <label><input type="checkbox" class="spf-sel" value="zendesk"/> Zendesk</label>
            <label><input type="checkbox" class="spf-sel" value="intercom"/> Intercom</label>
          </div>
          
          <div class="row">
            <div>
              <label for="spf-preview">Generated SPF Record</label>
              <input id="spf-preview" class="mono" value="v=spf1 ~all" readonly/>
            </div>
          </div>
          
          <div class="row">
            <div>
              <label for="spf-token">Cloudflare API Token (for domainsafepro.com zone)</label>
              <input id="spf-token" class="mono" type="password" placeholder="Paste token here"/>
            </div>
          </div>
          
          <div class="btn-row">
            <button class="btn secondary btn-sm" id="btnSpfLoad2">Load Current</button>
            <button class="btn btn-sm" id="btnSpfUpdate2">Update Control SPF</button>
          </div>
          
          <pre class="log mt-md" id="spf-log2">Select senders above, then click "Update Control SPF" to apply.</pre>
        </div>
      </section>

      <!-- INGEST REPORTS -->
      <div class="section-title"><span class="icon">üì•</span> Report Ingestion</div>
      <section class="grid full">
        <div class="card">
          <h3>DMARC Report Pipeline</h3>
          <p class="desc">DMARC aggregate reports are processed automatically. The Robot's <code>/ingest/daily</code> endpoint receives parsed data from the ingestion pipeline.</p>
          
          <div class="docs-content">
            <strong>How it works</strong>
            <p>Email providers (Google, Microsoft, etc.) send DMARC aggregate reports to the <code>rua</code> address. A background job parses these XMLs and pushes daily summaries to the Robot, which stores them in the <code>dmarc_daily</code> table.</p>
            
            <strong>Manual ingestion</strong>
            <p>To manually push data, send a POST to <code>/ingest/daily</code> with the <code>x-ingest-key</code> header:</p>
          </div>
          
          <pre class="log mt-md" id="ingest-log">{
  "domain": "example.com",
  "date": "2025-01-15",
  "total": 1234,
  "aligned": 1200,
  "spf_aligned": 1180,
  "dkim_aligned": 1195
}</pre>
          
          <div class="btn-row">
            <button class="btn btn-sm secondary" id="btnIngestTest">Test /ingest/daily Endpoint</button>
          </div>
        </div>
      </section>

      <!-- ALERTS -->
      <div class="section-title"><span class="icon">üîî</span> Alerts</div>
      <section class="grid full">
        <div class="card">
          <h3>Slack Notifications</h3>
          <p class="desc">Test the alert system and flush any queued notifications.</p>
          
          <div class="btn-row">
            <button class="btn btn-sm" id="btnAlertTest">Send Test Alert</button>
            <button class="btn secondary btn-sm" id="btnAlertFlush">Flush Alert Queue</button>
          </div>
          
          <pre class="log mt-md" id="alerts-out">‚Äî</pre>
        </div>
      </section>

      <!-- API DEBUG -->
      <div class="section-title"><span class="icon">üîç</span> API Diagnostics</div>
      <section class="grid full">
        <div class="card">
          <h3>Test API Endpoints</h3>
          <p class="desc">Check which endpoints are reachable. This helps diagnose "Failed to fetch" errors.</p>
          
          <div class="btn-row">
            <button class="btn btn-sm secondary" id="btnTestAll">Test All Endpoints</button>
          </div>
          
          <pre class="log mt-md" id="debug-log">Click "Test All Endpoints" to check API connectivity.</pre>
        </div>
      </section>

    </div><!-- /admin-content -->
  </div><!-- /admin-section -->

  <footer class="console-footer">
    <a href="https://domainsafepro.com" target="_blank">DomainSafePro</a> | Email Authentication on Autopilot
  </footer>

</main>

<script>
/* ====== Theme Toggle ====== */
function toggleTheme() {
  var html = document.documentElement;
  var current = html.getAttribute('data-theme');
  var next = current === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  try { localStorage.setItem('dsp-theme', next); } catch(e){}
}
(function(){
  try {
    var saved = localStorage.getItem('dsp-theme');
    if (saved) document.documentElement.setAttribute('data-theme', saved);
  } catch(e){}
})();

/* ====== Admin Toggle ====== */
function toggleAdmin() {
  var content = document.getElementById('admin-content');
  var text = document.getElementById('admin-toggle-text');
  var icon = document.getElementById('admin-toggle-icon');
  if (content.classList.contains('visible')) {
    content.classList.remove('visible');
    text.textContent = 'Show admin tools';
    icon.textContent = '‚ñº';
  } else {
    content.classList.add('visible');
    text.textContent = 'Hide admin tools';
    icon.textContent = '‚ñ≤';
  }
}

/* ====== Route Selection ====== */
var currentRoute = null;
var protectedDomains = []; // Track all protected domains across routes

function selectRoute(route) {
  currentRoute = route;
  
  // Update card selection states
  var cards = document.querySelectorAll('.route-card');
  cards.forEach(function(card) {
    if (card.getAttribute('data-route') === route) {
      card.classList.add('selected');
    } else {
      card.classList.remove('selected');
    }
  });
  
  // Show/hide appropriate sections
  var cfSection = document.getElementById('setup-cloudflare');
  var r53Section = document.getElementById('setup-route53');
  var manualSection = document.getElementById('setup-manual');
  var verifySection = document.getElementById('verify-section');
  var routeSelection = document.getElementById('route-selection');
  var helpSection = document.getElementById('help-section');
  var insightsSection = document.getElementById('insights-section');
  
  // Reset all
  cfSection.classList.remove('active');
  r53Section.classList.remove('active');
  manualSection.classList.remove('active');
  verifySection.classList.remove('active');
  
  if (route === null) {
    // Show route selection, show insights on main page
    routeSelection.style.display = '';
    helpSection.style.display = '';
    if (insightsSection) insightsSection.classList.remove('hidden');
    return;
  }
  
  // Hide route selection once a route is chosen
  routeSelection.style.display = 'none';
  
  // IMPORTANT: Hide insights during setup - user should focus on protection task only
  // Insights belong on the dashboard AFTER protection, not during setup
  if (insightsSection) insightsSection.classList.add('hidden');
  
  if (route === 'cloudflare') {
    cfSection.classList.add('active');
    verifySection.classList.add('active');
  } else if (route === 'route53') {
    r53Section.classList.add('active');
    verifySection.classList.add('active');
  } else if (route === 'manual') {
    manualSection.classList.add('active');
    verifySection.classList.add('active');
  }
}

/* ====== Protection Success Animation ====== */
function createConfetti() {
  var container = document.getElementById('confetti-container');
  if (!container) return;
  container.innerHTML = '';
  var colors = ['#67e8a3', '#5a81ff', '#ffd36a', '#ff7a7a', '#8a7aff', '#21E6C1'];
  
  for (var i = 0; i < 50; i++) {
    var confetti = document.createElement('div');
    confetti.className = 'confetti';
    var x = Math.random() * 300;
    var delay = Math.random() * 0.5;
    var duration = 1 + Math.random();
    var endX = (Math.random() - 0.5) * 200;
    var rotation = Math.random() * 720;
    
    confetti.style.cssText = 'left:' + x + 'px;top:50%;background:' + colors[Math.floor(Math.random() * colors.length)] + ';' +
      'animation:confetti' + i + ' ' + duration + 's ease-out ' + delay + 's forwards;';
    
    // Create unique keyframe for each confetti
    var style = document.createElement('style');
    style.textContent = '@keyframes confetti' + i + ' { 0% { opacity: 1; transform: translateY(0) rotate(0deg); } 100% { opacity: 0; transform: translateY(-150px) translateX(' + endX + 'px) rotate(' + rotation + 'deg); } }';
    document.head.appendChild(style);
    
    container.appendChild(confetti);
  }
}

function showProtectionSuccess(domain, route) {
  var overlay = document.getElementById('protection-success-overlay');
  var domainEl = document.getElementById('success-domain-name');
  if (domainEl) domainEl.textContent = domain;
  if (overlay) {
    overlay.style.display = 'flex';
    createConfetti();
  }
  // Add to protected domains list
  addProtectedDomain(domain, route);
}

function closeProtectionSuccess() {
  var overlay = document.getElementById('protection-success-overlay');
  if (overlay) {
    overlay.style.opacity = '0';
    setTimeout(function() {
      overlay.style.display = 'none';
      overlay.style.opacity = '';
    }, 300);
  }
}

function addProtectedDomain(domain, route) {
  // Check if already protected
  var exists = protectedDomains.some(function(d) { return d.domain === domain; });
  if (exists) return;
  
  protectedDomains.push({
    domain: domain,
    route: route,
    timestamp: new Date().toISOString(),
    isNew: true
  });
  
  updateProtectedDomainsList();
  updateDomainCounter();
  
  // Remove "new" flag after animation
  setTimeout(function() {
    protectedDomains.forEach(function(d) { d.isNew = false; });
    updateProtectedDomainsList();
  }, 3000);
}

function isDomainAlreadyProtected(domain) {
  return protectedDomains.some(function(d) { return d.domain === domain; });
}

function updateProtectedDomainsList() {
  var section = document.getElementById('protected-domains-section');
  var list = document.getElementById('protected-domains-list');
  var countEl = document.getElementById('protected-count');
  
  if (!protectedDomains.length) {
    if (section) section.classList.add('hidden');
    return;
  }
  
  if (section) section.classList.remove('hidden');
  if (countEl) countEl.textContent = protectedDomains.length + ' domain' + (protectedDomains.length === 1 ? '' : 's');
  
  var routeIcons = {
    cloudflare: '‚òÅÔ∏è',
    route53: 'üî∂',
    manual: 'üìù'
  };
  var routeNames = {
    cloudflare: 'Cloudflare',
    route53: 'AWS Route 53',
    manual: 'Manual DNS'
  };
  
  var html = protectedDomains.map(function(d) {
    var date = new Date(d.timestamp);
    var dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    return '<div class="protected-domain-item' + (d.isNew ? ' new-item' : '') + '">' +
      '<div class="protected-domain-icon">üõ°Ô∏è</div>' +
      '<div class="protected-domain-info">' +
        '<div class="protected-domain-name">' + d.domain + '</div>' +
        '<div class="protected-domain-meta">' + routeIcons[d.route] + ' ' + routeNames[d.route] + ' ¬∑ Protected ' + dateStr + '</div>' +
      '</div>' +
      '<div class="protected-domain-status">' +
        '<span class="protected-domain-badge ok">Protected</span>' +
      '</div>' +
    '</div>';
  }).join('');
  
  if (list) list.innerHTML = html;
}

function updateDomainCounter() {
  var planLabel = document.getElementById('auth-plan-label');
  if (!planLabel) return;
  
  var text = planLabel.textContent || '';
  var count = protectedDomains.length;
  
  // Update domains count in the label
  if (text.indexOf('Domains:') > -1) {
    // Extract max if present (e.g., "Domains: 0/5")
    var maxMatch = text.match(/Domains:\s*\d+\/(\d+)/);
    var max = maxMatch ? maxMatch[1] : null;
    
    if (max) {
      var newText = text.replace(/Domains:\s*\d+\/\d+/, 'Domains: ' + count + '/' + max);
      planLabel.textContent = newText;
    } else {
      var newText = text.replace(/Domains:\s*\d+\+?/, 'Domains: ' + count + '+');
      planLabel.textContent = newText;
    }
  }
  
  // Also update the protected domains count badge
  var countEl = document.getElementById('protected-count');
  if (countEl) {
    countEl.textContent = count + ' domain' + (count === 1 ? '' : 's');
  }
}

/* ====== Real endpoints ====== */
var ROBOT_API = "https://domainsafe-robot.pankajonlinerepository.workers.dev";
var DMARC_API = "https://api.domainsafepro.com";
var AUTH_API  = "https://domainsafe-robot.pankajonlinerepository.workers.dev";

/* ====== Tiny helpers ====== */
var $ = function(sel) { return document.querySelector(sel); };
var $$ = function(sel) { return document.querySelectorAll(sel); };
var logEl = function(sel, v) { 
  var el = $(sel); 
  if (!el) return; 
  el.textContent = (typeof v === "string") ? v : JSON.stringify(v, null, 2); 
};
var copy = function(txt) { 
  if (navigator.clipboard) return navigator.clipboard.writeText(txt).catch(function(){}); 
  return Promise.resolve();
};
var show = function(el) { if (el) el.classList.remove('hidden'); };
var hide = function(el) { if (el) el.classList.add('hidden'); };

function sanitizeDomain(raw){
  return (raw||"").trim().toLowerCase()
    .replace(/^https?:\/\//,"")
    .replace(/^mailto:/,"")
    .replace(/\/.*$/,"")
    .replace(/\.$/,"");
}
function isValidHostname(raw){
  var s = sanitizeDomain(raw);
  if (!/^[a-z0-9.-]+\.[a-z]{2,}$/i.test(s)) return false;
  var labels = s.split(".");
  return labels.every(function(lbl) { return lbl.length>0 && lbl.length<=63 && /^[a-z0-9-]+$/i.test(lbl); });
}
function isDomain(s){ return /^[a-z0-9.-]+\.[a-z]{2,}$/i.test(s||""); }
function apexify(raw){
  var s = sanitizeDomain(raw);
  if (!isDomain(s)) return s;
  var parts = s.split(".").filter(Boolean);
  if (parts.length <= 2) return s;
  var cc2 = ["co.uk","com.au","co.in","co.jp","com.br","com.mx","com.sg","com.hk"];
  var tail2 = parts.slice(-2).join(".");
  var tail3 = parts.slice(-3).join(".");
  return cc2.indexOf(tail2) >= 0 ? tail3 : tail2;
}
function normalizeForUI(raw, noticeEl, errorEl, opts){
  var options = opts || {};
  var typed = sanitizeDomain(raw);
  if (!isValidHostname(typed)){
    if (errorEl){
      errorEl.textContent = "Please enter a valid domain name (like yourdomain.com)";
      show(errorEl);
    }
    if (noticeEl) hide(noticeEl);
    return { ok:false, value:typed, apex:"", changed:false };
  }
  if (errorEl) hide(errorEl);
  var apex = apexify(typed);
  var value = apex, changed = false;
  if (options.allowExact){
    value = typed;
  } else if (typed !== apex){
    changed = true;
  }
  if (noticeEl){
    if (changed){
      noticeEl.innerHTML = 'We will protect the root domain <span class="mono">'+apex+'</span> to cover all subdomains.';
      show(noticeEl);
    } else {
      hide(noticeEl);
    }
  }
  return { ok:true, value:value, apex:apex, changed:changed, typed:typed };
}

/* ====== HTTP helpers ====== */
async function get(url){
  var r = await fetch(url, {
    method:"GET",
    credentials:"include",
    headers:{ "accept":"application/json" }
  });
  var t = await r.text();
  var j = null;
  try{ j = t ? JSON.parse(t) : null; }catch(e){}
  if (!r.ok){
    var msg = (j && j.error) ? j.error : t || ("HTTP "+r.status);
    throw new Error(msg);
  }
  return j;
}
async function post(url, body){
  var r = await fetch(url, {
    method:"POST",
    credentials:"include",
    headers:{ "content-type":"application/json", "accept":"application/json" },
    body: JSON.stringify(body || {})
  });
  var t = await r.text();
  var j = null;
  try{ j = t ? JSON.parse(t) : null; }catch(e){}
  if (!r.ok){
    var msg = (j && j.error) ? j.error : t || ("HTTP "+r.status);
    throw new Error(msg);
  }
  return j;
}

/* ====== AUTH (Google sign-in) ====== */
async function fetchCurrentUser(){
  try{
    var r = await fetch(AUTH_API + "/api/me", {
      method:"GET",
      credentials:"include",
      headers:{ "accept":"application/json" }
    });
    var t = await r.text();
    var j = null;
    try{ j = t ? JSON.parse(t) : null; }catch(e){ return null; }
    if (!r.ok || !j || j.ok === false || !j.user || !j.user.email) return null;
    return j.user;
  }catch(e){
    return null;
  }
}

function startGoogleLogin(){
  window.location.href = AUTH_API + "/auth/google/start";
}

function applyPlanGate(user){
  var gate = $("#plan-gate");
  var gateEmail = $("#plan-gate-email");
  var welcomeBanner = $(".welcome-banner");
  var routeSelection = $("#route-selection");
  var cfSetup = $("#setup-cloudflare");
  var r53Setup = $("#setup-route53");
  var manualSetup = $("#setup-manual");
  var helpSection = $("#help-section");
  var insightsSection = $("#insights-section");
  var protectedSection = $("#protected-domains-section");
  var adminSection = document.getElementById("admin-section");

  var email = user && user.email ? String(user.email) : "";
  var plan = user && user.plan ? user.plan : null;
  var lower = email.toLowerCase();
  var isAdminFront = (lower === "pankajonlinerepository@gmail.com" || lower === "ops@domainsafepro.com");
  var hasActivePlan = !!(plan && plan.status === "active");

  if (gateEmail && email){
    gateEmail.textContent = email;
  }

  // Sections visible to users with active plans (or admins)
  var userSections = [welcomeBanner, routeSelection, cfSetup, r53Setup, manualSetup, helpSection, insightsSection, protectedSection];

  if (hasActivePlan || isAdminFront) {
    if (gate) gate.classList.add("hidden");
    userSections.forEach(function(el){ if (el) el.classList.remove("hidden"); });
  } else {
    if (gate) gate.classList.remove("hidden");
    userSections.forEach(function(el){ if (el) el.classList.add("hidden"); });
  }

  // Admin section only visible for admin users
  if (isAdminFront && adminSection) {
    adminSection.classList.remove("hidden");
  } else if (adminSection) {
    adminSection.classList.add("hidden");
  }
}

function showAuthedUI(user){
  document.body.classList.remove("logged-out");
  document.body.classList.add("authed");
  var label = $("#auth-status-label");
  var planLabel = $("#auth-plan-label");
  var loginBtn = $("#auth-login-btn");
  if (label && user && user.email){
    label.textContent = user.email;
  }
  if (planLabel){
    if (user && user.plan && user.plan.code){
      var plan = user.plan;
      var parts = [];
      parts.push("Plan: " + String(plan.code));
      if (typeof plan.domains_used === "number" && (plan.max_domains === null || typeof plan.max_domains === "number")){
        var used = plan.domains_used;
        var max = plan.max_domains;
        if (max === null){
          parts.push("Domains: " + used + "+");
        } else {
          parts.push("Domains: " + used + "/" + max);
        }
      }
      if (plan.valid_until){
        parts.push("Until: " + String(plan.valid_until).slice(0,10));
      }
      planLabel.textContent = parts.join(" ¬∑ ");
      planLabel.classList.remove("hidden");
    } else {
      planLabel.textContent = "";
      planLabel.classList.add("hidden");
    }
  }
  if (loginBtn) {
    loginBtn.textContent = "Sign out";
    loginBtn.onclick = function() {
      // Redirect to Robot's logout endpoint which clears the session cookie and redirects to landing page
      window.location.href = "https://domainsafe-robot.pankajonlinerepository.workers.dev/auth/logout";
    };
  }
  applyPlanGate(user);
  var statusRows = $("#statusRows");
  if (statusRows){
    statusRows.innerHTML = '<tr><td colspan="7" class="muted">Loading...</td></tr>';
  }
  var addEmail = $("#add-email");
  if (addEmail && user && user.email){
    addEmail.value = user.email;
  }
  loadStatus();
  refreshRecent();
}

function showLoggedOutUI(){
  document.body.classList.remove("authed");
  document.body.classList.add("logged-out");
  var label = $("#auth-status-label");
  var planLabel = $("#auth-plan-label");
  var loginBtn = $("#auth-login-btn");
  if (label) label.textContent = "Not signed in";
  if (planLabel){
    planLabel.textContent = "";
    planLabel.classList.add("hidden");
  }
  if (loginBtn) {
    loginBtn.textContent = "Sign in with Google";
    loginBtn.onclick = startGoogleLogin;
  }
  var statusRows = $("#statusRows");
  if (statusRows){
    statusRows.innerHTML = '<tr><td colspan="7" class="muted">Sign in to see your connected domains.</td></tr>';
  }
  var recent = $("#recentWrap");
  if (recent) recent.textContent = "Sign in to see your domains.";
  var addEmail = $("#add-email");
  if (addEmail) addEmail.value = "";
  var addLog = $("#add-log");
  if (addLog) addLog.textContent = "Enter domain details above.";
}

async function initAuth(){
  var btnHeader = $("#auth-login-btn");
  var btnHero   = $("#login-hero-btn");
  if (btnHeader) btnHeader.addEventListener("click", startGoogleLogin);
  if (btnHero)   btnHero.addEventListener("click", startGoogleLogin);

  // Show loading state initially (already shown by default)
  // Now fetch user
  var user = await fetchCurrentUser();
  
  // Hide loading and show appropriate UI
  if (user) {
    showAuthedUI(user);
  } else {
    showLoggedOutUI();
  }
}

/* ====== STATUS & MONITOR ====== */
function pill(ok){
  return ok
    ? '<span class="pill ok">OK</span>'
    : '<span class="pill bad">Needs setup</span>';
}

async function loadStatus(){
  var tb = $("#statusRows");
  if (!tb) return;
  tb.innerHTML = '<tr><td colspan="7" class="muted">Loading...</td></tr>';
  try{
    var j = await get(ROBOT_API + "/api/status");
    var rows = (j && j.rows) ? j.rows : [];
    if (!rows.length){
      tb.innerHTML = '<tr><td colspan="7" class="muted">No domains registered yet. Add your first domain above.</td></tr>';
      return;
    }
    tb.innerHTML = rows.map(function(r) {
      return '<tr>' +
        '<td data-label="Domain" class="mono">'+(r.domain_name||"")+'</td>' +
        '<td data-label="Owner" class="mono tiny">'+(r.email||"")+'</td>' +
        '<td data-label="SPF">'+pill(r.spf_ok)+'</td>' +
        '<td data-label="DMARC">'+pill(r.dmarc_ok)+'</td>' +
        '<td data-label="DKIM s1">'+pill(r.dkim_s1_ok)+'</td>' +
        '<td data-label="DKIM s2">'+pill(r.dkim_s2_ok)+'</td>' +
        '<td data-label="Checked" class="tiny muted">'+(r.checked_at||"")+'</td>' +
      '</tr>';
    }).join("");
  }catch(e){
    tb.innerHTML = '<tr><td colspan="7" class="tiny danger">Could not load status. Please try again.</td></tr>';
  }
}
$("#btnStatus").addEventListener("click", loadStatus);
$("#btnMonitor").addEventListener("click", async function(){
  try{ await post(ROBOT_API + "/api/monitor-run", {}); }catch(e){}
  loadStatus();
});

/* ====== QUICK-CODES (Customer-facing) ====== */
function renderQuickCodes(records, extras) {
  var container = $("#qc-results");
  if (!records || records.length === 0) {
    container.innerHTML = '<p class="muted">No records to display.</p>';
    show(container);
    return;
  }

  function getPurpose(name) {
    if (name.indexOf('_domainkey') >= 0) {
      return name.indexOf('s1') === 0 ? 'Email Signature Key 1 (DKIM)' : 'Email Signature Key 2 (DKIM)';
    }
    if (name === '_dmarc' || name.indexOf('_dmarc.') === 0) return 'Email Policy (DMARC)';
    if (name === '@' || name === '') return 'Email Sender Authorization (SPF)';
    if (name === '_smtp._tls') return 'Transport Security Reporting';
    if (name === 'mta-sts') return 'Mail Transfer Security';
    return 'DNS Record';
  }

  function escapeHtml(str) {
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function createCard(r) {
    var typeClass = r.type.toLowerCase() === 'txt' ? 'txt' : 'cname';
    var purpose = getPurpose(r.name);
    var displayName = r.name === '@' ? '@ (root domain)' : escapeHtml(r.name);
    var escapedName = escapeHtml(r.name);
    var escapedValue = escapeHtml(r.value);
    
    return '<div class="qc-card">' +
      '<div class="qc-card-header">' +
        '<span class="qc-type ' + typeClass + '">' + escapeHtml(r.type) + '</span>' +
        '<span class="qc-purpose">' + purpose + '</span>' +
      '</div>' +
      '<div class="qc-field">' +
        '<div class="qc-label">Host / Name</div>' +
        '<div class="qc-value">' +
          '<code>' + displayName + '</code>' +
          '<button class="copy-btn" data-copy="' + escapedName + '">Copy</button>' +
        '</div>' +
      '</div>' +
      '<div class="qc-field">' +
        '<div class="qc-label">Value / Points To</div>' +
        '<div class="qc-value">' +
          '<code>' + escapedValue + '</code>' +
          '<button class="copy-btn" data-copy="' + escapedValue + '">Copy</button>' +
        '</div>' +
      '</div>' +
    '</div>';
  }

  var html = '<div class="qc-cards">';
  records.forEach(function(r) { html += createCard(r); });
  if (extras && extras.length > 0) {
    html += '<div class="mt-md mb-sm"><strong class="tiny muted">ADVANCED SECURITY (OPTIONAL)</strong></div>';
    extras.forEach(function(r) { html += createCard(r); });
  }
  html += '</div>';

  container.innerHTML = html;
  show(container);
  show($("#qc-actions"));
  
  // Add click handlers for copy buttons
  container.querySelectorAll('.copy-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var text = this.getAttribute('data-copy');
      var button = this;
      copy(text).then(function() {
        button.textContent = 'Copied!';
        button.classList.add('copied');
        setTimeout(function() {
          button.textContent = 'Copy';
          button.classList.remove('copied');
        }, 2000);
      });
    });
  });
}

$("#btnQCodes").addEventListener("click", async function(){
  var norm = normalizeForUI($("#qc-domain").value, $("#qc-notice"), null);
  if (!norm.ok){
    hide($("#qc-results"));
    hide($("#qc-actions"));
    hide($("#manual-step3-section"));
    return;
  }
  try{
    var extras = ($("#qc-extras").checked ? "&extras=1" : "");
    var j = await get(ROBOT_API + "/api/quick-codes?domain=" + encodeURIComponent(norm.apex || norm.value) + extras);
    renderQuickCodes(j.records || [], j.extras || []);
    
    var domainToProtect = norm.apex || norm.value;
    $("#verify-domain").value = domainToProtect;
    
    // Show Step 3 with the domain name
    $("#manual-protected-domain").textContent = "Domain: " + domainToProtect;
    $("#manual-step3-section").style.display = "";
    $("#manual-protect-status").classList.add("hidden");
    $("#manual-step3-section").dataset.domain = domainToProtect;
  }catch(e){
    $("#qc-results").innerHTML = '<p class="danger">Could not generate records: ' + String(e).slice(0,100) + '</p>';
    show($("#qc-results"));
    hide($("#manual-step3-section"));
  }
});

$("#btnCopyAll").addEventListener("click", function(){
  var cards = $$("#qc-results .qc-card");
  if (!cards.length) return;
  
  var text = "";
  cards.forEach(function(card) {
    var typeEl = card.querySelector('.qc-type');
    var codeEls = card.querySelectorAll('.qc-value code');
    var type = typeEl ? typeEl.textContent : '';
    var name = codeEls[0] ? codeEls[0].textContent : '';
    var value = codeEls[1] ? codeEls[1].textContent : '';
    text += type + "\t" + name + "\t" + value + "\n";
  });
  
  copy(text).then(function() {
    var btn = $("#btnCopyAll");
    var oldText = btn.textContent;
    btn.textContent = "Copied to clipboard!";
    setTimeout(function() { btn.textContent = oldText; }, 2000);
  });
});

/* ====== MANUAL DNS: Register domain after user adds records ====== */
$("#btnManualProtect").addEventListener("click", async function(){
  var btn = this;
  var statusEl = $("#manual-protect-status");
  var domain = $("#manual-step3-section").dataset.domain || $("#qc-domain").value.trim().toLowerCase();
  
  if (!domain) {
    statusEl.innerHTML = '<p class="danger">No domain specified. Please generate records first.</p>';
    statusEl.classList.remove("hidden");
    return;
  }
  
  // Check if already protected
  if (isDomainAlreadyProtected(domain)) {
    statusEl.innerHTML = '<p class="success">‚úì ' + domain + ' is already in your protected domains list!</p>';
    statusEl.classList.remove("hidden");
    return;
  }
  
  btn.disabled = true;
  btn.textContent = "Verifying & Registering...";
  statusEl.classList.add("hidden");
  
  try {
    // First verify the DNS records are actually in place
    var checkResult = await get(ROBOT_API + "/api/check-quick-codes?domain=" + encodeURIComponent(domain));
    
    var spfOk = checkResult.checks && checkResult.checks.spf && checkResult.checks.spf.present && checkResult.checks.spf.includesControl;
    var dmarcOk = checkResult.checks && checkResult.checks.dmarc && checkResult.checks.dmarc.present;
    var dkimOk = checkResult.checks && checkResult.checks.dkim && (checkResult.checks.dkim.s1.ok || checkResult.checks.dkim.s2.ok);
    
    if (!spfOk && !dmarcOk && !dkimOk) {
      statusEl.innerHTML = '<div class="verify-summary has-issues"><span class="verify-summary-icon">‚è≥</span><div class="verify-summary-text"><h4>Records not detected yet</h4><p>DNS changes can take 15-60 minutes to propagate. Please wait and try again. Make sure you deleted any duplicate SPF or DMARC records.</p></div></div>';
      statusEl.classList.remove("hidden");
      btn.disabled = false;
      btn.textContent = "üõ°Ô∏è I've Added My Records ‚Äî Protect My Domain";
      return;
    }
    
    // Register the domain with the API
    var regResult = await post(ROBOT_API + "/api/domains", { domain: domain, provider: "manual" });
    
    if (!regResult.ok) {
      throw new Error(regResult.error || "Failed to register domain");
    }
    
    // Show success animation
    showProtectionSuccess(domain, "manual");
    
    // Refresh user data and domains list to update counter
    await fetchCurrentUser();
    await refreshRecent();
    
    // Clear fields
    $("#qc-domain").value = "";
    hide($("#manual-step3-section"));
    hide($("#qc-results"));
    hide($("#qc-actions"));
    
    statusEl.innerHTML = '<p class="success">‚úì ' + domain + ' has been registered and is now protected!</p>';
    statusEl.classList.remove("hidden");
    
  } catch(e) {
    statusEl.innerHTML = '<p class="danger">Error: ' + String(e.message || e).slice(0,150) + '</p>';
    statusEl.classList.remove("hidden");
  } finally {
    btn.disabled = false;
    btn.textContent = "üõ°Ô∏è I've Added My Records ‚Äî Protect My Domain";
  }
});

/* ====== VERIFY (Human-readable output) - FIXED to match API response ====== */
function renderVerifyResults(data) {
  var container = $("#verify-results");
  var detailsEl = $("#verify-details");
  
  var checks = data.checks || {};
  var items = [];
  
  // SPF check - API returns "includesControl" (camelCase), not "includes_control"
  var spfPresent = checks.spf && checks.spf.present;
  var spfIncludesControl = checks.spf && (checks.spf.includesControl || checks.spf.includes_control);
  var spfOk = spfPresent && spfIncludesControl;
  
  items.push({
    label: 'SPF (Sender Authorization)',
    pass: spfOk,
    status: spfOk 
      ? 'Your SPF record is configured correctly and includes our central control.'
      : spfPresent
        ? 'SPF record found, but it does not include our central control yet.'
        : 'No SPF record found. Add the TXT record from Step 1.'
  });
  
  // DKIM check - API returns "s1.ok" and "s2.ok", not "s1.present" and "s1.points_to_control"
  var dkimS1Ok = checks.dkim && checks.dkim.s1 && checks.dkim.s1.ok;
  var dkimS2Ok = checks.dkim && checks.dkim.s2 && checks.dkim.s2.ok;
  var dkimOk = dkimS1Ok || dkimS2Ok;
  var dkimBothOk = dkimS1Ok && dkimS2Ok;
  
  items.push({
    label: 'DKIM (Email Signatures)',
    pass: dkimOk,
    status: dkimBothOk
      ? 'Both DKIM keys (s1 and s2) are configured correctly.'
      : dkimOk
        ? 'One DKIM key is configured. Consider adding both s1 and s2 for redundancy.'
        : 'No DKIM records found. Add the CNAME records from Step 1.'
  });
  
  // DMARC check - This one was correct
  var dmarcOk = checks.dmarc && checks.dmarc.present;
  items.push({
    label: 'DMARC (Email Policy)',
    pass: dmarcOk,
    status: dmarcOk
      ? 'Your DMARC policy is active. Policy: ' + (checks.dmarc.policy || 'none')
      : 'No DMARC record found. Add the TXT record from Step 1.'
  });
  
  var allPass = items.every(function(i) { return i.pass; });
  var passCount = items.filter(function(i) { return i.pass; }).length;
  
  var summaryHtml = '';
  if (allPass) {
    summaryHtml = '<div class="verify-summary all-pass">' +
      '<span class="verify-summary-icon">üéâ</span>' +
      '<div class="verify-summary-text">' +
        '<h4>Your domain is protected!</h4>' +
        '<p>All email authentication records are configured correctly.</p>' +
      '</div>' +
    '</div>';
  } else {
    summaryHtml = '<div class="verify-summary has-issues">' +
      '<span class="verify-summary-icon">‚ö†Ô∏è</span>' +
      '<div class="verify-summary-text">' +
        '<h4>' + passCount + ' of ' + items.length + ' checks passed</h4>' +
        '<p>Some records still need to be added. See details below.</p>' +
      '</div>' +
    '</div>';
  }
  
  var itemsHtml = items.map(function(item) {
    return '<div class="verify-item">' +
      '<div class="verify-icon ' + (item.pass ? 'pass' : 'fail') + '">' + (item.pass ? '‚úì' : '‚úó') + '</div>' +
      '<div class="verify-content">' +
        '<div class="verify-label">' + item.label + '</div>' +
        '<div class="verify-status ' + (item.pass ? 'pass' : 'fail') + '">' + item.status + '</div>' +
      '</div>' +
    '</div>';
  }).join('');
  
  container.innerHTML = summaryHtml + itemsHtml;
  show(container);
  
  logEl("#verify-log", data);
  show(detailsEl);
}

$("#btnVerify").addEventListener("click", async function(){
  var norm = normalizeForUI($("#verify-domain").value, $("#verify-notice"), null);
  if (!norm.ok){
    hide($("#verify-results"));
    hide($("#verify-details"));
    return;
  }
  
  $("#verify-results").innerHTML = '<div class="verify-summary has-issues"><span class="verify-summary-icon">‚è≥</span><div class="verify-summary-text"><h4>Checking your domain...</h4><p>This may take a few seconds while we query DNS servers.</p></div></div>';
  show($("#verify-results"));
  
  try{
    var j = await get(ROBOT_API + "/api/check-quick-codes?domain=" + encodeURIComponent(norm.apex || norm.value));
    renderVerifyResults(j);
  }catch(e){
    $("#verify-results").innerHTML = '<div class="verify-summary has-issues"><span class="verify-summary-icon">‚ùå</span><div class="verify-summary-text"><h4>Could not verify domain</h4><p>' + String(e).slice(0,150) + '</p></div></div>';
    show($("#verify-results"));
  }
});

/* ====== ADD DOMAIN + RECENT ====== */
async function refreshRecent(){
  var wrap = $("#recentWrap");
  try{
    var j = await get(ROBOT_API + "/api/domains");
    var rows = (j && (j.domains || j.rows)) ? (j.domains || j.rows) : [];
    
    // Populate protected domains from API
    protectedDomains = rows.map(function(r) {
      return {
        domain: r.domain_name || '',
        route: r.provider || r.source || 'manual',
        timestamp: r.created_at || new Date().toISOString(),
        isNew: false
      };
    }).filter(function(d) { return d.domain; });
    
    updateProtectedDomainsList();
    updateDomainCounter();
    
    if (!wrap) return;
    if (!rows.length){
      wrap.textContent = "No domains registered yet.";
      return;
    }
    wrap.innerHTML = rows.slice(0,10).map(function(r) {
      return '<div class="mono" style="margin-bottom:6px">'+(r.domain_name || "")+' <span class="muted">| '+(r.status || "")+(r.created_at ? " | "+r.created_at : "")+'</span></div>';
    }).join("");
  }catch(e){
    if (wrap) wrap.textContent = "Could not load domains.";
  }
}

$("#btnAdd").addEventListener("click", async function(){
  var noticeEl = $("#add-notice");
  var norm = normalizeForUI($("#add-domain").value, noticeEl, null);
  var email = ($("#add-email").value || "").trim();
  if (!email || !norm.ok){
    $("#add-log").textContent = "Please enter a valid email and domain name.";
    return;
  }
  try{
    if (noticeEl) hide(noticeEl);
    var j = await post(ROBOT_API + "/api/domains", {
      email: email,
      domain: norm.apex || norm.value
    });
    logEl("#add-log", j);
    refreshRecent();
  }catch(e){
    var msg = String(e);
    logEl("#add-log", "Error: " + msg);
    if (noticeEl){
      noticeEl.textContent = msg;
      show(noticeEl);
    }
  }
});

/* ====== CLOUDFLARE ====== */
$("#btnCfList").addEventListener("click", async function(){
  var token = ($("#cf-token").value || "").trim();
  if (!token){
    logEl("#cf-log","Please paste your Cloudflare API token first.");
    return;
  }
  try{
    var j = await post(ROBOT_API + "/api/cf/list-zones", { token: token });
    var sel = $("#cf-zones");
    sel.innerHTML = '<option value="">Select your domain</option>';
    (j.zones || []).forEach(function(z) {
      var o = document.createElement("option");
      o.value = z.id;
      o.textContent = z.name + " (" + (z.status || "") + ")";
      sel.appendChild(o);
    });
    logEl("#cf-log","Loaded " + (j.zones || []).length + " zones. Select your domain above.");
  }catch(e){
    logEl("#cf-log", String(e));
  }
});

$("#btnCfProtect").addEventListener("click", async function(){
  var btn = this;
  var token = ($("#cf-token").value || "").trim();
  var zone_id = $("#cf-zones").value;
  var zoneSelect = $("#cf-zones");
  var selectedOption = zoneSelect.options[zoneSelect.selectedIndex];
  var domainName = selectedOption ? selectedOption.textContent.split(' (')[0] : '';
  
  if (!token || !zone_id){
    logEl("#cf-log","Please load zones and select a domain first.");
    return;
  }
  
  // Check if already protected
  if (domainName && isDomainAlreadyProtected(domainName)) {
    logEl("#cf-log", "‚úì " + domainName + " is already protected! Select a different domain or verify your setup below.");
    return;
  }
  
  // Disable button and show loading
  btn.disabled = true;
  btn.textContent = "Protecting...";
  logEl("#cf-log", "Setting up email protection for " + domainName + "...");
  
  try{
    var j = await post(ROBOT_API + "/api/cf/protect", { token: token, zone_id: zone_id });
    
    var apex = j.apex || j.domain || domainName;
    
    // Show success animation
    showProtectionSuccess(apex, 'cloudflare');
    
    // Refresh user data and domains list to update counter
    await fetchCurrentUser();
    await refreshRecent();
    
    // Clear sensitive fields
    $("#cf-token").value = "";
    zoneSelect.innerHTML = '<option value="">Domain protected! Select another or go back</option>';
    
    // Update other fields
    if (apex) {
      $("#verify-domain").value = apex;
      if ($("#pol-domain")) $("#pol-domain").value = apex;
      if ($("#ins-domain")) $("#ins-domain").value = apex;
    }
    
    logEl("#cf-log", "‚úÖ Success! " + apex + " is now protected.\n\nDNS records created:\n‚Ä¢ SPF record configured\n‚Ä¢ DKIM selectors (s1, s2) added\n‚Ä¢ DMARC policy activated\n\nUse 'Verify My Setup' below to confirm everything is working.");
    
  }catch(e){
    logEl("#cf-log", "‚ùå Error: " + String(e));
  } finally {
    btn.disabled = false;
    btn.textContent = "Protect This Domain";
  }
});

/* ====== ROUTE 53 ====== */
async function r53ListZonesIfReady(){
  var access_key_id = ($("#r53-ak").value || "").trim();
  var secret_access_key = ($("#r53-sk").value || "").trim();
  if (!access_key_id || !secret_access_key) return;
  try{
    var j = await post(ROBOT_API + "/api/r53/list-zones", { access_key_id: access_key_id, secret_access_key: secret_access_key });
    var sel = $("#r53-zones");
    sel.innerHTML = '<option value="">Select your hosted zone</option>';
    (j.zones || []).forEach(function(z) {
      var o = document.createElement("option");
      o.value = z.id;
      o.textContent = z.name + " (" + z.id + ")";
      sel.appendChild(o);
    });
    logEl("#r53-log","Loaded " + (j.zones || []).length + " hosted zones.");
  }catch(e){
    logEl("#r53-log", String(e));
  }
}
$("#r53-ak").addEventListener("change", r53ListZonesIfReady);
$("#r53-sk").addEventListener("change", r53ListZonesIfReady);

$("#btnR53Protect").addEventListener("click", async function(){
  var btn = this;
  var access_key_id = ($("#r53-ak").value || "").trim();
  var secret_access_key = ($("#r53-sk").value || "").trim();
  var hosted_zone_id = $("#r53-zones").value;
  var zoneSelect = $("#r53-zones");
  var selectedOption = zoneSelect.options[zoneSelect.selectedIndex];
  var domainName = selectedOption ? selectedOption.textContent.split(' (')[0].replace(/\.$/, '') : '';
  
  if (!access_key_id || !secret_access_key || !hosted_zone_id){
    logEl("#r53-log","Please enter credentials and select a hosted zone.");
    return;
  }
  
  // Check if already protected
  if (domainName && isDomainAlreadyProtected(domainName)) {
    logEl("#r53-log", "‚úì " + domainName + " is already protected! Select a different zone or verify your setup below.");
    return;
  }
  
  // Disable button and show loading
  btn.disabled = true;
  btn.textContent = "Protecting...";
  logEl("#r53-log", "Setting up email protection for " + domainName + "...");
  
  try{
    var j = await post(ROBOT_API + "/api/r53/protect", { access_key_id: access_key_id, secret_access_key: secret_access_key, hosted_zone_id: hosted_zone_id });
    
    var apex = j.apex || j.domain || domainName;
    
    // Show success animation
    showProtectionSuccess(apex, 'route53');
    
    // Refresh user data and domains list to update counter
    await fetchCurrentUser();
    await refreshRecent();
    
    // Clear sensitive fields
    $("#r53-ak").value = "";
    $("#r53-sk").value = "";
    zoneSelect.innerHTML = '<option value="">Domain protected! Enter new credentials for another</option>';
    
    // Update other fields
    if (apex) {
      $("#verify-domain").value = apex;
      if ($("#pol-domain")) $("#pol-domain").value = apex;
      if ($("#ins-domain")) $("#ins-domain").value = apex;
    }
    
    logEl("#r53-log", "‚úÖ Success! " + apex + " is now protected.\n\nDNS records created:\n‚Ä¢ SPF record configured\n‚Ä¢ DKIM selectors (s1, s2) added\n‚Ä¢ DMARC policy activated\n\nUse 'Verify My Setup' below to confirm everything is working.");
    
  }catch(e){
    logEl("#r53-log", "‚ùå Error: " + String(e));
  } finally {
    btn.disabled = false;
    btn.textContent = "Protect This Domain";
  }
});

/* ====== ENHANCED INSIGHTS COMPONENTS ====== */

/* Generate Natural Language Summary based on rate and context */
function generateNLGSummary(rate, total, aligned, failed, days, domain) {
  var text = '';
  var levelClass = '';
  var icon = '';
  
  if (rate >= 97) {
    levelClass = 'excellent';
    icon = 'üõ°Ô∏è';
    if (failed === 0) {
      text = 'Excellent protection ‚Äî <strong>100%</strong> of your emails are fully authenticated. Your domain is well-defended against impersonation.';
    } else {
      text = 'Excellent protection ‚Äî <strong>' + rate + '%</strong> of your emails are verified. Only <strong>' + fmt(failed) + '</strong> emails failed authentication, which is within normal variance.';
    }
  } else if (rate >= 90) {
    levelClass = 'good';
    icon = '‚úÖ';
    text = 'Good protection ‚Äî <strong>' + rate + '%</strong> of your emails authenticated successfully. ' + fmt(failed) + ' emails failed checks. Consider reviewing your authorized senders to close the gap.';
  } else if (rate >= 75) {
    levelClass = 'fair';
    icon = '‚ö†Ô∏è';
    text = 'Fair protection ‚Äî <strong>' + rate + '%</strong> of your emails passed authentication. <strong>' + fmt(failed) + '</strong> emails failed, which may indicate misconfigured services or potential spoofing. Review the sources below.';
  } else if (rate >= 50) {
    levelClass = 'poor';
    icon = 'üö®';
    text = 'Needs attention ‚Äî Only <strong>' + rate + '%</strong> of your emails are authenticating. <strong>' + fmt(failed) + '</strong> emails failed checks. This suggests significant misconfiguration or active spoofing attempts. Investigate immediately.';
  } else {
    levelClass = 'poor';
    icon = 'üö®';
    text = 'Critical ‚Äî Only <strong>' + rate + '%</strong> of your emails are verified. Your domain may be actively targeted for spoofing. Review unauthorized senders and strengthen your policy urgently.';
  }
  
  return { text: text, levelClass: levelClass, icon: icon };
}

/* Render Hero Metric Card */
function renderHeroMetric(domain, rate, days, total) {
  var heroEl = $('#ins-hero');
  var valueEl = $('#ins-hero-value');
  var domainEl = $('#ins-hero-domain');
  var periodEl = $('#ins-hero-period');
  
  // Determine class based on rate
  var rateClass = 'excellent';
  if (rate < 97) rateClass = 'good';
  if (rate < 90) rateClass = 'fair';
  if (rate < 75) rateClass = 'poor';
  
  // Update elements
  domainEl.textContent = domain;
  valueEl.textContent = rate + '%';
  valueEl.className = 'hero-metric-value ' + rateClass;
  periodEl.textContent = fmt(total) + ' emails over ' + days + ' days';
}

/* Render History Strip - Visual 30-day bars */
function renderHistoryStrip(rows, days) {
  var barsEl = $('#ins-history-bars');
  var rangeEl = $('#ins-history-range');
  
  if (!rows || !rows.length) {
    barsEl.innerHTML = '';
    rangeEl.textContent = 'No data';
    return;
  }
  
  // Calculate date range
  var firstDate = rows[0].date;
  var lastDate = rows[rows.length - 1].date;
  rangeEl.textContent = firstDate + ' ‚Üí ' + lastDate;
  
  // Find max total for scaling
  var maxTotal = Math.max.apply(null, rows.map(function(r) { return r.total || 0; }));
  if (maxTotal === 0) maxTotal = 1;
  
  // Generate bars
  var barsHtml = rows.map(function(r) {
    var p = pct(r.aligned || 0, r.total || 0);
    var height = Math.max(10, Math.round(((r.total || 0) / maxTotal) * 100));
    
    var barClass = 'excellent';
    if (p < 97) barClass = 'good';
    if (p < 90) barClass = 'fair';
    if (p < 75) barClass = 'poor';
    if ((r.total || 0) === 0) barClass = 'empty';
    
    return '<div class="history-bar ' + barClass + '" style="height:' + height + '%">' +
      '<div class="history-bar-tooltip">' +
        '<strong>' + r.date + '</strong><br>' +
        fmt(r.total || 0) + ' emails ¬∑ ' + p + '% auth' +
      '</div>' +
    '</div>';
  }).join('');
  
  barsEl.innerHTML = barsHtml;
}

/* Show skeleton loading state */
function showInsightsSkeleton() {
  hide($('#ins-empty'));
  hide($('#ins-results'));
  show($('#ins-skeleton'));
  $('#ins-table').style.display = 'none';
  hide($('#ins-explainer'));
}

/* Hide skeleton and show results */
function showInsightsResults() {
  hide($('#ins-skeleton'));
  hide($('#ins-empty'));
  show($('#ins-results'));
}

/* Show empty state */
function showInsightsEmpty(message, hint) {
  hide($('#ins-skeleton'));
  hide($('#ins-results'));
  $('#ins-table').style.display = 'none';
  hide($('#ins-explainer'));
  
  var emptyEl = $('#ins-empty');
  if (message) {
    emptyEl.innerHTML = '<div class="empty-state">' +
      '<div class="empty-state-icon"><img src="https://res.cloudinary.com/dxwuwbmjd/image/upload/v1764246399/ChatGPT_Image_Nov_27_2025_02_56_26_PM_d3n4dr.png" alt="" style="width:48px;height:48px;object-fit:contain;"/></div>' +
      '<div class="empty-state-title">' + message + '</div>' +
      (hint ? '<div class="empty-state-desc">' + hint + '</div>' : '') +
    '</div>';
  }
  show(emptyEl);
}

/* Enhanced renderRollup with new components */
function renderRollupEnhanced(j) {
  var rows = asArray(j.series);
  var table = $('#ins-table');
  var body = $('#ins-rows');
  var explainer = $('#ins-explainer');
  
  if (!rows.length) {
    showInsightsEmpty('No data found', 'No DMARC reports available for ' + j.domain + ' in the selected period. Reports typically arrive 24-48 hours after email activity.');
    return;
  }
  
  // Calculate totals
  var T = rows.reduce(function(acc, r) {
    acc.total += r.total || 0;
    acc.aligned += r.aligned || 0;
    return acc;
  }, {total: 0, aligned: 0});
  
  var rate = pct(T.aligned, T.total);
  var failed = T.total - T.aligned;
  
  // Show results container
  showInsightsResults();
  
  // 1. Render Hero Metric
  renderHeroMetric(j.domain, rate, j.days, T.total);
  
  // 2. Render NLG Summary
  var nlg = generateNLGSummary(rate, T.total, T.aligned, failed, j.days, j.domain);
  var nlgEl = $('#ins-nlg');
  nlgEl.className = 'nlg-summary ' + nlg.levelClass;
  nlgEl.innerHTML = '<span class="nlg-summary-icon">' + nlg.icon + '</span><span>' + nlg.text + '</span>';
  
  // 3. Render History Strip
  renderHistoryStrip(rows, j.days);
  
  // 4. Update stats row
  $('#ins-stat-total').textContent = fmt(T.total);
  $('#ins-stat-auth').textContent = fmt(T.aligned);
  $('#ins-stat-fail').textContent = fmt(failed);
  
  // 5. Render table (still available)
  if (explainer) explainer.classList.remove('hidden');
  
  body.innerHTML = '';
  rows.forEach(function(r) {
    var p = pct(r.aligned || 0, r.total || 0);
    var statusClass = p >= 97 ? 'ok' : (p >= 90 ? 'ok' : (p >= 75 ? 'warn' : 'danger'));
    var statusText = p >= 97 ? 'Protected' : (p >= 90 ? 'Good' : (p >= 75 ? 'Fair' : 'At Risk'));
    var tr = document.createElement('tr');
    tr.innerHTML =
      '<td data-label="Date" class="mono">' + r.date + '</td>' +
      '<td data-label="Emails Sent">' + fmt(r.total || 0) + '</td>' +
      '<td data-label="Authenticated">' + fmt(r.aligned || 0) + '</td>' +
      '<td data-label="Protection">' + p + '%</td>' +
      '<td data-label="Status">' +
        '<div class="ins-bar"><i style="width:' + Math.min(100, p) + '%"></i></div>' +
        '<div class="ins-stats"><span class="pill ' + statusClass + '">' + statusText + '</span></div>' +
      '</td>';
    body.appendChild(tr);
  });
  table.style.display = '';
}

/* Enhanced sources empty state */
function showSourcesEmpty(title, desc, hint) {
  var listEl = $('#sources-list');
  listEl.innerHTML = '<div class="empty-state">' +
    '<div class="empty-state-icon"><img src="https://res.cloudinary.com/dxwuwbmjd/image/upload/v1764246390/ChatGPT_Image_Nov_27_2025_03_01_18_PM_q6r0lx.png" alt="Source" style="width:48px;height:48px;object-fit:contain;"/></div>' +
    '<div class="empty-state-title">' + (title || 'No source data available') + '</div>' +
    '<div class="empty-state-desc">' + (desc || 'No servers have been recorded sending email as this domain.') + '</div>' +
    (hint ? '<div class="empty-state-hint">' + hint + '</div>' : '') +
  '</div>';
}


/* ====== DMARC INSIGHTS (Rollup) ====== */
function fmt(n){ return (n||0).toLocaleString(); }
function pct(a,b){ var r = (b>0) ? (a/b) : 0; return Math.round(r*1000)/10; }
function asArray(series){ 
  if (Array.isArray(series)) return series; 
  if (series && typeof series==='object'){ 
    return Object.keys(series).sort().map(function(d) { 
      return Object.assign({date:d}, series[d]); 
    }); 
  } 
  return []; 
}

function renderRollup(j){
  var rows = asArray(j.series);
  var table = $('#ins-table'); 
  var body = $('#ins-rows'); 
  var summary = $('#ins-summary');
  var explainer = $('#ins-explainer');
  
  if (!rows.length){ 
    table.style.display='none'; 
    if (explainer) explainer.classList.add('hidden');
    summary.innerHTML = '<span class="muted">No data available. Enter a domain and click a time range button.</span>'; 
    return; 
  }
  
  var T = rows.reduce(function(acc,r){ 
    acc.total += r.total||0; 
    acc.aligned += r.aligned||0; 
    return acc; 
  }, {total:0,aligned:0});
  
  var rate = pct(T.aligned, T.total);
  var unaligned = T.total - T.aligned;
  
  // Determine protection level and color
  var level, levelClass, levelIcon;
  if (rate >= 97) {
    level = 'Excellent'; levelClass = 'ok'; levelIcon = 'üõ°Ô∏è';
  } else if (rate >= 90) {
    level = 'Good'; levelClass = 'ok'; levelIcon = '‚úÖ';
  } else if (rate >= 75) {
    level = 'Fair'; levelClass = 'warn'; levelIcon = '‚ö†Ô∏è';
  } else {
    level = 'Needs Attention'; levelClass = 'danger'; levelIcon = 'üö®';
  }
  
  // Build human-friendly summary
  var summaryHtml = '<div class="verify-summary ' + (rate >= 90 ? 'all-pass' : 'has-issues') + '">' +
    '<span class="verify-summary-icon">' + levelIcon + '</span>' +
    '<div class="verify-summary-text">' +
      '<h4 style="margin:0">' + j.domain + ' ‚Äî ' + level + ' Protection</h4>' +
      '<p style="margin:4px 0 0"><strong style="color:var(--' + levelClass + ')">' + rate + '%</strong> of ' + fmt(T.total) + ' emails authenticated over ' + j.days + ' days</p>' +
    '</div>' +
  '</div>';
  
  if (unaligned > 0 && rate < 97) {
    summaryHtml += '<p class="tiny muted mt-sm">' + fmt(unaligned) + ' emails failed authentication. These could be misconfigured services or impersonation attempts.</p>';
  }
  
  summary.innerHTML = summaryHtml;
  if (explainer) explainer.classList.remove('hidden');
  
  body.innerHTML = '';
  rows.forEach(function(r){
    var p = pct(r.aligned||0, r.total||0);
    var statusClass = p >= 97 ? 'ok' : (p >= 90 ? 'ok' : (p >= 75 ? 'warn' : 'danger'));
    var statusText = p >= 97 ? 'Protected' : (p >= 90 ? 'Good' : (p >= 75 ? 'Fair' : 'At Risk'));
    var tr = document.createElement('tr');
    tr.innerHTML = 
      '<td data-label="Date" class="mono">' + r.date + '</td>' +
      '<td data-label="Emails Sent">' + fmt(r.total||0) + '</td>' +
      '<td data-label="Authenticated">' + fmt(r.aligned||0) + '</td>' +
      '<td data-label="Protection">' + p + '%</td>' +
      '<td data-label="Status">' +
        '<div class="ins-bar"><i style="width:' + Math.min(100,p) + '%"></i></div>' +
        '<div class="ins-stats"><span class="pill ' + statusClass + '">' + statusText + '</span></div>' +
      '</td>';
    body.appendChild(tr);
  });
  table.style.display = '';
}

async function loadRoll(days){
  var norm = normalizeForUI($('#ins-domain').value, null, null);
  if(!norm.ok){ 
    showInsightsEmpty('Please enter a valid domain', 'Enter your domain name in the field above to analyze your email authentication.');
    return; 
  }
  
  // Show skeleton loading state
  showInsightsSkeleton();
  
  try{
    var url = ROBOT_API + '/api/rollup?domain=' + encodeURIComponent(norm.apex || norm.value) + '&days=' + days;
    var j = await get(url);
    $('#ins-wrap').textContent = JSON.stringify(j, null, 2);
    
    // Check if we got data
    var series = asArray(j.series);
    if (series.length === 0) {
      var hint = 'Possible reasons: DMARC reports typically arrive 24-48 hours after email activity, or no emails were sent from this domain during this period.';
      if (days === 7) {
        hint += ' Try "Last 30 Days" to see if older data is available.';
      }
      showInsightsEmpty('No data found for ' + (norm.apex || norm.value), hint);
      return;
    }
    
    // Use enhanced rendering
    renderRollupEnhanced({domain: j.domain || (norm.apex || norm.value), days: days, series: j.series || []});
  }catch(e){ 
    var errMsg = String(e);
    if (errMsg.indexOf('Failed to fetch') >= 0) {
      errMsg = 'Network error: Could not reach the API. Check console for details.';
    }
    showInsightsEmpty('Error loading data', errMsg);
    $('#ins-wrap').textContent = String(e); 
  }
}

$('#btnLoad7').addEventListener('click', function(){ loadRoll(7); });
$('#btnLoad30').addEventListener('click', function(){ loadRoll(30); });

/* ====== DMARC POLICY STEP-UP ====== */
$('#btnPolPreview').addEventListener('click', async function(){
  var d = ($('#pol-domain').value || '').trim();
  if(!d){ logEl('#pol-out','Enter a domain first.'); return; }
  try{
    var j = await get(ROBOT_API + '/policy/preview?domain=' + encodeURIComponent(d));
    logEl('#pol-out', j);
  }catch(e){ logEl('#pol-out', String(e)); }
});

$('#btnApplyCf').addEventListener('click', async function(){
  var body = {
    domain: ($('#pol-domain').value || '').trim(),
    policy: $('#pol-policy').value,
    pct: Number($('#pol-pct').value||100),
    adkim: $('#pol-adkim').value,
    aspf:  $('#pol-aspf').value,
    rua:   ($('#pol-rua').value || '').trim(),
    fo:    ($('#pol-fo').value || '').trim(),
    sp:    ($('#pol-sp').value || '').trim() || null
  };
  if(!body.domain){ logEl('#pol-out','Enter a domain first.'); return; }
  try{ 
    var j = await post(ROBOT_API + '/api/policy/dmarc/cf', body); 
    logEl('#pol-out', j); 
  }catch(e){ logEl('#pol-out', String(e)); }
});

$('#btnApplyR53').addEventListener('click', async function(){
  var body = {
    domain: ($('#pol-domain').value || '').trim(),
    policy: $('#pol-policy').value,
    pct: Number($('#pol-pct').value||100),
    adkim: $('#pol-adkim').value,
    aspf:  $('#pol-aspf').value,
    rua:   ($('#pol-rua').value || '').trim(),
    fo:    ($('#pol-fo').value || '').trim(),
    sp:    ($('#pol-sp').value || '').trim() || null,
    hosted_zone_id: ($('#r53-zones').value || '').trim()
  };
  if(!body.domain){ logEl('#pol-out','Enter a domain first.'); return; }
  if(!body.hosted_zone_id){ logEl('#pol-out','Pick a Route 53 hosted zone first (in the setup section above).'); return; }
  try{ 
    var j = await post(ROBOT_API + '/api/policy/dmarc/r53', body); 
    logEl('#pol-out', j); 
  }catch(e){ logEl('#pol-out', String(e)); }
});

$('#btnEvaluateNow').addEventListener('click', async function(){
  try{ 
    var j = await get(ROBOT_API + '/policy/evaluate-now'); 
    logEl('#pol-out', j); 
  }catch(e){ logEl('#pol-out', String(e)); }
});

/* ====== CONTROL SPF BUILDER ====== */
var SPF_MAP = {
  google:'include:_spf.google.com', 
  m365:'include:spf.protection.outlook.com', 
  sendgrid:'include:sendgrid.net',
  ses:'include:amazonses.com', 
  mailgun:'include:mailgun.org', 
  mailchimp:'include:servers.mcsv.net',
  postmark:'include:spf.mtasv.net', 
  sparkpost:'include:_spf.sparkpostmail.com', 
  zoho:'include:zoho.com',
  zendesk:'include:mail.zendesk.com', 
  intercom:'include:_spf.intercom.io'
};

function updateSpfPreview(){
  var sels = [];
  document.querySelectorAll('.spf-sel:checked').forEach(function(x) {
    if (SPF_MAP[x.value]) sels.push(SPF_MAP[x.value]);
  });
  var txt = ['v=spf1'].concat(sels).concat(['~all']).join(' ');
  $('#spf-preview').value = txt;
}

document.querySelectorAll('.spf-sel').forEach(function(cb) { 
  cb.addEventListener('change', updateSpfPreview); 
});
updateSpfPreview();

$('#btnSpfLoad2').addEventListener('click', async function(){
  var tok = ($('#spf-token').value || '').trim();
  if(!tok){ logEl('#spf-log2','Paste a Cloudflare API token first.'); return; }
  try{ 
    var j = await get(ROBOT_API + '/api/cf/control-spf?token=' + encodeURIComponent(tok)); 
    if (j.value) $('#spf-preview').value = j.value; 
    logEl('#spf-log2', j); 
  }catch(e){ logEl('#spf-log2', String(e)); }
});

$('#btnSpfUpdate2').addEventListener('click', async function(){
  var tok = ($('#spf-token').value || '').trim();
  var val = ($('#spf-preview').value || '').trim();
  if(!tok){ logEl('#spf-log2','Paste a Cloudflare API token first.'); return; }
  try{ 
    var j = await post(ROBOT_API + '/api/cf/control-spf', { token: tok, value: val }); 
    logEl('#spf-log2', j); 
  }catch(e){ logEl('#spf-log2', String(e)); }
});

/* ====== INGEST REPORTS ====== */
$('#btnIngestTest').addEventListener('click', async function(){
  logEl('#ingest-log', 'Testing /ingest/daily endpoint (auth required)...');
  try{
    // This will return 401 without the key, but proves the endpoint exists
    var r = await fetch(ROBOT_API + '/ingest/daily', {
      method: 'POST',
      credentials: 'include',
      headers: { 'content-type': 'application/json', 'accept': 'application/json' },
      body: JSON.stringify({ domain: 'test.com', date: '2025-01-01', total: 0, aligned: 0 })
    });
    var t = await r.text();
    var j = null;
    try { j = JSON.parse(t); } catch(e) {}
    
    if (r.status === 401) {
      logEl('#ingest-log', '‚úÖ Endpoint exists and is protected (401 Unauthorized - correct behavior without x-ingest-key)\n\nTo use this endpoint, send POST with:\n- Header: x-ingest-key: <your-key>\n- Body: { domain, date, total, aligned, spf_aligned, dkim_aligned }');
    } else if (r.ok) {
      logEl('#ingest-log', '‚úÖ Endpoint working:\n' + JSON.stringify(j, null, 2));
    } else {
      logEl('#ingest-log', '‚ö†Ô∏è Endpoint returned ' + r.status + ':\n' + (j ? JSON.stringify(j, null, 2) : t));
    }
  } catch(e) {
    logEl('#ingest-log', '‚ùå Failed to reach endpoint: ' + String(e) + '\n\nThis may be a CORS or network issue.');
  }
});

/* ====== ALERTS ====== */
$('#btnAlertTest').addEventListener('click', async function(){
  try{
    var j = await post(ROBOT_API + '/alerts/test', {domain:'domainsafepro.com', title:'Test alert', message:'This is a test from DomainSafePro Console.'});
    logEl('#alerts-out', j);
  }catch(e){ logEl('#alerts-out', String(e)); }
});

$('#btnAlertFlush').addEventListener('click', async function(){
  try{
    var j = await post(ROBOT_API + '/alerts/flush', {});
    logEl('#alerts-out', j);
  }catch(e){ logEl('#alerts-out', String(e)); }
});

/* ====== API DIAGNOSTICS ====== */
$('#btnTestAll').addEventListener('click', async function(){
  var log = $('#debug-log');
  var results = [];
  
  results.push('=== API Endpoint Diagnostics ===');
  results.push('ROBOT_API: ' + ROBOT_API);
  results.push('DMARC_API: ' + DMARC_API);
  results.push('');
  
  async function testEndpoint(name, url, method){
    var start = Date.now();
    try{
      var opts = { method: method || 'GET', credentials: 'include', headers: { 'accept': 'application/json' } };
      if (method === 'POST') {
        opts.headers['content-type'] = 'application/json';
        opts.body = '{}';
      }
      var r = await fetch(url, opts);
      var elapsed = Date.now() - start;
      var status = r.status + ' ' + r.statusText;
      if (r.ok) {
        return '‚úÖ ' + name + ': ' + status + ' (' + elapsed + 'ms)';
      } else {
        var body = '';
        try { body = await r.text(); body = body.slice(0,100); } catch(e){}
        return '‚ö†Ô∏è ' + name + ': ' + status + ' (' + elapsed + 'ms) - ' + body;
      }
    } catch(e) {
      return '‚ùå ' + name + ': ' + String(e).slice(0,80);
    }
  }
  
  log.textContent = 'Testing endpoints...\n';
  
  // Test core ROBOT_API endpoints
  results.push(await testEndpoint('/api/me', ROBOT_API + '/api/me', 'GET'));
  results.push(await testEndpoint('/api/status', ROBOT_API + '/api/status', 'GET'));
  results.push(await testEndpoint('/api/domains', ROBOT_API + '/api/domains', 'GET'));
  results.push(await testEndpoint('/api/rollup (7d)', ROBOT_API + '/api/rollup?domain=domainsafepro.com&days=7', 'GET'));
  results.push(await testEndpoint('/api/rollup (30d)', ROBOT_API + '/api/rollup?domain=domainsafepro.com&days=30', 'GET'));
  results.push(await testEndpoint('/policy/preview', ROBOT_API + '/policy/preview?domain=domainsafepro.com', 'GET'));
  results.push(await testEndpoint('/policy/evaluate-now', ROBOT_API + '/policy/evaluate-now', 'GET'));
  results.push(await testEndpoint('/alerts/test', ROBOT_API + '/alerts/test', 'POST'));
  
  results.push('');
  results.push('--- Ingest Endpoint ---');
  results.push(await testEndpoint('/ingest/daily (auth required)', ROBOT_API + '/ingest/daily', 'POST'));
  
  results.push('');
  results.push('=== Done ===');
  results.push('');
  results.push('Legend:');
  results.push('‚úÖ = Working');
  results.push('‚ö†Ô∏è = Reachable but returned error (401 = auth required, which is correct)');
  results.push('‚ùå = Failed to fetch (CORS/network/not deployed)');
  results.push('');
  results.push('Note: DMARC_API (api.domainsafepro.com) is reserved for future use.');
  
  log.textContent = results.join('\n');
});


/* ====== SOURCE ANALYSIS (Who's Sending As Your Domain) ====== */
function getSourceIcon(status) {
  switch(status) {
    case 'authorized': return '‚úÖ';
    case 'partial': return '‚ö†Ô∏è';
    case 'misconfigured': return 'üîß';
    case 'suspicious': return 'üö®';
    default: return '‚ùì';
  }
}

function getStatusLabel(status) {
  switch(status) {
    case 'authorized': return 'Authorized';
    case 'partial': return 'Partial';
    case 'misconfigured': return 'Misconfigured';
    case 'suspicious': return 'Suspicious';
    default: return 'Unknown';
  }
}

function renderSources(data) {
  var summaryEl = $('#sources-summary');
  var listEl = $('#sources-list');
  var explainerEl = $('#sources-explainer');
  var wrapEl = $('#sources-wrap');
  
  // Log raw response
  if (wrapEl) {
    wrapEl.textContent = JSON.stringify(data, null, 2);
  }
  
  var sources = data.sources || [];
  var summary = data.summary || {};
  
  if (!sources.length) {
    hide(summaryEl);
    hide(explainerEl);
    showSourcesEmpty(
      'No source data for ' + (data.domain || 'this domain'),
      'No servers have been recorded sending email as this domain in the last ' + (data.days || 7) + ' days.',
      'This could mean no emails were sent, or DMARC reports haven\'t been processed yet.'
    );
    return;
  }
  
  // Render summary stats
  var summaryHtml = '<div class="sources-stat">' +
      '<div class="sources-stat-value">' + fmt(summary.total_sources || sources.length) + '</div>' +
      '<div class="sources-stat-label">Sending Sources</div>' +
    '</div>' +
    '<div class="sources-stat">' +
      '<div class="sources-stat-value">' + fmt(summary.total_emails || 0) + '</div>' +
      '<div class="sources-stat-label">Total Emails</div>' +
    '</div>' +
    '<div class="sources-stat">' +
      '<div class="sources-stat-value" style="color:var(--ok)">' + fmt(summary.authorized_sources || 0) + '</div>' +
      '<div class="sources-stat-label">Authorized</div>' +
    '</div>' +
    '<div class="sources-stat">' +
      '<div class="sources-stat-value" style="color:var(--danger)">' + fmt(summary.suspicious_sources || 0) + '</div>' +
      '<div class="sources-stat-label">Suspicious</div>' +
    '</div>';
  
  summaryEl.innerHTML = summaryHtml;
  show(summaryEl);
  
  // Render source rows
  var rowsHtml = sources.map(function(src) {
    var status = src.status || 'unknown';
    var identity = src.identity || 'Unknown';
    var ip = src.source_ip || '';
    var org = src.org || '';
    var reverse = src.reverse || '';
    var total = src.total || 0;
    var aligned = src.aligned || 0;
    var alignedRate = src.aligned_rate !== undefined ? src.aligned_rate : (total > 0 ? Math.round((aligned / total) * 100) : 0);
    var spfPass = (src.spf && src.spf.pass) || 0;
    var spfFail = (src.spf && src.spf.fail) || 0;
    var dkimPass = (src.dkim && src.dkim.pass) || 0;
    var dkimFail = (src.dkim && src.dkim.fail) || 0;
    var firstSeen = src.first_seen || '';
    var lastSeen = src.last_seen || '';
    
    var subInfo = '';
    if (reverse) {
      subInfo = reverse;
    } else if (org) {
      subInfo = org;
    } else {
      subInfo = 'No reverse DNS';
    }
    
    return '<div class="source-row">' +
      '<div class="source-icon ' + status + '">' + getSourceIcon(status) + '</div>' +
      '<div class="source-identity">' +
        '<div class="source-identity-name">' + identity + '</div>' +
        '<div class="source-identity-ip">' + ip + '</div>' +
        '<div class="source-identity-org">' + subInfo + '</div>' +
      '</div>' +
      '<div class="source-stats">' +
        '<div class="source-stat-item">' +
          '<div class="source-stat-num">' + fmt(total) + '</div>' +
          '<div class="source-stat-lbl">Emails</div>' +
        '</div>' +
        '<div class="source-stat-item">' +
          '<div class="source-stat-num">' + alignedRate + '%</div>' +
          '<div class="source-stat-lbl">Aligned</div>' +
        '</div>' +
        '<div class="source-stat-item">' +
          '<div class="source-stat-num" style="color:' + (spfPass > 0 ? 'var(--ok)' : 'var(--danger)') + '">' + fmt(spfPass) + '</div>' +
          '<div class="source-stat-lbl">SPF ‚úì</div>' +
        '</div>' +
        '<div class="source-stat-item">' +
          '<div class="source-stat-num" style="color:' + (dkimPass > 0 ? 'var(--ok)' : 'var(--danger)') + '">' + fmt(dkimPass) + '</div>' +
          '<div class="source-stat-lbl">DKIM ‚úì</div>' +
        '</div>' +
      '</div>' +
      '<div class="source-status">' +
        '<span class="pill ' + status + '">' + getStatusLabel(status) + '</span>' +
        (lastSeen ? '<div class="tiny muted mt-sm">Last: ' + lastSeen + '</div>' : '') +
      '</div>' +
    '</div>';
  }).join('');
  
  listEl.innerHTML = rowsHtml;
  show(explainerEl);
}

async function loadSources(days) {
  var norm = normalizeForUI($('#ins-domain').value, null, null);
  if (!norm.ok) {
    showSourcesEmpty('Enter a domain first', 'Please enter a valid domain name in the insights section above.');
    return;
  }
  
  $('#sources-list').innerHTML = '<div class="sources-loading">Loading source data for ' + (norm.apex || norm.value) + '...</div>';
  hide($('#sources-summary'));
  hide($('#sources-explainer'));
  
  try {
    var url = ROBOT_API + '/api/sources?domain=' + encodeURIComponent(norm.apex || norm.value) + '&days=' + days;
    var j = await get(url);
    renderSources(j);
  } catch(e) {
    var errMsg = String(e);
    if (errMsg.indexOf('Failed to fetch') >= 0) {
      errMsg = 'Network error: Could not reach the API.';
    }
    if (errMsg.indexOf('404') >= 0 || errMsg.indexOf('Not Found') >= 0) {
      errMsg = 'The /api/sources endpoint is not yet deployed. Deploy Robot v0.5.2 to enable this feature.';
    }
    showSourcesEmpty('Error loading sources', errMsg, 'Please check your connection and try again.');
    $('#sources-wrap').textContent = String(e);
  }
}

$('#btnSources7').addEventListener('click', function() { loadSources(7); });
$('#btnSources30').addEventListener('click', function() { loadSources(30); });

/* ====== CHECKOUT SUCCESS DETECTION ====== */
function isCheckoutSuccess() {
  var params = new URLSearchParams(window.location.search);
  return params.get('checkout') === 'success';
}

function applyCheckoutSuccessUI() {
  if (isCheckoutSuccess()) {
    var loginCard = document.getElementById('login-card');
    if (loginCard) {
      loginCard.classList.add('checkout-success');
    }
    // Clean URL without reloading (remove ?checkout=success)
    if (window.history && window.history.replaceState) {
      var cleanUrl = window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);
    }
  }
}

// Apply checkout success UI immediately
applyCheckoutSuccessUI();

/* ====== CLAIM SUBSCRIPTION ====== */
async function claimSubscription() {
  var emailInput = document.getElementById('claim-email');
  var statusEl = document.getElementById('claim-status');
  var btn = document.getElementById('btn-claim-subscription');
  
  if (!emailInput || !statusEl) return;
  
  var checkoutEmail = (emailInput.value || '').trim().toLowerCase();
  
  if (!checkoutEmail || checkoutEmail.indexOf('@') === -1) {
    statusEl.textContent = 'Please enter a valid email address.';
    statusEl.className = 'claim-status error';
    return;
  }
  
  // Disable button and show loading
  if (btn) {
    btn.disabled = true;
    btn.textContent = 'Linking...';
  }
  statusEl.textContent = '';
  statusEl.className = 'claim-status';
  
  try {
    var response = await fetch(ROBOT_API + '/api/claim-subscription', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ checkout_email: checkoutEmail })
    });
    
    var data = await response.json();
    
    if (data.ok) {
      if (data.already_active) {
        statusEl.textContent = 'You already have an active subscription!';
        statusEl.className = 'claim-status success';
      } else if (data.claimed) {
        statusEl.textContent = 'Subscription linked successfully! Refreshing...';
        statusEl.className = 'claim-status success';
        // Refresh the page to show the unlocked UI
        setTimeout(function() {
          window.location.reload();
        }, 1500);
        return; // Don't re-enable button since we're reloading
      } else {
        statusEl.textContent = data.message || 'Subscription linked!';
        statusEl.className = 'claim-status success';
      }
    } else {
      statusEl.textContent = data.error || 'Could not link subscription. Please try again.';
      statusEl.className = 'claim-status error';
    }
  } catch (e) {
    statusEl.textContent = 'Network error. Please check your connection and try again.';
    statusEl.className = 'claim-status error';
  }
  
  // Re-enable button
  if (btn) {
    btn.disabled = false;
    btn.textContent = 'Link Subscription';
  }
}

// Wire up claim subscription button
(function() {
  var claimBtn = document.getElementById('btn-claim-subscription');
  var claimEmail = document.getElementById('claim-email');
  
  if (claimBtn) {
    claimBtn.addEventListener('click', claimSubscription);
  }
  
  // Allow Enter key to submit
  if (claimEmail) {
    claimEmail.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        claimSubscription();
      }
    });
  }
})();

/* ====== Bootstrap ====== */
initAuth();
</script>
</body>
</html>
