<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DomainSafe — Calm · Minimal · One‑and‑done</title>
  <style>
    :root{
      --bg:#0f1221; --fg:#e8ebff; --mut:#b8c3ff; --card:#121633; --border:#2a3470; --accent:#9dc0ff;
      --ok:#2ecc71; --warn:#f1c40f; --bad:#e74c3c; --btn:#233064;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:32px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    a{color:var(--accent);text-decoration:none}
    h1{margin:0 0 12px 0;font-size:24px}
    h2{margin:28px 0 12px 0;font-size:18px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px}
    .full{grid-column:1/13}.half{grid-column:1/7}.halfR{grid-column:7/13}
    label{display:block;margin:6px 0 4px 0;color:var(--mut);font-size:12px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:#0f1533;color:var(--fg);font-family:inherit}
    textarea{min-height:88px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > div{flex:1 1 200px}
    .btn{background:var(--btn);border:1px solid var(--border);padding:10px 14px;border-radius:8px;cursor:pointer;color:var(--fg)}
    .btn.secondary{background:transparent}
    .btn.ok{background:#1d7b46;border-color:#1d7b46}
    .mono{font-family:var(--mono)}
    .mut{color:var(--mut)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#0f1533}
    .table{width:100%;border-collapse:collapse;font-size:14px}
    .table th,.table td{border:1px solid var(--border);padding:8px 10px;text-align:left;vertical-align:top}
    .log{background:#0b0f26;border:1px solid var(--border);border-radius:8px;padding:10px;white-space:pre-wrap;font-family:var(--mono);min-height:58px}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
    .tips{color:var(--mut);margin-top:0}
    .section-note{font-size:12px;color:var(--mut)}
  </style>
</head>
<body>

  <h1>DomainSafe is live ✅ <span class="mut pill">StepUp‑UI</span></h1>
  <p class="mut">Status, Quick‑Codes, Verify, one‑click Connect, new DMARC Policy Step‑Up, Control SPF, Insights. The robot keeps watch daily.</p>

  <div class="grid">

    <!-- Domain Status -->
    <div class="card full">
      <h2>Domain Status (daily robot checks)</h2>
      <div class="row" style="align-items:center">
        <button class="btn" id="stRefresh">Refresh status</button>
        <button class="btn secondary" id="stRun">Run now (dev)</button>
        <span id="stOk" class="pill mut">—</span>
      </div>
      <div style="overflow:auto;margin-top:10px">
        <table class="table" id="stTable">
          <thead><tr>
            <th>Domain</th><th>Owner</th><th>SPF</th><th>DMARC</th><th>DKIM s1</th><th>DKIM s2</th><th>Checked at</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Add Domain -->
    <div class="card half">
      <h2>Add Domain</h2>
      <div class="row">
        <div><label>Contact email</label><input id="adEmail" placeholder="you@example.com"></div>
        <div><label>Domain</label><input id="adDomain" placeholder="example.com"></div>
      </div>
      <div class="row" style="align-items:center;gap:12px;margin-top:8px">
        <button class="btn" id="adAdd">Add domain</button>
        <span class="mut" id="adWait">Waiting…</span>
      </div>
      <h3 style="margin-top:16px">Recent domains</h3>
      <div style="max-height:180px;overflow:auto">
        <table class="table" id="adRecent">
          <thead><tr><th>Domain</th><th>Status</th><th>Owner</th><th>Created</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Quick-Codes -->
    <div class="card halfR">
      <h2>Quick‑Codes (one‑time DNS)</h2>
      <p class="tips">Use if you don’t want to connect a provider account. Paste these at your DNS provider and you’re done.</p>
      <div class="row">
        <div><label>Domain to secure</label><input id="qcDomain" placeholder="example.com"></div>
      </div>
      <div class="row" style="gap:12px;margin-top:8px">
        <button class="btn" id="qcGen">Generate Quick‑Codes</button>
        <label class="mut" style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="qcExtras"> Show optional extras (MTA‑STS & TLS‑RPT)</label>
        <button class="btn secondary" id="qcCopy">Copy all</button>
      </div>
      <pre class="log" id="qcOut">Enter a domain → Generate.</pre>
    </div>

    <!-- Verify -->
    <div class="card half">
      <h2>Verify Records</h2>
      <div class="row">
        <div><label>Domain to check</label><input id="vrDomain" placeholder="example.com"></div>
      </div>
      <div class="row" style="gap:12px;margin-top:8px">
        <button class="btn" id="vrCheck">Check</button>
      </div>
      <pre class="log" id="vrOut">Enter a domain → Check.</pre>
    </div>

    <!-- Connect Cloudflare -->
    <div class="card halfR">
      <h2>Connect Cloudflare (one‑click Protect)</h2>
      <p class="tips">Paste a Cloudflare API Token (Zone:Read + DNS:Edit). Token is used only for this request.</p>
      <div class="row">
        <div><label>Cloudflare API Token</label><input id="cfToken" placeholder="paste token here"></div>
      </div>
      <div class="row" style="gap:12px;margin-top:8px">
        <button class="btn" id="cfList">List zones</button>
        <select id="cfZones"><option value="">— choose a zone —</option></select>
        <button class="btn ok" id="cfProtect">Protect</button>
      </div>
      <pre class="log" id="cfLog">Paste token → List zones → choose zone → Protect.</pre>
    </div>

    <!-- Connect Route 53 -->
    <div class="card half">
      <h2>Connect AWS Route 53 (one‑click Protect)</h2>
      <p class="tips">Paste an AWS Access Key ID + Secret (IAM user limited to Route 53). Keys are used only for this request.</p>
      <div class="row">
        <div><label>AWS Access Key ID</label><input id="r53Key" placeholder="AKIA..."></div>
        <div><label>AWS Secret Access Key</label><input id="r53Secret" placeholder="********"></div>
      </div>
      <div class="row" style="gap:12px;margin-top:8px">
        <button class="btn" id="r53List">List hosted zones</button>
        <select id="r53Zones"><option value="">— choose a hosted zone —</option></select>
        <button class="btn ok" id="r53Protect">Protect</button>
      </div>
      <pre class="log" id="r53Log">Paste keys → List hosted zones → choose one → Protect.</pre>
    </div>

    <!-- DMARC Policy Step‑Up -->
    <div class="card full">
      <h2>DMARC Policy Step‑Up (None → Quarantine → Reject)</h2>
      <p class="tips">Start safe in monitor (<span class="mono">p=none</span>), then raise to <b>quarantine</b> (percentage of mail), finally <b>reject</b>. We write TXT at <span class="mono">_dmarc.&lt;domain&gt;</span>.</p>

      <div class="row" style="align-items:center;gap:18px">
        <div><label>Mode</label></div>
        <label><input type="radio" name="ps-policy" value="none"> None (monitor)</label>
        <label><input type="radio" name="ps-policy" value="quarantine" checked> Quarantine</label>
        <label><input type="radio" name="ps-policy" value="reject"> Reject</label>
      </div>

      <div class="row">
        <div><label>Aggregate reports (RUA)</label><input id="ps-rua" value="mailto:dmarc@domainsafepro.com"></div>
        <div><label>Preview TXT (<span class="mono">_dmarc</span>)</label><textarea id="ps-preview" readonly>v=DMARC1; p=none; adkim=s; aspf=s; rua=mailto:dmarc@domainsafepro.com; pct=100</textarea></div>
      </div>

      <div class="row">
        <div><label>Target domain (apex)</label><input id="ps-domain" placeholder="example.com"></div>
        <div><label>% of mail (pct)</label><input id="ps-pct" type="number" min="1" max="100" value="25"></div>
      </div>

      <div class="row" style="align-items:center;gap:18px">
        <div><label>Alignment</label></div>
        <label><input type="checkbox" id="ps-strict" checked> Strict alignment (adkim=s, aspf=s)</label>
      </div>

      <div class="row" style="gap:12px;margin-top:8px">
        <button class="btn secondary" id="psPreviewBtn">Preview</button>
        <button class="btn" id="psCF">Apply via Cloudflare (uses selected zone)</button>
        <button class="btn" id="psR53">Apply via Route 53 (uses selected hosted zone)</button>
        <a class="btn secondary" id="psEval" href="#" target="_blank">Run automation (bookmark)</a>
      </div>
      <pre class="log" id="ps-log">Use Preview, then Apply via CF or R53. For “other DNS”, copy the TXT from Preview.</pre>
      <p class="section-note">Safety: “Protect” never downgrades DMARC. If a stricter policy already exists, we preserve it.</p>
    </div>

    <!-- Control SPF -->
    <div class="card full">
      <h2>Control SPF (central include for all protected domains)</h2>
      <p class="tips">Choose senders and update <span class="mono">_spf.control.domainsafepro.com</span> once. All protected domains inherit it.</p>

      <div class="row">
        <div class="half">
          <label>Senders (include)</label>
          <div class="row" style="gap:8px">
            <label><input type="checkbox" class="spfOpt" value="include:_spf.google.com"> Google Workspace</label>
            <label><input type="checkbox" class="spfOpt" value="include:spf.protection.outlook.com"> Microsoft 365</label>
            <label><input type="checkbox" class="spfOpt" value="include:sendgrid.net"> SendGrid</label>
            <label><input type="checkbox" class="spfOpt" value="include:amazonses.com"> Amazon SES</label>
            <label><input type="checkbox" class="spfOpt" value="include:mailgun.org"> Mailgun</label>
            <label><input type="checkbox" class="spfOpt" value="include:servers.mcsv.net"> Mailchimp</label>
            <label><input type="checkbox" class="spfOpt" value="include:spf.mtasv.net"> Postmark</label>
            <label><input type="checkbox" class="spfOpt" value="include:_spf.sparkpostmail.com"> SparkPost</label>
            <label><input type="checkbox" class="spfOpt" value="include:zoho.com"> Zoho</label>
            <label><input type="checkbox" class="spfOpt" value="include:mail.zendesk.com"> Zendesk</label>
            <label><input type="checkbox" class="spfOpt" value="include:mail.intercom.io"> Intercom</label>
          </div>
        </div>
        <div class="halfR">
          <label>Preview (TXT <span class="mono">_spf.control.domainsafepro.com</span>)</label>
          <textarea id="spfPreview" class="mono">v=spf1 ~all</textarea>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="half"><label>Cloudflare API Token (Zone:Read + DNS:Edit on domainsafepro.com)</label><input id="spfTok" placeholder="paste token here"></div>
      </div>
      <div class="row" style="gap:12px;margin-top:8px">
        <button class="btn" id="spfLoad">Load current</button>
        <button class="btn ok" id="spfSave">Update control SPF</button>
      </div>
      <pre class="log" id="spfLog">Use “Load current” to see existing value, select senders, then “Update”.</pre>
    </div>

    <!-- Insights (lightweight scaffolding) -->
    <div class="card full">
      <h2>DMARC Insights (beta)</h2>
      <div class="row">
        <div><label>Domain</label><input id="insDomain" value="domainsafepro.com"></div>
      </div>
      <div class="row" style="gap:12px;margin-top:8px">
        <button class="btn" id="ins7">Load 7‑day</button>
        <button class="btn" id="ins30">Load 30‑day</button>
      </div>
      <pre class="log" id="insLog">Use the buttons to query summary windows from the robot. (This is a simple textual summary.)</pre>
    </div>

    <!-- Docs -->
    <div class="card full">
      <h2>Docs (short & practical)</h2>
      <h3>Option A — Quick‑Codes (copy‑paste at your DNS provider)</h3>
      <ol>
        <li>Enter your domain in Quick‑Codes → Generate.</li>
        <li>Copy each required row (use Copy buttons) and paste at your DNS provider (TXT/CNAME records).</li>
        <li>(Optional) Tick “Show optional extras” and add those too.</li>
        <li>Go to Verify Records → Check → expect all green.</li>
      </ol>
      <p>Platform links: <a href="https://dash.cloudflare.com" target="_blank">Cloudflare Dashboard</a> · <a href="https://console.aws.amazon.com/route53/" target="_blank">AWS Route 53</a></p>

      <h3>Option B — Connect Cloudflare (one‑click)</h3>
      <ol>
        <li>Cloudflare → API Tokens → Create Token (Zone:Read + DNS:Edit).</li>
        <li>Paste token here → List zones → choose zone → Protect.</li>
        <li>Use Verify to confirm.</li>
      </ol>

      <h3>Option C — Connect AWS Route 53 (one‑click)</h3>
      <ol>
        <li>AWS IAM → create user with Route 53 access (first test).</li>
        <li>Create access key → paste here → List hosted zones → choose → Protect.</li>
        <li>Use Verify to confirm.</li>
      </ol>

      <h3>What the robot sets</h3>
      <ul>
        <li>SPF TXT at apex: <span class="mono">v=spf1 include:_spf.control.domainsafepro.com ~all</span></li>
        <li>DKIM CNAMEs: <span class="mono">s1._domainkey</span> and <span class="mono">s2._domainkey</span> → central keys</li>
        <li>DMARC TXT at <span class="mono">_dmarc</span>: start in monitor mode (<span class="mono">p=none</span>)</li>
        <li>Extras (optional): <span class="mono">mta-sts</span> CNAME and <span class="mono">_smtp._tls</span> TXT for TLS reporting</li>
      </ul>
      <p>You can tighten DMARC later without touching customer DNS because SPF/DKIM are centrally included.</p>
    </div>

  </div>

  <script>
    // ─────────────────────────────────────────────────────────────────────
    // Config — no placeholders: your live Worker and control domain.
    const API_BASE = "https://domainsafe-robot.pankajonlinerepository.workers.dev";
    const CONTROL_DOMAIN = "control.domainsafepro.com";
    const CF_ZONE_ID_DOMAINSafe = "cdef12f697794db4095acd67e555f9e8"; // fallback for control SPF if robot endpoint is unavailable

    // Remember currently selected zone/hosted zone for Apply buttons
    let CURRENT_CF = { token: "", zone_id: "", zone_name: "" };
    let CURRENT_R53 = { access_key_id: "", secret_access_key: "", hosted_zone_id: "", zone_name: "" };

    // Helpers
    const $ = (q) => document.querySelector(q);
    const log = (el, v) => el.textContent = (typeof v === "string" ? v : JSON.stringify(v, null, 2));
    const jget = async (url) => (await fetch(url)).json();
    const jpost = async (url, body) => (await fetch(url, { method: "POST", headers: { "content-type": "application/json" }, body: JSON.stringify(body||{}) })).json();

    // Copy util for Quick-Codes
    async function copy(text){ try { await navigator.clipboard.writeText(text); } catch {} }

    // ─────────────────────────────────────────────────────────────────────
    // Status
    async function loadStatus(){
      const j = await jget(API_BASE + "/api/status");
      const tb = $("#stTable tbody"); tb.innerHTML = "";
      if (!j.ok) { $("#stOk").textContent = "Error"; return; }
      const rows = j.rows || [];
      let okCount = 0;
      for(const r of rows){
        const tr = document.createElement("tr");
        const toCell = (v)=>{ const td=document.createElement("td"); td.textContent = (v ?? ""); return td; };
        tr.appendChild(toCell(r.domain_name));
        tr.appendChild(toCell(r.email || ""));
        tr.appendChild(toCell(r.spf_ok ? "OK" : "Needs fix"));
        tr.appendChild(toCell(r.dmarc_ok ? "OK" : "Needs fix"));
        tr.appendChild(toCell(r.dkim_s1_ok ? "OK" : "Needs fix"));
        tr.appendChild(toCell(r.dkim_s2_ok ? "OK" : "Needs fix"));
        tr.appendChild(toCell(r.checked_at || ""));
        tb.appendChild(tr);
        if (r.spf_ok && r.dmarc_ok && r.dkim_s1_ok && r.dkim_s2_ok) okCount++;
      }
      $("#stOk").textContent = rows.length ? (okCount === rows.length ? "OK" : "Some need fix") : "—";
    }
    $("#stRefresh").addEventListener("click", loadStatus);
    $("#stRun").addEventListener("click", async ()=>{ await jpost(API_BASE + "/api/monitor-run"); await loadStatus(); });

    // ─────────────────────────────────────────────────────────────────────
    // Add Domain
    async function loadRecent(){
      const j = await jget(API_BASE + "/api/status");
      const tb = $("#adRecent tbody"); tb.innerHTML = "";
      for(const r of (j.rows || [])){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.domain_name}</td><td>${(r.spf_ok&&r.dmarc_ok&&r.dkim_s1_ok&&r.dkim_s2_ok)?"connected":"pending"}</td><td>${r.email||""}</td><td>${r.checked_at||""}</td>`;
        tb.appendChild(tr);
      }
    }
    $("#adAdd").addEventListener("click", async ()=>{
      $("#adWait").textContent = "Adding…";
      const j = await jpost(API_BASE + "/api/domains", {
        email: $("#adEmail").value.trim(),
        domain: $("#adDomain").value.trim().toLowerCase()
      });
      $("#adWait").textContent = j.ok ? "Added (or already present)." : ("Error: " + (j.error || "failed"));
      await loadRecent();
    });

    // ─────────────────────────────────────────────────────────────────────
    // Quick‑Codes
    $("#qcGen").addEventListener("click", async ()=>{
      const d = $("#qcDomain").value.trim().toLowerCase();
      if (!d) return log($("#qcOut"), "Enter a domain first.");
      const j = await jget(API_BASE + "/api/quick-codes?domain=" + encodeURIComponent(d));
      if (!j.ok) return log($("#qcOut"), j);
      const wantExtras = $("#qcExtras").checked;
      const lines = [];
      for (const r of (j.records||[])) lines.push(`${r.type}\t${r.name}\t${r.value}\t; ${r.purpose||""}`);
      if (wantExtras) for (const r of (j.extras||[])) lines.push(`${r.type}\t${r.name}\t${r.value}\t; ${r.purpose||""}`);
      log($("#qcOut"), lines.join("\n"));
    });
    $("#qcCopy").addEventListener("click", ()=> copy($("#qcOut").textContent||""));

    // Verify
    $("#vrCheck").addEventListener("click", async ()=>{
      const d = $("#vrDomain").value.trim().toLowerCase();
      if (!d) return log($("#vrOut"), "Enter a domain first.");
      const j = await jget(API_BASE + "/api/check-quick-codes?domain=" + encodeURIComponent(d));
      log($("#vrOut"), j);
    });

    // ─────────────────────────────────────────────────────────────────────
    // Cloudflare Connect
    $("#cfList").addEventListener("click", async ()=>{
      CURRENT_CF.token = $("#cfToken").value.trim();
      const j = await jpost(API_BASE + "/api/cf/list-zones", { token: CURRENT_CF.token });
      if (!j.ok) return log($("#cfLog"), j);
      const sel = $("#cfZones"); sel.innerHTML = `<option value="">— choose a zone —</option>`;
      for (const z of (j.zones || [])){
        const opt = document.createElement("option");
        opt.value = z.id; opt.textContent = `${z.name} (${z.status})`;
        sel.appendChild(opt);
      }
      log($("#cfLog"), "Choose a zone, then click Protect.");
    });
    $("#cfZones").addEventListener("change", (e)=>{
      CURRENT_CF.zone_id = e.target.value || "";
      const label = e.target.options[e.target.selectedIndex]?.textContent || "";
      CURRENT_CF.zone_name = label.split(" (")[0] || "";
      // Also prime Step‑Up domain field
      if (CURRENT_CF.zone_name) $("#ps-domain").value = CURRENT_CF.zone_name;
    });
    $("#cfProtect").addEventListener("click", async ()=>{
      if (!CURRENT_CF.token || !CURRENT_CF.zone_id) return log($("#cfLog"), "Paste token, list zones, choose one, then Protect.");
      const j = await jpost(API_BASE + "/api/cf/protect", { token: CURRENT_CF.token, zone_id: CURRENT_CF.zone_id });
      log($("#cfLog"), j);
      // Also refresh status table
      await loadStatus();
    });

    // ─────────────────────────────────────────────────────────────────────
    // Route 53 Connect
    $("#r53List").addEventListener("click", async ()=>{
      CURRENT_R53.access_key_id = $("#r53Key").value.trim();
      CURRENT_R53.secret_access_key = $("#r53Secret").value.trim();
      const j = await jpost(API_BASE + "/api/r53/list-zones", {
        access_key_id: CURRENT_R53.access_key_id,
        secret_access_key: CURRENT_R53.secret_access_key
      });
      if (!j.ok) return log($("#r53Log"), j);
      const sel = $("#r53Zones"); sel.innerHTML = `<option value="">— choose a hosted zone —</option>`;
      for (const z of (j.zones || [])){
        const opt = document.createElement("option");
        opt.value = z.id; opt.textContent = `${z.name}`;
        sel.appendChild(opt);
      }
      log($("#r53Log"), "Choose a hosted zone, then Protect.");
    });
    $("#r53Zones").addEventListener("change", (e)=>{
      CURRENT_R53.hosted_zone_id = e.target.value || "";
      CURRENT_R53.zone_name = e.target.options[e.target.selectedIndex]?.textContent || "";
      if (CURRENT_R53.zone_name) $("#ps-domain").value = CURRENT_R53.zone_name.replace(/\.$/,"");
    });
    $("#r53Protect").addEventListener("click", async ()=>{
      if (!CURRENT_R53.access_key_id || !CURRENT_R53.secret_access_key || !CURRENT_R53.hosted_zone_id) return log($("#r53Log"), "Paste keys, list hosted zones, choose one, then Protect.");
      const j = await jpost(API_BASE + "/api/r53/protect", {
        access_key_id: CURRENT_R53.access_key_id,
        secret_access_key: CURRENT_R53.secret_access_key,
        hosted_zone_id: CURRENT_R53.hosted_zone_id
      });
      log($("#r53Log"), j);
      await loadStatus();
    });

    // ─────────────────────────────────────────────────────────────────────
    // DMARC Step‑Up
    function currentPolicy(){ const r = document.querySelector('input[name="ps-policy"]:checked'); return r ? r.value : "none"; }
    function buildDmarcString(pct, adkim, aspf){
      return `v=DMARC1; p=${currentPolicy()}; pct=${pct}; adkim=${adkim}; aspf=${aspf}; rua=${$("#ps-rua").value.trim()||"mailto:dmarc@domainsafepro.com"}; fo=1`;
    }
    function updatePreview(){
      const strict = $("#ps-strict").checked; const adkim = strict ? "s" : "r"; const aspf = strict ? "s" : "r";
      const pct = Math.max(1, Math.min(100, Number($("#ps-pct").value || 100)));
      $("#ps-preview").value = buildDmarcString(pct, adkim, aspf);
    }
    document.querySelectorAll('input[name="ps-policy"], #ps-pct, #ps-strict, #ps-rua').forEach(e=> e.addEventListener("input", updatePreview));
    updatePreview();

    $("#psPreviewBtn").addEventListener("click", async ()=>{
      const d = $("#ps-domain").value.trim().toLowerCase();
      if (!d) return log($("#ps-log"), "Enter a domain (apex) first.");
      const j = await jget(API_BASE + "/policy/preview?domain=" + encodeURIComponent(d));
      log($("#ps-log"), j);
    });

    $("#psCF").addEventListener("click", async ()=>{
      const domain = $("#ps-domain").value.trim().toLowerCase();
      if (!domain) return log($("#ps-log"), "Enter domain.");
      const pct = Math.max(1, Math.min(100, Number($("#ps-pct").value || 25)));
      const strict = $("#ps-strict").checked; const adkim = strict ? "s":"r"; const aspf = strict ? "s":"r";
      const token = $("#cfToken").value.trim() || undefined;   // optional; Worker can use its secret
      const zone_id = CURRENT_CF.zone_id || undefined;         // optional; Worker can infer from ledger
      const body = { domain, policy: currentPolicy(), pct, adkim, aspf };
      if (token) body.token = token;
      if (zone_id) body.zone_id = zone_id;
      const j = await jpost(API_BASE + "/api/policy/dmarc/cf", body);
      log($("#ps-log"), j);
    });

    $("#psR53").addEventListener("click", async ()=>{
      const domain = $("#ps-domain").value.trim().toLowerCase();
      const pct = Math.max(1, Math.min(100, Number($("#ps-pct").value || 25)));
      const strict = $("#ps-strict").checked; const adkim = strict ? "s":"r"; const aspf = strict ? "s":"r";
      if (!domain || !CURRENT_R53.hosted_zone_id) return log($("#ps-log"), "Choose a Route 53 hosted zone first.");
      const j = await jpost(API_BASE + "/api/policy/dmarc/r53", {
        domain, policy: currentPolicy(), pct, adkim, aspf, hosted_zone_id: CURRENT_R53.hosted_zone_id
      });
      log($("#ps-log"), j);
    });

    // Bookmarkable automation run
    $("#psEval").href = API_BASE + "/policy/evaluate-now";

    // ─────────────────────────────────────────────────────────────────────
    // Control SPF
    function recomputeSpf(){
      const opts = [...document.querySelectorAll(".spfOpt:checked")].map(i=>i.value);
      const parts = ["v=spf1"].concat(opts);
      parts.push("~all");
      $("#spfPreview").value = parts.join(" ");
    }
    document.querySelectorAll(".spfOpt").forEach(cb=> cb.addEventListener("change", recomputeSpf));

    $("#spfLoad").addEventListener("click", async ()=>{
      const tok = $("#spfTok").value.trim();
      if (!tok){ log($("#spfLog"), "Paste your Cloudflare API token for domainsafepro.com"); return; }
      // Try robot endpoint first (preferred)
      try{
        const j = await jget(API_BASE + "/api/cf/control-spf?token=" + encodeURIComponent(tok));
        if (j && j.ok && j.value){ $("#spfPreview").value = j.value; log($("#spfLog"), j); return; }
        throw new Error("robot endpoint not available");
      } catch {
        // Fallback: call CF API directly for TXT _spf.control.domainsafepro.com
        try{
          const H = { "Authorization": "Bearer " + tok };
          const name = "_spf." + CONTROL_DOMAIN;
          const u = "https://api.cloudflare.com/client/v4/zones/"+CF_ZONE_ID_DOMAINSafe+"/dns_records?type=TXT&name="+encodeURIComponent(name);
          const res = await fetch(u, { headers: H }).then(r=>r.json());
          const rec = res?.result?.find(r=>/^v=spf1\b/i.test(r?.content||""));
          if (rec){ $("#spfPreview").value = rec.content; log($("#spfLog"), {ok:true, value:rec.content}); }
          else log($("#spfLog"), {ok:false, error:"No SPF record found"});
        } catch(e){ log($("#spfLog"), {ok:false, error:e.message||String(e)}); }
      }
    });

    $("#spfSave").addEventListener("click", async ()=>{
      const tok = $("#spfTok").value.trim();
      if (!tok){ log($("#spfLog"), "Paste your Cloudflare API token for domainsafepro.com"); return; }
      const value = $("#spfPreview").value.trim() || "v=spf1 ~all";
      // Try robot endpoint first
      try{
        const j = await jpost(API_BASE + "/api/cf/control-spf", { token: tok, value });
        if (j && j.ok){ log($("#spfLog"), j); return; }
        throw new Error("robot endpoint not available");
      } catch {
        // Fallback: CF API direct upsert
        try{
          const name = "_spf." + CONTROL_DOMAIN;
          const H = { "Authorization":"Bearer "+tok, "content-type":"application/json" };
          const listU = "https://api.cloudflare.com/client/v4/zones/"+CF_ZONE_ID_DOMAINSafe+"/dns_records?type=TXT&name="+encodeURIComponent(name);
          const listJ = await fetch(listU, { headers:H }).then(r=>r.json());
          if (listJ?.result?.length){
            const id = listJ.result[0].id;
            const upd = await fetch("https://api.cloudflare.com/client/v4/zones/"+CF_ZONE_ID_DOMAINSafe+"/dns_records/"+id, {
              method:"PUT", headers:H, body: JSON.stringify({ type:"TXT", name, content:value, ttl:3600 })
            }).then(r=>r.json());
            log($("#spfLog"), upd);
          } else {
            const crt = await fetch("https://api.cloudflare.com/client/v4/zones/"+CF_ZONE_ID_DOMAINSafe+"/dns_records", {
              method:"POST", headers:H, body: JSON.stringify({ type:"TXT", name, content:value, ttl:3600 })
            }).then(r=>r.json());
            log($("#spfLog"), crt);
          }
        } catch(e){ log($("#spfLog"), {ok:false, error:e.message||String(e)}); }
      }
    });

    // ─────────────────────────────────────────────────────────────────────
    // Insights (simple window summaries based on policy preview windows)
    async function loadWindow(days){
      const dom = $("#insDomain").value.trim().toLowerCase();
      if (!dom) return log($("#insLog"), "Enter a domain.");
      // We don’t have a public summary endpoint; show policy preview + status to keep it simple.
      const prev = await jget(API_BASE + "/policy/preview?domain="+encodeURIComponent(dom));
      const st = await jget(API_BASE + "/api/status?domain="+encodeURIComponent(dom));
      log($("#insLog"), { domain: dom, days, preview: prev, status: st });
    }
    $("#ins7").addEventListener("click", ()=> loadWindow(7));
    $("#ins30").addEventListener("click", ()=> loadWindow(30));

    // Initial paint
    (async function init(){
      await loadStatus();
      await loadRecent();
      recomputeSpf();
    })();
  </script>
</body>
</html>
