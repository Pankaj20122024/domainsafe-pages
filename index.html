<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DomainSafePro - Setup Your Protection</title>
  <meta name="description" content="Set up email authentication for your domain. Get your DNS records and verify your protection status."/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vollkorn:wght@600&family=Exo+2:wght@600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://rsms.me/">
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">

  <style>
/* ========== TOKENS (matching landing page) ========== */
:root {
  --font-serif: 'Vollkorn', Georgia, serif;
  --font-sans: 'Inter', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  --font-brand: 'Exo 2', sans-serif;
  --font-mono: 'Roboto Mono', 'Fira Code', ui-monospace, monospace;
  --radius: 14px;
  --radius-sm: 8px;
  --maxw: 1100px;
  --fast-transition: 0.15s ease;
  --med-transition: 0.3s ease;
}

[data-theme="dark"] {
  --bg: #0c0c0e;
  --bg-card: #141417;
  --bg-alt: #1a1a1d;
  --bg-input: rgba(0,0,0,0.25);
  --fg: #ededf0;
  --fg-muted: #9496a3;
  --border: rgba(255,255,255,0.1);
  --border-glow: rgba(255,255,255,0.2);
  --brand: #5a81ff;
  --brand-accent: #8a7aff;
  --warn: #ffd36a;
  --ok: #67e8a3;
  --danger: #ff7a7a;
  --shadow-color: rgba(0,0,0,0.3);
  --glass-bg: rgba(20,20,23,0.55);
  --glass-border: rgba(255,255,255,0.12);
  --highlight-bg: rgba(90,129,255,0.08);
  --highlight-border: rgba(90,129,255,0.3);
}

[data-theme="light"] {
  --bg: #fafafa;
  --bg-card: #ffffff;
  --bg-alt: #f5f5f5;
  --bg-input: rgba(0,0,0,0.04);
  --fg: #111113;
  --fg-muted: #55555c;
  --border: rgba(0,0,0,0.1);
  --border-glow: rgba(0,0,0,0.2);
  --brand: #4a75ff;
  --brand-accent: #7a6aff;
  --warn: #f5a623;
  --ok: #28a745;
  --danger: #d9534f;
  --shadow-color: rgba(0,0,0,0.08);
  --glass-bg: rgba(255,255,255,0.6);
  --glass-border: rgba(0,0,0,0.08);
  --highlight-bg: rgba(74,117,255,0.06);
  --highlight-border: rgba(74,117,255,0.25);
}

/* ========== BASE ========== */
* { box-sizing: border-box; }
html { scroll-behavior: smooth; font-feature-settings: 'liga' 1, 'kern' 1; }
html, body { max-width: 100%; overflow-x: clip; }
body {
  margin: 0;
  min-height: 100vh;
  background: linear-gradient(135deg, var(--bg) 0%, var(--bg-alt) 50%, var(--bg) 100%);
  color: var(--fg);
  font-family: var(--font-sans);
  font-size: 17px;
  line-height: 1.7;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  transition: background-color var(--med-transition), color var(--med-transition);
}
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 1000px;
  height: 1000px;
  background: radial-gradient(circle, rgba(90,129,255,0.06) 0%, transparent 70%);
  pointer-events: none;
  z-index: 0;
}

h1, h2, h3, h4 {
  font-family: var(--font-serif);
  color: var(--fg);
  font-weight: 600;
  letter-spacing: -0.01em;
  line-height: 1.3;
  margin: 0;
}
p { color: var(--fg-muted); margin: 0; max-width: 65ch; }
a { text-decoration: none; color: var(--brand); }
code, .mono { font-family: var(--font-mono); font-size: 0.9em; }

/* ========== HEADER ========== */
header {
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  background: var(--glass-bg);
  border-bottom: 1px solid var(--glass-border);
  padding: 16px 20px;
}
.header-inner {
  max-width: var(--maxw);
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 12px;
}
.brand {
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 700;
  font-size: 1.4rem;
  color: var(--fg);
  text-decoration: none;
}
.brand:hover {
  opacity: 0.9;
}
.brand-text {
  font-family: var(--font-brand);
  background: linear-gradient(90deg, #5a81ff 0%, #21E6C1 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.header-tag {
  font-size: 13px;
  color: var(--fg-muted);
  display: none;
}
@media (min-width: 768px) {
  .header-tag { display: block; max-width: 400px; }
}

.auth-bar {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}
#auth-status-label {
  font-size: 13px;
  color: var(--fg-muted);
}

/* Theme toggle */
.theme-toggle {
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-card);
  border: 1px solid var(--border);
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  transition: all var(--fast-transition);
}
.theme-toggle:hover { border-color: var(--border-glow); }
.theme-toggle svg { width: 16px; height: 16px; color: var(--fg-muted); }
[data-theme="dark"] .theme-toggle .sun-icon { display: block; }
[data-theme="dark"] .theme-toggle .moon-icon { display: none; }
[data-theme="light"] .theme-toggle .sun-icon { display: none; }
[data-theme="light"] .theme-toggle .moon-icon { display: block; }

/* ========== BUTTONS ========== */
.btn {
  appearance: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 12px 22px;
  border-radius: 999px;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--fast-transition);
  font-size: 15px;
  font-family: var(--font-sans);
  border: 2px solid var(--brand);
  background: var(--brand);
  color: #fff;
  box-shadow: 0 4px 12px var(--shadow-color);
}
.btn:hover {
  filter: brightness(1.1);
  transform: translateY(-1px);
  box-shadow: 0 6px 18px var(--shadow-color);
}
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; filter: none; }

.btn.secondary, .btn-auth {
  background: var(--glass-bg);
  border: 2px solid var(--glass-border);
  color: var(--fg);
  backdrop-filter: blur(8px);
}
.btn.secondary:hover, .btn-auth:hover {
  background: var(--bg-alt);
  border-color: var(--border-glow);
}

.btn.ghost {
  background: transparent;
  border: 2px solid var(--border);
  color: var(--fg-muted);
}
.btn.ghost:hover {
  border-color: var(--border-glow);
  color: var(--fg);
}

.btn.warn {
  background: linear-gradient(135deg, #ffd36a 0%, #f5a623 100%);
  border-color: #f5a623;
  color: #1a1a1d;
}
.btn.warn:hover {
  filter: brightness(1.05);
}

.btn.large {
  padding: 16px 32px;
  font-size: 1rem;
}

.btn-sm {
  padding: 8px 16px;
  font-size: 13px;
}

/* ========== LOADING SECTION ========== */
#loading-section {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  min-height: 60vh;
}
.loading-card {
  width: 100%;
  max-width: 480px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: var(--radius);
  border: 1px solid var(--glass-border);
  padding: 48px 28px;
  box-shadow: 0 24px 60px var(--shadow-color);
  text-align: center;
  position: relative;
  z-index: 1;
}
.loading-spinner {
  width: 48px;
  height: 48px;
  border: 3px solid var(--border);
  border-top-color: var(--brand);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
.loading-card h2 {
  font-size: 1.5rem;
  margin-bottom: 8px;
}
.loading-card p {
  font-size: 15px;
  color: var(--fg-muted);
  max-width: 320px;
  margin: 0 auto;
}

/* ========== PLAN GATE (locked state) ========== */
#plan-gate {
  padding: 60px 20px;
  text-align: center;
  min-height: 60vh;
  display: flex;
  align-items: center;
  justify-content: center;
}
.plan-gate-card {
  width: 100%;
  max-width: 480px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: var(--radius);
  border: 1px solid var(--glass-border);
  padding: 48px 28px;
  box-shadow: 0 24px 60px var(--shadow-color);
  text-align: center;
  position: relative;
  z-index: 1;
}
.plan-gate-card .gate-icon {
  font-size: 48px;
  margin-bottom: 16px;
}
.plan-gate-card h2 {
  font-size: 1.5rem;
  margin-bottom: 12px;
}
.plan-gate-card p {
  font-size: 15px;
  color: var(--fg-muted);
  max-width: 320px;
  margin: 0 auto 24px;
}

/* Show/hide based on auth state */
body.logged-out .show-when-authed { display: none !important; }
body.authed .show-when-logged-out { display: none !important; }

/* ========== MAIN WRAPPER ========== */
main {
  max-width: var(--maxw);
  margin: 0 auto;
  padding: 40px 20px 80px;
  position: relative;
  z-index: 1;
}

/* ========== WELCOME BANNER ========== */
.welcome-banner {
  text-align: center;
  padding: 32px 20px;
  margin-bottom: 36px;
  background: var(--highlight-bg);
  border: 1px solid var(--highlight-border);
  border-radius: var(--radius);
}
.welcome-banner h1 {
  font-size: 1.6rem;
  margin-bottom: 12px;
}
.welcome-banner p {
  font-size: 15px;
  margin: 0 auto;
  max-width: 600px;
}

/* ========== SECTION LAYOUT ========== */
.grid {
  display: grid;
  gap: 24px;
  margin-bottom: 32px;
}
.grid.full { grid-template-columns: 1fr; }
.grid.two { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }

/* ========== CARD ========== */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 28px;
  box-shadow: 0 8px 24px var(--shadow-color);
  transition: border-color var(--fast-transition);
}
.card:hover { border-color: var(--border-glow); }
.card h3 {
  font-size: 1.1rem;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.card h3 .card-icon {
  font-size: 1.2rem;
}
.card .desc {
  font-size: 14px;
  color: var(--fg-muted);
  margin-bottom: 18px;
}
.card.highlight {
  background: var(--highlight-bg);
  border-color: var(--highlight-border);
}

/* ========== ROUTE SELECTION ========== */
#route-selection {
  margin-bottom: 40px;
}
.route-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
  margin-top: 20px;
}
.route-card {
  background: var(--bg-card);
  border: 2px solid var(--border);
  border-radius: var(--radius);
  padding: 28px 24px;
  cursor: pointer;
  transition: all var(--fast-transition);
  text-align: center;
}
.route-card:hover {
  border-color: var(--brand);
  transform: translateY(-2px);
  box-shadow: 0 8px 24px var(--shadow-color);
}
.route-card.selected {
  border-color: var(--brand);
  background: var(--highlight-bg);
}
.route-card-icon {
  width: 64px;
  height: 64px;
  margin: 0 auto 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: var(--bg-alt);
  font-size: 32px;
}
.route-card-icon img {
  width: 64px;
  height: 64px;
  object-fit: contain;
  border-radius: 50%;
}
.route-card h3 {
  font-size: 1rem;
  margin-bottom: 8px;
  justify-content: center;
}
.route-card p {
  font-size: 13px;
  color: var(--fg-muted);
  margin: 0 auto;
  max-width: 200px;
}

/* ========== SETUP SECTIONS (conditional visibility) ========== */
.setup-section {
  display: none;
}
.setup-section.active {
  display: block;
}

/* ========== INSIGHTS SECTION ========== */
.insights-section {
  margin-top: 40px;
  border-top: 1px solid var(--border);
  padding-top: 40px;
}

/* Insights bar chart */
.ins-bar {
  width: 120px;
  height: 8px;
  background: rgba(255,255,255,0.1);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 6px;
}
.ins-bar i {
  display: block;
  height: 100%;
  background: linear-gradient(90deg, var(--brand), var(--ok));
  border-radius: 4px;
}
.ins-stats {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* ========== SOURCE ANALYSIS SECTION ========== */
.sources-section {
  margin-top: 32px;
  border-top: 1px solid var(--border);
  padding-top: 32px;
}

.sources-section h4 {
  font-size: 1rem;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.sources-summary {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  margin-bottom: 20px;
}

.sources-stat {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 12px 18px;
  min-width: 140px;
}

.sources-stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--fg);
  line-height: 1.2;
}

.sources-stat-label {
  font-size: 12px;
  color: var(--fg-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.source-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 16px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  margin-bottom: 10px;
  transition: border-color var(--fast-transition);
}

.source-row:hover {
  border-color: var(--border-glow);
}

.source-row:last-child {
  margin-bottom: 0;
}

.source-identity {
  flex: 1;
  min-width: 0;
}

.source-identity-name {
  font-weight: 600;
  color: var(--fg);
  margin-bottom: 2px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.source-identity-ip {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--fg-muted);
}

.source-identity-org {
  font-size: 12px;
  color: var(--fg-muted);
}

.source-stats {
  display: flex;
  gap: 24px;
  align-items: center;
  flex-wrap: wrap;
}

.source-stat-item {
  text-align: center;
  min-width: 60px;
}

.source-stat-num {
  font-weight: 600;
  font-size: 1.1rem;
  color: var(--fg);
}

.source-stat-lbl {
  font-size: 11px;
  color: var(--fg-muted);
  text-transform: uppercase;
}

.source-status {
  min-width: 100px;
  text-align: right;
}

.pill.authorized {
  background: rgba(103,232,163,0.15);
  color: var(--ok);
}

.pill.partial {
  background: rgba(255,211,106,0.15);
  color: var(--warn);
}

.pill.misconfigured {
  background: rgba(255,211,106,0.2);
  color: var(--warn);
}

.pill.suspicious {
  background: rgba(255,122,122,0.15);
  color: var(--danger);
}

.source-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--bg-alt);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
}

.source-icon.authorized {
  background: rgba(103,232,163,0.15);
}

.source-icon.suspicious {
  background: rgba(255,122,122,0.15);
}

.source-icon.partial,
.source-icon.misconfigured {
  background: rgba(255,211,106,0.15);
}

.sources-empty {
  padding: 32px;
  text-align: center;
  color: var(--fg-muted);
  background: var(--bg-input);
  border: 1px dashed var(--border);
  border-radius: var(--radius-sm);
}

.sources-loading {
  padding: 24px;
  text-align: center;
  color: var(--fg-muted);
}

/* Source details expansion */
.source-details {
  margin-top: 10px;
  padding: 12px 16px;
  background: var(--bg-alt);
  border-radius: var(--radius-sm);
  font-size: 13px;
}

.source-details-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 12px;
}

.source-detail-item {
  display: flex;
  flex-direction: column;
}

.source-detail-label {
  font-size: 11px;
  color: var(--fg-muted);
  text-transform: uppercase;
  margin-bottom: 2px;
}

.source-detail-value {
  color: var(--fg);
  font-weight: 500;
}

.source-detail-value.pass {
  color: var(--ok);
}

.source-detail-value.fail {
  color: var(--danger);
}

/* ========== ADMIN SECTION ========== */
.admin-section {
  margin-top: 48px;
  border-top: 2px solid var(--border);
  padding-top: 32px;
}
.admin-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 16px;
  margin-bottom: 24px;
}
.admin-header h2 {
  font-size: 1.2rem;
  display: flex;
  align-items: center;
  gap: 10px;
}
.admin-toggle {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: var(--fg-muted);
  cursor: pointer;
  padding: 6px 12px;
  border-radius: var(--radius-sm);
  background: var(--bg-input);
  border: 1px solid var(--border);
  transition: all var(--fast-transition);
}
.admin-toggle:hover {
  border-color: var(--border-glow);
  color: var(--fg);
}
.admin-content {
  display: none;
}
.admin-content.visible {
  display: block;
}

.section-title {
  font-size: 13px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--fg-muted);
  margin-bottom: 12px;
  margin-top: 32px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.section-title .icon {
  font-size: 16px;
}
.section-title:first-of-type { margin-top: 0; }

/* ========== FORM ELEMENTS ========== */
label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: var(--fg-muted);
  margin-bottom: 6px;
}
input, select, textarea {
  width: 100%;
  padding: 12px 14px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--fg);
  font-size: 15px;
  font-family: var(--font-sans);
  transition: border-color var(--fast-transition);
}
input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--brand);
}
input[readonly] {
  opacity: 0.7;
}

.checkbox-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 14px;
}
.checkbox-row input[type="checkbox"] {
  width: auto;
}
.checkbox-row label {
  margin: 0;
  font-weight: normal;
  font-size: 14px;
  color: var(--fg);
}

/* Button row */
.btn-row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 16px;
}

/* Spacing helpers */
.mt-sm { margin-top: 8px; }
.mt-md { margin-top: 16px; }
.mb-sm { margin-bottom: 8px; }
.hidden { display: none !important; }
.muted { color: var(--fg-muted); }
.tiny { font-size: 12px; }

/* SPF checkbox grid */
.spf-checkboxes {
  display: flex;
  flex-wrap: wrap;
  gap: 10px 20px;
  margin-bottom: 14px;
}
.spf-checkboxes label {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: var(--fg);
  cursor: pointer;
  margin-bottom: 0;
}
.spf-checkboxes input[type="checkbox"] {
  width: auto;
  margin: 0;
}

/* Row layouts */
.row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 12px;
}
.row:last-child { margin-bottom: 0; }
.row > div { flex: 1 1 200px; }
.row > div.narrow { flex: 0 0 140px; }
.row > div.action { flex: 0 0 auto; align-self: flex-end; }

/* Notice banners */
.notice {
  margin-top: 8px;
  padding: 10px 14px;
  background: rgba(90,129,255,0.1);
  border: 1px solid rgba(90,129,255,0.2);
  border-radius: var(--radius-sm);
  color: var(--brand);
  font-size: 13px;
}

/* ========== LOG / OUTPUT AREAS ========== */
.log {
  white-space: pre-wrap;
  word-break: break-word;
  font-family: var(--font-mono);
  font-size: 13px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 14px;
  max-height: 300px;
  overflow-y: auto;
  color: var(--fg-muted);
}
.log:empty::before {
  content: 'Ready.';
  opacity: 0.5;
}

/* ========== VERIFICATION RESULTS (Human-readable) ========== */
.verify-results {
  margin-top: 16px;
}
.verify-item {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 14px 16px;
  background: var(--bg-input);
  border-radius: var(--radius-sm);
  margin-bottom: 10px;
  border: 1px solid var(--border);
}
.verify-item:last-child { margin-bottom: 0; }
.verify-icon {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  flex-shrink: 0;
}
.verify-icon.pass {
  background: rgba(103,232,163,0.15);
  color: var(--ok);
}
.verify-icon.fail {
  background: rgba(255,122,122,0.15);
  color: var(--danger);
}
.verify-icon.warn {
  background: rgba(255,211,106,0.12);
  color: var(--warn);
}
.verify-content {
  flex: 1;
}
.verify-label {
  font-weight: 600;
  color: var(--fg);
  margin-bottom: 2px;
}
.verify-status {
  font-size: 13px;
  color: var(--fg-muted);
}
.verify-status.pass { color: var(--ok); }
.verify-status.fail { color: var(--danger); }

/* Overall status banner */
.verify-summary {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px 20px;
  border-radius: var(--radius-sm);
  margin-bottom: 16px;
}
.verify-summary.all-pass {
  background: rgba(103,232,163,0.1);
  border: 1px solid rgba(103,232,163,0.3);
}
.verify-summary.has-issues {
  background: rgba(255,211,106,0.1);
  border: 1px solid rgba(255,211,106,0.3);
}
.verify-summary-icon {
  font-size: 28px;
}
.verify-summary-text h4 {
  font-family: var(--font-sans);
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 2px;
}
.verify-summary-text p {
  font-size: 14px;
  margin: 0;
}

/* ========== TABLES ========== */
.table-wrap {
  overflow-x: auto;
  margin-top: 16px;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}
th, td {
  padding: 10px 12px;
  text-align: left;
  border-bottom: 1px solid var(--border);
}
th {
  font-weight: 600;
  color: var(--fg-muted);
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
td {
  color: var(--fg);
}
.pill {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
}
.pill.ok {
  background: rgba(103,232,163,0.15);
  color: var(--ok);
}
.pill.warn {
  background: rgba(255,211,106,0.15);
  color: var(--warn);
}
.pill.bad, .pill.danger {
  background: rgba(255,122,122,0.12);
  color: var(--danger);
}

/* Responsive tables */
@media (max-width: 768px) {
  table, thead, tbody, th, td, tr {
    display: block;
  }
  thead tr {
    position: absolute;
    top: -9999px;
    left: -9999px;
  }
  tr {
    margin-bottom: 16px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px;
    background: var(--bg-input);
  }
  td {
    border: none;
    padding: 8px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  td::before {
    content: attr(data-label);
    font-weight: 600;
    color: var(--fg-muted);
    font-size: 12px;
    text-transform: uppercase;
  }
}

/* ========== QUICK CODES CARDS ========== */
.qc-cards {
  margin-top: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.qc-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 18px 20px;
}
.qc-card-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 14px;
}
.qc-type {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.qc-type.txt {
  background: rgba(90,129,255,0.15);
  color: var(--brand);
}
.qc-type.cname {
  background: rgba(138,122,255,0.15);
  color: var(--brand-accent);
}
.qc-purpose {
  font-size: 13px;
  color: var(--fg-muted);
}
.qc-field {
  margin-bottom: 12px;
}
.qc-field:last-child { margin-bottom: 0; }
.qc-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--fg-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 6px;
}
.qc-value {
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 10px 14px;
}
.qc-value code {
  flex: 1;
  word-break: break-all;
  font-size: 13px;
  color: var(--fg);
}
.copy-btn {
  padding: 6px 12px;
  background: var(--bg-alt);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 12px;
  font-weight: 600;
  color: var(--fg-muted);
  cursor: pointer;
  transition: all var(--fast-transition);
  flex-shrink: 0;
}
.copy-btn:hover {
  border-color: var(--brand);
  color: var(--brand);
}
.copy-btn.copied {
  background: rgba(103,232,163,0.15);
  border-color: var(--ok);
  color: var(--ok);
}

/* ========== DOCS CONTENT ========== */
.docs-content {
  font-size: 14px;
  color: var(--fg-muted);
  line-height: 1.7;
}
.docs-content strong {
  display: block;
  color: var(--fg);
  margin-top: 16px;
  margin-bottom: 6px;
}
.docs-content strong:first-child {
  margin-top: 0;
}
.docs-content p {
  margin-bottom: 10px;
  max-width: none;
}
.docs-content code {
  background: var(--bg-input);
  padding: 2px 6px;
  border-radius: 4px;
  color: var(--fg);
}

/* Details/Summary */
details {
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--bg-input);
}
summary {
  padding: 12px 16px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  color: var(--fg-muted);
  list-style: none;
}
summary::-webkit-details-marker { display: none; }
summary::before {
  content: '‚ñ∏ ';
}
details[open] summary::before {
  content: '‚ñæ ';
}
details > div {
  padding: 12px 16px;
  border-top: 1px solid var(--border);
}

/* ========== FOOTER ========== */
.console-footer {
  text-align: center;
  padding: 24px;
  font-size: 13px;
  color: var(--fg-muted);
  border-top: 1px solid var(--border);
  margin-top: 48px;
}
.console-footer a {
  color: var(--brand);
}

/* ========== PLAN LABEL ========== */
#auth-plan-label {
  font-size: 11px;
  color: var(--fg-muted);
  background: var(--bg-input);
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid var(--border);
}

/* ========== RESPONSIVE ========== */
@media (max-width: 600px) {
  main { padding: 24px 16px 60px; }
  .card { padding: 20px; }
  .welcome-banner { padding: 24px 16px; }
  .welcome-banner h1 { font-size: 1.3rem; }
  .route-cards { grid-template-columns: 1fr; }
  .btn.large { padding: 14px 24px; font-size: 15px; }
  .header-inner { gap: 8px; }
  .brand { font-size: 1.2rem; }
  
  /* Source analysis responsive */
  .source-row {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  .source-stats {
    width: 100%;
    justify-content: space-between;
  }
  .source-status {
    width: 100%;
    text-align: left;
  }
}
  </style>
</head>
<body class="logged-out">

<header>
  <div class="header-inner">
    <a href="https://domainsafepro.com" class="brand">
      <img src="https://res.cloudinary.com/dcvlblp1b/image/upload/v1748456920/dsp-logo-final2_yiqujd.svg" alt="DomainSafePro" style="height:32px;width:auto"/>
      <span class="brand-text">DomainSafePro</span>
    </a>
    <div class="header-tag">Email Authentication on Autopilot</div>
    <div class="auth-bar">
      <span id="auth-status-label">Loading...</span>
      <span id="auth-plan-label" class="hidden"></span>
      <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
        <svg class="sun-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
        <svg class="moon-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
      </button>
      <button id="auth-login-btn" class="btn-auth btn-sm">Sign in with Google</button>
    </div>
  </div>
</header>

<main>
  <!-- LOADING STATE -->
  <section id="loading-section">
    <div class="loading-card">
      <div class="loading-spinner"></div>
      <h2>Loading your console</h2>
      <p>Checking your authentication status...</p>
    </div>
  </section>

  <!-- PLAN GATE (shown when no active plan) -->
  <section id="plan-gate" class="hidden show-when-authed">
    <div class="plan-gate-card">
      <div class="gate-icon">üîí</div>
      <h2>Subscription Required</h2>
      <p>You're signed in as <strong id="plan-gate-email"></strong>, but you don't have an active plan yet.</p>
      <a href="https://domainsafepro.com#pricing" class="btn large">View Pricing Plans</a>
      <p class="tiny muted mt-md">Already purchased? Refresh the page after your subscription is confirmed.</p>
    </div>
  </section>

  <!-- WELCOME BANNER (visible only with active plan) -->
  <div class="welcome-banner hidden show-when-authed" id="welcome-banner">
    <h1>Welcome to Your Setup Console</h1>
    <p>Choose how you would like to protect your domain. We recommend Cloudflare or Route 53 for instant setup, or use manual DNS if you manage records elsewhere.</p>
  </div>

  <!-- ========== ROUTE SELECTION ========== -->
  <section id="route-selection" class="hidden show-when-authed">
    <div class="route-cards">
      <div class="route-card" data-route="cloudflare" onclick="selectRoute('cloudflare')">
        <div class="route-card-icon">
          <img src="https://res.cloudinary.com/dcvlblp1b/image/upload/v1748461426/cloudflare-icon_p0cfsr.svg" alt="Cloudflare"/>
        </div>
        <h3>Cloudflare DNS</h3>
        <p>Connect your Cloudflare account and we will set up everything automatically.</p>
      </div>
      <div class="route-card" data-route="route53" onclick="selectRoute('route53')">
        <div class="route-card-icon">
          <img src="https://res.cloudinary.com/dcvlblp1b/image/upload/v1748461425/route53-icon_qbimwi.svg" alt="AWS Route 53"/>
        </div>
        <h3>AWS Route 53</h3>
        <p>Enter your AWS credentials and we will configure your hosted zone instantly.</p>
      </div>
      <div class="route-card" data-route="manual" onclick="selectRoute('manual')">
        <div class="route-card-icon">üìù</div>
        <h3>Manual DNS</h3>
        <p>Get the DNS records and add them yourself through any domain registrar.</p>
      </div>
    </div>
  </section>

  <!-- ========== CLOUDFLARE SETUP ========== -->
  <div id="setup-cloudflare" class="setup-section">
    <section class="grid full">
      <div class="card highlight">
        <h3><span class="card-icon"><img src="https://res.cloudinary.com/dcvlblp1b/image/upload/v1748461426/cloudflare-icon_p0cfsr.svg" alt="" style="height:24px;vertical-align:middle"/></span> Cloudflare Protection</h3>
        <p class="desc">Connect your Cloudflare account to automatically configure SPF, DKIM, and DMARC records. You will need an API token with "Zone: DNS: Edit" permissions.</p>
        
        <div class="row">
          <div>
            <label for="cf-token">Cloudflare API Token</label>
            <input id="cf-token" class="mono" type="password" placeholder="Paste your API token here" autocomplete="off"/>
          </div>
          <div class="action">
            <button class="btn secondary btn-sm" id="btnCfList">Load My Zones</button>
          </div>
        </div>
        
        <div class="row">
          <div>
            <label for="cf-zones">Select Zone (Domain)</label>
            <select id="cf-zones">
              <option value="">Load zones first</option>
            </select>
          </div>
          <div class="action">
            <button class="btn large" id="btnCfProtect">Protect This Domain</button>
          </div>
        </div>
        
        <pre class="log mt-md" id="cf-log">Paste your Cloudflare API token, then click "Load My Zones".</pre>
        
        <details class="mt-md">
          <summary>How to create a Cloudflare API token</summary>
          <div class="docs-content">
            <p>1. Log in to your Cloudflare dashboard</p>
            <p>2. Go to <strong>My Profile ‚Üí API Tokens</strong></p>
            <p>3. Click <strong>Create Token</strong></p>
            <p>4. Use the "Edit zone DNS" template</p>
            <p>5. Select your specific zone (domain) for security</p>
            <p>6. Create the token and copy it here</p>
          </div>
        </details>
      </div>
    </section>
  </div>

  <!-- ========== ROUTE 53 SETUP ========== -->
  <div id="setup-route53" class="setup-section">
    <section class="grid full">
      <div class="card highlight">
        <h3><span class="card-icon"><img src="https://res.cloudinary.com/dcvlblp1b/image/upload/v1748461425/route53-icon_qbimwi.svg" alt="" style="height:24px;vertical-align:middle"/></span> AWS Route 53 Protection</h3>
        <p class="desc">Connect your AWS account to configure email protection on your Route 53 hosted zones. You will need an IAM user with Route 53 permissions.</p>
        
        <div class="row">
          <div>
            <label for="r53-ak">Access Key ID</label>
            <input id="r53-ak" class="mono" type="password" placeholder="AKIA..." autocomplete="off"/>
          </div>
          <div>
            <label for="r53-sk">Secret Access Key</label>
            <input id="r53-sk" class="mono" type="password" placeholder="Your secret key" autocomplete="off"/>
          </div>
        </div>
        
        <div class="row">
          <div>
            <label for="r53-zones">Select Hosted Zone</label>
            <select id="r53-zones">
              <option value="">Enter credentials to load zones</option>
            </select>
          </div>
          <div class="action">
            <button class="btn large" id="btnR53Protect">Protect This Domain</button>
          </div>
        </div>
        
        <pre class="log mt-md" id="r53-log">Enter your AWS credentials above. Zones will load automatically.</pre>
        
        <details class="mt-md">
          <summary>How to create AWS credentials</summary>
          <div class="docs-content">
            <p>1. Log in to AWS Console ‚Üí IAM</p>
            <p>2. Create a new IAM user (or use existing)</p>
            <p>3. Attach the <strong>AmazonRoute53FullAccess</strong> policy (or a custom policy with Route 53 write permissions)</p>
            <p>4. Generate access keys and paste them here</p>
            <p><strong>Security tip:</strong> Use a dedicated IAM user with minimal permissions for this integration.</p>
          </div>
        </details>
      </div>
    </section>
  </div>

  <!-- ========== MANUAL DNS SETUP ========== -->
  <div id="setup-manual" class="setup-section">
    <!-- STEP 1: GET YOUR CODES -->
    <section class="grid full">
      <div class="card highlight">
        <h3><span class="card-icon">üìã</span> Step 1: Get Your DNS Records</h3>
        <p class="desc">Enter your domain below and we will generate the DNS records you need. Then copy each record and add it at your domain registrar.</p>
        
        <div class="row">
          <div>
            <label for="qc-domain">Your domain name</label>
            <input id="qc-domain" class="mono" placeholder="yourdomain.com" autocapitalize="off" autocorrect="off" spellcheck="false"/>
            <div class="notice hidden" id="qc-notice"></div>
          </div>
          <div class="action">
            <button class="btn large" id="btnQCodes">Generate My Records</button>
          </div>
        </div>
        
        <div class="checkbox-row">
          <input type="checkbox" id="qc-extras"/>
          <label for="qc-extras" style="margin:0">Include advanced security records (MTA-STS and TLS reporting)</label>
        </div>

        <div id="qc-results" class="hidden"></div>
        
        <div id="qc-actions" class="btn-row hidden">
          <button class="btn secondary btn-sm" id="btnCopyAll">Copy All as Text</button>
        </div>
      </div>
    </section>

    <!-- STEP 2: Instructions -->
    <section class="grid full">
      <div class="card">
        <h3><span class="card-icon">üìù</span> Step 2: Add Records to Your DNS</h3>
        <p class="desc">Log in to your domain registrar and add each record from Step 1. Here is what to look for:</p>
        
        <div class="docs-content">
          <strong>Where to add these records</strong>
          <p>Go to your domain registrar (the company where you bought your domain) and find the DNS settings. Common places include: "DNS Management", "DNS Records", or "Zone Editor".</p>
          
          <strong>Adding TXT records</strong>
          <p>For TXT records, create a new record with the "Host" (or "Name") and "Value" exactly as shown. The Host field is usually just the prefix like <code>_dmarc</code>, not the full domain.</p>
          
          <strong>Adding CNAME records</strong>
          <p>For CNAME records, the "Points to" or "Value" field should be the target address we provide. Some registrars add your domain automatically, so just enter the prefix.</p>
          
          <strong>When will it work?</strong>
          <p>DNS changes can take a few minutes to a few hours to spread across the internet. If verification fails at first, wait 15 minutes and try again.</p>
        </div>
      </div>
    </section>
  </div>

  <!-- ========== VERIFY SETUP (Always visible after route selected) ========== -->
  <div id="verify-section" class="setup-section">
    <section class="grid full">
      <div class="card highlight">
        <h3><span class="card-icon">‚úÖ</span> Verify Your Setup</h3>
        <p class="desc">Check if your domain's email protection is configured correctly. We will test each record and tell you if anything needs attention.</p>
        
        <div class="row">
          <div>
            <label for="verify-domain">Domain to verify</label>
            <input id="verify-domain" class="mono" placeholder="yourdomain.com" autocapitalize="off" autocorrect="off" spellcheck="false"/>
            <div class="notice hidden" id="verify-notice"></div>
          </div>
          <div class="action">
            <button class="btn large" id="btnVerify">Verify My Setup</button>
          </div>
        </div>
        
        <div id="verify-results" class="verify-results hidden"></div>
        
        <details class="hidden" id="verify-details">
          <summary>View technical details</summary>
          <div>
            <pre id="verify-log" class="log tiny">Waiting for verification...</pre>
          </div>
        </details>
      </div>
    </section>
  </div>

  <!-- HELP SECTION (Always visible) -->
  <section class="grid full" id="help-section">
    <div class="card">
      <h3><span class="card-icon">üí°</span> Need Help?</h3>
      <div class="docs-content">
        <strong>Not sure which DNS provider you use?</strong>
        <p>Your DNS is typically managed by whoever you registered your domain with (like GoDaddy, Namecheap), or by a service you pointed your nameservers to (like Cloudflare or AWS). Check your domain registrar's settings if unsure.</p>
        
        <strong>Already protected but showing errors?</strong>
        <p>If you set up protection through Cloudflare or Route 53 but verification shows issues, wait a few minutes for DNS to propagate and try again.</p>
      </div>
    </div>
  </section>

  <!-- ========== DMARC INSIGHTS (User-visible for active plans) ========== -->
  <div class="insights-section" id="insights-section">
    <section class="grid full">
      <div class="card">
        <h3><span class="card-icon">üìä</span> Email Authentication Insights</h3>
        <p class="desc">See how well your outgoing emails are authenticating. Higher alignment means better protection against impersonation.</p>
        
        <div class="row">
          <div>
            <label for="ins-domain">Your domain</label>
            <input id="ins-domain" class="mono" placeholder="yourdomain.com" autocapitalize="off"/>
          </div>
          <div class="action">
            <button class="btn secondary btn-sm" id="btnLoad7">Last 7 Days</button>
          </div>
          <div class="action">
            <button class="btn secondary btn-sm" id="btnLoad30">Last 30 Days</button>
          </div>
        </div>
        
        <div id="ins-summary" class="mt-md"><span class="muted">Enter your domain and select a time range to view authentication insights.</span></div>
        
        <div class="table-wrap">
          <table id="ins-table" style="display:none">
            <thead>
              <tr>
                <th>Date</th>
                <th>Emails Sent</th>
                <th>Authenticated</th>
                <th>Protection</th>
                <th style="min-width:140px">Status</th>
              </tr>
            </thead>
            <tbody id="ins-rows"></tbody>
          </table>
        </div>
        
        <div id="ins-explainer" class="docs-content mt-md hidden">
          <strong>What does this mean?</strong>
          <p><b>Authenticated emails</b> passed both SPF and DKIM checks, proving they really came from your authorized servers. Unauthenticated emails may be legitimate services you haven't added yet, or could be someone impersonating your domain.</p>
          <p><b>97%+ alignment</b> is excellent. Below 90% suggests you may have services sending email that aren't properly configured, or potential spoofing attempts.</p>
        </div>
        
        <details class="mt-md">
          <summary>View raw API response</summary>
          <div>
            <pre id="ins-wrap" class="log tiny">‚Äî</pre>
          </div>
        </details>

        <!-- ========== WHO'S SENDING AS YOUR DOMAIN (Source Analysis) ========== -->
        <div class="sources-section" id="sources-section">
          <h4><span>üîç</span> Who's Sending As Your Domain</h4>
          <p class="desc" style="margin-bottom:16px">See every server that has sent email claiming to be from your domain. Identify legitimate senders vs potential impersonators.</p>
          
          <div class="btn-row" style="margin-bottom:16px">
            <button class="btn secondary btn-sm" id="btnSources7">Load Sources (7 Days)</button>
            <button class="btn secondary btn-sm" id="btnSources30">Load Sources (30 Days)</button>
          </div>
          
          <div id="sources-summary" class="sources-summary hidden"></div>
          
          <div id="sources-list">
            <div class="sources-empty">
              <p>üì≠ No source data loaded yet</p>
              <p class="tiny muted">Select a time range above to see which servers are sending email as your domain.</p>
            </div>
          </div>
          
          <div id="sources-explainer" class="docs-content mt-md hidden">
            <strong>Understanding the status badges</strong>
            <p><b>Authorized</b> (green) ‚Äî This sender passed both SPF and DKIM checks. They are properly configured and trusted.</p>
            <p><b>Partial</b> (yellow) ‚Äî This sender passed some checks but not all. They may need configuration fixes.</p>
            <p><b>Misconfigured</b> (orange) ‚Äî This sender failed most checks. Usually a legitimate service that needs proper setup.</p>
            <p><b>Suspicious</b> (red) ‚Äî This sender failed all authentication. Could be a spoofing attempt or severely misconfigured service. Investigate immediately.</p>
          </div>
          
          <details class="mt-md">
            <summary>View raw sources API response</summary>
            <div>
              <pre id="sources-wrap" class="log tiny">‚Äî</pre>
            </div>
          </details>
        </div>
      </div>
    </section>
  </div>

  <!-- ============================================================ -->
  <!-- ADMIN / OWNER SECTION (Collapsible) -->
  <!-- ============================================================ -->
  <div class="admin-section" id="admin-section">
    <div class="admin-header">
      <h2><span>üîß</span> Admin Tools</h2>
      <div class="admin-toggle" id="admin-toggle" onclick="toggleAdmin()">
        <span id="admin-toggle-text">Show admin tools</span>
        <span id="admin-toggle-icon">‚ñº</span>
      </div>
    </div>

    <div class="admin-content" id="admin-content">

      <!-- DOMAIN STATUS -->
      <div class="section-title"><span class="icon">üìä</span> Connected Domains</div>
      <section class="grid full">
        <div class="card">
          <h3>Domain Health Dashboard</h3>
          <p class="desc">All domains under your account with their current protection status. The robot checks these automatically every day.</p>
          <div class="btn-row">
            <button class="btn btn-sm" id="btnStatus">Refresh Status</button>
            <button class="btn btn-sm secondary" id="btnMonitor">Run Check Now</button>
          </div>
          <div class="mt-md table-wrap">
            <table id="statusTable">
              <thead>
                <tr>
                  <th>Domain</th>
                  <th>Owner</th>
                  <th>SPF</th>
                  <th>DMARC</th>
                  <th>DKIM s1</th>
                  <th>DKIM s2</th>
                  <th>Checked</th>
                </tr>
              </thead>
              <tbody id="statusRows">
                <tr><td colspan="7" class="muted">Loading domain status...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ADD DOMAIN -->
      <div class="section-title"><span class="icon">‚ûï</span> Register Domain</div>
      <section class="grid full">
        <div class="card">
          <h3>Add Domain to Monitoring</h3>
          <p class="desc">Register a new domain with the robot. We will start tracking its email security status automatically.</p>
          <div class="row">
            <div>
              <label for="add-email">Contact email for this domain</label>
              <input id="add-email" class="mono" placeholder="owner@example.com" type="email"/>
            </div>
            <div>
              <label for="add-domain">Domain name</label>
              <input id="add-domain" class="mono" placeholder="example.com" autocapitalize="off"/>
              <div class="notice hidden" id="add-notice"></div>
            </div>
          </div>
          <div class="btn-row">
            <button class="btn" id="btnAdd">Add Domain</button>
          </div>
          <pre class="log mt-md" id="add-log">Enter domain details above.</pre>

          <details class="mt-md">
            <summary>View registered domains</summary>
            <div id="recentWrap" class="tiny muted">Loading...</div>
          </details>
        </div>
      </section>

      <!-- DMARC POLICY STEP-UP -->
      <div class="section-title"><span class="icon">üìà</span> DMARC Policy Step-Up</div>
      <section class="grid full">
        <div class="card">
          <h3>Adjust DMARC Policy</h3>
          <p class="desc">Progress from monitoring (<code>p=none</code>) to quarantine to full rejection. Start safe, then tighten as alignment improves.</p>
          
          <div class="row">
            <div>
              <label for="pol-domain">Domain</label>
              <input id="pol-domain" class="mono" placeholder="example.com"/>
            </div>
            <div class="narrow">
              <label for="pol-policy">Policy</label>
              <select id="pol-policy">
                <option value="none">none (monitor)</option>
                <option value="quarantine">quarantine</option>
                <option value="reject">reject</option>
              </select>
            </div>
            <div class="narrow">
              <label for="pol-pct">Percentage</label>
              <input id="pol-pct" type="number" min="1" max="100" value="100"/>
            </div>
          </div>
          
          <div class="row">
            <div class="narrow">
              <label for="pol-adkim">DKIM Alignment</label>
              <select id="pol-adkim">
                <option value="r">relaxed (r)</option>
                <option value="s">strict (s)</option>
              </select>
            </div>
            <div class="narrow">
              <label for="pol-aspf">SPF Alignment</label>
              <select id="pol-aspf">
                <option value="r">relaxed (r)</option>
                <option value="s">strict (s)</option>
              </select>
            </div>
            <div>
              <label for="pol-rua">Report URI (rua)</label>
              <input id="pol-rua" class="mono" value="mailto:dmarc@domainsafepro.com"/>
            </div>
          </div>
          
          <div class="row">
            <div class="narrow">
              <label for="pol-fo">Failure Options (fo)</label>
              <input id="pol-fo" value="1"/>
            </div>
            <div>
              <label for="pol-sp">Subdomain Policy (sp, optional)</label>
              <input id="pol-sp" placeholder="leave blank to inherit"/>
            </div>
          </div>
          
          <div class="btn-row">
            <button class="btn secondary btn-sm" id="btnPolPreview">Preview Policy</button>
            <button class="btn btn-sm" id="btnApplyCf">Apply via Cloudflare</button>
            <button class="btn btn-sm" id="btnApplyR53">Apply via Route 53</button>
            <button class="btn secondary btn-sm" id="btnEvaluateNow">Evaluate Engine</button>
          </div>
          
          <pre class="log mt-md" id="pol-out">Use Preview to see the generated DMARC record, then Apply via your DNS provider.</pre>
        </div>
      </section>

      <!-- CONTROL SPF BUILDER -->
      <div class="section-title"><span class="icon">üõ†Ô∏è</span> Control SPF (Central Include)</div>
      <section class="grid full">
        <div class="card">
          <h3>SPF Sender Builder</h3>
          <p class="desc">Select authorized email senders and update <code>_spf.control.domainsafepro.com</code>. All protected domains inherit this central include automatically.</p>
          
          <div class="spf-checkboxes">
            <label><input type="checkbox" class="spf-sel" value="google"/> Google Workspace</label>
            <label><input type="checkbox" class="spf-sel" value="m365"/> Microsoft 365</label>
            <label><input type="checkbox" class="spf-sel" value="sendgrid"/> SendGrid</label>
            <label><input type="checkbox" class="spf-sel" value="ses"/> Amazon SES</label>
            <label><input type="checkbox" class="spf-sel" value="mailgun"/> Mailgun</label>
            <label><input type="checkbox" class="spf-sel" value="mailchimp"/> Mailchimp</label>
            <label><input type="checkbox" class="spf-sel" value="postmark"/> Postmark</label>
            <label><input type="checkbox" class="spf-sel" value="sparkpost"/> SparkPost</label>
            <label><input type="checkbox" class="spf-sel" value="zoho"/> Zoho</label>
            <label><input type="checkbox" class="spf-sel" value="zendesk"/> Zendesk</label>
            <label><input type="checkbox" class="spf-sel" value="intercom"/> Intercom</label>
          </div>
          
          <div class="row">
            <div>
              <label for="spf-preview">Generated SPF Record</label>
              <input id="spf-preview" class="mono" value="v=spf1 ~all" readonly/>
            </div>
          </div>
          
          <div class="row">
            <div>
              <label for="spf-token">Cloudflare API Token (for domainsafepro.com zone)</label>
              <input id="spf-token" class="mono" type="password" placeholder="Paste token here"/>
            </div>
          </div>
          
          <div class="btn-row">
            <button class="btn secondary btn-sm" id="btnSpfLoad2">Load Current</button>
            <button class="btn btn-sm" id="btnSpfUpdate2">Update Control SPF</button>
          </div>
          
          <pre class="log mt-md" id="spf-log2">Select senders above, then click "Update Control SPF" to apply.</pre>
        </div>
      </section>

      <!-- INGEST REPORTS -->
      <div class="section-title"><span class="icon">üì•</span> Report Ingestion</div>
      <section class="grid full">
        <div class="card">
          <h3>DMARC Report Pipeline</h3>
          <p class="desc">DMARC aggregate reports are processed automatically. The Robot's <code>/ingest/daily</code> endpoint receives parsed data from the ingestion pipeline.</p>
          
          <div class="docs-content">
            <strong>How it works</strong>
            <p>Email providers (Google, Microsoft, etc.) send DMARC aggregate reports to the <code>rua</code> address. A background job parses these XMLs and pushes daily summaries to the Robot, which stores them in the <code>dmarc_daily</code> table.</p>
            
            <strong>Manual ingestion</strong>
            <p>To manually push data, send a POST to <code>/ingest/daily</code> with the <code>x-ingest-key</code> header:</p>
          </div>
          
          <pre class="log mt-md" id="ingest-log">{
  "domain": "example.com",
  "date": "2025-01-15",
  "total": 1234,
  "aligned": 1200,
  "spf_aligned": 1180,
  "dkim_aligned": 1195
}</pre>
          
          <div class="btn-row">
            <button class="btn btn-sm secondary" id="btnIngestTest">Test /ingest/daily Endpoint</button>
          </div>
        </div>
      </section>

      <!-- ALERTS -->
      <div class="section-title"><span class="icon">üîî</span> Alerts</div>
      <section class="grid full">
        <div class="card">
          <h3>Slack Notifications</h3>
          <p class="desc">Test the alert system and flush any queued notifications.</p>
          
          <div class="btn-row">
            <button class="btn btn-sm" id="btnAlertTest">Send Test Alert</button>
            <button class="btn secondary btn-sm" id="btnAlertFlush">Flush Alert Queue</button>
          </div>
          
          <pre class="log mt-md" id="alerts-out">‚Äî</pre>
        </div>
      </section>

      <!-- API DEBUG -->
      <div class="section-title"><span class="icon">üîç</span> API Diagnostics</div>
      <section class="grid full">
        <div class="card">
          <h3>Test API Endpoints</h3>
          <p class="desc">Check which endpoints are reachable. This helps diagnose "Failed to fetch" errors.</p>
          
          <div class="btn-row">
            <button class="btn btn-sm secondary" id="btnTestAll">Test All Endpoints</button>
          </div>
          
          <pre class="log mt-md" id="debug-log">Click "Test All Endpoints" to check API connectivity.</pre>
        </div>
      </section>

    </div><!-- /admin-content -->
  </div><!-- /admin-section -->

  <footer class="console-footer">
    <a href="https://domainsafepro.com" target="_blank">DomainSafePro</a> | Email Authentication on Autopilot
  </footer>

</main>

<script>
/* ====== Theme Toggle ====== */
function toggleTheme() {
  var html = document.documentElement;
  var current = html.getAttribute('data-theme');
  var next = current === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  try { localStorage.setItem('dsp-theme', next); } catch(e){}
}
(function(){
  try {
    var saved = localStorage.getItem('dsp-theme');
    if (saved) document.documentElement.setAttribute('data-theme', saved);
  } catch(e){}
})();

/* ====== Admin Toggle ====== */
function toggleAdmin() {
  var content = document.getElementById('admin-content');
  var text = document.getElementById('admin-toggle-text');
  var icon = document.getElementById('admin-toggle-icon');
  if (content.classList.contains('visible')) {
    content.classList.remove('visible');
    text.textContent = 'Show admin tools';
    icon.textContent = '‚ñº';
  } else {
    content.classList.add('visible');
    text.textContent = 'Hide admin tools';
    icon.textContent = '‚ñ≤';
  }
}

/* ====== Route Selection ====== */
var currentRoute = null;

function selectRoute(route) {
  currentRoute = route;
  
  // Update card selection states
  var cards = document.querySelectorAll('.route-card');
  cards.forEach(function(card) {
    if (card.getAttribute('data-route') === route) {
      card.classList.add('selected');
    } else {
      card.classList.remove('selected');
    }
  });
  
  // Show/hide appropriate sections
  var cfSection = document.getElementById('setup-cloudflare');
  var r53Section = document.getElementById('setup-route53');
  var manualSection = document.getElementById('setup-manual');
  var verifySection = document.getElementById('verify-section');
  var routeSelection = document.getElementById('route-selection');
  var helpSection = document.getElementById('help-section');
  
  // Reset all
  cfSection.classList.remove('active');
  r53Section.classList.remove('active');
  manualSection.classList.remove('active');
  verifySection.classList.remove('active');
  
  if (route === null) {
    // Show route selection, hide everything else
    routeSelection.style.display = '';
    helpSection.style.display = '';
    return;
  }
  
  // Hide route selection once a route is chosen
  routeSelection.style.display = 'none';
  
  if (route === 'cloudflare') {
    cfSection.classList.add('active');
    verifySection.classList.add('active');
  } else if (route === 'route53') {
    r53Section.classList.add('active');
    verifySection.classList.add('active');
  } else if (route === 'manual') {
    manualSection.classList.add('active');
    verifySection.classList.add('active');
  }
}

/* ====== Real endpoints ====== */
var ROBOT_API = "https://domainsafe-robot.pankajonlinerepository.workers.dev";
var DMARC_API = "https://api.domainsafepro.com";
var AUTH_API  = "https://domainsafe-robot.pankajonlinerepository.workers.dev";

/* ====== Tiny helpers ====== */
var $ = function(sel) { return document.querySelector(sel); };
var $$ = function(sel) { return document.querySelectorAll(sel); };
var logEl = function(sel, v) { 
  var el = $(sel); 
  if (!el) return; 
  el.textContent = (typeof v === "string") ? v : JSON.stringify(v, null, 2); 
};
var copy = function(txt) { 
  if (navigator.clipboard) return navigator.clipboard.writeText(txt).catch(function(){}); 
  return Promise.resolve();
};
var show = function(el) { if (el) el.classList.remove('hidden'); };
var hide = function(el) { if (el) el.classList.add('hidden'); };

function sanitizeDomain(raw){
  return (raw||"").trim().toLowerCase()
    .replace(/^https?:\/\//,"")
    .replace(/^mailto:/,"")
    .replace(/\/.*$/,"")
    .replace(/\.$/,"");
}
function isValidHostname(raw){
  var s = sanitizeDomain(raw);
  if (!/^[a-z0-9.-]+\.[a-z]{2,}$/i.test(s)) return false;
  var labels = s.split(".");
  return labels.every(function(lbl) { return lbl.length>0 && lbl.length<=63 && /^[a-z0-9-]+$/i.test(lbl); });
}
function isDomain(s){ return /^[a-z0-9.-]+\.[a-z]{2,}$/i.test(s||""); }
function apexify(raw){
  var s = sanitizeDomain(raw);
  if (!isDomain(s)) return s;
  var parts = s.split(".").filter(Boolean);
  if (parts.length <= 2) return s;
  var cc2 = ["co.uk","com.au","co.in","co.jp","com.br","com.mx","com.sg","com.hk"];
  var tail2 = parts.slice(-2).join(".");
  var tail3 = parts.slice(-3).join(".");
  return cc2.indexOf(tail2) >= 0 ? tail3 : tail2;
}
function normalizeForUI(raw, noticeEl, errorEl, opts){
  var options = opts || {};
  var typed = sanitizeDomain(raw);
  if (!isValidHostname(typed)){
    if (errorEl){
      errorEl.textContent = "Please enter a valid domain name (like yourdomain.com)";
      show(errorEl);
    }
    if (noticeEl) hide(noticeEl);
    return { ok:false, value:typed, apex:"", changed:false };
  }
  if (errorEl) hide(errorEl);
  var apex = apexify(typed);
  var value = apex, changed = false;
  if (options.allowExact){
    value = typed;
  } else if (typed !== apex){
    changed = true;
  }
  if (noticeEl){
    if (changed){
      noticeEl.innerHTML = 'We will protect the root domain <span class="mono">'+apex+'</span> to cover all subdomains.';
      show(noticeEl);
    } else {
      hide(noticeEl);
    }
  }
  return { ok:true, value:value, apex:apex, changed:changed, typed:typed };
}

/* ====== HTTP helpers ====== */
async function get(url){
  var r = await fetch(url, {
    method:"GET",
    credentials:"include",
    headers:{ "accept":"application/json" }
  });
  var t = await r.text();
  var j = null;
  try{ j = t ? JSON.parse(t) : null; }catch(e){}
  if (!r.ok){
    var msg = (j && j.error) ? j.error : t || ("HTTP "+r.status);
    throw new Error(msg);
  }
  return j;
}
async function post(url, body){
  var r = await fetch(url, {
    method:"POST",
    credentials:"include",
    headers:{ "content-type":"application/json", "accept":"application/json" },
    body: JSON.stringify(body || {})
  });
  var t = await r.text();
  var j = null;
  try{ j = t ? JSON.parse(t) : null; }catch(e){}
  if (!r.ok){
    var msg = (j && j.error) ? j.error : t || ("HTTP "+r.status);
    throw new Error(msg);
  }
  return j;
}

/* ====== AUTH (Google sign-in) ====== */
async function fetchCurrentUser(){
  try{
    var r = await fetch(AUTH_API + "/api/me", {
      method:"GET",
      credentials:"include",
      headers:{ "accept":"application/json" }
    });
    var t = await r.text();
    var j = null;
    try{ j = t ? JSON.parse(t) : null; }catch(e){ return null; }
    if (!r.ok || !j || j.ok === false || !j.user || !j.user.email) return null;
    return j.user;
  }catch(e){
    return null;
  }
}

function startGoogleLogin(){
  window.location.href = AUTH_API + "/auth/google/start";
}

function applyPlanGate(user){
  var gate = $("#plan-gate");
  var gateEmail = $("#plan-gate-email");
  var welcomeBanner = $(".welcome-banner");
  var routeSelection = $("#route-selection");
  var cfSetup = $("#setup-cloudflare");
  var r53Setup = $("#setup-route53");
  var manualSetup = $("#setup-manual");
  var helpSection = $("#help-section");
  var insightsSection = $("#insights-section");
  var adminSection = document.getElementById("admin-section");

  var email = user && user.email ? String(user.email) : "";
  var plan = user && user.plan ? user.plan : null;
  var lower = email.toLowerCase();
  var isAdminFront = (lower === "pankajonlinerepository@gmail.com" || lower === "ops@domainsafepro.com");
  var hasActivePlan = !!(plan && plan.status === "active");

  if (gateEmail && email){
    gateEmail.textContent = email;
  }

  // Sections visible to users with active plans (or admins)
  var userSections = [welcomeBanner, routeSelection, cfSetup, r53Setup, manualSetup, helpSection, insightsSection];

  if (hasActivePlan || isAdminFront) {
    if (gate) gate.classList.add("hidden");
    userSections.forEach(function(el){ if (el) el.classList.remove("hidden"); });
  } else {
    if (gate) gate.classList.remove("hidden");
    userSections.forEach(function(el){ if (el) el.classList.add("hidden"); });
  }

  // Admin section only visible for admin users
  if (isAdminFront && adminSection) {
    adminSection.classList.remove("hidden");
  } else if (adminSection) {
    adminSection.classList.add("hidden");
  }
}

function showAuthedUI(user){
  document.body.classList.remove("logged-out");
  document.body.classList.add("authed");
  var label = $("#auth-status-label");
  var planLabel = $("#auth-plan-label");
  var loginBtn = $("#auth-login-btn");
  if (label && user && user.email){
    label.textContent = user.email;
  }
  if (planLabel){
    if (user && user.plan && user.plan.code){
      var plan = user.plan;
      var parts = [];
      parts.push("Plan: " + String(plan.code));
      if (typeof plan.domains_used === "number" && (plan.max_domains === null || typeof plan.max_domains === "number")){
        var used = plan.domains_used;
        var max = plan.max_domains;
        if (max === null){
          parts.push("Domains: " + used + "+");
        } else {
          parts.push("Domains: " + used + "/" + max);
        }
      }
      if (plan.valid_until){
        parts.push("Until: " + String(plan.valid_until).slice(0,10));
      }
      planLabel.textContent = parts.join(" ¬∑ ");
      planLabel.classList.remove("hidden");
    } else {
      planLabel.textContent = "";
      planLabel.classList.add("hidden");
    }
  }
  if (loginBtn) {
    loginBtn.textContent = "Sign out";
    loginBtn.onclick = function() {
      // Redirect to Robot's logout endpoint which clears the session cookie and redirects to landing page
      window.location.href = "https://domainsafe-robot.pankajonlinerepository.workers.dev/auth/logout";
    };
  }
  applyPlanGate(user);
  var statusRows = $("#statusRows");
  if (statusRows){
    statusRows.innerHTML = '<tr><td colspan="7" class="muted">Loading...</td></tr>';
  }
  var addEmail = $("#add-email");
  if (addEmail && user && user.email){
    addEmail.value = user.email;
  }
  loadStatus();
  refreshRecent();
}

function showLoggedOutUI(){
  document.body.classList.remove("authed");
  document.body.classList.add("logged-out");
  var label = $("#auth-status-label");
  var planLabel = $("#auth-plan-label");
  var loginBtn = $("#auth-login-btn");
  if (label) label.textContent = "Not signed in";
  if (planLabel){
    planLabel.textContent = "";
    planLabel.classList.add("hidden");
  }
  if (loginBtn) {
    loginBtn.textContent = "Sign in with Google";
    loginBtn.onclick = startGoogleLogin;
  }
  var statusRows = $("#statusRows");
  if (statusRows){
    statusRows.innerHTML = '<tr><td colspan="7" class="muted">Sign in to see your connected domains.</td></tr>';
  }
  var recent = $("#recentWrap");
  if (recent) recent.textContent = "Sign in to see your domains.";
  var addEmail = $("#add-email");
  if (addEmail) addEmail.value = "";
  var addLog = $("#add-log");
  if (addLog) addLog.textContent = "Enter domain details above.";
}

async function initAuth(){
  var btnHeader = $("#auth-login-btn");
  var btnHero   = $("#login-hero-btn");
  if (btnHeader) btnHeader.addEventListener("click", startGoogleLogin);
  if (btnHero)   btnHero.addEventListener("click", startGoogleLogin);

  // Show loading state initially (already shown by default)
  // Now fetch user
  var user = await fetchCurrentUser();
  
  // Hide loading and show appropriate UI
  if (user) {
    showAuthedUI(user);
  } else {
    showLoggedOutUI();
  }
}

/* ====== STATUS & MONITOR ====== */
function pill(ok){
  return ok
    ? '<span class="pill ok">OK</span>'
    : '<span class="pill bad">Needs setup</span>';
}

async function loadStatus(){
  var tb = $("#statusRows");
  if (!tb) return;
  tb.innerHTML = '<tr><td colspan="7" class="muted">Loading...</td></tr>';
  try{
    var j = await get(ROBOT_API + "/api/status");
    var rows = (j && j.rows) ? j.rows : [];
    if (!rows.length){
      tb.innerHTML = '<tr><td colspan="7" class="muted">No domains registered yet. Add your first domain above.</td></tr>';
      return;
    }
    tb.innerHTML = rows.map(function(r) {
      return '<tr>' +
        '<td data-label="Domain" class="mono">'+(r.domain_name||"")+'</td>' +
        '<td data-label="Owner" class="mono tiny">'+(r.email||"")+'</td>' +
        '<td data-label="SPF">'+pill(r.spf_ok)+'</td>' +
        '<td data-label="DMARC">'+pill(r.dmarc_ok)+'</td>' +
        '<td data-label="DKIM s1">'+pill(r.dkim_s1_ok)+'</td>' +
        '<td data-label="DKIM s2">'+pill(r.dkim_s2_ok)+'</td>' +
        '<td data-label="Checked" class="tiny muted">'+(r.checked_at||"")+'</td>' +
      '</tr>';
    }).join("");
  }catch(e){
    tb.innerHTML = '<tr><td colspan="7" class="tiny danger">Could not load status. Please try again.</td></tr>';
  }
}
$("#btnStatus").addEventListener("click", loadStatus);
$("#btnMonitor").addEventListener("click", async function(){
  try{ await post(ROBOT_API + "/api/monitor-run", {}); }catch(e){}
  loadStatus();
});

/* ====== QUICK-CODES (Customer-facing) ====== */
function renderQuickCodes(records, extras) {
  var container = $("#qc-results");
  if (!records || records.length === 0) {
    container.innerHTML = '<p class="muted">No records to display.</p>';
    show(container);
    return;
  }

  function getPurpose(name) {
    if (name.indexOf('_domainkey') >= 0) {
      return name.indexOf('s1') === 0 ? 'Email Signature Key 1 (DKIM)' : 'Email Signature Key 2 (DKIM)';
    }
    if (name === '_dmarc' || name.indexOf('_dmarc.') === 0) return 'Email Policy (DMARC)';
    if (name === '@' || name === '') return 'Email Sender Authorization (SPF)';
    if (name === '_smtp._tls') return 'Transport Security Reporting';
    if (name === 'mta-sts') return 'Mail Transfer Security';
    return 'DNS Record';
  }

  function escapeHtml(str) {
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function createCard(r) {
    var typeClass = r.type.toLowerCase() === 'txt' ? 'txt' : 'cname';
    var purpose = getPurpose(r.name);
    var displayName = r.name === '@' ? '@ (root domain)' : escapeHtml(r.name);
    var escapedName = escapeHtml(r.name);
    var escapedValue = escapeHtml(r.value);
    
    return '<div class="qc-card">' +
      '<div class="qc-card-header">' +
        '<span class="qc-type ' + typeClass + '">' + escapeHtml(r.type) + '</span>' +
        '<span class="qc-purpose">' + purpose + '</span>' +
      '</div>' +
      '<div class="qc-field">' +
        '<div class="qc-label">Host / Name</div>' +
        '<div class="qc-value">' +
          '<code>' + displayName + '</code>' +
          '<button class="copy-btn" data-copy="' + escapedName + '">Copy</button>' +
        '</div>' +
      '</div>' +
      '<div class="qc-field">' +
        '<div class="qc-label">Value / Points To</div>' +
        '<div class="qc-value">' +
          '<code>' + escapedValue + '</code>' +
          '<button class="copy-btn" data-copy="' + escapedValue + '">Copy</button>' +
        '</div>' +
      '</div>' +
    '</div>';
  }

  var html = '<div class="qc-cards">';
  records.forEach(function(r) { html += createCard(r); });
  if (extras && extras.length > 0) {
    html += '<div class="mt-md mb-sm"><strong class="tiny muted">ADVANCED SECURITY (OPTIONAL)</strong></div>';
    extras.forEach(function(r) { html += createCard(r); });
  }
  html += '</div>';

  container.innerHTML = html;
  show(container);
  show($("#qc-actions"));
  
  // Add click handlers for copy buttons
  container.querySelectorAll('.copy-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var text = this.getAttribute('data-copy');
      var button = this;
      copy(text).then(function() {
        button.textContent = 'Copied!';
        button.classList.add('copied');
        setTimeout(function() {
          button.textContent = 'Copy';
          button.classList.remove('copied');
        }, 2000);
      });
    });
  });
}

$("#btnQCodes").addEventListener("click", async function(){
  var norm = normalizeForUI($("#qc-domain").value, $("#qc-notice"), null);
  if (!norm.ok){
    hide($("#qc-results"));
    hide($("#qc-actions"));
    return;
  }
  try{
    var extras = ($("#qc-extras").checked ? "&extras=1" : "");
    var j = await get(ROBOT_API + "/api/quick-codes?domain=" + encodeURIComponent(norm.apex || norm.value) + extras);
    renderQuickCodes(j.records || [], j.extras || []);
    
    $("#verify-domain").value = norm.apex || norm.value;
  }catch(e){
    $("#qc-results").innerHTML = '<p class="danger">Could not generate records: ' + String(e).slice(0,100) + '</p>';
    show($("#qc-results"));
  }
});

$("#btnCopyAll").addEventListener("click", function(){
  var cards = $$("#qc-results .qc-card");
  if (!cards.length) return;
  
  var text = "";
  cards.forEach(function(card) {
    var typeEl = card.querySelector('.qc-type');
    var codeEls = card.querySelectorAll('.qc-value code');
    var type = typeEl ? typeEl.textContent : '';
    var name = codeEls[0] ? codeEls[0].textContent : '';
    var value = codeEls[1] ? codeEls[1].textContent : '';
    text += type + "\t" + name + "\t" + value + "\n";
  });
  
  copy(text).then(function() {
    var btn = $("#btnCopyAll");
    var oldText = btn.textContent;
    btn.textContent = "Copied to clipboard!";
    setTimeout(function() { btn.textContent = oldText; }, 2000);
  });
});

/* ====== VERIFY (Human-readable output) - FIXED to match API response ====== */
function renderVerifyResults(data) {
  var container = $("#verify-results");
  var detailsEl = $("#verify-details");
  
  var checks = data.checks || {};
  var items = [];
  
  // SPF check - API returns "includesControl" (camelCase), not "includes_control"
  var spfPresent = checks.spf && checks.spf.present;
  var spfIncludesControl = checks.spf && (checks.spf.includesControl || checks.spf.includes_control);
  var spfOk = spfPresent && spfIncludesControl;
  
  items.push({
    label: 'SPF (Sender Authorization)',
    pass: spfOk,
    status: spfOk 
      ? 'Your SPF record is configured correctly and includes our central control.'
      : spfPresent
        ? 'SPF record found, but it does not include our central control yet.'
        : 'No SPF record found. Add the TXT record from Step 1.'
  });
  
  // DKIM check - API returns "s1.ok" and "s2.ok", not "s1.present" and "s1.points_to_control"
  var dkimS1Ok = checks.dkim && checks.dkim.s1 && checks.dkim.s1.ok;
  var dkimS2Ok = checks.dkim && checks.dkim.s2 && checks.dkim.s2.ok;
  var dkimOk = dkimS1Ok || dkimS2Ok;
  var dkimBothOk = dkimS1Ok && dkimS2Ok;
  
  items.push({
    label: 'DKIM (Email Signatures)',
    pass: dkimOk,
    status: dkimBothOk
      ? 'Both DKIM keys (s1 and s2) are configured correctly.'
      : dkimOk
        ? 'One DKIM key is configured. Consider adding both s1 and s2 for redundancy.'
        : 'No DKIM records found. Add the CNAME records from Step 1.'
  });
  
  // DMARC check - This one was correct
  var dmarcOk = checks.dmarc && checks.dmarc.present;
  items.push({
    label: 'DMARC (Email Policy)',
    pass: dmarcOk,
    status: dmarcOk
      ? 'Your DMARC policy is active. Policy: ' + (checks.dmarc.policy || 'none')
      : 'No DMARC record found. Add the TXT record from Step 1.'
  });
  
  var allPass = items.every(function(i) { return i.pass; });
  var passCount = items.filter(function(i) { return i.pass; }).length;
  
  var summaryHtml = '';
  if (allPass) {
    summaryHtml = '<div class="verify-summary all-pass">' +
      '<span class="verify-summary-icon">üéâ</span>' +
      '<div class="verify-summary-text">' +
        '<h4>Your domain is protected!</h4>' +
        '<p>All email authentication records are configured correctly.</p>' +
      '</div>' +
    '</div>';
  } else {
    summaryHtml = '<div class="verify-summary has-issues">' +
      '<span class="verify-summary-icon">‚ö†Ô∏è</span>' +
      '<div class="verify-summary-text">' +
        '<h4>' + passCount + ' of ' + items.length + ' checks passed</h4>' +
        '<p>Some records still need to be added. See details below.</p>' +
      '</div>' +
    '</div>';
  }
  
  var itemsHtml = items.map(function(item) {
    return '<div class="verify-item">' +
      '<div class="verify-icon ' + (item.pass ? 'pass' : 'fail') + '">' + (item.pass ? '‚úì' : '‚úó') + '</div>' +
      '<div class="verify-content">' +
        '<div class="verify-label">' + item.label + '</div>' +
        '<div class="verify-status ' + (item.pass ? 'pass' : 'fail') + '">' + item.status + '</div>' +
      '</div>' +
    '</div>';
  }).join('');
  
  container.innerHTML = summaryHtml + itemsHtml;
  show(container);
  
  logEl("#verify-log", data);
  show(detailsEl);
}

$("#btnVerify").addEventListener("click", async function(){
  var norm = normalizeForUI($("#verify-domain").value, $("#verify-notice"), null);
  if (!norm.ok){
    hide($("#verify-results"));
    hide($("#verify-details"));
    return;
  }
  
  $("#verify-results").innerHTML = '<div class="verify-summary has-issues"><span class="verify-summary-icon">‚è≥</span><div class="verify-summary-text"><h4>Checking your domain...</h4><p>This may take a few seconds while we query DNS servers.</p></div></div>';
  show($("#verify-results"));
  
  try{
    var j = await get(ROBOT_API + "/api/check-quick-codes?domain=" + encodeURIComponent(norm.apex || norm.value));
    renderVerifyResults(j);
  }catch(e){
    $("#verify-results").innerHTML = '<div class="verify-summary has-issues"><span class="verify-summary-icon">‚ùå</span><div class="verify-summary-text"><h4>Could not verify domain</h4><p>' + String(e).slice(0,150) + '</p></div></div>';
    show($("#verify-results"));
  }
});

/* ====== ADD DOMAIN + RECENT ====== */
async function refreshRecent(){
  var wrap = $("#recentWrap");
  if (!wrap) return;
  try{
    var j = await get(ROBOT_API + "/api/domains");
    var rows = (j && (j.domains || j.rows)) ? (j.domains || j.rows) : [];
    if (!rows.length){
      wrap.textContent = "No domains registered yet.";
      return;
    }
    wrap.innerHTML = rows.slice(0,10).map(function(r) {
      return '<div class="mono" style="margin-bottom:6px">'+(r.domain_name || "")+' <span class="muted">| '+(r.status || "")+(r.created_at ? " | "+r.created_at : "")+'</span></div>';
    }).join("");
  }catch(e){
    wrap.textContent = "Could not load domains.";
  }
}

$("#btnAdd").addEventListener("click", async function(){
  var noticeEl = $("#add-notice");
  var norm = normalizeForUI($("#add-domain").value, noticeEl, null);
  var email = ($("#add-email").value || "").trim();
  if (!email || !norm.ok){
    $("#add-log").textContent = "Please enter a valid email and domain name.";
    return;
  }
  try{
    if (noticeEl) hide(noticeEl);
    var j = await post(ROBOT_API + "/api/domains", {
      email: email,
      domain: norm.apex || norm.value
    });
    logEl("#add-log", j);
    refreshRecent();
  }catch(e){
    var msg = String(e);
    logEl("#add-log", "Error: " + msg);
    if (noticeEl){
      noticeEl.textContent = msg;
      show(noticeEl);
    }
  }
});

/* ====== CLOUDFLARE ====== */
$("#btnCfList").addEventListener("click", async function(){
  var token = ($("#cf-token").value || "").trim();
  if (!token){
    logEl("#cf-log","Please paste your Cloudflare API token first.");
    return;
  }
  try{
    var j = await post(ROBOT_API + "/api/cf/list-zones", { token: token });
    var sel = $("#cf-zones");
    sel.innerHTML = '<option value="">Select your domain</option>';
    (j.zones || []).forEach(function(z) {
      var o = document.createElement("option");
      o.value = z.id;
      o.textContent = z.name + " (" + (z.status || "") + ")";
      sel.appendChild(o);
    });
    logEl("#cf-log","Loaded " + (j.zones || []).length + " zones. Select your domain above.");
  }catch(e){
    logEl("#cf-log", String(e));
  }
});

$("#btnCfProtect").addEventListener("click", async function(){
  var token = ($("#cf-token").value || "").trim();
  var zone_id = $("#cf-zones").value;
  if (!token || !zone_id){
    logEl("#cf-log","Please load zones and select a domain first.");
    return;
  }
  try{
    var j = await post(ROBOT_API + "/api/cf/protect", { token: token, zone_id: zone_id });
    logEl("#cf-log", j);
    if (j.apex) {
      $("#verify-domain").value = j.apex;
      $("#pol-domain").value = j.apex;
      $("#ins-domain").value = j.apex;
    }
  }catch(e){
    logEl("#cf-log", String(e));
  }
});

/* ====== ROUTE 53 ====== */
async function r53ListZonesIfReady(){
  var access_key_id = ($("#r53-ak").value || "").trim();
  var secret_access_key = ($("#r53-sk").value || "").trim();
  if (!access_key_id || !secret_access_key) return;
  try{
    var j = await post(ROBOT_API + "/api/r53/list-zones", { access_key_id: access_key_id, secret_access_key: secret_access_key });
    var sel = $("#r53-zones");
    sel.innerHTML = '<option value="">Select your hosted zone</option>';
    (j.zones || []).forEach(function(z) {
      var o = document.createElement("option");
      o.value = z.id;
      o.textContent = z.name + " (" + z.id + ")";
      sel.appendChild(o);
    });
    logEl("#r53-log","Loaded " + (j.zones || []).length + " hosted zones.");
  }catch(e){
    logEl("#r53-log", String(e));
  }
}
$("#r53-ak").addEventListener("change", r53ListZonesIfReady);
$("#r53-sk").addEventListener("change", r53ListZonesIfReady);

$("#btnR53Protect").addEventListener("click", async function(){
  var access_key_id = ($("#r53-ak").value || "").trim();
  var secret_access_key = ($("#r53-sk").value || "").trim();
  var hosted_zone_id = $("#r53-zones").value;
  if (!access_key_id || !secret_access_key || !hosted_zone_id){
    logEl("#r53-log","Please enter credentials and select a hosted zone.");
    return;
  }
  try{
    var j = await post(ROBOT_API + "/api/r53/protect", { access_key_id: access_key_id, secret_access_key: secret_access_key, hosted_zone_id: hosted_zone_id });
    logEl("#r53-log", j);
    if (j.apex) {
      $("#verify-domain").value = j.apex;
      $("#pol-domain").value = j.apex;
      $("#ins-domain").value = j.apex;
    }
  }catch(e){
    logEl("#r53-log", String(e));
  }
});

/* ====== DMARC INSIGHTS (Rollup) ====== */
function fmt(n){ return (n||0).toLocaleString(); }
function pct(a,b){ var r = (b>0) ? (a/b) : 0; return Math.round(r*1000)/10; }
function asArray(series){ 
  if (Array.isArray(series)) return series; 
  if (series && typeof series==='object'){ 
    return Object.keys(series).sort().map(function(d) { 
      return Object.assign({date:d}, series[d]); 
    }); 
  } 
  return []; 
}

function renderRollup(j){
  var rows = asArray(j.series);
  var table = $('#ins-table'); 
  var body = $('#ins-rows'); 
  var summary = $('#ins-summary');
  var explainer = $('#ins-explainer');
  
  if (!rows.length){ 
    table.style.display='none'; 
    if (explainer) explainer.classList.add('hidden');
    summary.innerHTML = '<span class="muted">No data available. Enter a domain and click a time range button.</span>'; 
    return; 
  }
  
  var T = rows.reduce(function(acc,r){ 
    acc.total += r.total||0; 
    acc.aligned += r.aligned||0; 
    return acc; 
  }, {total:0,aligned:0});
  
  var rate = pct(T.aligned, T.total);
  var unaligned = T.total - T.aligned;
  
  // Determine protection level and color
  var level, levelClass, levelIcon;
  if (rate >= 97) {
    level = 'Excellent'; levelClass = 'ok'; levelIcon = 'üõ°Ô∏è';
  } else if (rate >= 90) {
    level = 'Good'; levelClass = 'ok'; levelIcon = '‚úÖ';
  } else if (rate >= 75) {
    level = 'Fair'; levelClass = 'warn'; levelIcon = '‚ö†Ô∏è';
  } else {
    level = 'Needs Attention'; levelClass = 'danger'; levelIcon = 'üö®';
  }
  
  // Build human-friendly summary
  var summaryHtml = '<div class="verify-summary ' + (rate >= 90 ? 'all-pass' : 'has-issues') + '">' +
    '<span class="verify-summary-icon">' + levelIcon + '</span>' +
    '<div class="verify-summary-text">' +
      '<h4 style="margin:0">' + j.domain + ' ‚Äî ' + level + ' Protection</h4>' +
      '<p style="margin:4px 0 0"><strong style="color:var(--' + levelClass + ')">' + rate + '%</strong> of ' + fmt(T.total) + ' emails authenticated over ' + j.days + ' days</p>' +
    '</div>' +
  '</div>';
  
  if (unaligned > 0 && rate < 97) {
    summaryHtml += '<p class="tiny muted mt-sm">' + fmt(unaligned) + ' emails failed authentication. These could be misconfigured services or impersonation attempts.</p>';
  }
  
  summary.innerHTML = summaryHtml;
  if (explainer) explainer.classList.remove('hidden');
  
  body.innerHTML = '';
  rows.forEach(function(r){
    var p = pct(r.aligned||0, r.total||0);
    var statusClass = p >= 97 ? 'ok' : (p >= 90 ? 'ok' : (p >= 75 ? 'warn' : 'danger'));
    var statusText = p >= 97 ? 'Protected' : (p >= 90 ? 'Good' : (p >= 75 ? 'Fair' : 'At Risk'));
    var tr = document.createElement('tr');
    tr.innerHTML = 
      '<td data-label="Date" class="mono">' + r.date + '</td>' +
      '<td data-label="Emails Sent">' + fmt(r.total||0) + '</td>' +
      '<td data-label="Authenticated">' + fmt(r.aligned||0) + '</td>' +
      '<td data-label="Protection">' + p + '%</td>' +
      '<td data-label="Status">' +
        '<div class="ins-bar"><i style="width:' + Math.min(100,p) + '%"></i></div>' +
        '<div class="ins-stats"><span class="pill ' + statusClass + '">' + statusText + '</span></div>' +
      '</td>';
    body.appendChild(tr);
  });
  table.style.display = '';
}

async function loadRoll(days){
  var norm = normalizeForUI($('#ins-domain').value, null, null);
  if(!norm.ok){ 
    $('#ins-summary').textContent = 'Please enter a valid domain name first.'; 
    return; 
  }
  $('#ins-summary').textContent = 'Loading ' + days + '-day insights...';
  $('#ins-table').style.display = 'none';
  try{
    var url = ROBOT_API + '/api/rollup?domain=' + encodeURIComponent(norm.apex || norm.value) + '&days=' + days;
    var j = await get(url);
    $('#ins-wrap').textContent = JSON.stringify(j, null, 2);
    
    // Check if we got data
    var series = asArray(j.series);
    if (series.length === 0) {
      var msg = 'No DMARC data found for ' + (norm.apex || norm.value) + ' in the last ' + days + ' days.\n\n';
      msg += 'Possible reasons:\n';
      msg += '‚Ä¢ DMARC reports typically arrive 24-48 hours after email activity\n';
      msg += '‚Ä¢ No emails were sent from this domain during this period\n';
      if (days === 7) {
        msg += '‚Ä¢ Try "Last 30 Days" to see if older data is available';
      }
      $('#ins-summary').innerHTML = '<span style="white-space:pre-wrap">' + msg + '</span>';
      return;
    }
    
    renderRollup({domain: j.domain || (norm.apex || norm.value), days: days, series: j.series || []});
  }catch(e){ 
    var errMsg = String(e);
    if (errMsg.indexOf('Failed to fetch') >= 0) {
      errMsg = 'Network error: Could not reach the API. Check console for details.';
    }
    $('#ins-summary').textContent = 'Error loading ' + days + '-day data: ' + errMsg;
    $('#ins-wrap').textContent = String(e); 
  }
}

$('#btnLoad7').addEventListener('click', function(){ loadRoll(7); });
$('#btnLoad30').addEventListener('click', function(){ loadRoll(30); });

/* ====== SOURCE ANALYSIS (Who's Sending As Your Domain) ====== */
function getSourceIcon(status) {
  switch(status) {
    case 'authorized': return '‚úÖ';
    case 'partial': return '‚ö†Ô∏è';
    case 'misconfigured': return 'üîß';
    case 'suspicious': return 'üö®';
    default: return '‚ùì';
  }
}

function getStatusLabel(status) {
  switch(status) {
    case 'authorized': return 'Authorized';
    case 'partial': return 'Partial';
    case 'misconfigured': return 'Misconfigured';
    case 'suspicious': return 'Suspicious';
    default: return 'Unknown';
  }
}

function renderSources(data) {
  var summaryEl = $('#sources-summary');
  var listEl = $('#sources-list');
  var explainerEl = $('#sources-explainer');
  var wrapEl = $('#sources-wrap');
  
  // Log raw response
  if (wrapEl) {
    wrapEl.textContent = JSON.stringify(data, null, 2);
  }
  
  var sources = data.sources || [];
  var summary = data.summary || {};
  
  if (!sources.length) {
    hide(summaryEl);
    hide(explainerEl);
    listEl.innerHTML = '<div class="sources-empty">' +
      '<p>üì≠ No source data available</p>' +
      '<p class="tiny muted">No servers have been recorded sending email as ' + (data.domain || 'this domain') + ' in the last ' + (data.days || 7) + ' days.</p>' +
      '<p class="tiny muted">This could mean no emails were sent, or DMARC reports haven\'t been processed yet.</p>' +
    '</div>';
    return;
  }
  
  // Render summary stats
  var summaryHtml = '<div class="sources-stat">' +
      '<div class="sources-stat-value">' + fmt(summary.total_sources || sources.length) + '</div>' +
      '<div class="sources-stat-label">Sending Sources</div>' +
    '</div>' +
    '<div class="sources-stat">' +
      '<div class="sources-stat-value">' + fmt(summary.total_emails || 0) + '</div>' +
      '<div class="sources-stat-label">Total Emails</div>' +
    '</div>' +
    '<div class="sources-stat">' +
      '<div class="sources-stat-value" style="color:var(--ok)">' + fmt(summary.authorized_sources || 0) + '</div>' +
      '<div class="sources-stat-label">Authorized</div>' +
    '</div>' +
    '<div class="sources-stat">' +
      '<div class="sources-stat-value" style="color:var(--danger)">' + fmt(summary.suspicious_sources || 0) + '</div>' +
      '<div class="sources-stat-label">Suspicious</div>' +
    '</div>';
  
  summaryEl.innerHTML = summaryHtml;
  show(summaryEl);
  
  // Render source rows
  var rowsHtml = sources.map(function(src) {
    var status = src.status || 'unknown';
    var identity = src.identity || 'Unknown';
    var ip = src.source_ip || '';
    var org = src.org || '';
    var reverse = src.reverse || '';
    var total = src.total || 0;
    var aligned = src.aligned || 0;
    var alignedRate = src.aligned_rate !== undefined ? src.aligned_rate : (total > 0 ? Math.round((aligned / total) * 100) : 0);
    var spfPass = (src.spf && src.spf.pass) || 0;
    var spfFail = (src.spf && src.spf.fail) || 0;
    var dkimPass = (src.dkim && src.dkim.pass) || 0;
    var dkimFail = (src.dkim && src.dkim.fail) || 0;
    var firstSeen = src.first_seen || '';
    var lastSeen = src.last_seen || '';
    
    var subInfo = '';
    if (reverse) {
      subInfo = reverse;
    } else if (org) {
      subInfo = org;
    } else {
      subInfo = 'No reverse DNS';
    }
    
    return '<div class="source-row">' +
      '<div class="source-icon ' + status + '">' + getSourceIcon(status) + '</div>' +
      '<div class="source-identity">' +
        '<div class="source-identity-name">' + identity + '</div>' +
        '<div class="source-identity-ip">' + ip + '</div>' +
        '<div class="source-identity-org">' + subInfo + '</div>' +
      '</div>' +
      '<div class="source-stats">' +
        '<div class="source-stat-item">' +
          '<div class="source-stat-num">' + fmt(total) + '</div>' +
          '<div class="source-stat-lbl">Emails</div>' +
        '</div>' +
        '<div class="source-stat-item">' +
          '<div class="source-stat-num">' + alignedRate + '%</div>' +
          '<div class="source-stat-lbl">Aligned</div>' +
        '</div>' +
        '<div class="source-stat-item">' +
          '<div class="source-stat-num" style="color:' + (spfPass > 0 ? 'var(--ok)' : 'var(--danger)') + '">' + fmt(spfPass) + '</div>' +
          '<div class="source-stat-lbl">SPF ‚úì</div>' +
        '</div>' +
        '<div class="source-stat-item">' +
          '<div class="source-stat-num" style="color:' + (dkimPass > 0 ? 'var(--ok)' : 'var(--danger)') + '">' + fmt(dkimPass) + '</div>' +
          '<div class="source-stat-lbl">DKIM ‚úì</div>' +
        '</div>' +
      '</div>' +
      '<div class="source-status">' +
        '<span class="pill ' + status + '">' + getStatusLabel(status) + '</span>' +
        (lastSeen ? '<div class="tiny muted mt-sm">Last: ' + lastSeen + '</div>' : '') +
      '</div>' +
    '</div>';
  }).join('');
  
  listEl.innerHTML = rowsHtml;
  show(explainerEl);
}

async function loadSources(days) {
  var norm = normalizeForUI($('#ins-domain').value, null, null);
  if (!norm.ok) {
    $('#sources-list').innerHTML = '<div class="sources-empty"><p>Please enter a valid domain name first.</p></div>';
    return;
  }
  
  $('#sources-list').innerHTML = '<div class="sources-loading">Loading source data for ' + (norm.apex || norm.value) + '...</div>';
  hide($('#sources-summary'));
  hide($('#sources-explainer'));
  
  try {
    var url = ROBOT_API + '/api/sources?domain=' + encodeURIComponent(norm.apex || norm.value) + '&days=' + days;
    var j = await get(url);
    renderSources(j);
  } catch(e) {
    var errMsg = String(e);
    if (errMsg.indexOf('Failed to fetch') >= 0) {
      errMsg = 'Network error: Could not reach the API.';
    }
    if (errMsg.indexOf('404') >= 0 || errMsg.indexOf('not found') >= 0) {
      errMsg = 'The /api/sources endpoint is not yet deployed. Deploy Robot v0.5.2 to enable this feature.';
    }
    $('#sources-list').innerHTML = '<div class="sources-empty"><p>‚ö†Ô∏è ' + errMsg + '</p></div>';
    $('#sources-wrap').textContent = String(e);
  }
}

$('#btnSources7').addEventListener('click', function() { loadSources(7); });
$('#btnSources30').addEventListener('click', function() { loadSources(30); });

/* ====== DMARC POLICY STEP-UP ====== */
$('#btnPolPreview').addEventListener('click', async function(){
  var d = ($('#pol-domain').value || '').trim();
  if(!d){ logEl('#pol-out','Enter a domain first.'); return; }
  try{
    var j = await get(ROBOT_API + '/policy/preview?domain=' + encodeURIComponent(d));
    logEl('#pol-out', j);
  }catch(e){ logEl('#pol-out', String(e)); }
});

$('#btnApplyCf').addEventListener('click', async function(){
  var body = {
    domain: ($('#pol-domain').value || '').trim(),
    policy: $('#pol-policy').value,
    pct: Number($('#pol-pct').value||100),
    adkim: $('#pol-adkim').value,
    aspf:  $('#pol-aspf').value,
    rua:   ($('#pol-rua').value || '').trim(),
    fo:    ($('#pol-fo').value || '').trim(),
    sp:    ($('#pol-sp').value || '').trim() || null
  };
  if(!body.domain){ logEl('#pol-out','Enter a domain first.'); return; }
  try{ 
    var j = await post(ROBOT_API + '/api/policy/dmarc/cf', body); 
    logEl('#pol-out', j); 
  }catch(e){ logEl('#pol-out', String(e)); }
});

$('#btnApplyR53').addEventListener('click', async function(){
  var body = {
    domain: ($('#pol-domain').value || '').trim(),
    policy: $('#pol-policy').value,
    pct: Number($('#pol-pct').value||100),
    adkim: $('#pol-adkim').value,
    aspf:  $('#pol-aspf').value,
    rua:   ($('#pol-rua').value || '').trim(),
    fo:    ($('#pol-fo').value || '').trim(),
    sp:    ($('#pol-sp').value || '').trim() || null,
    hosted_zone_id: ($('#r53-zones').value || '').trim()
  };
  if(!body.domain){ logEl('#pol-out','Enter a domain first.'); return; }
  if(!body.hosted_zone_id){ logEl('#pol-out','Pick a Route 53 hosted zone first (in the setup section above).'); return; }
  try{ 
    var j = await post(ROBOT_API + '/api/policy/dmarc/r53', body); 
    logEl('#pol-out', j); 
  }catch(e){ logEl('#pol-out', String(e)); }
});

$('#btnEvaluateNow').addEventListener('click', async function(){
  try{ 
    var j = await get(ROBOT_API + '/policy/evaluate-now'); 
    logEl('#pol-out', j); 
  }catch(e){ logEl('#pol-out', String(e)); }
});

/* ====== CONTROL SPF BUILDER ====== */
var SPF_MAP = {
  google:'include:_spf.google.com', 
  m365:'include:spf.protection.outlook.com', 
  sendgrid:'include:sendgrid.net',
  ses:'include:amazonses.com', 
  mailgun:'include:mailgun.org', 
  mailchimp:'include:servers.mcsv.net',
  postmark:'include:spf.mtasv.net', 
  sparkpost:'include:_spf.sparkpostmail.com', 
  zoho:'include:zoho.com',
  zendesk:'include:mail.zendesk.com', 
  intercom:'include:_spf.intercom.io'
};

function updateSpfPreview(){
  var sels = [];
  document.querySelectorAll('.spf-sel:checked').forEach(function(x) {
    if (SPF_MAP[x.value]) sels.push(SPF_MAP[x.value]);
  });
  var txt = ['v=spf1'].concat(sels).concat(['~all']).join(' ');
  $('#spf-preview').value = txt;
}

document.querySelectorAll('.spf-sel').forEach(function(cb) { 
  cb.addEventListener('change', updateSpfPreview); 
});
updateSpfPreview();

$('#btnSpfLoad2').addEventListener('click', async function(){
  var tok = ($('#spf-token').value || '').trim();
  if(!tok){ logEl('#spf-log2','Paste a Cloudflare API token first.'); return; }
  try{ 
    var j = await get(ROBOT_API + '/api/cf/control-spf?token=' + encodeURIComponent(tok)); 
    if (j.value) $('#spf-preview').value = j.value; 
    logEl('#spf-log2', j); 
  }catch(e){ logEl('#spf-log2', String(e)); }
});

$('#btnSpfUpdate2').addEventListener('click', async function(){
  var tok = ($('#spf-token').value || '').trim();
  var val = ($('#spf-preview').value || '').trim();
  if(!tok){ logEl('#spf-log2','Paste a Cloudflare API token first.'); return; }
  try{ 
    var j = await post(ROBOT_API + '/api/cf/control-spf', { token: tok, value: val }); 
    logEl('#spf-log2', j); 
  }catch(e){ logEl('#spf-log2', String(e)); }
});

/* ====== INGEST REPORTS ====== */
$('#btnIngestTest').addEventListener('click', async function(){
  logEl('#ingest-log', 'Testing /ingest/daily endpoint (auth required)...');
  try{
    // This will return 401 without the key, but proves the endpoint exists
    var r = await fetch(ROBOT_API + '/ingest/daily', {
      method: 'POST',
      credentials: 'include',
      headers: { 'content-type': 'application/json', 'accept': 'application/json' },
      body: JSON.stringify({ domain: 'test.com', date: '2025-01-01', total: 0, aligned: 0 })
    });
    var t = await r.text();
    var j = null;
    try { j = JSON.parse(t); } catch(e) {}
    
    if (r.status === 401) {
      logEl('#ingest-log', '‚úÖ Endpoint exists and is protected (401 Unauthorized - correct behavior without x-ingest-key)\n\nTo use this endpoint, send POST with:\n- Header: x-ingest-key: <your-key>\n- Body: { domain, date, total, aligned, spf_aligned, dkim_aligned }');
    } else if (r.ok) {
      logEl('#ingest-log', '‚úÖ Endpoint working:\n' + JSON.stringify(j, null, 2));
    } else {
      logEl('#ingest-log', '‚ö†Ô∏è Endpoint returned ' + r.status + ':\n' + (j ? JSON.stringify(j, null, 2) : t));
    }
  } catch(e) {
    logEl('#ingest-log', '‚ùå Failed to reach endpoint: ' + String(e) + '\n\nThis may be a CORS or network issue.');
  }
});

/* ====== ALERTS ====== */
$('#btnAlertTest').addEventListener('click', async function(){
  try{
    var j = await post(ROBOT_API + '/alerts/test', {domain:'domainsafepro.com', title:'Test alert', message:'This is a test from DomainSafePro Console.'});
    logEl('#alerts-out', j);
  }catch(e){ logEl('#alerts-out', String(e)); }
});

$('#btnAlertFlush').addEventListener('click', async function(){
  try{
    var j = await post(ROBOT_API + '/alerts/flush', {});
    logEl('#alerts-out', j);
  }catch(e){ logEl('#alerts-out', String(e)); }
});

/* ====== API DIAGNOSTICS ====== */
$('#btnTestAll').addEventListener('click', async function(){
  var log = $('#debug-log');
  var results = [];
  
  results.push('=== API Endpoint Diagnostics ===');
  results.push('ROBOT_API: ' + ROBOT_API);
  results.push('DMARC_API: ' + DMARC_API);
  results.push('');
  
  async function testEndpoint(name, url, method){
    var start = Date.now();
    try{
      var opts = { method: method || 'GET', credentials: 'include', headers: { 'accept': 'application/json' } };
      if (method === 'POST') {
        opts.headers['content-type'] = 'application/json';
        opts.body = '{}';
      }
      var r = await fetch(url, opts);
      var elapsed = Date.now() - start;
      var status = r.status + ' ' + r.statusText;
      if (r.ok) {
        return '‚úÖ ' + name + ': ' + status + ' (' + elapsed + 'ms)';
      } else {
        var body = '';
        try { body = await r.text(); body = body.slice(0,100); } catch(e){}
        return '‚ö†Ô∏è ' + name + ': ' + status + ' (' + elapsed + 'ms) - ' + body;
      }
    } catch(e) {
      return '‚ùå ' + name + ': ' + String(e).slice(0,80);
    }
  }
  
  log.textContent = 'Testing endpoints...\n';
  
  // Test core ROBOT_API endpoints
  results.push(await testEndpoint('/api/me', ROBOT_API + '/api/me', 'GET'));
  results.push(await testEndpoint('/api/status', ROBOT_API + '/api/status', 'GET'));
  results.push(await testEndpoint('/api/domains', ROBOT_API + '/api/domains', 'GET'));
  results.push(await testEndpoint('/api/rollup (7d)', ROBOT_API + '/api/rollup?domain=domainsafepro.com&days=7', 'GET'));
  results.push(await testEndpoint('/api/rollup (30d)', ROBOT_API + '/api/rollup?domain=domainsafepro.com&days=30', 'GET'));
  results.push(await testEndpoint('/api/sources (7d)', ROBOT_API + '/api/sources?domain=domainsafepro.com&days=7', 'GET'));
  results.push(await testEndpoint('/policy/preview', ROBOT_API + '/policy/preview?domain=domainsafepro.com', 'GET'));
  results.push(await testEndpoint('/policy/evaluate-now', ROBOT_API + '/policy/evaluate-now', 'GET'));
  results.push(await testEndpoint('/alerts/test', ROBOT_API + '/alerts/test', 'POST'));
  
  results.push('');
  results.push('--- Ingest Endpoints ---');
  results.push(await testEndpoint('/ingest/daily (auth required)', ROBOT_API + '/ingest/daily', 'POST'));
  results.push(await testEndpoint('/ingest/source (auth required)', ROBOT_API + '/ingest/source', 'POST'));
  results.push(await testEndpoint('/ingest/sources (auth required)', ROBOT_API + '/ingest/sources', 'POST'));
  
  results.push('');
  results.push('=== Done ===');
  results.push('');
  results.push('Legend:');
  results.push('‚úÖ = Working');
  results.push('‚ö†Ô∏è = Reachable but returned error (401 = auth required, which is correct)');
  results.push('‚ùå = Failed to fetch (CORS/network/not deployed)');
  results.push('');
  results.push('Note: DMARC_API (api.domainsafepro.com) is reserved for future use.');
  
  log.textContent = results.join('\n');
});

/* ====== Bootstrap ====== */
initAuth();
</script>
</body>
</html>
