<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DomainSafe — Status • Quick‑Codes • Step‑Up</title>
  <style>
    :root{
      --bg:#0f1221; --fg:#e8ebff; --muted:#a7b1e6; --card:#14183a; --line:#2a3470;
      --ok:#3ddc97; --warn:#ffcc66; --bad:#ff6b6b; --btn:#3142d0; --btn2:#1f2a7a;
      --mono:#0f1533; --accent:#9dc0ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
      background:var(--bg); color:var(--fg); line-height:1.45;
    }
    header{padding:28px 20px 8px; border-bottom:1px solid var(--line)}
    header h1{margin:0 0 6px 0; font-size:22px}
    header .tag{color:var(--muted); font-size:13px}
    main{max-width:1150px; margin:0 auto; padding:24px 16px 56px}
    .grid{display:grid; grid-template-columns:1fr; gap:16px}
    @media(min-width:1040px){ .grid{grid-template-columns:1fr 1fr} }
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:12px; padding:16px;
    }
    .card h3{margin:0 0 8px 0; font-size:18px}
    .desc{color:var(--muted); font-size:13px; margin:0 0 10px 0}
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    input,select,textarea{
      width:100%; padding:10px 12px; background:#0f1533; border:1px solid var(--line); color:var(--fg);
      border-radius:8px; outline:none;
    }
    textarea{min-height:100px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > div{flex:1 1 220px}
    .btn{
      appearance:none; border:1px solid var(--btn); background:var(--btn);
      color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600;
    }
    .btn.secondary{background:var(--btn2); border-color:var(--btn2)}
    .btn.ghost{background:transparent; color:var(--fg); border-color:var(--line)}
    .btn.warn{background:linear-gradient(180deg,#f7c74e,#d8a823); border-color:#d8a823; color:#100a00}
    .btn:disabled{opacity:0.6; cursor:not-allowed}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .log{white-space:pre-wrap; font-family:ui-monospace, Menlo, Monaco, Consolas, monospace;
         background:var(--mono); border:1px solid var(--line); border-radius:8px; padding:10px; font-size:13px}
    table{width:100%; border-collapse:collapse; font-size:14px}
    th,td{border-bottom:1px solid var(--line); padding:8px 6px; text-align:left}
    th{color:#c7d0ff; font-weight:600}
    .pill{display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px}
    .ok{background:rgba(61,220,151,.15); color:var(--ok); border:1px solid rgba(61,220,151,.4)}
    .bad{background:rgba(255,107,107,.15); color:var(--bad); border:1px solid rgba(255,107,107,.35)}
    .warn{background:rgba(255,204,102,.12); color:var(--warn); border:1px solid rgba(255,204,102,.35)}
    .hint{font-size:12px; color:var(--muted)}
    .tiny{font-size:12px}
    .muted{color:var(--muted)}
    .notice{margin-top:6px; background:rgba(255,204,102,.12); border:1px dashed var(--warn); color:var(--warn); padding:6px 8px; border-radius:8px}
    .kvs{display:grid; grid-template-columns: 160px 1fr; gap:8px 12px}
    .meter{ height:12px; border-radius:999px; background:#0b1028; border:1px solid #1c2559; overflow:hidden; max-width:320px }
    .meter > i{ display:block; height:100%; background:linear-gradient(90deg,#ff6d6d,#ffcc66,#3ddc97); width:0% }
    .badges{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px}
    .badge{display:inline-flex; align-items:center; gap:6px; padding:6px 8px; border-radius:999px; border:1px solid var(--line); background:#0f1533; font-weight:600}
    .badge.ok{border-color:#1e8f62}
    .badge.warn{border-color:#a1893a}
    .badge.bad{border-color:#a04444}
    /* Insights mini‑bars */
    .bar{height:8px; background:var(--line); border-radius:6px; overflow:hidden}
    .bar > i{display:block; height:100%; background:var(--ok)}
    .rowstats{font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
<header>
  <h1>DomainSafe is live ✅ <span class="muted">Step‑Up UI + Apex‑Guard</span></h1>
  <div class="tag">Status, Quick‑Codes, Verify, one‑click Connect, DMARC Policy Step‑Up, Control SPF, Insights. The robot keeps watch daily.</div>
</header>

<main>

  <!-- STATUS + QUICK CHECK -->
  <section class="grid">
    <div class="card">
      <h3>Domain Status (daily robot checks)</h3>
      <p class="desc">Robot monitors connected domains and records SPF / DMARC / DKIM health snapshots.</p>
      <div class="row">
        <button class="btn" id="btnStatus">Refresh status</button>
        <button class="btn secondary" id="btnMonitor">Run monitor now</button>
      </div>
      <div style="height:6px"></div>
      <table id="statusTable">
        <thead>
          <tr><th>Domain</th><th>Owner</th><th>SPF</th><th>DMARC</th><th>DKIM s1</th><th>DKIM s2</th><th>Checked at</th></tr>
        </thead>
        <tbody id="statusRows"><tr><td colspan="7" class="muted">Loading…</td></tr></tbody>
      </table>
    </div>

    <div class="card">
      <h3>“Check my domain” (instant protection check)</h3>
      <p class="desc">Quick, safe checker — no tokens. Uses <code>/api/check-score</code> and shows badges.</p>
      <div class="row">
        <div>
          <label>Domain</label>
          <input id="chk-domain" class="mono" placeholder="example.com"/>
          <div class="notice tiny" id="chk-notice" style="display:none"></div>
        </div>
        <div style="flex:0 0 180px; align-self:flex-end"><button class="btn" id="btnCheck">Check now</button></div>
      </div>
      <div class="row">
        <label class="tiny"><input type="checkbox" id="chk-exact"> Treat as typed (no apex normalization)</label>
        <label class="tiny"><input type="checkbox" id="chk-legacy"> Also show legacy (status + quick‑codes + DoH JSON)</label>
      </div>

      <div style="height:6px"></div>
      <div id="checkOut" style="display:none">
        <div class="kvs">
          <div>Score</div>
          <div>
            <div class="meter"><i id="scoreBar"></i></div>
            <div class="tiny muted" id="scoreLbl">0/100</div>
          </div>

          <div>Badges</div>
          <div class="badges" id="badgeRow"></div>

          <div>DoH</div>
          <div class="tiny">
            <div><b>_dmarc</b><div id="dohDMARC" class="log tiny" style="margin-top:6px"></div></div>
            <div style="height:6px"></div>
            <div><b>_smtp._tls</b><div id="dohTLS" class="log tiny" style="margin-top:6px"></div></div>
            <div style="height:6px"></div>
            <div><b>mta-sts</b><div id="dohSTS" class="log tiny" style="margin-top:6px"></div></div>
          </div>

          <div>Tips</div>
          <div id="tips" class="tiny">—</div>

          <div>Raw JSON</div>
          <div><pre id="checkRaw" class="log tiny">—</pre></div>
        </div>
      </div>

      <div id="legacyOut" style="display:none">
        <h4 class="tiny" style="margin-top:10px;color:#c7d0ff">Legacy deep check (debug)</h4>
        <pre id="legacyRaw" class="log tiny">—</pre>
        <p class="hint tiny">Legacy calls: Robot <code>/api/status</code> & <code>/api/check-quick-codes</code> + DoH TXT/CNAME.</p>
      </div>
    </div>
  </section>

  <!-- ONBOARD / ADD DOMAIN + VERIFY -->
  <section class="grid">
    <div class="card">
      <h3>Add Domain</h3>
      <p class="desc">Register a domain with the robot (owner email only; no tokens here).</p>
      <div class="row">
        <div><label>Contact email</label><input id="add-email" class="mono" placeholder="owner@example.com"/></div>
        <div>
          <label>Domain</label>
          <input id="add-domain" class="mono" placeholder="example.com"/>
          <div class="notice tiny" id="add-notice" style="display:none"></div>
        </div>
      </div>
      <div style="height:6px"></div>
      <button class="btn" id="btnAdd">Add domain</button>
      <div style="height:6px"></div>
      <pre class="log" id="add-log">Waiting…</pre>

      <h4 class="tiny" style="margin-top:10px;color:#c7d0ff">Recent domains</h4>
      <div id="recentWrap" class="tiny muted">—</div>
    </div>

    <div class="card">
      <h3>Verify Records</h3>
      <p class="desc">Checks public DNS. Green means your domain is wired to central controls.</p>
      <div class="row">
        <div>
          <label>Domain to check</label>
          <input id="verify-domain" class="mono" placeholder="example.com"/>
          <div class="notice tiny" id="verify-notice" style="display:none"></div>
        </div>
        <div style="flex:0 0 160px; align-self:flex-end"><button class="btn" id="btnVerify">Check</button></div>
      </div>
      <div style="height:6px"></div>
      <pre class="log" id="verify-log">Enter a domain → Check.</pre>
    </div>
  </section>

  <!-- QUICK CODES + CLOUDFLARE -->
  <section class="grid">
    <div class="card">
      <h3>Quick‑Codes (one‑time DNS)</h3>
      <p class="desc">Use if you don’t want to connect a provider account. Paste these at your DNS provider and you’re done.</p>
      <div class="row">
        <div>
          <label>Domain to secure</label>
          <input id="qc-domain" class="mono" placeholder="example.com"/>
          <div class="notice tiny" id="qc-notice" style="display:none"></div>
        </div>
        <div style="flex:0 0 200px; align-self:flex-end"><button class="btn" id="btnQCodes">Generate Quick‑Codes</button></div>
      </div>
      <div style="margin:8px 0">
        <label class="tiny"><input type="checkbox" id="qc-extras"/> Show optional extras (MTA‑STS &amp; TLS‑RPT)</label>
      </div>
      <div style="height:6px"></div>
      <div id="qc-results" class="tiny muted">Enter a domain → Generate.</div>
      <div style="height:6px"></div>
      <button class="btn ghost" id="btnCopyAll">Copy all</button>
    </div>

    <div class="card">
      <h3>Connect Cloudflare (one‑click Protect)</h3>
      <p class="desc">Paste a Cloudflare API Token (Zone:Read + DNS:Edit). Token is used only for this request.</p>
      <div class="row">
        <div><label>Cloudflare API Token</label><input id="cf-token" class="mono" type="password" placeholder="paste token here"/></div>
        <div style="flex:0 0 180px; align-self:flex-end"><button class="btn" id="btnCfList">List zones</button></div>
      </div>
      <div class="row">
        <div><label>Zone</label><select id="cf-zones"><option value="">— choose a zone —</option></select></div>
        <div style="flex:0 0 180px; align-self:flex-end"><button class="btn warn" id="btnCfProtect">Protect</button></div>
      </div>
      <div style="height:6px"></div>
      <pre class="log tiny" id="cf-log">Paste token → List zones → choose zone → Protect.</pre>

      <h4 class="tiny" style="margin-top:10px;color:#c7d0ff">Control‑SPF (_spf.control.domainsafepro.com)</h4>
      <div class="row">
        <div style="flex:1 1 100%"><button class="btn secondary" id="btnSpfLoad">Load current</button></div>
        <div style="flex:1 1 100%"><button class="btn secondary" id="btnSpfUpdate">Update control SPF</button></div>
      </div>
      <div class="row">
        <div><label>Current / Desired value</label><textarea id="spf-value" class="mono" spellcheck="false"></textarea></div>
      </div>
    </div>
  </section>

  <!-- ROUTE 53 + POLICY STEP‑UP -->
  <section class="grid">
    <div class="card">
      <h3>Connect AWS Route 53 (one‑click Protect)</h3>
      <p class="desc">Use an IAM user limited to Route 53. Keys are used only for this request.</p>
      <div class="row">
        <div><label>AWS Access Key ID</label><input id="r53-ak" class="mono" placeholder="AKIA…"/></div>
        <div><label>AWS Secret Access Key</label><input id="r53-sk" class="mono" type="password" placeholder="(paste secret)"/></div>
      </div>
      <div class="row">
        <div><label>Hosted zone</label><select id="r53-zones"><option value="">— choose a hosted zone —</option></select></div>
        <div style="flex:0 0 180px; align-self:flex-end"><button class="btn warn" id="btnR53Protect">Protect</button></div>
      </div>
      <div style="height:6px"></div>
      <pre class="log tiny" id="r53-log">Paste keys → List hosted zones → choose one → Protect.</pre>
    </div>

    <div class="card">
      <h3>DMARC Policy Step‑Up (None → Quarantine → Reject)</h3>
      <p class="desc">Start safe (<code>p=none</code>), then raise to <code>quarantine</code> (percentage), finally <code>reject</code>. Robot writes TXT at <code>_dmarc.&lt;domain&gt;</code>.</p>
      <div class="row">
        <div><label>Domain</label><input id="pol-domain" class="mono" placeholder="example.com"/></div>
        <div><label>Policy</label>
          <select id="pol-policy"><option>none</option><option>quarantine</option><option>reject</option></select>
        </div>
        <div><label>PCT</label><input id="pol-pct" type="number" min="1" max="100" value="100"/></div>
        <div><label>adkim</label><select id="pol-adkim"><option>s</option><option>r</option></select></div>
        <div><label>aspf</label><select id="pol-aspf"><option>s</option><option>r</option></select></div>
      </div>
      <div class="row">
        <div><label>rua</label><input id="pol-rua" value="mailto:dmarc@domainsafepro.com"/></div>
        <div><label>fo</label><input id="pol-fo" value="1"/></div>
        <div><label>sp (optional)</label><input id="pol-sp" placeholder=""/></div>
      </div>
      <div class="row">
        <button class="btn secondary" id="btnPolPreview">Preview decision</button>
        <button class="btn" id="btnApplyCf">Apply via Cloudflare</button>
        <button class="btn" id="btnApplyR53">Apply via Route 53</button>
        <button class="btn secondary" id="btnEvaluateNow">Evaluate now (engine)</button>
      </div>
      <div style="height:6px"></div>
      <pre id="pol-out" class="log tiny">Use Preview, then Apply via CF or R53. For “other DNS”, copy the TXT from Preview.</pre>
    </div>
  </section>

  <!-- CONTROL SPF BUILDER + INSIGHTS -->
  <section class="grid">
    <div class="card">
      <h3>Control SPF (central include for all protected domains)</h3>
      <p class="desc">Choose senders and update <code>_spf.control.domainsafepro.com</code> once. All protected domains inherit it.</p>

      <div class="row tiny" style="gap:12px">
        <label><input type="checkbox" class="spf-sel" value="google"/> Google Workspace</label>
        <label><input type="checkbox" class="spf-sel" value="m365"/> Microsoft 365</label>
        <label><input type="checkbox" class="spf-sel" value="sendgrid"/> SendGrid</label>
        <label><input type="checkbox" class="spf-sel" value="ses"/> Amazon SES</label>
        <label><input type="checkbox" class="spf-sel" value="mailgun"/> Mailgun</label>
        <label><input type="checkbox" class="spf-sel" value="mailchimp"/> Mailchimp</label>
        <label><input type="checkbox" class="spf-sel" value="postmark"/> Postmark</label>
        <label><input type="checkbox" class="spf-sel" value="sparkpost"/> SparkPost</label>
        <label><input type="checkbox" class="spf-sel" value="zoho"/> Zoho</label>
        <label><input type="checkbox" class="spf-sel" value="zendesk"/> Zendesk</label>
        <label><input type="checkbox" class="spf-sel" value="intercom"/> Intercom</label>
      </div>

      <div class="row">
        <div><label>Preview (TXT for <span class="mono">_spf.control.domainsafepro.com</span>)</label>
          <input id="spf-preview" class="mono" value="v=spf1 ~all" readonly/>
        </div>
      </div>

      <div class="row">
        <div><label>Cloudflare API Token (Zone:Read + DNS:Edit on <span class="mono">domainsafepro.com</span>)</label>
          <input id="spf-token" class="mono" type="password" placeholder="paste token here"/>
        </div>
      </div>

      <div class="row">
        <button class="btn" id="btnSpfLoad2">Load current</button>
        <button class="btn" id="btnSpfUpdate2">Update control SPF</button>
      </div>

      <div style="height:6px"></div>
      <pre class="log tiny" id="spf-log2">Use “Load current” to see existing value, select senders, then “Update”.</pre>
    </div>

    <div class="card">
      <h3>DMARC Insights</h3>
      <p class="desc">Pull fresh aggregate XMLs and show daily alignment summaries (7/30 days).</p>
      <div class="row">
        <div style="flex:0 0 200px"><button class="btn" id="btnIngest">Ingest latest 20</button></div>
        <div style="flex:1">
          <label>Domain</label>
          <input id="ins-domain" class="mono" value="domainsafepro.com"/>
        </div>
        <div style="flex:0 0 140px; align-self:flex-end">
          <button class="btn secondary" id="btnLoad7">Load 7‑day</button>
        </div>
        <div style="flex:0 0 140px; align-self:flex-end">
          <button class="btn secondary" id="btnLoad30">Load 30‑day</button>
        </div>
      </div>
      <div style="height:6px"></div>
      <div id="ins-summary" class="tiny muted">—</div>
      <div style="height:6px"></div>
      <table id="ins-table" style="display:none">
        <thead>
          <tr><th>Date</th><th>Total</th><th>Aligned</th><th>Aligned&nbsp;%</th><th style="width:160px">Trend</th></tr>
        </thead>
        <tbody id="ins-rows"></tbody>
      </table>
      <div style="height:6px"></div>
      <div id="ins-wrap" class="tiny muted">—</div>
    </div>
  </section>

  <!-- ALERTS -->
  <section class="card">
    <h3>Alerts</h3>
    <p class="desc">Send a test to Slack, then flush queued messages.</p>
    <div class="row">
      <button class="btn" id="btnAlertTest">Send test alert</button>
      <button class="btn secondary" id="btnAlertFlush">Flush alerts</button>
    </div>
    <div style="height:6px"></div>
    <pre class="log tiny" id="alerts-out">—</pre>
  </section>

</main>

<script>
/* ====== Real endpoints (no placeholders) ====== */
const ROBOT_API = "https://domainsafe-robot.pankajonlinerepository.workers.dev";
const DMARC_API = "https://api.domainsafepro.com";

/* ====== Tiny helpers ====== */
const $ = sel => document.querySelector(sel);
const logEl = (sel, v) => { $(sel).textContent = (typeof v === 'string') ? v : JSON.stringify(v, null, 2); };
const qs  = o => new URLSearchParams(o).toString();
const copy = txt => navigator.clipboard?.writeText(txt).catch(()=>{});
async function get(url){
  const r = await fetch(url, { credentials:"omit" });
  const t = await r.text();
  try { const j = JSON.parse(t); if(!r.ok || j?.ok===false) throw new Error(j.error || t); return j; }
  catch{ if(!r.ok) throw new Error(t); return t; }
}
async function post(url, body){
  const r = await fetch(url, { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify(body||{}) });
  const t = await r.text();
  let j; try{ j=JSON.parse(t); } catch{ throw new Error(t); }
  if(!r.ok || j?.ok===false) throw new Error(j.error || t);
  return j;
}
function sanitizeDomain(raw){
  return (raw||'').trim().toLowerCase()
    .replace(/^https?:\/\//,'').replace(/^mailto:/,'').replace(/\/.*$/,'').replace(/\.$/,'');
}
function isDomain(s){ return /^[a-z0-9.-]+\.[a-z]{2,}$/i.test(s||''); }
function apexify(raw){
  const s = sanitizeDomain(raw); if (!isDomain(s)) return s;
  const parts = s.split(".").filter(Boolean);
  if (parts.length <= 2) return s;
  const cc2 = new Set(["co.uk","com.au","co.in","co.jp","com.br","com.mx","com.sg","com.hk"]);
  const tail2 = parts.slice(-2).join("."); const tail3 = parts.slice(-3).join(".");
  return cc2.has(tail2) ? tail3 : tail2;
}
function normalizeForUI(raw, noticeEl, {allowExact=false}={}){
  const input = sanitizeDomain(raw);
  if (!isDomain(input)) return { ok:false, value: input, apex: '', changed:false };
  const apex = apexify(input); let value = apex, changed = false;
  if (allowExact && $('#chk-exact')?.checked){ value = input; } else if (input !== apex){ changed = true; }
  if (noticeEl){
    if (changed){ noticeEl.innerHTML = `Using apex <span class="mono">${apex}</span> (from <span class="mono">${input}</span>).`; noticeEl.style.display = ''; }
    else { noticeEl.style.display = 'none'; }
  }
  return { ok:true, value, apex, changed };
}

/* ====== STATUS & MONITOR ====== */
async function loadStatus(){
  const tb = $("#statusRows"); tb.innerHTML = `<tr><td colspan="7" class="muted">Loading…</td></tr>`;
  try{
    const j = await get(`${ROBOT_API}/api/status`);
    const rows = j.rows || [];
    if (!rows.length){ tb.innerHTML = `<tr><td colspan="7" class="muted">No rows yet.</td></tr>`; return; }
    tb.innerHTML = rows.map(r=>{
      const yn = v => v ? '<span class="pill ok">OK</span>' : '<span class="pill bad">Needs fix</span>';
      return `<tr>
        <td class="mono">${r.domain_name}</td>
        <td class="mono">${r.email||''}</td>
        <td>${yn(r.spf_ok)}</td>
        <td>${yn(r.dmarc_ok)}</td>
        <td>${yn(r.dkim_s1_ok)}</td>
        <td>${yn(r.dkim_s2_ok)}</td>
        <td class="tiny muted">${r.checked_at||''}</td>
      </tr>`;
    }).join('');
  }catch(e){ tb.innerHTML = `<tr><td colspan="7" class="tiny" style="color:#ff9f9f">Error: ${String(e).slice(0,200)}</td></tr>`; }
}
$("#btnStatus").addEventListener("click", loadStatus);
$("#btnMonitor").addEventListener("click", async ()=>{
  try{ await post(`${ROBOT_API}/api/monitor-run`, {}); }catch(e){ /* ignore */ }
  loadStatus();
});
loadStatus();

/* ====== CHECK (fun status via /api/check-score; optional legacy debug) ====== */
function badgeHtml(label, state, detail){
  let cls='bad', icon='✖';
  if (state===true || state==='ok'){ cls='ok'; icon='✔'; }
  else if (state==='warn'){ cls='warn'; icon='⚠'; }
  const extra = detail ? ` <span class="tiny muted">${detail}</span>` : '';
  return `<span class="badge ${cls}">${icon} ${label}${extra}</span>`;
}
$("#btnCheck").addEventListener("click", async ()=>{
  const norm = normalizeForUI($("#chk-domain").value, $("#chk-notice"), {allowExact:true});
  if(!norm.ok) return;
  const dom = norm.value;
  try{
    // Single call for score + badges
    const exact = $("#chk-exact").checked ? "&exact=1" : "";
    const j = await get(`${ROBOT_API}/api/check-score?domain=${encodeURIComponent(dom)}${exact}`);

    // Meter + score
    const pct = Math.max(0, Math.min(100, Number(j.score||0)));
    $("#scoreBar").style.width = pct + "%";
    $("#scoreLbl").textContent = `${pct}/100`;

    // Badges
    const b = j.badges || {};
    const dm = (b.dmarc||"").toString();
    $("#badgeRow").innerHTML = [
      badgeHtml("SPF", b.spf===true, b.spf ? "include:_spf.control" : "missing include"),
      badgeHtml("DKIM", b.dkim===true, b.dkim ? "s1+s2 → control OK" : "selectors not to control"),
      badgeHtml("DMARC", dm ? "ok" : false, dm ? `p=${dm}` : "missing"),
      badgeHtml("TLS‑RPT", b.extras?.tlsrpt===true),
      badgeHtml("MTA‑STS", b.extras?.mtasts===true)
    ].join(" ");

    // DoH + tips + raw
    $("#dohDMARC").textContent = j.doh?._dmarc || "—";
    $("#dohTLS").textContent   = j.doh?._smtp__tls || "—";
    $("#dohSTS").textContent   = j.doh?.mta_sts || "—";
    $("#tips").innerHTML = (j.tips||[]).map(t => `<div class="notice tiny">${t}</div>`).join("") || "—";
    $("#checkRaw").textContent = JSON.stringify(j, null, 2);
    $("#checkOut").style.display = "";

    // Optional: legacy deep JSON (for parity with your previous page)
    if ($("#chk-legacy").checked){
      const status = await get(`${ROBOT_API}/api/status?domain=${encodeURIComponent(dom)}`);
      const quick  = await get(`${ROBOT_API}/api/check-quick-codes?domain=${encodeURIComponent(dom)}`);
      const dohDMARC = await fetch(`https://cloudflare-dns.com/dns-query?name=${encodeURIComponent('_dmarc.'+dom)}&type=TXT`, {headers:{Accept:'application/dns-json'}}).then(r=>r.json()).catch(()=>null);
      const dohTLS   = await fetch(`https://cloudflare-dns.com/dns-query?name=${encodeURIComponent('_smtp._tls.'+dom)}&type=TXT`, {headers:{Accept:'application/dns-json'}}).then(r=>r.json()).catch(()=>null);
      const dohSTS   = await fetch(`https://cloudflare-dns.com/dns-query?name=${encodeURIComponent('mta-sts.'+dom)}&type=CNAME`, {headers:{Accept:'application/dns-json'}}).then(r=>r.json()).catch(()=>null);
      const ansTxt = (ans) => (ans && ans.Answer) ? ans.Answer.map(a=>String(a.data).replace(/^"|"$/g,'')).join('\n') : '—';
      const legacy = {
        domain: dom,
        robot_status: status?.status || status,
        quick_checks: quick?.checks,
        doh: { _dmarc: ansTxt(dohDMARC), _smtp__tls: ansTxt(dohTLS), mta_sts: ansTxt(dohSTS) }
      };
      $("#legacyRaw").textContent = JSON.stringify(legacy, null, 2);
      $("#legacyOut").style.display = "";
    } else {
      $("#legacyOut").style.display = "none";
    }

  }catch(e){
    $("#checkRaw").textContent = `Error: ${String(e)}`;
    $("#checkOut").style.display = "";
  }
});

/* ====== ADD DOMAIN ====== */
async function refreshRecent(){
  try{
    const s = await get(`${ROBOT_API}/api/domains`);
    const rows = s.domains || s.rows || [];
    $("#recentWrap").innerHTML = rows.slice(0,10).map(r =>
      `<div class="mono">${r.domain_name} <span class="muted">— ${r.status||''} — ${r.created_at||''}</span></div>`
    ).join("") || "—";
  }catch{}
}
$("#btnAdd").addEventListener("click", async ()=>{
  const norm = normalizeForUI($("#add-domain").value, $("#add-notice"));
  const email = $("#add-email").value.trim();
  if(!email || !norm.ok){ $("#add-log").textContent = "Please enter a valid email and domain."; return; }
  try{
    const j = await post(`${ROBOT_API}/api/domains`, { email, domain: norm.apex || norm.value });
    logEl("#add-log", j); refreshRecent();
  }catch(e){ logEl("#add-log", String(e)); }
});
refreshRecent();

/* ====== VERIFY ====== */
$("#btnVerify").addEventListener("click", async ()=>{
  const norm = normalizeForUI($("#verify-domain").value, $("#verify-notice"));
  if(!norm.ok) return logEl("#verify-log","Enter a valid domain.");
  try{
    const j = await get(`${ROBOT_API}/api/check-quick-codes?domain=${encodeURIComponent(norm.apex || norm.value)}`);
    logEl("#verify-log", j);
  }catch(e){ logEl("#verify-log", String(e)); }
});

/* ====== QUICK‑CODES ====== */
$("#btnQCodes").addEventListener("click", async ()=>{
  const norm = normalizeForUI($("#qc-domain").value, $("#qc-notice"));
  if(!norm.ok) return $("#qc-results").textContent = "Enter a valid domain.";
  try{
    const j = await get(`${ROBOT_API}/api/quick-codes?domain=${encodeURIComponent(norm.apex || norm.value)}${$("#qc-extras").checked?'&extras=1':''}`);
    const lines = [];
    (j.records||[]).forEach(r => lines.push(`${r.type}\t${r.name}\t${r.value}`));
    if ($("#qc-extras").checked) (j.extras||[]).forEach(r => lines.push(`${r.type}\t${r.name}\t${r.value}`));
    $("#qc-results").innerHTML = `<pre class="log">${lines.join("\n")||"—"}</pre>`;
  }catch(e){ $("#qc-results").textContent = String(e); }
});
$("#btnCopyAll").addEventListener("click", ()=>{
  const pre = $("#qc-results").querySelector("pre"); if (pre) copy(pre.textContent);
});

/* ====== CLOUDFLARE ====== */
$("#btnCfList").addEventListener("click", async ()=>{
  const token = $("#cf-token").value.trim();
  if(!token) return logEl("#cf-log","Paste your Cloudflare API token first.");
  try{
    const j = await post(`${ROBOT_API}/api/cf/list-zones`, { token });
    const sel = $("#cf-zones"); sel.innerHTML = '<option value="">— choose a zone —</option>';
    (j.zones||[]).forEach(z => {
      const o = document.createElement("option"); o.value = z.id; o.textContent = `${z.name} (${z.status})`; sel.appendChild(o);
    });
    logEl("#cf-log", {ok:true, zones:(j.zones||[]).map(v=>({id:v.id,name:v.name,status:v.status}))});
  }catch(e){ logEl("#cf-log", String(e)); }
});
$("#btnCfProtect").addEventListener("click", async ()=>{
  const token = $("#cf-token").value.trim();
  const zone_id = $("#cf-zones").value;
  if(!token || !zone_id) return logEl("#cf-log","Paste token and choose a zone.");
  try{
    const j = await post(`${ROBOT_API}/api/cf/protect`, { token, zone_id });
    logEl("#cf-log", j);
    if (j.apex) $("#pol-domain").value = j.apex;
  }catch(e){ logEl("#cf-log", String(e)); }
});

/* Control‑SPF (in this panel) */
$("#btnSpfLoad").addEventListener("click", async ()=>{
  const token = $("#cf-token").value.trim();
  if(!token) return logEl("#cf-log","Paste a Cloudflare API token first.");
  try{
    const j = await get(`${ROBOT_API}/api/cf/control-spf?token=${encodeURIComponent(token)}`);
    $("#spf-value").value = j.value || "";
    logEl("#cf-log", j);
  }catch(e){ logEl("#cf-log", String(e)); }
});
$("#btnSpfUpdate").addEventListener("click", async ()=>{
  const token = $("#cf-token").value.trim();
  const value = $("#spf-value").value.trim();
  if(!token) return logEl("#cf-log","Paste a Cloudflare API token first.");
  try{
    const j = await post(`${ROBOT_API}/api/cf/control-spf`, { token, value });
    logEl("#cf-log", j);
  }catch(e){ logEl("#cf-log", String(e)); }
});

/* ====== ROUTE 53 ====== */
$("#btnR53Protect").addEventListener("click", async ()=>{
  const access_key_id = $("#r53-ak").value.trim();
  const secret_access_key = $("#r53-sk").value.trim();
  const hosted_zone_id = $("#r53-zones").value;
  if(!access_key_id || !secret_access_key || !hosted_zone_id) return logEl("#r53-log","Paste keys and pick a hosted zone.");
  try{
    const j = await post(`${ROBOT_API}/api/r53/protect`, { access_key_id, secret_access_key, hosted_zone_id });
    logEl("#r53-log", j);
    if (j.apex) $("#pol-domain").value = j.apex;
  }catch(e){ logEl("#r53-log", String(e)); }
});
/* Auto-list zones when AK/SK both present (keeps UI nimble) */
async function r53ListZonesIfReady(){
  const access_key_id = $("#r53-ak").value.trim();
  const secret_access_key = $("#r53-sk").value.trim();
  if(!access_key_id || !secret_access_key) return;
  try{
    const j = await post(`${ROBOT_API}/api/r53/list-zones`, { access_key_id, secret_access_key });
    const sel = $("#r53-zones"); sel.innerHTML = '<option value="">— choose a hosted zone —</option>';
    (j.zones||[]).forEach(z => {
      const o = document.createElement("option"); o.value = z.id; o.textContent = `${z.name} (${z.id})`; sel.appendChild(o);
    });
    logEl("#r53-log", {ok:true, zones:j.zones});
  }catch(e){ logEl("#r53-log", String(e)); }
}
$("#r53-ak").addEventListener("change", r53ListZonesIfReady);
$("#r53-sk").addEventListener("change", r53ListZonesIfReady);

/* ====== POLICY STEP‑UP ====== */
$("#btnPolPreview").addEventListener("click", async ()=>{
  const d = $("#pol-domain").value.trim();
  if(!d) return logEl("#pol-out","Enter a domain first.");
  try{
    const j = await get(`${ROBOT_API}/policy/preview?domain=${encodeURIComponent(d)}`);
    logEl("#pol-out", j);
  }catch(e){ logEl("#pol-out", String(e)); }
});
$("#btnApplyCf").addEventListener("click", async ()=>{
  const body = {
    domain: $("#pol-domain").value.trim(),
    policy: $("#pol-policy").value,
    pct: Number($("#pol-pct").value||100),
    adkim: $("#pol-adkim").value,
    aspf:  $("#pol-aspf").value,
    rua:   $("#pol-rua").value.trim(),
    fo:    $("#pol-fo").value.trim(),
    sp:    ($("#pol-sp").value.trim()||null)
  };
  if(!body.domain) return logEl("#pol-out","Enter a domain first.");
  try{ const j = await post(`${ROBOT_API}/api/policy/dmarc/cf`, body); logEl("#pol-out", j); }
  catch(e){ logEl("#pol-out", String(e)); }
});
$("#btnApplyR53").addEventListener("click", async ()=>{
  const body = {
    domain: $("#pol-domain").value.trim(),
    policy: $("#pol-policy").value,
    pct: Number($("#pol-pct").value||100),
    adkim: $("#pol-adkim").value,
    aspf:  $("#pol-aspf").value,
    rua:   $("#pol-rua").value.trim(),
    fo:    $("#pol-fo").value.trim(),
    sp:    ($("#pol-sp").value.trim()||null),
    hosted_zone_id: $("#r53-zones").value.trim()
  };
  if(!body.domain) return logEl("#pol-out","Enter a domain first.");
  if(!body.hosted_zone_id) return logEl("#pol-out","Pick a Route 53 hosted zone (top-left panel).");
  try{ const j = await post(`${ROBOT_API}/api/policy/dmarc/r53`, body); logEl("#pol-out", j); }
  catch(e){ logEl("#pol-out", String(e)); }
});
$("#btnEvaluateNow").addEventListener("click", async ()=>{
  try{ const j = await get(`${ROBOT_API}/policy/evaluate-now`); logEl("#pol-out", j); }
  catch(e){ logEl("#pol-out", String(e)); }
});

/* ====== CONTROL SPF (builder) ====== */
const SPF_MAP = {
  google:'include:_spf.google.com', m365:'include:spf.protection.outlook.com', sendgrid:'include:sendgrid.net',
  ses:'include:amazonses.com', mailgun:'include:mailgun.org', mailchimp:'include:servers.mcsv.net',
  postmark:'include:spf.mtasv.net', sparkpost:'include:_spf.sparkpostmail.com', zoho:'include:zoho.com',
  zendesk:'include:mail.zendesk.com', intercom:'include:_spf.intercom.io'
};
function updateSpfPreview(){
  const sels = [...document.querySelectorAll('.spf-sel:checked')].map(x => SPF_MAP[x.value]).filter(Boolean);
  const txt = ['v=spf1', ...sels, '~all'].join(' ');
  $("#spf-preview").value = txt;
}
document.querySelectorAll('.spf-sel').forEach(cb => cb.addEventListener('change', updateSpfPreview));
updateSpfPreview();

$("#btnSpfLoad2").addEventListener("click", async ()=>{
  const tok = $("#spf-token").value.trim();
  if(!tok) return logEl("#spf-log2","Paste a Cloudflare API token first.");
  try{ const j = await get(`${ROBOT_API}/api/cf/control-spf?token=${encodeURIComponent(tok)}`); if (j.value) $("#spf-preview").value = j.value; logEl("#spf-log2", j); }
  catch(e){ logEl("#spf-log2", String(e)); }
});
$("#btnSpfUpdate2").addEventListener("click", async ()=>{
  const tok = $("#spf-token").value.trim();
  const val = $("#spf-preview").value.trim();
  if(!tok) return logEl("#spf-log2","Paste a Cloudflare API token first.");
  try{ const j = await post(`${ROBOT_API}/api/cf/control-spf`, { token: tok, value: val }); logEl("#spf-log2", j); }
  catch(e){ logEl("#spf-log2", String(e)); }
});

/* ====== INSIGHTS (rollup) ====== */
function fmt(n){ return (n||0).toLocaleString(); }
function pct(a,b){ const r = (b>0) ? (a/b) : 0; return Math.round(r*1000)/10; }
function asArray(series){ if (Array.isArray(series)) return series; if (series && typeof series==='object'){ return Object.keys(series).sort().map(d => ({date:d, ...series[d]})); } return []; }
function renderRollup(j){
  const rows = asArray(j.series);
  const table = $('#ins-table'); const body = $('#ins-rows'); const summary = $('#ins-summary');
  if (!rows.length){ table.style.display='none'; summary.textContent='No data yet for this window.'; return; }
  const T = rows.reduce((acc,r)=>{ acc.total+=r.total||0; acc.aligned+=r.aligned||0; return acc; }, {total:0,aligned:0});
  const rate = pct(T.aligned, T.total);
  summary.innerHTML = `<strong>${j.domain}</strong> — ${j.days}‑day totals: <strong>${fmt(T.total)}</strong> msgs, <strong style="color:#8be8bd">${fmt(T.aligned)}</strong> aligned (<strong style="color:#8be8bd">${rate}%</strong>)`;
  body.innerHTML = '';
  rows.forEach(r=>{
    const p = pct(r.aligned||0, r.total||0);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">${r.date}</td>
      <td>${fmt(r.total||0)}</td>
      <td>${fmt(r.aligned||0)}</td>
      <td>${p}%</td>
      <td>
        <div class="bar"><i style="width:${Math.min(100,p)}%"></i></div>
        <div class="rowstats">${r.spf_aligned!=null && r.dkim_aligned!=null ? `SPF ${fmt(r.spf_aligned)} · DKIM ${fmt(r.dkim_aligned)}` : ''}</div>
      </td>`;
    body.appendChild(tr);
  });
  table.style.display = '';
}
async function loadRoll(days){
  const norm = normalizeForUI($('#ins-domain').value);
  if(!norm.ok){ $('#ins-wrap').textContent = 'Enter a valid domain first.'; return; }
  try{
    const j = await get(`${ROBOT_API}/api/rollup?domain=${encodeURIComponent(norm.apex || norm.value)}&days=${days}`);
    $('#ins-wrap').textContent = JSON.stringify(j, null, 2);
    renderRollup({ domain: j.domain || (norm.apex||norm.value), days, series: j.series||[] });
  }catch(e){ $('#ins-wrap').textContent = String(e); }
}
$("#btnLoad7").addEventListener("click", ()=>loadRoll(7));
$("#btnLoad30").addEventListener("click", ()=>loadRoll(30));

/* Optional: DMARC ingest trigger (kept from your page) */
$("#btnIngest").addEventListener("click", async ()=>{
  try{
    const j = await post(`${DMARC_API}/api/dmarc/ingest-latest`, { limit:25 });
    $('#ins-wrap').textContent = JSON.stringify(j, null, 2);
  }catch(e){ $('#ins-wrap').textContent = String(e); }
});

/* ====== ALERTS ====== */
$("#btnAlertTest").addEventListener("click", async ()=>{
  try{ const j = await post(`${ROBOT_API}/alerts/test`, { domain:'slawitness.com', title:'Test', message:'This is a test from DomainSafe.' }); logEl("#alerts-out", j); }
  catch(e){ logEl("#alerts-out", String(e)); }
});
$("#btnAlertFlush").addEventListener("click", async ()=>{
  try{ const j = await post(`${ROBOT_API}/alerts/flush`, {}); logEl("#alerts-out", j); }
  catch(e){ logEl("#alerts-out", String(e)); }
});
</script>
</body>
</html>
